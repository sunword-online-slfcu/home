!function(e){"use strict";function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function n(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if("function"==typeof t){var n=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})})),n}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,g(r.key),r)}}function s(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function a(e){var t=d();return function(){var n,r=l(e);if(t){var i=l(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,n)}}function u(e,t,n){return(t=g(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(){return c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=function(e,t){for(;!{}.hasOwnProperty.call(e,t)&&null!==(e=l(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},c.apply(null,arguments)}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&v(e,t)}function d(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(d=function(){return!!e})()}function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){u(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function v(e,t){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},v(e,t)}function b(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,o,s,a=[],u=!0,c=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=o.call(n)).done)&&(a.push(r.value),a.length!==t);u=!0);}catch(e){c=!0,i=e}finally{try{if(!u&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(c)throw i}}return a}}(e,t)||_(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||_(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function g(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t);if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}function y(e){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y(e)}function _(e,t){if(e){if("string"==typeof e)return r(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}}function w(e){var t="function"==typeof Map?new Map:void 0;return w=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return function(e,t,n){if(d())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,t);var i=new(e.bind.apply(e,r));return n&&v(i,n.prototype),i}(e,arguments,l(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),v(n,e)},w(e)}sm.siteId=sm.conf.engagement.site_id,sm.rxVersion=6;var E,O={exports:{}};var S,T=(E||(E=1,S=O,function(){function e(){}var t=e.prototype,n=this,r=n.EventEmitter;function i(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function o(e){return function(){return this[e].apply(this,arguments)}}t.getListeners=function(e){var t,n,r=this._getEvents();if("object"===y(e))for(n in t={},r)r.hasOwnProperty(n)&&e.test(n)&&(t[n]=r[n]);else t=r[e]||(r[e]=[]);return t},t.flattenListeners=function(e){var t,n=[];for(t=0;t<e.length;t+=1)n.push(e[t].listener);return n},t.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&((t={})[e]=n),t||n},t.addListener=function(e,t){var n,r=this.getListenersAsObject(e),o="object"===y(t);for(n in r)r.hasOwnProperty(n)&&-1===i(r[n],t)&&r[n].push(o?t:{listener:t,once:!1});return this},t.on=o("addListener"),t.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},t.once=o("addOnceListener"),t.defineEvent=function(e){return this.getListeners(e),this},t.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},t.removeListener=function(e,t){var n,r,o=this.getListenersAsObject(e);for(r in o)o.hasOwnProperty(r)&&-1!==(n=i(o[r],t))&&o[r].splice(n,1);return this},t.off=o("removeListener"),t.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},t.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},t.manipulateListeners=function(e,t,n){var r,i,o=e?this.removeListener:this.addListener,s=e?this.removeListeners:this.addListeners;if("object"!==y(t)||t instanceof RegExp)for(r=n.length;r--;)o.call(this,t,n[r]);else for(r in t)t.hasOwnProperty(r)&&(i=t[r])&&("function"==typeof i?o.call(this,r,i):s.call(this,r,i));return this},t.removeEvent=function(e){var t,n=y(e),r=this._getEvents();if("string"===n)delete r[e];else if("object"===n)for(t in r)r.hasOwnProperty(t)&&e.test(t)&&delete r[t];else delete this._events;return this},t.removeAllListeners=o("removeEvent"),t.emitEvent=function(e,t){var n,r,i,o=this.getListenersAsObject(e);for(i in o)if(o.hasOwnProperty(i))for(r=o[i].length;r--;)!0===(n=o[i][r]).once&&this.removeListener(e,n.listener),n.listener.apply(this,t||[])===this._getOnceReturnValue()&&this.removeListener(e,n.listener);return this},t.trigger=o("emitEvent"),t.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},t.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},t._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},t._getEvents=function(){return this._events||(this._events={})},e.noConflict=function(){return n.EventEmitter=r,e},S.exports?S.exports=e:this.EventEmitter=e}.call(O.exports)),O.exports),A=t(T),I={"@@functional/placeholder":!0};function k(e){return null!=e&&"object"===y(e)&&!0===e["@@functional/placeholder"]}function x(e){return function t(n){return 0===arguments.length||k(n)?t:e.apply(this,arguments)}}function M(e){return function t(n,r){switch(arguments.length){case 0:return t;case 1:return k(n)?t:x((function(t){return e(n,t)}));default:return k(n)&&k(r)?t:k(n)?x((function(t){return e(t,r)})):k(r)?x((function(t){return e(n,t)})):e(n,r)}}}var N=M((function(e,t){return Number(e)+Number(t)}));function R(e,t){var n;t=t||[];var r=(e=e||[]).length,i=t.length,o=[];for(n=0;n<r;)o[o.length]=e[n],n+=1;for(n=0;n<i;)o[o.length]=t[n],n+=1;return o}function C(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,n){return t.apply(this,arguments)};case 3:return function(e,n,r){return t.apply(this,arguments)};case 4:return function(e,n,r,i){return t.apply(this,arguments)};case 5:return function(e,n,r,i,o){return t.apply(this,arguments)};case 6:return function(e,n,r,i,o,s){return t.apply(this,arguments)};case 7:return function(e,n,r,i,o,s,a){return t.apply(this,arguments)};case 8:return function(e,n,r,i,o,s,a,u){return t.apply(this,arguments)};case 9:return function(e,n,r,i,o,s,a,u,c){return t.apply(this,arguments)};case 10:return function(e,n,r,i,o,s,a,u,c,l){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}function P(e,t,n){return function(){for(var r=[],i=0,o=e,s=0;s<t.length||i<arguments.length;){var a;s<t.length&&(!k(t[s])||i>=arguments.length)?a=t[s]:(a=arguments[i],i+=1),r[s]=a,k(a)||(o-=1),s+=1}return o<=0?n.apply(this,r):C(o,P(e,r,n))}}var j=M((function(e,t){return 1===e?x(t):C(e,P(e,[],t))})),L=x((function(e){return j(e.length,(function(){var t=0,n=arguments[0],r=arguments[arguments.length-1],i=Array.prototype.slice.call(arguments,0);return i[0]=function(){var e=n.apply(this,R(arguments,[t,r]));return t+=1,e},e.apply(this,i)}))}));function U(e){return function t(n,r,i){switch(arguments.length){case 0:return t;case 1:return k(n)?t:M((function(t,r){return e(n,t,r)}));case 2:return k(n)&&k(r)?t:k(n)?M((function(t,n){return e(t,r,n)})):k(r)?M((function(t,r){return e(n,t,r)})):x((function(t){return e(n,r,t)}));default:return k(n)&&k(r)&&k(i)?t:k(n)&&k(r)?M((function(t,n){return e(t,n,i)})):k(n)&&k(i)?M((function(t,n){return e(t,r,n)})):k(r)&&k(i)?M((function(t,r){return e(n,t,r)})):k(n)?x((function(t){return e(t,r,i)})):k(r)?x((function(t){return e(n,t,i)})):k(i)?x((function(t){return e(n,r,t)})):e(n,r,i)}}}var q=U((function(e,t,n){if(e>=n.length||e<-n.length)return n;var r=(e<0?n.length:0)+e,i=R(n);return i[r]=t(n[r]),i})),D=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)};function V(e){return null!=e&&"function"==typeof e["@@transducer/step"]}function F(e,t,n){return function(){if(0===arguments.length)return n();var r=Array.prototype.slice.call(arguments,0),i=r.pop();if(!D(i)){for(var o=0;o<e.length;){if("function"==typeof i[e[o]])return i[e[o]].apply(i,r);o+=1}if(V(i))return t.apply(null,r)(i)}return n.apply(this,arguments)}}function H(e){return e&&e["@@transducer/reduced"]?e:{"@@transducer/value":e,"@@transducer/reduced":!0}}var W={init:function(){return this.xf["@@transducer/init"]()},result:function(e){return this.xf["@@transducer/result"](e)}},G=function(){function e(e,t){this.xf=t,this.f=e,this.all=!0}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=function(e){return this.all&&(e=this.xf["@@transducer/step"](e,!0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)||(this.all=!1,e=H(this.xf["@@transducer/step"](e,!1))),e},e}(),B=M(F(["all"],M((function(e,t){return new G(e,t)})),(function(e,t){for(var n=0;n<t.length;){if(!e(t[n]))return!1;n+=1}return!0}))),z=M((function(e,t){return t>e?t:e}));function J(e,t){for(var n=0,r=t.length,i=Array(r);n<r;)i[n]=e(t[n]),n+=1;return i}function Q(e){return"[object String]"===Object.prototype.toString.call(e)}var Y=x((function(e){return!!D(e)||!!e&&("object"===y(e)&&(!Q(e)&&(1===e.nodeType?!!e.length:0===e.length||e.length>0&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))})),K=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},e}();function X(e){return new K(e)}var $=M((function(e,t){return C(e.length,(function(){return e.apply(t,arguments)}))}));function Z(e,t,n){for(var r=n.next();!r.done;){if((t=e["@@transducer/step"](t,r.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r=n.next()}return e["@@transducer/result"](t)}function ee(e,t,n,r){return e["@@transducer/result"](n[r]($(e["@@transducer/step"],e),t))}var te="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";function ne(e,t,n){if("function"==typeof e&&(e=X(e)),Y(n))return function(e,t,n){for(var r=0,i=n.length;r<i;){if((t=e["@@transducer/step"](t,n[r]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r+=1}return e["@@transducer/result"](t)}(e,t,n);if("function"==typeof n["fantasy-land/reduce"])return ee(e,t,n,"fantasy-land/reduce");if(null!=n[te])return Z(e,t,n[te]());if("function"==typeof n.next)return Z(e,t,n);if("function"==typeof n.reduce)return ee(e,t,n,"reduce");throw new TypeError("reduce: list must be array or iterable")}var re=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=W.result,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},e}(),ie=M((function(e,t){return new re(e,t)}));function oe(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var se=Object.prototype.toString,ae=function(){return"[object Arguments]"===se.call(arguments)?function(e){return"[object Arguments]"===se.call(e)}:function(e){return oe("callee",e)}}(),ue=!{toString:null}.propertyIsEnumerable("toString"),ce=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],le=function(){return arguments.propertyIsEnumerable("length")}(),fe=function(e,t){for(var n=0;n<e.length;){if(e[n]===t)return!0;n+=1}return!1},de="function"!=typeof Object.keys||le?x((function(e){if(Object(e)!==e)return[];var t,n,r=[],i=le&&ae(e);for(t in e)!oe(t,e)||i&&"length"===t||(r[r.length]=t);if(ue)for(n=ce.length-1;n>=0;)oe(t=ce[n],e)&&!fe(r,t)&&(r[r.length]=t),n-=1;return r})):x((function(e){return Object(e)!==e?[]:Object.keys(e)})),pe=M(F(["fantasy-land/map","map"],ie,(function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return j(t.length,(function(){return e.call(this,t.apply(this,arguments))}));case"[object Object]":return ne((function(n,r){return n[r]=e(t[r]),n}),{},de(t));default:return J(e,t)}}))),he=Number.isInteger||function(e){return(e|0)===e},ve=M((function(e,t){var n=e<0?t.length+e:e;return Q(t)?t.charAt(n):t[n]})),be=M((function(e,t){return e.map((function(e){for(var n,r=t,i=0;i<e.length;){if(null==r)return;n=e[i],r=he(n)?ve(n,r):r[n],i+=1}return r}))})),me=M((function(e,t){return be([e],t)[0]})),ge=M((function(e,t){return me([e],t)})),ye=M((function(e,t){return pe(ge(e),t)})),_e=U(ne),we=x((function(e){return j(_e(z,0,ye("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(!e[t].apply(this,arguments))return!1;t+=1}return!0}))})),Ee=x((function(e){return function(){return e}})),Oe=M((function(e,t){return e&&t})),Se=function(){function e(e,t){this.xf=t,this.f=e,this.any=!1}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=function(e){return this.any||(e=this.xf["@@transducer/step"](e,!1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.any=!0,e=H(this.xf["@@transducer/step"](e,!0))),e},e}(),Te=M(F(["any"],M((function(e,t){return new Se(e,t)})),(function(e,t){for(var n=0;n<t.length;){if(e(t[n]))return!0;n+=1}return!1}))),Ae=x((function(e){return j(_e(z,0,ye("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(e[t].apply(this,arguments))return!0;t+=1}return!1}))})),Ie=M((function(e,t){return"function"==typeof t["fantasy-land/ap"]?t["fantasy-land/ap"](e):"function"==typeof e.ap?e.ap(t):"function"==typeof e?function(n){return e(n)(t(n))}:ne((function(e,n){return R(e,pe(n,t))}),[],e)}));function ke(e,t){for(var n=0,r=t.length-(e-1),i=new Array(r>=0?r:0);n<r;)i[n]=Array.prototype.slice.call(t,n,n+e),n+=1;return i}var xe=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.store(t),this.full?this.xf["@@transducer/step"](e,this.getCopy()):e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e.prototype.getCopy=function(){return R(Array.prototype.slice.call(this.acc,this.pos),Array.prototype.slice.call(this.acc,0,this.pos))},e}(),Me=M(F([],M((function(e,t){return new xe(e,t)})),ke)),Ne=M((function(e,t){return R(t,[e])})),Re=M((function(e,t){return e.apply(this,t)})),Ce=x((function(e){for(var t=de(e),n=t.length,r=[],i=0;i<n;)r[i]=e[t[i]],i+=1;return r}));function Pe(e,t){return de(t).reduce((function(n,r){return n[r]=e(t[r]),n}),{})}var je=x((function e(t){return t=Pe((function(t){return"function"==typeof t?t:e(t)}),t),j(_e(z,0,ye("length",Ce(t))),(function(){var e=arguments;return Pe((function(t){return Re(t,e)}),t)}))})),Le=M((function(e,t){return t(e)})),Ue=U((function(e,t,n){var r=e(t),i=e(n);return r<i?-1:r>i?1:0})),qe=U((function(e,t,n){var r={};for(var i in n)r[i]=n[i];return r[e]=t,r})),De=x((function(e){return null==e})),Ve=U((function e(t,n,r){if(0===t.length)return n;var i=t[0];if(t.length>1){var o=!De(r)&&oe(i,r)?r[i]:he(t[1])?[]:{};n=e(Array.prototype.slice.call(t,1),n,o)}if(he(i)&&D(r)){var s=[].concat(r);return s[i]=n,s}return qe(i,n,r)})),Fe=M((function(e,t){switch(e){case 0:return function(){return t.call(this)};case 1:return function(e){return t.call(this,e)};case 2:return function(e,n){return t.call(this,e,n)};case 3:return function(e,n,r){return t.call(this,e,n,r)};case 4:return function(e,n,r,i){return t.call(this,e,n,r,i)};case 5:return function(e,n,r,i,o){return t.call(this,e,n,r,i,o)};case 6:return function(e,n,r,i,o,s){return t.call(this,e,n,r,i,o,s)};case 7:return function(e,n,r,i,o,s,a){return t.call(this,e,n,r,i,o,s,a)};case 8:return function(e,n,r,i,o,s,a,u){return t.call(this,e,n,r,i,o,s,a,u)};case 9:return function(e,n,r,i,o,s,a,u,c){return t.call(this,e,n,r,i,o,s,a,u,c)};case 10:return function(e,n,r,i,o,s,a,u,c,l){return t.call(this,e,n,r,i,o,s,a,u,c,l)};default:throw new Error("First argument to nAry must be a non-negative integer no greater than ten")}})),He=x((function(e){return Fe(2,e)}));function We(e){var t=Object.prototype.toString.call(e);return"[object Function]"===t||"[object AsyncFunction]"===t||"[object GeneratorFunction]"===t||"[object AsyncGeneratorFunction]"===t}var Ge=M((function(e,t){var n=j(e,t);return j(e,(function(){return ne(Ie,pe(n,arguments[0]),Array.prototype.slice.call(arguments,1))}))})),Be=x((function(e){return Ge(e.length,e)})),ze=M((function(e,t){return We(e)?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:Be(Oe)(e,t)})),Je=x((function(e){return j(e.length,e)})),Qe=Je((function(e){return e.apply(this,Array.prototype.slice.call(arguments,1))}));function Ye(e){return function t(n){for(var r,i,o,s=[],a=0,u=n.length;a<u;){if(Y(n[a]))for(o=0,i=(r=e?t(n[a]):n[a]).length;o<i;)s[s.length]=r[o],o+=1;else s[s.length]=n[a];a+=1}return s}}var Ke=function(e){var t=function(e){return{"@@transducer/init":W.init,"@@transducer/result":function(t){return e["@@transducer/result"](t)},"@@transducer/step":function(t,n){var r=e["@@transducer/step"](t,n);return r["@@transducer/reduced"]?{"@@transducer/value":r,"@@transducer/reduced":!0}:r}}}(e);return{"@@transducer/init":W.init,"@@transducer/result":function(e){return t["@@transducer/result"](e)},"@@transducer/step":function(e,n){return Y(n)?ne(t,e,n):ne(t,e,[n])}}},Xe=M(F(["fantasy-land/chain","chain"],M((function(e,t){return pe(e,Ke(t))})),(function(e,t){return"function"==typeof t?function(n){return e(t(n))(n)}:Ye(!1)(pe(e,t))}))),$e=U((function(e,t,n){if(e>t)throw new Error("min must not be greater than max in clamp(min, max, value)");return n<e?e:n>t?t:n}));function Ze(e){return new RegExp(e.source,(e.global?"g":"")+(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.sticky?"y":"")+(e.unicode?"u":""))}var et=x((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}));function tt(e,t,n,r){var i=function(i){for(var o=t.length,s=0;s<o;){if(e===t[s])return n[s];s+=1}for(var a in t[s+1]=e,n[s+1]=i,e)i[a]=r?tt(e[a],t,n,!0):e[a];return i};switch(et(e)){case"Object":return i({});case"Array":return i([]);case"Date":return new Date(e.valueOf());case"RegExp":return Ze(e);default:return e}}var nt=x((function(e){return null!=e&&"function"==typeof e.clone?e.clone():tt(e,[],[],!0)})),rt=x((function(e){return function(t,n){return e(t,n)?-1:e(n,t)?1:0}})),it=x((function(e){return!e})),ot=Be(it);function st(e,t){return function(){return t.call(this,e.apply(this,arguments))}}function at(e,t){return function(){var n=arguments.length;if(0===n)return t();var r=arguments[n-1];return D(r)||"function"!=typeof r[e]?t.apply(this,arguments):r[e].apply(r,Array.prototype.slice.call(arguments,0,n-1))}}var ut=U(at("slice",(function(e,t,n){return Array.prototype.slice.call(n,e,t)}))),ct=x(at("tail",ut(1,1/0)));function lt(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return C(arguments[0].length,_e(st,arguments[0],ct(arguments)))}var ft=x((function(e){return Q(e)?e.split("").reverse().join(""):Array.prototype.slice.call(e,0).reverse()}));function dt(){if(0===arguments.length)throw new Error("compose requires at least one argument");return lt.apply(this,ft(arguments))}function pt(){if(0===arguments.length)throw new Error("composeK requires at least one argument");var e=Array.prototype.slice.call(arguments),t=e.pop();return dt(dt.apply(this,pe(Xe,e)),t)}function ht(e,t){return function(){var n=this;return e.apply(n,arguments).then((function(e){return t.call(n,e)}))}}function vt(){if(0===arguments.length)throw new Error("pipeP requires at least one argument");return C(arguments[0].length,_e(ht,arguments[0],ct(arguments)))}var bt=ve(0);function mt(e){return e}var gt=x(mt),yt=M((function(e,t){if(t.length<=0)return gt;var n=bt(t),r=ct(t);return C(n.length,(function(){return ne((function(t,n){return e.call(this,n,t)}),n.apply(this,arguments),r)}))})),_t=M((function(e,t){return yt.apply(this,[e,ft(t)])}));function wt(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n}function Et(e,t,n){for(var r=0,i=n.length;r<i;){if(e(t,n[r]))return!0;r+=1}return!1}var Ot="function"==typeof Object.is?Object.is:function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t};function St(e,t,n,r){var i=wt(e);function o(e,t){return Tt(e,t,n.slice(),r.slice())}return!Et((function(e,t){return!Et(o,t,e)}),wt(t),i)}function Tt(e,t,n,r){if(Ot(e,t))return!0;var i=et(e);if(i!==et(t))return!1;if(null==e||null==t)return!1;if("function"==typeof e["fantasy-land/equals"]||"function"==typeof t["fantasy-land/equals"])return"function"==typeof e["fantasy-land/equals"]&&e["fantasy-land/equals"](t)&&"function"==typeof t["fantasy-land/equals"]&&t["fantasy-land/equals"](e);if("function"==typeof e.equals||"function"==typeof t.equals)return"function"==typeof e.equals&&e.equals(t)&&"function"==typeof t.equals&&t.equals(e);switch(i){case"Arguments":case"Array":case"Object":if("function"==typeof e.constructor&&"Promise"===function(e){var t=String(e).match(/^function (\w*)/);return null==t?"":t[1]}(e.constructor))return e===t;break;case"Boolean":case"Number":case"String":if(y(e)!==y(t)||!Ot(e.valueOf(),t.valueOf()))return!1;break;case"Date":if(!Ot(e.valueOf(),t.valueOf()))return!1;break;case"Error":return e.name===t.name&&e.message===t.message;case"RegExp":if(e.source!==t.source||e.global!==t.global||e.ignoreCase!==t.ignoreCase||e.multiline!==t.multiline||e.sticky!==t.sticky||e.unicode!==t.unicode)return!1}for(var o=n.length-1;o>=0;){if(n[o]===e)return r[o]===t;o-=1}switch(i){case"Map":return e.size===t.size&&St(e.entries(),t.entries(),n.concat([e]),r.concat([t]));case"Set":return e.size===t.size&&St(e.values(),t.values(),n.concat([e]),r.concat([t]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var s=de(e);if(s.length!==de(t).length)return!1;var a=n.concat([e]),u=r.concat([t]);for(o=s.length-1;o>=0;){var c=s[o];if(!oe(c,t)||!Tt(t[c],e[c],a,u))return!1;o-=1}return!0}var At=M((function(e,t){return Tt(e,t,[],[])}));function It(e,t,n){var r,i;if("function"==typeof e.indexOf)switch(y(t)){case"number":if(0===t){for(r=1/t;n<e.length;){if(0===(i=e[n])&&1/i===r)return n;n+=1}return-1}if(t!=t){for(;n<e.length;){if("number"==typeof(i=e[n])&&i!=i)return n;n+=1}return-1}return e.indexOf(t,n);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,n);case"object":if(null===t)return e.indexOf(t,n)}for(;n<e.length;){if(At(e[n],t))return n;n+=1}return-1}function kt(e,t){return It(t,e,0)>=0}function xt(e){return'"'+e.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0").replace(/"/g,'\\"')+'"'}var Mt=function(e){return(e<10?"0":"")+e},Nt="function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+Mt(e.getUTCMonth()+1)+"-"+Mt(e.getUTCDate())+"T"+Mt(e.getUTCHours())+":"+Mt(e.getUTCMinutes())+":"+Mt(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"};function Rt(e){return function(){return!e.apply(this,arguments)}}function Ct(e,t){for(var n=0,r=t.length,i=[];n<r;)e(t[n])&&(i[i.length]=t[n]),n+=1;return i}function Pt(e){return"[object Object]"===Object.prototype.toString.call(e)}var jt=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=W.result,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},e}(),Lt=M(F(["filter"],M((function(e,t){return new jt(e,t)})),(function(e,t){return Pt(t)?ne((function(n,r){return e(t[r])&&(n[r]=t[r]),n}),{},de(t)):Ct(e,t)}))),Ut=M((function(e,t){return Lt(Rt(e),t)}));function qt(e,t){var n=function(n){var r=t.concat([e]);return kt(n,r)?"<Circular>":qt(n,r)},r=function(e,t){return J((function(t){return xt(t)+": "+n(e[t])}),t.slice().sort())};switch(Object.prototype.toString.call(e)){case"[object Arguments]":return"(function() { return arguments; }("+J(n,e).join(", ")+"))";case"[object Array]":return"["+J(n,e).concat(r(e,Ut((function(e){return/^\d+$/.test(e)}),de(e)))).join(", ")+"]";case"[object Boolean]":return"object"===y(e)?"new Boolean("+n(e.valueOf())+")":e.toString();case"[object Date]":return"new Date("+(isNaN(e.valueOf())?n(NaN):xt(Nt(e)))+")";case"[object Null]":return"null";case"[object Number]":return"object"===y(e)?"new Number("+n(e.valueOf())+")":1/e==-1/0?"-0":e.toString(10);case"[object String]":return"object"===y(e)?"new String("+n(e.valueOf())+")":xt(e);case"[object Undefined]":return"undefined";default:if("function"==typeof e.toString){var i=e.toString();if("[object Object]"!==i)return i}return"{"+r(e,de(e)).join(", ")+"}"}}var Dt=x((function(e){return qt(e,[])})),Vt=M((function(e,t){if(D(e)){if(D(t))return e.concat(t);throw new TypeError(Dt(t)+" is not an array")}if(Q(e)){if(Q(t))return e+t;throw new TypeError(Dt(t)+" is not a string")}if(null!=e&&We(e["fantasy-land/concat"]))return e["fantasy-land/concat"](t);if(null!=e&&We(e.concat))return e.concat(t);throw new TypeError(Dt(e)+' does not have a method named "concat" or "fantasy-land/concat"')})),Ft=x((function(e){var t=_e(z,0,pe((function(e){return e[0].length}),e));return C(t,(function(){for(var t=0;t<e.length;){if(e[t][0].apply(this,arguments))return e[t][1].apply(this,arguments);t+=1}}))})),Ht=M((function(e,t){if(e>10)throw new Error("Constructor with greater than ten arguments");return 0===e?function(){return new t}:Je(Fe(e,(function(e,n,r,i,o,s,a,u,c,l){switch(arguments.length){case 1:return new t(e);case 2:return new t(e,n);case 3:return new t(e,n,r);case 4:return new t(e,n,r,i);case 5:return new t(e,n,r,i,o);case 6:return new t(e,n,r,i,o,s);case 7:return new t(e,n,r,i,o,s,a);case 8:return new t(e,n,r,i,o,s,a,u);case 9:return new t(e,n,r,i,o,s,a,u,c);case 10:return new t(e,n,r,i,o,s,a,u,c,l)}})))})),Wt=x((function(e){return Ht(e.length,e)})),Gt=M(kt),Bt=M((function(e,t){return j(_e(z,0,ye("length",t)),(function(){var n=arguments,r=this;return e.apply(r,J((function(e){return e.apply(r,n)}),t))}))})),zt=function(){function e(e,t,n,r){this.valueFn=e,this.valueAcc=t,this.keyFn=n,this.xf=r,this.inputs={}}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=function(e){var t;for(t in this.inputs)if(oe(t,this.inputs)&&(e=this.xf["@@transducer/step"](e,this.inputs[t]))["@@transducer/reduced"]){e=e["@@transducer/value"];break}return this.inputs=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var n=this.keyFn(t);return this.inputs[n]=this.inputs[n]||[n,this.valueAcc],this.inputs[n][1]=this.valueFn(this.inputs[n][1],t),e},e}(),Jt=P(4,[],F([],P(4,[],(function(e,t,n,r){return new zt(e,t,n,r)})),(function(e,t,n,r){return ne((function(r,i){var o=n(i);return r[o]=e(oe(o,r)?r[o]:tt(t,[],[],!1),i),r}),{},r)}))),Qt=Jt((function(e,t){return e+1}),0),Yt=N(-1),Kt=M((function(e,t){return null==t||t!=t?e:t})),Xt=U((function(e,t,n){var r=e(t),i=e(n);return r>i?-1:r<i?1:0})),$t=function(){function e(){this._nativeSet="function"==typeof Set?new Set:null,this._items={}}return e.prototype.add=function(e){return!Zt(e,!0,this)},e.prototype.has=function(e){return Zt(e,!1,this)},e}();function Zt(e,t,n){var r,i=y(e);switch(i){case"string":case"number":return 0===e&&1/e==-1/0?!!n._items["-0"]||(t&&(n._items["-0"]=!0),!1):null!==n._nativeSet?t?(r=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===r):n._nativeSet.has(e):i in n._items?e in n._items[i]||(t&&(n._items[i][e]=!0),!1):(t&&(n._items[i]={},n._items[i][e]=!0),!1);case"boolean":if(i in n._items){var o=e?1:0;return!!n._items[i][o]||(t&&(n._items[i][o]=!0),!1)}return t&&(n._items[i]=e?[!1,!0]:[!0,!1]),!1;case"function":return null!==n._nativeSet?t?(r=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===r):n._nativeSet.has(e):i in n._items?!!kt(e,n._items[i])||(t&&n._items[i].push(e),!1):(t&&(n._items[i]=[e]),!1);case"undefined":return!!n._items[i]||(t&&(n._items[i]=!0),!1);case"object":if(null===e)return!!n._items.null||(t&&(n._items.null=!0),!1);default:return(i=Object.prototype.toString.call(e))in n._items?!!kt(e,n._items[i])||(t&&n._items[i].push(e),!1):(t&&(n._items[i]=[e]),!1)}}var en=M((function(e,t){for(var n=[],r=0,i=e.length,o=t.length,s=new $t,a=0;a<o;a+=1)s.add(t[a]);for(;r<i;)s.add(e[r])&&(n[n.length]=e[r]),r+=1;return n})),tn=U((function(e,t,n){for(var r=[],i=0,o=t.length;i<o;)Et(e,t[i],n)||Et(e,t[i],r)||r.push(t[i]),i+=1;return r})),nn=M((function(e,t){var n={};for(var r in t)n[r]=t[r];return delete n[e],n})),rn=U((function(e,t,n){var r=Array.prototype.slice.call(n,0);return r.splice(e,t),r})),on=U((function(e,t,n){return q(e,Ee(t),n)})),sn=M((function e(t,n){switch(t.length){case 0:return n;case 1:return he(t[0])&&D(n)?rn(t[0],1,n):nn(t[0],n);default:var r=t[0],i=Array.prototype.slice.call(t,1);return null==n[r]?n:he(r)&&D(n)?on(r,e(i,n[r]),n):qe(r,e(i,n[r]),n)}})),an=M((function(e,t){return e/t})),un=function(){function e(e,t){this.xf=t,this.n=e}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=W.result,e.prototype["@@transducer/step"]=function(e,t){return this.n>0?(this.n-=1,e):this.xf["@@transducer/step"](e,t)},e}(),cn=M(F(["drop"],M((function(e,t){return new un(e,t)})),(function(e,t){return ut(Math.max(0,e),1/0,t)}))),ln=function(){function e(e,t){this.xf=t,this.n=e,this.i=0}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=W.result,e.prototype["@@transducer/step"]=function(e,t){this.i+=1;var n=0===this.n?e:this.xf["@@transducer/step"](e,t);return this.n>=0&&this.i>=this.n?H(n):n},e}(),fn=M(F(["take"],M((function(e,t){return new ln(e,t)})),(function(e,t){return ut(0,e<0?1/0:e,t)})));function dn(e,t){return fn(e<t.length?t.length-e:0,t)}var pn=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.full&&(e=this.xf["@@transducer/step"](e,this.acc[this.pos])),this.store(t),e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e}(),hn=M(F([],M((function(e,t){return new pn(e,t)})),dn));function vn(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return ut(0,n+1,t)}var bn=function(){function e(e,t){this.f=e,this.retained=[],this.xf=t}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=function(e){return this.retained=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.retain(e,t):this.flush(e,t)},e.prototype.flush=function(e,t){return e=ne(this.xf["@@transducer/step"],e,this.retained),this.retained=[],this.xf["@@transducer/step"](e,t)},e.prototype.retain=function(e,t){return this.retained.push(t),e},e}(),mn=M((function(e,t){return new bn(e,t)})),gn=M(F([],mn,vn)),yn=function(){function e(e,t){this.xf=t,this.pred=e,this.lastValue=void 0,this.seenFirstValue=!1}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=W.result,e.prototype["@@transducer/step"]=function(e,t){var n=!1;return this.seenFirstValue?this.pred(this.lastValue,t)&&(n=!0):this.seenFirstValue=!0,this.lastValue=t,n?e:this.xf["@@transducer/step"](e,t)},e}(),_n=M((function(e,t){return new yn(e,t)})),wn=ve(-1),En=M(F([],_n,(function(e,t){var n=[],r=1,i=t.length;if(0!==i)for(n[0]=t[0];r<i;)e(wn(n),t[r])||(n[n.length]=t[r]),r+=1;return n}))),On=x(F([],_n(At),En(At))),Sn=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=W.result,e.prototype["@@transducer/step"]=function(e,t){if(this.f){if(this.f(t))return e;this.f=null}return this.xf["@@transducer/step"](e,t)},e}(),Tn=M(F(["dropWhile"],M((function(e,t){return new Sn(e,t)})),(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return ut(n,1/0,t)}))),An=M((function(e,t){return e||t})),In=M((function(e,t){return We(e)?function(){return e.apply(this,arguments)||t.apply(this,arguments)}:Be(An)(e,t)})),kn=x((function(e){return null!=e&&"function"==typeof e["fantasy-land/empty"]?e["fantasy-land/empty"]():null!=e&&null!=e.constructor&&"function"==typeof e.constructor["fantasy-land/empty"]?e.constructor["fantasy-land/empty"]():null!=e&&"function"==typeof e.empty?e.empty():null!=e&&null!=e.constructor&&"function"==typeof e.constructor.empty?e.constructor.empty():D(e)?[]:Q(e)?"":Pt(e)?{}:ae(e)?function(){return arguments}():void 0})),xn=M((function(e,t){return cn(e>=0?t.length-e:0,t)})),Mn=M((function(e,t){return At(xn(e.length,t),e)})),Nn=U((function(e,t,n){return At(e(t),e(n))})),Rn=U((function(e,t,n){return At(t[e],n[e])})),Cn=M((function e(t,n){var r,i,o,s=n instanceof Array?[]:{};for(i in n)o=y(r=t[i]),s[i]="function"===o?r(n[i]):r&&"object"===o?e(r,n[i]):n[i];return s})),Pn=function(){function e(e,t){this.xf=t,this.f=e,this.found=!1}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,void 0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.found=!0,e=H(this.xf["@@transducer/step"](e,t))),e},e}(),jn=M(F(["find"],M((function(e,t){return new Pn(e,t)})),(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return t[n];n+=1}}))),Ln=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.found=!1}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,-1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.found=!0,e=H(this.xf["@@transducer/step"](e,this.idx))),e},e}(),Un=M(F([],M((function(e,t){return new Ln(e,t)})),(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return n;n+=1}return-1}))),qn=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.last))},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.last=t),e},e}(),Dn=M(F([],M((function(e,t){return new qn(e,t)})),(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return t[n];n-=1}}))),Vn=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.lastIdx=-1}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.lastIdx))},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.lastIdx=this.idx),e},e}(),Fn=M(F([],M((function(e,t){return new Vn(e,t)})),(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return n;n-=1}return-1}))),Hn=x(Ye(!0)),Wn=x((function(e){return j(e.length,(function(t,n){var r=Array.prototype.slice.call(arguments,0);return r[0]=n,r[1]=t,e.apply(this,r)}))})),Gn=M(at("forEach",(function(e,t){for(var n=t.length,r=0;r<n;)e(t[r]),r+=1;return t}))),Bn=M((function(e,t){for(var n=de(t),r=0;r<n.length;){var i=n[r];e(t[i],i,t),r+=1}return t})),zn=x((function(e){for(var t={},n=0;n<e.length;)t[e[n][0]]=e[n][1],n+=1;return t})),Jn=M(at("groupBy",Jt((function(e,t){return null==e&&(e=[]),e.push(t),e}),null))),Qn=M((function(e,t){for(var n=[],r=0,i=t.length;r<i;){for(var o=r+1;o<i&&e(t[o-1],t[o]);)o+=1;n.push(t.slice(r,o)),r=o}return n})),Yn=M((function(e,t){return e>t})),Kn=M((function(e,t){return e>=t})),Xn=M((function(e,t){if(0===e.length||De(t))return!1;for(var n=t,r=0;r<e.length;){if(De(n)||!oe(e[r],n))return!1;n=n[e[r]],r+=1}return!0})),$n=M((function(e,t){return Xn([e],t)})),Zn=M((function(e,t){return e in t})),er=M(Ot),tr=U((function(e,t,n){return j(Math.max(e.length,t.length,n.length),(function(){return e.apply(this,arguments)?t.apply(this,arguments):n.apply(this,arguments)}))})),nr=N(1),rr=M(kt),ir=Jt((function(e,t){return t}),null),or=M((function(e,t){return"function"!=typeof t.indexOf||D(t)?It(t,e,0):t.indexOf(e)})),sr=ut(0,-1),ar=U((function(e,t,n){return Ct((function(t){return Et(e,t,n)}),t)})),ur=U((function(e,t,n){e=e<n.length&&e>=0?e:n.length;var r=Array.prototype.slice.call(n,0);return r.splice(e,0,t),r})),cr=U((function(e,t,n){return e=e<n.length&&e>=0?e:n.length,[].concat(Array.prototype.slice.call(n,0,e),t,Array.prototype.slice.call(n,e))})),lr=M((function(e,t){for(var n,r,i=new $t,o=[],s=0;s<t.length;)n=e(r=t[s]),i.add(n)&&o.push(r),s+=1;return o})),fr=lr(gt),dr=M((function(e,t){var n,r;return e.length>t.length?(n=e,r=t):(n=t,r=e),fr(Ct(Wn(kt)(n),r))})),pr=M(at("intersperse",(function(e,t){for(var n=[],r=0,i=t.length;r<i;)r===i-1?n.push(t[r]):n.push(t[r],e),r+=1;return n})));var hr="function"==typeof Object.assign?Object.assign:function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),n=1,r=arguments.length;n<r;){var i=arguments[n];if(null!=i)for(var o in i)oe(o,i)&&(t[o]=i[o]);n+=1}return t},vr=M((function(e,t){var n={};return n[e]=t,n})),br={"@@transducer/init":Array,"@@transducer/step":function(e,t){return e.push(t),e},"@@transducer/result":mt},mr={"@@transducer/init":String,"@@transducer/step":function(e,t){return e+t},"@@transducer/result":mt},gr={"@@transducer/init":Object,"@@transducer/step":function(e,t){return hr(e,Y(t)?vr(t[0],t[1]):t)},"@@transducer/result":mt};var yr=U((function(e,t,n){return V(e)?ne(t(e),e["@@transducer/init"](),n):ne(t(function(e){if(V(e))return e;if(Y(e))return br;if("string"==typeof e)return mr;if("object"===y(e))return gr;throw new Error("Cannot create transformer for "+e)}(e)),tt(e,[],[],!1),n)})),_r=x((function(e){for(var t=de(e),n=t.length,r=0,i={};r<n;){var o=t[r],s=e[o],a=oe(s,i)?i[s]:i[s]=[];a[a.length]=o,r+=1}return i})),wr=x((function(e){for(var t=de(e),n=t.length,r=0,i={};r<n;){var o=t[r];i[e[o]]=o,r+=1}return i})),Er=M((function(e,t){return j(e+1,(function(){var n=arguments[e];if(null!=n&&We(n[t]))return n[t].apply(n,Array.prototype.slice.call(arguments,0,e));throw new TypeError(Dt(n)+' does not have a method named "'+t+'"')}))})),Or=M((function(e,t){return null!=t&&t.constructor===e||t instanceof e})),Sr=x((function(e){return null!=e&&At(e,kn(e))})),Tr=Er(1,"join"),Ar=x((function(e){return Bt((function(){return Array.prototype.slice.call(arguments,0)}),e)})),Ir=x((function(e){var t,n=[];for(t in e)n[n.length]=t;return n})),kr=M((function(e,t){if("function"!=typeof t.lastIndexOf||D(t)){for(var n=t.length-1;n>=0;){if(At(t[n],e))return n;n-=1}return-1}return t.lastIndexOf(e)}));function xr(e){return"[object Number]"===Object.prototype.toString.call(e)}var Mr=x((function(e){return null!=e&&xr(e.length)?e.length:NaN})),Nr=M((function(e,t){return function(n){return function(r){return pe((function(e){return t(e,r)}),n(e(r)))}}})),Rr=x((function(e){return Nr(ve(e),on(e))})),Cr=x((function(e){return Nr(me(e),Ve(e))})),Pr=x((function(e){return Nr(ge(e),qe(e))})),jr=M((function(e,t){return e<t})),Lr=M((function(e,t){return e<=t})),Ur=U((function(e,t,n){for(var r=0,i=n.length,o=[],s=[t];r<i;)s=e(s[0],n[r]),o[r]=s[1],r+=1;return[s[0],o]})),qr=U((function(e,t,n){for(var r=n.length-1,i=[],o=[t];r>=0;)o=e(o[0],n[r]),i[r]=o[1],r-=1;return[o[0],i]})),Dr=M((function(e,t){return ne((function(n,r){return n[r]=e(t[r],r,t),n}),{},de(t))})),Vr=M((function(e,t){return t.match(e)||[]})),Fr=M((function(e,t){return he(e)?!he(t)||t<1?NaN:(e%t+t)%t:NaN})),Hr=U((function(e,t,n){return e(n)>e(t)?n:t})),Wr=_e(N,0),Gr=x((function(e){return Wr(e)/e.length})),Br=x((function(e){var t=e.length;if(0===t)return NaN;var n=2-t%2,r=(t-n)/2;return Gr(Array.prototype.slice.call(e,0).sort((function(e,t){return e<t?-1:e>t?1:0})).slice(r,r+n))})),zr=M((function(e,t){var n={};return C(t.length,(function(){var r=e.apply(this,arguments);return oe(r,n)||(n[r]=t.apply(this,arguments)),n[r]}))})),Jr=M((function(e,t){return hr({},e,t)})),Qr=x((function(e){return hr.apply(null,[{}].concat(e))})),Yr=U((function(e,t,n){var r,i={};for(r in t)oe(r,t)&&(i[r]=oe(r,n)?e(r,t[r],n[r]):t[r]);for(r in n)oe(r,n)&&!oe(r,i)&&(i[r]=n[r]);return i})),Kr=U((function e(t,n,r){return Yr((function(n,r,i){return Pt(r)&&Pt(i)?e(t,r,i):t(n,r,i)}),n,r)})),Xr=M((function(e,t){return Kr((function(e,t,n){return t}),e,t)})),$r=M((function(e,t){return Kr((function(e,t,n){return n}),e,t)})),Zr=U((function(e,t,n){return Kr((function(t,n,r){return e(n,r)}),t,n)})),ei=M((function(e,t){return hr({},t,e)})),ti=M((function(e,t){return hr({},e,t)})),ni=U((function(e,t,n){return Yr((function(t,n,r){return e(n,r)}),t,n)})),ri=M((function(e,t){return t<e?t:e})),ii=U((function(e,t,n){return e(n)<e(t)?n:t})),oi=M((function(e,t){return e%t})),si=U((function(e,t,n){var r=n.length,i=n.slice(),o=e<0?r+e:e,s=t<0?r+t:t,a=i.splice(o,1);return o<0||o>=n.length||s<0||s>=n.length?n:[].concat(i.slice(0,s)).concat(a).concat(i.slice(s,n.length))})),ai=M((function(e,t){return e*t})),ui=x((function(e){return-e})),ci=M((function(e,t){return B(Rt(e),t)})),li=x((function(e){return j(e<0?1:e+1,(function(){return ve(e,arguments)}))})),fi=U((function(e,t,n){return e(t(n))}));function di(e){return[e]}var pi=x(di),hi=M((function(e,t){for(var n={},r={},i=0,o=e.length;i<o;)r[e[i]]=1,i+=1;for(var s in t)r.hasOwnProperty(s)||(n[s]=t[s]);return n})),vi=x((function(e){var t,n=!1;return C(e.length,(function(){return n?t:(n=!0,t=e.apply(this,arguments))}))}));function bi(e,t){if(null==t||!We(t.then))throw new TypeError("`"+e+"` expected a Promise, received "+qt(t,[]))}var mi=M((function(e,t){return bi("otherwise",t),t.then(null,e)})),gi=function e(t){return{value:t,map:function(n){return e(n(t))}}},yi=U((function(e,t,n){return e((function(e){return gi(t(e))}))(n).value})),_i=M((function(e,t){return[e,t]}));function wi(e){return M((function(t,n){return C(Math.max(0,t.length-n.length),(function(){return t.apply(this,e(n,arguments))}))}))}var Ei=wi(R),Oi=wi(Wn(R)),Si=Ar([Lt,Ut]),Ti=U((function(e,t,n){return At(me(e,n),t)})),Ai=U((function(e,t,n){return Kt(e,me(t,n))})),Ii=U((function(e,t,n){return e(me(t,n))})),ki=M((function(e,t){for(var n={},r=0;r<e.length;)e[r]in t&&(n[e[r]]=t[e[r]]),r+=1;return n})),xi=M((function(e,t){for(var n={},r=0,i=e.length;r<i;){var o=e[r];n[o]=t[o],r+=1}return n})),Mi=M((function(e,t){var n={};for(var r in t)e(t[r],r,t)&&(n[r]=t[r]);return n}));var Ni=M((function(e,t){return R([e],t)})),Ri=_e(ai,1),Ci=M((function(e,t){return j(t.length,(function(){for(var n=[],r=0;r<t.length;)n.push(t[r].call(this,arguments[r])),r+=1;return e.apply(this,n.concat(Array.prototype.slice.call(arguments,t.length)))}))})),Pi=Ci(J,[xi,gt]),ji=U((function(e,t,n){return At(t,n[e])})),Li=U((function(e,t,n){return Or(e,n[t])})),Ui=U((function(e,t,n){return Ai(e,[t],n)})),qi=U((function(e,t,n){return e(n[t])})),Di=M((function(e,t){return e.map((function(e){return me([e],t)}))})),Vi=M((function(e,t){if(!xr(e)||!xr(t))throw new TypeError("Both arguments to range must be numbers");for(var n=[],r=e;r<t;)n.push(r),r+=1;return n})),Fi=U((function(e,t,n){for(var r=n.length-1;r>=0;)t=e(n[r],t),r-=1;return t})),Hi=P(4,[],(function(e,t,n,r){return ne((function(n,r){return e(n,r)?t(n,r):H(n)}),n,r)})),Wi=x(H),Gi=M((function(e,t){var n,r=Number(t),i=0;if(r<0||isNaN(r))throw new RangeError("n must be a non-negative number");for(n=new Array(r);i<r;)n[i]=e(i),i+=1;return n})),Bi=M((function(e,t){return Gi(Ee(e),t)})),zi=U((function(e,t,n){return n.replace(e,t)})),Ji=U((function(e,t,n){for(var r=0,i=n.length,o=[t];r<i;)t=e(t,n[r]),o[r+1]=t,r+=1;return o})),Qi=M((function(e,t){return"function"==typeof t.sequence?t.sequence(e):Fi((function(e,t){return Ie(pe(Ni,e),t)}),e([]),t)})),Yi=U((function(e,t,n){return yi(e,Ee(t),n)})),Ki=M((function(e,t){return Array.prototype.slice.call(t,0).sort(e)})),Xi=M((function(e,t){return Array.prototype.slice.call(t,0).sort((function(t,n){var r=e(t),i=e(n);return r<i?-1:r>i?1:0}))})),$i=M((function(e,t){return Array.prototype.slice.call(t,0).sort((function(t,n){for(var r=0,i=0;0===r&&i<e.length;)r=e[i](t,n),i+=1;return r}))})),Zi=Er(1,"split"),eo=M((function(e,t){return[ut(0,e,t),ut(e,Mr(t),t)]})),to=M((function(e,t){if(e<=0)throw new Error("First argument to splitEvery must be a positive integer");for(var n=[],r=0;r<t.length;)n.push(ut(r,r+=e,t));return n})),no=M((function(e,t){for(var n=0,r=t.length,i=[];n<r&&!e(t[n]);)i.push(t[n]),n+=1;return[i,Array.prototype.slice.call(t,n)]})),ro=M((function(e,t){return At(fn(e.length,t),e)})),io=M((function(e,t){return Number(e)-Number(t)})),oo=M((function(e,t){return Vt(en(e,t),en(t,e))})),so=U((function(e,t,n){return Vt(tn(e,t,n),tn(e,n,t))})),ao=M((function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return ut(n+1,1/0,t)})),uo=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=W.result,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):H(e)},e}(),co=M(F(["takeWhile"],M((function(e,t){return new uo(e,t)})),(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return ut(0,n,t)}))),lo=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=W.init,e.prototype["@@transducer/result"]=W.result,e.prototype["@@transducer/step"]=function(e,t){return this.f(t),this.xf["@@transducer/step"](e,t)},e}(),fo=M(F([],M((function(e,t){return new lo(e,t)})),(function(e,t){return e(t),t})));var po=M((function(e,t){if(n=e,"[object RegExp]"!==Object.prototype.toString.call(n))throw new TypeError("‘test’ requires a value of type RegExp as its first argument; received "+Dt(e));var n;return Ze(e).test(t)})),ho=M((function(e,t){return bi("andThen",t),t.then(e)})),vo=Er(0,"toLowerCase"),bo=x((function(e){var t=[];for(var n in e)oe(n,e)&&(t[t.length]=[n,e[n]]);return t})),mo=x((function(e){var t=[];for(var n in e)t[t.length]=[n,e[n]];return t})),go=Er(0,"toUpperCase"),yo=j(4,(function(e,t,n,r){return ne(e("function"==typeof t?X(t):t),n,r)})),_o=x((function(e){for(var t=0,n=[];t<e.length;){for(var r=e[t],i=0;i<r.length;)void 0===n[i]&&(n[i]=[]),n[i].push(r[i]),i+=1;t+=1}return n})),wo=U((function(e,t,n){return"function"==typeof n["fantasy-land/traverse"]?n["fantasy-land/traverse"](t,e):Qi(e,pe(t,n))})),Eo="\t\n\v\f\r                　\u2028\u2029\ufeff",Oo=x("function"==typeof String.prototype.trim&&!Eo.trim()&&"​".trim()?function(e){return e.trim()}:function(e){var t=new RegExp("^["+Eo+"]["+Eo+"]*"),n=new RegExp("["+Eo+"]["+Eo+"]*$");return e.replace(t,"").replace(n,"")}),So=M((function(e,t){return C(e.length,(function(){try{return e.apply(this,arguments)}catch(e){return t.apply(this,R([e],arguments))}}))})),To=x((function(e){return function(){return e(Array.prototype.slice.call(arguments,0))}})),Ao=x((function(e){return Fe(1,e)})),Io=M((function(e,t){return j(e,(function(){for(var n,r=1,i=t,o=0;r<=e&&"function"==typeof i;)n=r===e?arguments.length:o+i.length,i=i.apply(this,Array.prototype.slice.call(arguments,o,n)),r+=1,o=n;return i}))})),ko=M((function(e,t){for(var n=e(t),r=[];n&&n.length;)r[r.length]=n[0],n=e(n[1]);return r})),xo=M(dt(fr,R)),Mo=M((function(e,t){for(var n,r=0,i=t.length,o=[];r<i;)Et(e,n=t[r],o)||(o[o.length]=n),r+=1;return o})),No=U((function(e,t,n){return Mo(e,R(t,n))})),Ro=U((function(e,t,n){return e(n)?n:t(n)})),Co=Xe(mt),Po=U((function(e,t,n){for(var r=n;!e(r);)r=t(r);return r})),jo=x((function(e){var t,n=[];for(t in e)n[n.length]=e[t];return n})),Lo=function(e){return{value:e,"fantasy-land/map":function(){return this}}},Uo=M((function(e,t){return e(Lo)(t).value})),qo=U((function(e,t,n){return e(n)?t(n):n})),Do=M((function(e,t){for(var n in e)if(oe(n,e)&&!e[n](t[n]))return!1;return!0})),Vo=M((function(e,t){return Do(pe(At,e),t)})),Fo=M((function(e,t){return Ut(Wn(kt)(e),t)})),Ho=M((function(e,t){return Boolean(!e^!t)})),Wo=M((function(e,t){for(var n,r=0,i=e.length,o=t.length,s=[];r<i;){for(n=0;n<o;)s[s.length]=[e[r],t[n]],n+=1;r+=1}return s})),Go=M((function(e,t){for(var n=[],r=0,i=Math.min(e.length,t.length);r<i;)n[r]=[e[r],t[r]],r+=1;return n})),Bo=M((function(e,t){for(var n=0,r=Math.min(e.length,t.length),i={};n<r;)i[e[n]]=t[n],n+=1;return i})),zo=U((function(e,t,n){for(var r=[],i=0,o=Math.min(t.length,n.length);i<o;)r[i]=e(t[i],n[i]),i+=1;return r})),Jo=x((function(e){return j(e.length,(function(){var t=arguments;return function(){return e.apply(this,t)}}))})),Qo=Object.freeze({__proto__:null,F:function(){return!1},T:function(){return!0},__:I,add:N,addIndex:L,adjust:q,all:B,allPass:we,always:Ee,and:Oe,andThen:ho,any:Te,anyPass:Ae,ap:Ie,aperture:Me,append:Ne,apply:Re,applySpec:je,applyTo:Le,ascend:Ue,assoc:qe,assocPath:Ve,binary:He,bind:$,both:ze,call:Qe,chain:Xe,clamp:$e,clone:nt,comparator:rt,complement:ot,compose:dt,composeK:pt,composeP:function(){if(0===arguments.length)throw new Error("composeP requires at least one argument");return vt.apply(this,ft(arguments))},composeWith:_t,concat:Vt,cond:Ft,construct:Wt,constructN:Ht,contains:Gt,converge:Bt,countBy:Qt,curry:Je,curryN:j,dec:Yt,defaultTo:Kt,descend:Xt,difference:en,differenceWith:tn,dissoc:nn,dissocPath:sn,divide:an,drop:cn,dropLast:hn,dropLastWhile:gn,dropRepeats:On,dropRepeatsWith:En,dropWhile:Tn,either:In,empty:kn,endsWith:Mn,eqBy:Nn,eqProps:Rn,equals:At,evolve:Cn,filter:Lt,find:jn,findIndex:Un,findLast:Dn,findLastIndex:Fn,flatten:Hn,flip:Wn,forEach:Gn,forEachObjIndexed:Bn,fromPairs:zn,groupBy:Jn,groupWith:Qn,gt:Yn,gte:Kn,has:$n,hasIn:Zn,hasPath:Xn,head:bt,identical:er,identity:gt,ifElse:tr,inc:nr,includes:rr,indexBy:ir,indexOf:or,init:sr,innerJoin:ar,insert:ur,insertAll:cr,intersection:dr,intersperse:pr,into:yr,invert:_r,invertObj:wr,invoker:Er,is:Or,isEmpty:Sr,isNil:De,join:Tr,juxt:Ar,keys:de,keysIn:Ir,last:wn,lastIndexOf:kr,length:Mr,lens:Nr,lensIndex:Rr,lensPath:Cr,lensProp:Pr,lift:Be,liftN:Ge,lt:jr,lte:Lr,map:pe,mapAccum:Ur,mapAccumRight:qr,mapObjIndexed:Dr,match:Vr,mathMod:Fr,max:z,maxBy:Hr,mean:Gr,median:Br,memoizeWith:zr,merge:Jr,mergeAll:Qr,mergeDeepLeft:Xr,mergeDeepRight:$r,mergeDeepWith:Zr,mergeDeepWithKey:Kr,mergeLeft:ei,mergeRight:ti,mergeWith:ni,mergeWithKey:Yr,min:ri,minBy:ii,modulo:oi,move:si,multiply:ai,nAry:Fe,negate:ui,none:ci,not:it,nth:ve,nthArg:li,o:fi,objOf:vr,of:pi,omit:hi,once:vi,or:An,otherwise:mi,over:yi,pair:_i,partial:Ei,partialRight:Oi,partition:Si,path:me,pathEq:Ti,pathOr:Ai,pathSatisfies:Ii,paths:be,pick:ki,pickAll:xi,pickBy:Mi,pipe:lt,pipeK:function(){if(0===arguments.length)throw new Error("pipeK requires at least one argument");return pt.apply(this,ft(arguments))},pipeP:vt,pipeWith:yt,pluck:ye,prepend:Ni,product:Ri,project:Pi,prop:ge,propEq:ji,propIs:Li,propOr:Ui,propSatisfies:qi,props:Di,range:Vi,reduce:_e,reduceBy:Jt,reduceRight:Fi,reduceWhile:Hi,reduced:Wi,reject:Ut,remove:rn,repeat:Bi,replace:zi,reverse:ft,scan:Ji,sequence:Qi,set:Yi,slice:ut,sort:Ki,sortBy:Xi,sortWith:$i,split:Zi,splitAt:eo,splitEvery:to,splitWhen:no,startsWith:ro,subtract:io,sum:Wr,symmetricDifference:oo,symmetricDifferenceWith:so,tail:ct,take:fn,takeLast:xn,takeLastWhile:ao,takeWhile:co,tap:fo,test:po,thunkify:Jo,times:Gi,toLower:vo,toPairs:bo,toPairsIn:mo,toString:Dt,toUpper:go,transduce:yo,transpose:_o,traverse:wo,trim:Oo,tryCatch:So,type:et,unapply:To,unary:Ao,uncurryN:Io,unfold:ko,union:xo,unionWith:No,uniq:fr,uniqBy:lr,uniqWith:Mo,unless:Ro,unnest:Co,until:Po,update:on,useWith:Ci,values:Ce,valuesIn:jo,view:Uo,when:qo,where:Do,whereEq:Vo,without:Fo,xor:Ho,xprod:Wo,zip:Go,zipObj:Bo,zipWith:zo}),Yo={enabled:!0},Ko=function(e,t,n,r,i){t||(t=6e4),void 0===n&&(n=2),void 0===r&&(r=.5),i||(i=Math.random);var o=null,s=function(s){if(!Yo.enabled)return 6048e5;var a=e*Math.pow(n,s);o&&(a=Math.max(a,o),o=null);var u=i(),c=Math.floor(u*r*a),l=Math.floor(10*u)%2==0?a-c:a+c;return a=Math.min(l,t),Yo.maxDelay&&a>Yo.maxDelay?Yo.maxDelay:Yo.minDelay&&a<=Yo.minDelay?Yo.minDelay:a};return s.setNextDelayMinimum=function(e){o=e},s.maximizeNextDelay=function(){return s.setNextDelayMinimum(t)},s},Xo=function e(t){var n=t.calculateAttemptDelay,r=t.attempt,i=t.onGiveUp,o=t.retryLimit,s=t.retryCount,a=function(t){return r({context:{retryLimit:o,retryCount:s,delay:t},repeat:function(t){return 0===o||s<o?e({calculateAttemptDelay:n,attempt:r,onGiveUp:i,retryLimit:o,retryCount:s+1}):i(t)}})};if(0===s)a(0);else{var u=n(s);setTimeout((function(){return a(u)}),u)}},$o=function(e){var t=e.calculateAttemptDelay,n=e.attempt,r=e.onGiveUp,i=e.retryLimit;if(0!==i&&!r)throw new Error("Must define onGiveUp if retryLimit is not 0");return Xo({calculateAttemptDelay:t,attempt:n,onGiveUp:r,retryLimit:i,retryCount:0})},Zo=function(){return sm.conf.integrities_enabled},es=function(e){if(Zo()||e.force){var t=e.name?ji("name",e.name):ji("versioned_name",e.versionedName),n=jn(t,sm.conf.integrities);if(n)return ge("integrity",n);sm.logger.error("Could not find expected integrity for module",e)}},ts=function(e){var t=e.beforeLoad,n=e.onAttempt,r=e.onLoad,i=e.onError,o=e.onGiveUp,s=e.integrity,a=e.fileUrl,u=e.retryLimit,c=void 0===u?5:u,l=e.backoffDelay;$o({calculateAttemptDelay:Ko(void 0===l?1e3:l),attempt:function(e){var o=e.repeat;"function"==typeof n&&n();var u=document.createElement("script");return u.type="text/javascript",u.onload=function(){"function"==typeof r&&r()},u.onerror=function(){"function"==typeof i&&i(),document.head.removeChild(u),o()},u.src=a,s&&(u.setAttribute("integrity",s),u.setAttribute("crossorigin","*")),"function"==typeof t&&t(u),document.head.appendChild(u),u},onGiveUp:function(){"function"==typeof o&&o()},retryLimit:c})},ns=function(e){var t=e.integrity,n=e.fileUrl,r=e.onAttempt,i=e.onLoad,o=e.onError,s=e.onGiveUp;return $o({calculateAttemptDelay:Ko(1e3),attempt:function(e){var s=e.repeat;"function"==typeof r&&r();var a=document.createElement("link");return a.type="text/css",a.rel="stylesheet",a.onload=function(){"function"==typeof i&&i()},a.onerror=function(){"function"==typeof o&&o(),document.head.removeChild(a),s()},a.href=n,t&&(a.setAttribute("integrity",t),a.setAttribute("crossorigin","*")),document.head.appendChild(a),a},onGiveUp:function(){"function"==typeof s&&s()},retryLimit:5})};function rs(e){return rs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},rs(e)}function is(e){return function(e){if(Array.isArray(e))return ss(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||os(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function os(e,t){if(e){if("string"==typeof e)return ss(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ss(e,t):void 0}}function ss(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function as(){var e=this;this.list=[],this.add=function(t){10===e.list.length&&(e.list=e.list.slice(1)),e.list.push(t)}}var us=function(e,t){var n={};for(var r in e)n[r]=e[r];for(var i in t)n[i]=t[i];return n},cs=["string","number","boolean","null","undefined"];var ls={HttpTransport:function(e){var t=e.url,n=e.method,r=e.headers,i=e.encode;if(!t)throw new Error("url must be specificed when using HttpTransport");n||(n="POST"),r||(r={}),i||(i=function(e){return JSON.stringify(e)}),this.process=window.fetch?function(e){var o=e.payload;return window.fetch(t,{method:n,headers:r,keepalive:!0,body:i(o)})}:function(e){var o=e.payload;return new Promise((function(e,s){var a=new XMLHttpRequest;a.open(n,t),Object.keys(r).forEach((function(e){a.setRequestHeader(e,r[e])})),a.onload=function(){a.status<200||status>=300?s():e()},a.onerror=function(){return s()},a.send(i(o))}))}}},fs=function(e){return function(t){var n=t.namespace;return{attempted:function(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).tags,r=void 0===t?[]:t,i=Date.now(),o=!1,s=function(t){var i=t.action,o=t.reason,s=["action:".concat(i)];return o&&s.push("reason:".concat(o)),e.increment("sm.lib.".concat(n),Vt(r,s))},a=function(e){return s({action:"failed",reason:e})},u=function(t){var s=t.action;o=!0;var a=Date.now()-i;e.histogram("sm.timing.lib.".concat(n),a,Vt(r,["client:browser","action:".concat(s)]))};return s({action:"attempted"}),{succeeded:function(){s({action:"succeeded"}),u({action:"succeeded"})},failed:function(e){a(e),u({action:"failed"})},timedOut:function(){a("timed_out"),u({action:"failed"})},failedUnknown:function(){a("unknown"),u({action:"failed"})},isFinished:function(){return o}}}}}},ds=["timing","increment","decrement","gauge","histogram","set"],ps=function(){function e(){var t=this;i(this,e),this.withTags=this.withTags.bind(this),this.instrument=function(){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}},ds.forEach((function(e){t[e]=function(){}}))}return s(e,[{key:"recordMessageHubConnectionEstablished",value:function(){}},{key:"recordBaseDomCaching",value:function(){}},{key:"clientHandlerError",value:function(){}},{key:"statApiUsage",value:function(e){e.resource;return function(e){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}}}},{key:"statScreenShareUsage",value:function(e,t){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}}},{key:"withTags",value:function(){return this}}]),e}(),hs=function(){function e(t,n){var r=this;i(this,e),this.statApiUsage=this.statApiUsage.bind(this),this.statScreenShareUsage=this.statScreenShareUsage.bind(this),this.withTags=this.withTags.bind(this),this.statsClient=t,this.latencyMeasurer=n,this.instrument=fs(this.statsClient),ds.forEach((function(e){r.statsClient[e]&&(r[e]=r.statsClient[e].bind(r.statsClient))}))}return s(e,[{key:"recordBaseDomCaching",value:function(e){var t=e.result;this.statsClient.increment("sm.app.visitor.api.cached_base_dom",["action:save","result:".concat(t)])}},{key:"clientHandlerError",value:function(e){this.statsClient.increment("sm.app.visitor.api.client_handler",["action:failed","executor:".concat(e)])}},{key:"statApiUsage",value:function(e){var t=this,n=e.protocol,r=e.resource;return function(e){return fs(t.statsClient.withTags(["protocol:".concat(n),"method:".concat(e)]))({namespace:r})}}},{key:"statScreenShareUsage",value:function(e){var t=e.stage,n=e.resource;return fs(this.statsClient.withTags(["stage:".concat(t)]))({namespace:n})}},{key:"withTags",value:function(t){return new e(this.statsClient.withTags(t))}}],[{key:"createDummy",value:function(){return new ps}}]),e}(),vs={},bs={},ms=function(e,t){return ms=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},ms(e,t)};function gs(e,t){function n(){this.constructor=e}ms(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var ys=function(){return ys=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},ys.apply(this,arguments)};function _s(e){return"function"==typeof e}var ws=!1,Es={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){e&&(new Error).stack;ws=e},get useDeprecatedSynchronousErrorHandling(){return ws}};function Os(e){setTimeout((function(){throw e}),0)}var Ss={closed:!0,next:function(e){},error:function(e){if(Es.useDeprecatedSynchronousErrorHandling)throw e;Os(e)},complete:function(){}},Ts=function(){return Array.isArray||function(e){return e&&"number"==typeof e.length}}();function As(e){return null!==e&&"object"===y(e)}var Is=function(){function e(e){return Error.call(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e,this}return e.prototype=Object.create(Error.prototype),e}(),ks=function(){function e(e){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,e&&(this._ctorUnsubscribe=!0,this._unsubscribe=e)}return e.prototype.unsubscribe=function(){var t;if(!this.closed){var n=this,r=n._parentOrParents,i=n._ctorUnsubscribe,o=n._unsubscribe,s=n._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,r instanceof e)r.remove(this);else if(null!==r)for(var a=0;a<r.length;++a){r[a].remove(this)}if(_s(o)){i&&(this._unsubscribe=void 0);try{o.call(this)}catch(e){t=e instanceof Is?xs(e.errors):[e]}}if(Ts(s)){a=-1;for(var u=s.length;++a<u;){var c=s[a];if(As(c))try{c.unsubscribe()}catch(e){t=t||[],e instanceof Is?t=t.concat(xs(e.errors)):t.push(e)}}}if(t)throw new Is(t)}},e.prototype.add=function(t){var n=t;if(!t)return e.EMPTY;switch(y(t)){case"function":n=new e(t);case"object":if(n===this||n.closed||"function"!=typeof n.unsubscribe)return n;if(this.closed)return n.unsubscribe(),n;if(!(n instanceof e)){var r=n;(n=new e)._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+t+" added to Subscription.")}var i=n._parentOrParents;if(null===i)n._parentOrParents=this;else if(i instanceof e){if(i===this)return n;n._parentOrParents=[i,this]}else{if(-1!==i.indexOf(this))return n;i.push(this)}var o=this._subscriptions;return null===o?this._subscriptions=[n]:o.push(n),n},e.prototype.remove=function(e){var t=this._subscriptions;if(t){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}},e.EMPTY=function(e){return e.closed=!0,e}(new e),e}();function xs(e){return e.reduce((function(e,t){return e.concat(t instanceof Is?t.errors:t)}),[])}var Ms=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),Ns=function(e){function t(n,r,i){var o=e.call(this)||this;switch(o.syncErrorValue=null,o.syncErrorThrown=!1,o.syncErrorThrowable=!1,o.isStopped=!1,arguments.length){case 0:o.destination=Ss;break;case 1:if(!n){o.destination=Ss;break}if("object"===y(n)){n instanceof t?(o.syncErrorThrowable=n.syncErrorThrowable,o.destination=n,n.add(o)):(o.syncErrorThrowable=!0,o.destination=new Rs(o,n));break}default:o.syncErrorThrowable=!0,o.destination=new Rs(o,n,r,i)}return o}return gs(t,e),t.prototype[Ms]=function(){return this},t.create=function(e,n,r){var i=new t(e,n,r);return i.syncErrorThrowable=!1,i},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this))},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},t.prototype._unsubscribeAndRecycle=function(){var e=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=e,this},t}(ks),Rs=function(e){function t(t,n,r,i){var o,s=e.call(this)||this;s._parentSubscriber=t;var a=s;return _s(n)?o=n:n&&(o=n.next,r=n.error,i=n.complete,n!==Ss&&(_s((a=Object.create(n)).unsubscribe)&&s.add(a.unsubscribe.bind(a)),a.unsubscribe=s.unsubscribe.bind(s))),s._context=a,s._next=o,s._error=r,s._complete=i,s}return gs(t,e),t.prototype.next=function(e){if(!this.isStopped&&this._next){var t=this._parentSubscriber;Es.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e)}},t.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,n=Es.useDeprecatedSynchronousErrorHandling;if(this._error)n&&t.syncErrorThrowable?(this.__tryOrSetError(t,this._error,e),this.unsubscribe()):(this.__tryOrUnsub(this._error,e),this.unsubscribe());else if(t.syncErrorThrowable)n?(t.syncErrorValue=e,t.syncErrorThrown=!0):Os(e),this.unsubscribe();else{if(this.unsubscribe(),n)throw e;Os(e)}}},t.prototype.complete=function(){var e=this;if(!this.isStopped){var t=this._parentSubscriber;if(this._complete){var n=function(){return e._complete.call(e._context)};Es.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?(this.__tryOrSetError(t,n),this.unsubscribe()):(this.__tryOrUnsub(n),this.unsubscribe())}else this.unsubscribe()}},t.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),Es.useDeprecatedSynchronousErrorHandling)throw e;Os(e)}},t.prototype.__tryOrSetError=function(e,t,n){if(!Es.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{t.call(this._context,n)}catch(t){return Es.useDeprecatedSynchronousErrorHandling?(e.syncErrorValue=t,e.syncErrorThrown=!0,!0):(Os(t),!0)}return!1},t.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},t}(Ns);function Cs(e){for(;e;){var t=e,n=t.closed,r=t.destination,i=t.isStopped;if(n||i)return!1;e=r&&r instanceof Ns?r:null}return!0}function Ps(e,t,n){if(e){if(e instanceof Ns)return e;if(e[Ms])return e[Ms]()}return e||t||n?new Ns(e,t,n):new Ns(Ss)}var js=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function Ls(e){return e}function Us(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return qs(e)}function qs(e){return 0===e.length?Ls:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var Ds=function(){function e(e){this._isScalar=!1,e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r=this.operator,i=Ps(e,t,n);if(r?i.add(r.call(i,this.source)):i.add(this.source||Es.useDeprecatedSynchronousErrorHandling&&!i.syncErrorThrowable?this._subscribe(i):this._trySubscribe(i)),Es.useDeprecatedSynchronousErrorHandling&&i.syncErrorThrowable&&(i.syncErrorThrowable=!1,i.syncErrorThrown))throw i.syncErrorValue;return i},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){Es.useDeprecatedSynchronousErrorHandling&&(e.syncErrorThrown=!0,e.syncErrorValue=t),Cs(e)?e.error(t):console.warn(t)}},e.prototype.forEach=function(e,t){var n=this;return new(t=Vs(t))((function(t,r){var i;i=n.subscribe((function(t){try{e(t)}catch(e){r(e),i&&i.unsubscribe()}}),r,t)}))},e.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},e.prototype[js]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 0===e.length?this:qs(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=Vs(e))((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function Vs(e){if(e||(e=Es.Promise||Promise),!e)throw new Error("no Promise impl found");return e}var Fs=function(){function e(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return e.prototype=Object.create(Error.prototype),e}(),Hs=function(e){function t(t,n){var r=e.call(this)||this;return r.subject=t,r.subscriber=n,r.closed=!1,r}return gs(t,e),t.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var e=this.subject,t=e.observers;if(this.subject=null,t&&0!==t.length&&!e.isStopped&&!e.closed){var n=t.indexOf(this.subscriber);-1!==n&&t.splice(n,1)}}},t}(ks),Ws=function(e){function t(t){var n=e.call(this,t)||this;return n.destination=t,n}return gs(t,e),t}(Ns),Gs=function(e){function t(){var t=e.call(this)||this;return t.observers=[],t.closed=!1,t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return gs(t,e),t.prototype[Ms]=function(){return new Ws(this)},t.prototype.lift=function(e){var t=new Bs(this,this);return t.operator=e,t},t.prototype.next=function(e){if(this.closed)throw new Fs;if(!this.isStopped)for(var t=this.observers,n=t.length,r=t.slice(),i=0;i<n;i++)r[i].next(e)},t.prototype.error=function(e){if(this.closed)throw new Fs;this.hasError=!0,this.thrownError=e,this.isStopped=!0;for(var t=this.observers,n=t.length,r=t.slice(),i=0;i<n;i++)r[i].error(e);this.observers.length=0},t.prototype.complete=function(){if(this.closed)throw new Fs;this.isStopped=!0;for(var e=this.observers,t=e.length,n=e.slice(),r=0;r<t;r++)n[r].complete();this.observers.length=0},t.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},t.prototype._trySubscribe=function(t){if(this.closed)throw new Fs;return e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){if(this.closed)throw new Fs;return this.hasError?(e.error(this.thrownError),ks.EMPTY):this.isStopped?(e.complete(),ks.EMPTY):(this.observers.push(e),new Hs(this,e))},t.prototype.asObservable=function(){var e=new Ds;return e.source=this,e},t.create=function(e,t){return new Bs(e,t)},t}(Ds),Bs=function(e){function t(t,n){var r=e.call(this)||this;return r.destination=t,r.source=n,r}return gs(t,e),t.prototype.next=function(e){var t=this.destination;t&&t.next&&t.next(e)},t.prototype.error=function(e){var t=this.destination;t&&t.error&&this.destination.error(e)},t.prototype.complete=function(){var e=this.destination;e&&e.complete&&this.destination.complete()},t.prototype._subscribe=function(e){return this.source?this.source.subscribe(e):ks.EMPTY},t}(Gs);function zs(){return function(e){return e.lift(new Js(e))}}var Js=function(){function e(e){this.connectable=e}return e.prototype.call=function(e,t){var n=this.connectable;n._refCount++;var r=new Qs(e,n),i=t.subscribe(r);return r.closed||(r.connection=n.connect()),i},e}(),Qs=function(e){function t(t,n){var r=e.call(this,t)||this;return r.connectable=n,r}return gs(t,e),t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._refCount;if(t<=0)this.connection=null;else if(e._refCount=t-1,t>1)this.connection=null;else{var n=this.connection,r=e._connection;this.connection=null,!r||n&&r!==n||r.unsubscribe()}}else this.connection=null},t}(Ns),Ys=function(e){function t(t,n){var r=e.call(this)||this;return r.source=t,r.subjectFactory=n,r._refCount=0,r._isComplete=!1,r}return gs(t,e),t.prototype._subscribe=function(e){return this.getSubject().subscribe(e)},t.prototype.getSubject=function(){var e=this._subject;return e&&!e.isStopped||(this._subject=this.subjectFactory()),this._subject},t.prototype.connect=function(){var e=this._connection;return e||(this._isComplete=!1,(e=this._connection=new ks).add(this.source.subscribe(new Xs(this.getSubject(),this))),e.closed&&(this._connection=null,e=ks.EMPTY)),e},t.prototype.refCount=function(){return zs()(this)},t}(Ds),Ks=function(){var e=Ys.prototype;return{operator:{value:null},_refCount:{value:0,writable:!0},_subject:{value:null,writable:!0},_connection:{value:null,writable:!0},_subscribe:{value:e._subscribe},_isComplete:{value:e._isComplete,writable:!0},getSubject:{value:e.getSubject},connect:{value:e.connect},refCount:{value:e.refCount}}}(),Xs=function(e){function t(t,n){var r=e.call(this,t)||this;return r.connectable=n,r}return gs(t,e),t.prototype._error=function(t){this._unsubscribe(),e.prototype._error.call(this,t)},t.prototype._complete=function(){this.connectable._isComplete=!0,this._unsubscribe(),e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._connection;e._refCount=0,e._subject=null,e._connection=null,t&&t.unsubscribe()}},t}(Ws);function $s(e,t,n,r){return function(i){return i.lift(new Zs(e,t,n,r))}}var Zs=function(){function e(e,t,n,r){this.keySelector=e,this.elementSelector=t,this.durationSelector=n,this.subjectSelector=r}return e.prototype.call=function(e,t){return t.subscribe(new ea(e,this.keySelector,this.elementSelector,this.durationSelector,this.subjectSelector))},e}(),ea=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.keySelector=n,s.elementSelector=r,s.durationSelector=i,s.subjectSelector=o,s.groups=null,s.attemptedToUnsubscribe=!1,s.count=0,s}return gs(t,e),t.prototype._next=function(e){var t;try{t=this.keySelector(e)}catch(e){return void this.error(e)}this._group(e,t)},t.prototype._group=function(e,t){var n=this.groups;n||(n=this.groups=new Map);var r,i=n.get(t);if(this.elementSelector)try{r=this.elementSelector(e)}catch(e){this.error(e)}else r=e;if(!i){i=this.subjectSelector?this.subjectSelector():new Gs,n.set(t,i);var o=new na(t,i,this);if(this.destination.next(o),this.durationSelector){var s=void 0;try{s=this.durationSelector(new na(t,i))}catch(e){return void this.error(e)}this.add(s.subscribe(new ta(t,i,this)))}}i.closed||i.next(r)},t.prototype._error=function(e){var t=this.groups;t&&(t.forEach((function(t,n){t.error(e)})),t.clear()),this.destination.error(e)},t.prototype._complete=function(){var e=this.groups;e&&(e.forEach((function(e,t){e.complete()})),e.clear()),this.destination.complete()},t.prototype.removeGroup=function(e){this.groups.delete(e)},t.prototype.unsubscribe=function(){this.closed||(this.attemptedToUnsubscribe=!0,0===this.count&&e.prototype.unsubscribe.call(this))},t}(Ns),ta=function(e){function t(t,n,r){var i=e.call(this,n)||this;return i.key=t,i.group=n,i.parent=r,i}return gs(t,e),t.prototype._next=function(e){this.complete()},t.prototype._unsubscribe=function(){var e=this.parent,t=this.key;this.key=this.parent=null,e&&e.removeGroup(t)},t}(Ns),na=function(e){function t(t,n,r){var i=e.call(this)||this;return i.key=t,i.groupSubject=n,i.refCountSubscription=r,i}return gs(t,e),t.prototype._subscribe=function(e){var t=new ks,n=this.refCountSubscription,r=this.groupSubject;return n&&!n.closed&&t.add(new ra(n)),t.add(r.subscribe(e)),t},t}(Ds),ra=function(e){function t(t){var n=e.call(this)||this;return n.parent=t,t.count++,n}return gs(t,e),t.prototype.unsubscribe=function(){var t=this.parent;t.closed||this.closed||(e.prototype.unsubscribe.call(this),t.count-=1,0===t.count&&t.attemptedToUnsubscribe&&t.unsubscribe())},t}(ks),ia=function(e){function t(t){var n=e.call(this)||this;return n._value=t,n}return gs(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),t.prototype._subscribe=function(t){var n=e.prototype._subscribe.call(this,t);return n&&!n.closed&&t.next(this._value),n},t.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new Fs;return this._value},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t}(Gs),oa=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r.pending=!1,r}return gs(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var n=this.id,r=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(r,n,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(r,this.id,t),this},t.prototype.requestAsyncId=function(e,t,n){return void 0===n&&(n=0),setInterval(e.flush.bind(e,this),n)},t.prototype.recycleAsyncId=function(e,t,n){if(void 0===n&&(n=0),null!==n&&this.delay===n&&!1===this.pending)return t;clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(e,t);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var n=!1,r=void 0;try{this.work(e)}catch(e){n=!0,r=!!e&&e||new Error(e)}if(n)return this.unsubscribe(),r},t.prototype._unsubscribe=function(){var e=this.id,t=this.scheduler,n=t.actions,r=n.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==r&&n.splice(r,1),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null},t}(function(e){function t(t,n){return e.call(this)||this}return gs(t,e),t.prototype.schedule=function(e,t){return this},t}(ks)),sa=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r}return gs(t,e),t.prototype.schedule=function(t,n){return void 0===n&&(n=0),n>0?e.prototype.schedule.call(this,t,n):(this.delay=n,this.state=t,this.scheduler.flush(this),this)},t.prototype.execute=function(t,n){return n>0||this.closed?e.prototype.execute.call(this,t,n):this._execute(t,n)},t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0?e.prototype.requestAsyncId.call(this,t,n,r):t.flush(this)},t}(oa),aa=function(){function e(t,n){void 0===n&&(n=e.now),this.SchedulerAction=t,this.now=n}return e.prototype.schedule=function(e,t,n){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(n,t)},e.now=function(){return Date.now()},e}(),ua=function(e){function t(n,r){void 0===r&&(r=aa.now);var i=e.call(this,n,(function(){return t.delegate&&t.delegate!==i?t.delegate.now():r()}))||this;return i.actions=[],i.active=!1,i.scheduled=void 0,i}return gs(t,e),t.prototype.schedule=function(n,r,i){return void 0===r&&(r=0),t.delegate&&t.delegate!==this?t.delegate.schedule(n,r,i):e.prototype.schedule.call(this,n,r,i)},t.prototype.flush=function(e){var t=this.actions;if(this.active)t.push(e);else{var n;this.active=!0;do{if(n=e.execute(e.state,e.delay))break}while(e=t.shift());if(this.active=!1,n){for(;e=t.shift();)e.unsubscribe();throw n}}},t}(aa),ca=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return gs(t,e),t}(ua),la=new ca(sa),fa=la,da=new Ds((function(e){return e.complete()}));function pa(e){return e?function(e){return new Ds((function(t){return e.schedule((function(){return t.complete()}))}))}(e):da}function ha(e){return e&&"function"==typeof e.schedule}var va,ba=function(e){return function(t){for(var n=0,r=e.length;n<r&&!t.closed;n++)t.next(e[n]);t.complete()}};function ma(e,t){return new Ds((function(n){var r=new ks,i=0;return r.add(t.schedule((function(){i!==e.length?(n.next(e[i++]),n.closed||r.add(this.schedule())):n.complete()}))),r}))}function ga(e,t){return t?ma(e,t):new Ds(ba(e))}function ya(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[e.length-1];return ha(n)?(e.pop(),ma(e,n)):ga(e)}function _a(e,t){return new Ds(t?function(n){return t.schedule(wa,0,{error:e,subscriber:n})}:function(t){return t.error(e)})}function wa(e){var t=e.error;e.subscriber.error(t)}va||(va={});var Ea=function(){function e(e,t,n){this.kind=e,this.value=t,this.error=n,this.hasValue="N"===e}return e.prototype.observe=function(e){switch(this.kind){case"N":return e.next&&e.next(this.value);case"E":return e.error&&e.error(this.error);case"C":return e.complete&&e.complete()}},e.prototype.do=function(e,t,n){switch(this.kind){case"N":return e&&e(this.value);case"E":return t&&t(this.error);case"C":return n&&n()}},e.prototype.accept=function(e,t,n){return e&&"function"==typeof e.next?this.observe(e):this.do(e,t,n)},e.prototype.toObservable=function(){switch(this.kind){case"N":return ya(this.value);case"E":return _a(this.error);case"C":return pa()}throw new Error("unexpected notification kind value")},e.createNext=function(t){return void 0!==t?new e("N",t):e.undefinedValueNotification},e.createError=function(t){return new e("E",void 0,t)},e.createComplete=function(){return e.completeNotification},e.completeNotification=new e("C"),e.undefinedValueNotification=new e("N",void 0),e}();var Oa=function(){function e(e,t){void 0===t&&(t=0),this.scheduler=e,this.delay=t}return e.prototype.call=function(e,t){return t.subscribe(new Sa(e,this.scheduler,this.delay))},e}(),Sa=function(e){function t(t,n,r){void 0===r&&(r=0);var i=e.call(this,t)||this;return i.scheduler=n,i.delay=r,i}return gs(t,e),t.dispatch=function(e){var t=e.notification,n=e.destination;t.observe(n),this.unsubscribe()},t.prototype.scheduleMessage=function(e){this.destination.add(this.scheduler.schedule(t.dispatch,this.delay,new Ta(e,this.destination)))},t.prototype._next=function(e){this.scheduleMessage(Ea.createNext(e))},t.prototype._error=function(e){this.scheduleMessage(Ea.createError(e)),this.unsubscribe()},t.prototype._complete=function(){this.scheduleMessage(Ea.createComplete()),this.unsubscribe()},t}(Ns),Ta=function(){return function(e,t){this.notification=e,this.destination=t}}(),Aa=function(e){function t(t,n,r){void 0===t&&(t=Number.POSITIVE_INFINITY),void 0===n&&(n=Number.POSITIVE_INFINITY);var i=e.call(this)||this;return i.scheduler=r,i._events=[],i._infiniteTimeWindow=!1,i._bufferSize=t<1?1:t,i._windowTime=n<1?1:n,n===Number.POSITIVE_INFINITY?(i._infiniteTimeWindow=!0,i.next=i.nextInfiniteTimeWindow):i.next=i.nextTimeWindow,i}return gs(t,e),t.prototype.nextInfiniteTimeWindow=function(t){if(!this.isStopped){var n=this._events;n.push(t),n.length>this._bufferSize&&n.shift()}e.prototype.next.call(this,t)},t.prototype.nextTimeWindow=function(t){this.isStopped||(this._events.push(new Ia(this._getNow(),t)),this._trimBufferThenGetEvents()),e.prototype.next.call(this,t)},t.prototype._subscribe=function(e){var t,n=this._infiniteTimeWindow,r=n?this._events:this._trimBufferThenGetEvents(),i=this.scheduler,o=r.length;if(this.closed)throw new Fs;if(this.isStopped||this.hasError?t=ks.EMPTY:(this.observers.push(e),t=new Hs(this,e)),i&&e.add(e=new Sa(e,i)),n)for(var s=0;s<o&&!e.closed;s++)e.next(r[s]);else for(s=0;s<o&&!e.closed;s++)e.next(r[s].value);return this.hasError?e.error(this.thrownError):this.isStopped&&e.complete(),t},t.prototype._getNow=function(){return(this.scheduler||fa).now()},t.prototype._trimBufferThenGetEvents=function(){for(var e=this._getNow(),t=this._bufferSize,n=this._windowTime,r=this._events,i=r.length,o=0;o<i&&!(e-r[o].time<n);)o++;return i>t&&(o=Math.max(o,i-t)),o>0&&r.splice(0,o),r},t}(Gs),Ia=function(){return function(e,t){this.time=e,this.value=t}}(),ka=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.value=null,t.hasNext=!1,t.hasCompleted=!1,t}return gs(t,e),t.prototype._subscribe=function(t){return this.hasError?(t.error(this.thrownError),ks.EMPTY):this.hasCompleted&&this.hasNext?(t.next(this.value),t.complete(),ks.EMPTY):e.prototype._subscribe.call(this,t)},t.prototype.next=function(e){this.hasCompleted||(this.value=e,this.hasNext=!0)},t.prototype.error=function(t){this.hasCompleted||e.prototype.error.call(this,t)},t.prototype.complete=function(){this.hasCompleted=!0,this.hasNext&&e.prototype.next.call(this,this.value),e.prototype.complete.call(this)},t}(Gs),xa=1,Ma=function(){return Promise.resolve()}(),Na={};function Ra(e){return e in Na&&(delete Na[e],!0)}var Ca={setImmediate:function(e){var t=xa++;return Na[t]=!0,Ma.then((function(){return Ra(t)&&e()})),t},clearImmediate:function(e){Ra(e)}},Pa=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r}return gs(t,e),t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0?e.prototype.requestAsyncId.call(this,t,n,r):(t.actions.push(this),t.scheduled||(t.scheduled=Ca.setImmediate(t.flush.bind(t,null))))},t.prototype.recycleAsyncId=function(t,n,r){if(void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0)return e.prototype.recycleAsyncId.call(this,t,n,r);0===t.actions.length&&(Ca.clearImmediate(n),t.scheduled=void 0)},t}(oa),ja=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return gs(t,e),t.prototype.flush=function(e){this.active=!0,this.scheduled=void 0;var t,n=this.actions,r=-1,i=n.length;e=e||n.shift();do{if(t=e.execute(e.state,e.delay))break}while(++r<i&&(e=n.shift()));if(this.active=!1,t){for(;++r<i&&(e=n.shift());)e.unsubscribe();throw t}},t}(ua),La=new ja(Pa),Ua=La,qa=new ua(oa),Da=qa,Va=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r}return gs(t,e),t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0?e.prototype.requestAsyncId.call(this,t,n,r):(t.actions.push(this),t.scheduled||(t.scheduled=requestAnimationFrame((function(){return t.flush(null)}))))},t.prototype.recycleAsyncId=function(t,n,r){if(void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0)return e.prototype.recycleAsyncId.call(this,t,n,r);0===t.actions.length&&(cancelAnimationFrame(n),t.scheduled=void 0)},t}(oa),Fa=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return gs(t,e),t.prototype.flush=function(e){this.active=!0,this.scheduled=void 0;var t,n=this.actions,r=-1,i=n.length;e=e||n.shift();do{if(t=e.execute(e.state,e.delay))break}while(++r<i&&(e=n.shift()));if(this.active=!1,t){for(;++r<i&&(e=n.shift());)e.unsubscribe();throw t}},t}(ua),Ha=new Fa(Va),Wa=Ha,Ga=function(e){function t(t,n){void 0===t&&(t=Ba),void 0===n&&(n=Number.POSITIVE_INFINITY);var r=e.call(this,t,(function(){return r.frame}))||this;return r.maxFrames=n,r.frame=0,r.index=-1,r}return gs(t,e),t.prototype.flush=function(){for(var e,t,n=this.actions,r=this.maxFrames;(t=n[0])&&t.delay<=r&&(n.shift(),this.frame=t.delay,!(e=t.execute(t.state,t.delay))););if(e){for(;t=n.shift();)t.unsubscribe();throw e}},t.frameTimeFactor=10,t}(ua),Ba=function(e){function t(t,n,r){void 0===r&&(r=t.index+=1);var i=e.call(this,t,n)||this;return i.scheduler=t,i.work=n,i.index=r,i.active=!0,i.index=t.index=r,i}return gs(t,e),t.prototype.schedule=function(n,r){if(void 0===r&&(r=0),!this.id)return e.prototype.schedule.call(this,n,r);this.active=!1;var i=new t(this.scheduler,this.work);return this.add(i),i.schedule(n,r)},t.prototype.requestAsyncId=function(e,n,r){void 0===r&&(r=0),this.delay=e.frame+r;var i=e.actions;return i.push(this),i.sort(t.sortActions),!0},t.prototype.recycleAsyncId=function(e,t,n){},t.prototype._execute=function(t,n){if(!0===this.active)return e.prototype._execute.call(this,t,n)},t.sortActions=function(e,t){return e.delay===t.delay?e.index===t.index?0:e.index>t.index?1:-1:e.delay>t.delay?1:-1},t}(oa);function za(){}var Ja=function(){function e(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}return e.prototype=Object.create(Error.prototype),e}(),Qa=function(){function e(){return Error.call(this),this.message="no elements in sequence",this.name="EmptyError",this}return e.prototype=Object.create(Error.prototype),e}(),Ya=function(){function e(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return e.prototype=Object.create(Error.prototype),e}();function Ka(e,t){return function(n){if("function"!=typeof e)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return n.lift(new Xa(e,t))}}var Xa=function(){function e(e,t){this.project=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new $a(e,this.project,this.thisArg))},e}(),$a=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.project=n,i.count=0,i.thisArg=r||i,i}return gs(t,e),t.prototype._next=function(e){var t;try{t=this.project.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(Ns);function Za(e){var t=this,n=e.args,r=e.subscriber,i=e.params,o=i.callbackFunc,s=i.context,a=i.scheduler,u=i.subject;if(!u){u=i.subject=new ka;try{o.apply(s,n.concat([function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=e.length<=1?e[0]:e;t.add(a.schedule(eu,0,{value:r,subject:u}))}]))}catch(e){u.error(e)}}this.add(u.subscribe(r))}function eu(e){var t=e.value,n=e.subject;n.next(t),n.complete()}function tu(e){var t=this,n=e.params,r=e.subscriber,i=e.context,o=n.callbackFunc,s=n.args,a=n.scheduler,u=n.subject;if(!u){u=n.subject=new ka;try{o.apply(i,s.concat([function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=e.shift();if(r)t.add(a.schedule(ru,0,{err:r,subject:u}));else{var i=e.length<=1?e[0]:e;t.add(a.schedule(nu,0,{value:i,subject:u}))}}]))}catch(e){this.add(a.schedule(ru,0,{err:e,subject:u}))}}this.add(u.subscribe(r))}function nu(e){var t=e.value,n=e.subject;n.next(t),n.complete()}function ru(e){var t=e.err;e.subject.error(t)}var iu=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return gs(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.destination.next(t)},t.prototype.notifyError=function(e,t){this.destination.error(e)},t.prototype.notifyComplete=function(e){this.destination.complete()},t}(Ns),ou=function(e){function t(t,n,r){var i=e.call(this)||this;return i.parent=t,i.outerValue=n,i.outerIndex=r,i.index=0,i}return gs(t,e),t.prototype._next=function(e){this.parent.notifyNext(this.outerValue,e,this.outerIndex,this.index++,this)},t.prototype._error=function(e){this.parent.notifyError(e,this),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},t}(Ns),su=function(e){return function(t){return e.then((function(e){t.closed||(t.next(e),t.complete())}),(function(e){return t.error(e)})).then(null,Os),t}};function au(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}var uu=au(),cu=function(e){return function(t){for(var n=e[uu]();;){var r=void 0;try{r=n.next()}catch(e){return t.error(e),t}if(r.done){t.complete();break}if(t.next(r.value),t.closed)break}return"function"==typeof n.return&&t.add((function(){n.return&&n.return()})),t}},lu=function(e){return function(t){var n=e[js]();if("function"!=typeof n.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return n.subscribe(t)}},fu=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function du(e){return!!e&&"function"!=typeof e.subscribe&&"function"==typeof e.then}var pu=function(e){if(e&&"function"==typeof e[js])return lu(e);if(fu(e))return ba(e);if(du(e))return su(e);if(e&&"function"==typeof e[uu])return cu(e);var t=As(e)?"an invalid object":"'"+e+"'";throw new TypeError("You provided "+t+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function hu(e,t,n,r,i){if(void 0===i&&(i=new ou(e,n,r)),!i.closed)return t instanceof Ds?t.subscribe(i):pu(t)(i)}var vu={};var bu=function(){function e(e){this.resultSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new mu(e,this.resultSelector))},e}(),mu=function(e){function t(t,n){var r=e.call(this,t)||this;return r.resultSelector=n,r.active=0,r.values=[],r.observables=[],r}return gs(t,e),t.prototype._next=function(e){this.values.push(vu),this.observables.push(e)},t.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{this.active=t,this.toRespond=t;for(var n=0;n<t;n++){var r=e[n];this.add(hu(this,r,void 0,n))}}},t.prototype.notifyComplete=function(e){0==(this.active-=1)&&this.destination.complete()},t.prototype.notifyNext=function(e,t,n){var r=this.values,i=r[n],o=this.toRespond?i===vu?--this.toRespond:this.toRespond:0;r[n]=t,0===o&&(this.resultSelector?this._tryResultSelector(r):this.destination.next(r.slice()))},t.prototype._tryResultSelector=function(e){var t;try{t=this.resultSelector.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(iu);function gu(e,t){return new Ds((function(n){var r=new ks;return r.add(t.schedule((function(){return e.then((function(e){r.add(t.schedule((function(){n.next(e),r.add(t.schedule((function(){return n.complete()})))})))}),(function(e){r.add(t.schedule((function(){return n.error(e)})))}))}))),r}))}function yu(e,t){if(!e)throw new Error("Iterable cannot be null");return new Ds((function(n){var r,i=new ks;return i.add((function(){r&&"function"==typeof r.return&&r.return()})),i.add(t.schedule((function(){r=e[uu](),i.add(t.schedule((function(){if(!n.closed){var e,t;try{var i=r.next();e=i.value,t=i.done}catch(e){return void n.error(e)}t?n.complete():(n.next(e),this.schedule())}})))}))),i}))}function _u(e){return e&&"function"==typeof e[js]}function wu(e){return e&&"function"==typeof e[uu]}function Eu(e,t){if(null!=e){if(_u(e))return function(e,t){return new Ds((function(n){var r=new ks;return r.add(t.schedule((function(){var i=e[js]();r.add(i.subscribe({next:function(e){r.add(t.schedule((function(){return n.next(e)})))},error:function(e){r.add(t.schedule((function(){return n.error(e)})))},complete:function(){r.add(t.schedule((function(){return n.complete()})))}}))}))),r}))}(e,t);if(du(e))return gu(e,t);if(fu(e))return ma(e,t);if(wu(e)||"string"==typeof e)return yu(e,t)}throw new TypeError((null!==e&&y(e)||e)+" is not observable")}function Ou(e,t){return t?Eu(e,t):e instanceof Ds?e:new Ds(pu(e))}var Su=function(e){function t(t){var n=e.call(this)||this;return n.parent=t,n}return gs(t,e),t.prototype._next=function(e){this.parent.notifyNext(e)},t.prototype._error=function(e){this.parent.notifyError(e),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},t}(Ns),Tu=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return gs(t,e),t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.destination.complete()},t}(Ns);function Au(e,t){if(!t.closed){if(e instanceof Ds)return e.subscribe(t);var n;try{n=pu(e)(t)}catch(e){t.error(e)}return n}}function Iu(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),"function"==typeof t?function(r){return r.pipe(Iu((function(n,r){return Ou(e(n,r)).pipe(Ka((function(e,i){return t(n,e,r,i)})))}),n))}:("number"==typeof t&&(n=t),function(t){return t.lift(new ku(e,n))})}var ku=function(){function e(e,t){void 0===t&&(t=Number.POSITIVE_INFINITY),this.project=e,this.concurrent=t}return e.prototype.call=function(e,t){return t.subscribe(new xu(e,this.project,this.concurrent))},e}(),xu=function(e){function t(t,n,r){void 0===r&&(r=Number.POSITIVE_INFINITY);var i=e.call(this,t)||this;return i.project=n,i.concurrent=r,i.hasCompleted=!1,i.buffer=[],i.active=0,i.index=0,i}return gs(t,e),t.prototype._next=function(e){this.active<this.concurrent?this._tryNext(e):this.buffer.push(e)},t.prototype._tryNext=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this.active++,this._innerSub(t)},t.prototype._innerSub=function(e){var t=new Su(this),n=this.destination;n.add(t);var r=Au(e,t);r!==t&&n.add(r)},t.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyComplete=function(){var e=this.buffer;this.active--,e.length>0?this._next(e.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},t}(Tu),Mu=Iu;function Nu(e){return void 0===e&&(e=Number.POSITIVE_INFINITY),Iu(Ls,e)}function Ru(){return Nu(1)}function Cu(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Ru()(ya.apply(void 0,e))}function Pu(e){return new Ds((function(t){var n;try{n=e()}catch(e){return void t.error(e)}return(n?Ou(n):pa()).subscribe(t)}))}function ju(e,t){return new Ds((function(n){var r=e.length;if(0!==r)for(var i=new Array(r),o=0,s=0,a=function(a){var u=Ou(e[a]),c=!1;n.add(u.subscribe({next:function(e){c||(c=!0,s++),i[a]=e},error:function(e){return n.error(e)},complete:function(){++o!==r&&c||(s===r&&n.next(t?t.reduce((function(e,t,n){return e[t]=i[n],e}),{}):i),n.complete())}}))},u=0;u<r;u++)a(u);else n.complete()}))}function Lu(e,t,n,r,i){var o;if(function(e){return e&&"function"==typeof e.addEventListener&&"function"==typeof e.removeEventListener}(e)){var s=e;e.addEventListener(t,n,i),o=function(){return s.removeEventListener(t,n,i)}}else if(function(e){return e&&"function"==typeof e.on&&"function"==typeof e.off}(e)){var a=e;e.on(t,n),o=function(){return a.off(t,n)}}else if(function(e){return e&&"function"==typeof e.addListener&&"function"==typeof e.removeListener}(e)){var u=e;e.addListener(t,n),o=function(){return u.removeListener(t,n)}}else{if(!e||!e.length)throw new TypeError("Invalid event target");for(var c=0,l=e.length;c<l;c++)Lu(e[c],t,n,r,i)}r.add(o)}function Uu(e){var t=e.subscriber,n=e.condition;if(!t.closed){if(e.needIterate)try{e.state=e.iterate(e.state)}catch(e){return void t.error(e)}else e.needIterate=!0;if(n){var r=void 0;try{r=n(e.state)}catch(e){return void t.error(e)}if(!r)return void t.complete();if(t.closed)return}var i;try{i=e.resultSelector(e.state)}catch(e){return void t.error(e)}if(!t.closed&&(t.next(i),!t.closed))return this.schedule(e)}}function qu(e){return!Ts(e)&&e-parseFloat(e)+1>=0}function Du(e){var t=e.subscriber,n=e.counter,r=e.period;t.next(n),this.schedule({subscriber:t,counter:n+1,period:r},r)}function Vu(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=Number.POSITIVE_INFINITY,r=null,i=e[e.length-1];return ha(i)?(r=e.pop(),e.length>1&&"number"==typeof e[e.length-1]&&(n=e.pop())):"number"==typeof i&&(n=e.pop()),null===r&&1===e.length&&e[0]instanceof Ds?e[0]:Nu(n)(ga(e,r))}var Fu=new Ds(za);function Hu(e){var t=e.keys,n=e.index,r=e.subscriber,i=e.subscription,o=e.obj;if(!r.closed)if(n<t.length){var s=t[n];r.next([s,o[s]]),i.add(this.schedule({keys:t,index:n+1,subscriber:r,subscription:i,obj:o}))}else r.complete()}function Wu(e,t){function n(){return!n.pred.apply(n.thisArg,arguments)}return n.pred=e,n.thisArg=t,n}function Gu(e,t){return function(n){return n.lift(new Bu(e,t))}}var Bu=function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new zu(e,this.predicate,this.thisArg))},e}(),zu=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.thisArg=r,i.count=0,i}return gs(t,e),t.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},t}(Ns);function Ju(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){if(!Ts(e[0]))return e[0];e=e[0]}return ga(e,void 0).lift(new Qu)}var Qu=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Yu(e))},e}(),Yu=function(e){function t(t){var n=e.call(this,t)||this;return n.hasFirst=!1,n.observables=[],n.subscriptions=[],n}return gs(t,e),t.prototype._next=function(e){this.observables.push(e)},t.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{for(var n=0;n<t&&!this.hasFirst;n++){var r=hu(this,e[n],void 0,n);this.subscriptions&&this.subscriptions.push(r),this.add(r)}this.observables=null}},t.prototype.notifyNext=function(e,t,n){if(!this.hasFirst){this.hasFirst=!0;for(var r=0;r<this.subscriptions.length;r++)if(r!==n){var i=this.subscriptions[r];i.unsubscribe(),this.remove(i)}this.subscriptions=null}this.destination.next(t)},t}(iu);function Ku(e){var t=e.start,n=e.index,r=e.count,i=e.subscriber;n>=r?i.complete():(i.next(t),i.closed||(e.index=n+1,e.start=t+1,this.schedule(e)))}function Xu(e,t,n){void 0===e&&(e=0);var r=-1;return qu(t)?r=Number(t)<1?1:Number(t):ha(t)&&(n=t),ha(n)||(n=Da),new Ds((function(t){var i=qu(e)?e:+e-n.now();return n.schedule($u,i,{index:0,period:r,subscriber:t})}))}function $u(e){var t=e.index,n=e.period,r=e.subscriber;if(r.next(t),!r.closed){if(-1===n)return r.complete();e.index=t+1,this.schedule(e,n)}}function Zu(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[e.length-1];return"function"==typeof n&&e.pop(),ga(e,void 0).lift(new ec(n))}var ec=function(){function e(e){this.resultSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new tc(e,this.resultSelector))},e}(),tc=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.resultSelector=n,i.iterators=[],i.active=0,i.resultSelector="function"==typeof n?n:void 0,i}return gs(t,e),t.prototype._next=function(e){var t=this.iterators;Ts(e)?t.push(new rc(e)):"function"==typeof e[uu]?t.push(new nc(e[uu]())):t.push(new ic(this.destination,this,e))},t.prototype._complete=function(){var e=this.iterators,t=e.length;if(this.unsubscribe(),0!==t){this.active=t;for(var n=0;n<t;n++){var r=e[n];if(r.stillUnsubscribed)this.destination.add(r.subscribe());else this.active--}}else this.destination.complete()},t.prototype.notifyInactive=function(){this.active--,0===this.active&&this.destination.complete()},t.prototype.checkIterators=function(){for(var e=this.iterators,t=e.length,n=this.destination,r=0;r<t;r++){if("function"==typeof(s=e[r]).hasValue&&!s.hasValue())return}var i=!1,o=[];for(r=0;r<t;r++){var s,a=(s=e[r]).next();if(s.hasCompleted()&&(i=!0),a.done)return void n.complete();o.push(a.value)}this.resultSelector?this._tryresultSelector(o):n.next(o),i&&n.complete()},t.prototype._tryresultSelector=function(e){var t;try{t=this.resultSelector.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(Ns),nc=function(){function e(e){this.iterator=e,this.nextResult=e.next()}return e.prototype.hasValue=function(){return!0},e.prototype.next=function(){var e=this.nextResult;return this.nextResult=this.iterator.next(),e},e.prototype.hasCompleted=function(){var e=this.nextResult;return Boolean(e&&e.done)},e}(),rc=function(){function e(e){this.array=e,this.index=0,this.length=0,this.length=e.length}return e.prototype[uu]=function(){return this},e.prototype.next=function(e){var t=this.index++,n=this.array;return t<this.length?{value:n[t],done:!1}:{value:null,done:!0}},e.prototype.hasValue=function(){return this.array.length>this.index},e.prototype.hasCompleted=function(){return this.array.length===this.index},e}(),ic=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.parent=n,i.observable=r,i.stillUnsubscribed=!0,i.buffer=[],i.isComplete=!1,i}return gs(t,e),t.prototype[uu]=function(){return this},t.prototype.next=function(){var e=this.buffer;return 0===e.length&&this.isComplete?{value:null,done:!0}:{value:e.shift(),done:!1}},t.prototype.hasValue=function(){return this.buffer.length>0},t.prototype.hasCompleted=function(){return 0===this.buffer.length&&this.isComplete},t.prototype.notifyComplete=function(){this.buffer.length>0?(this.isComplete=!0,this.parent.notifyInactive()):this.destination.complete()},t.prototype.notifyNext=function(e){this.buffer.push(e),this.parent.checkIterators()},t.prototype.subscribe=function(){return Au(this.observable,new Su(this))},t}(Tu),oc=Object.freeze({__proto__:null,ArgumentOutOfRangeError:Ja,AsyncSubject:ka,BehaviorSubject:ia,ConnectableObservable:Ys,EMPTY:da,EmptyError:Qa,GroupedObservable:na,NEVER:Fu,Notification:Ea,get NotificationKind(){return va},ObjectUnsubscribedError:Fs,Observable:Ds,ReplaySubject:Aa,Scheduler:aa,Subject:Gs,Subscriber:Ns,Subscription:ks,TimeoutError:Ya,UnsubscriptionError:Is,VirtualAction:Ba,VirtualTimeScheduler:Ga,animationFrame:Wa,animationFrameScheduler:Ha,asap:Ua,asapScheduler:La,async:Da,asyncScheduler:qa,bindCallback:function e(t,n,r){if(n){if(!ha(n))return function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];return e(t,r).apply(void 0,i).pipe(Ka((function(e){return Ts(e)?n.apply(void 0,e):n(e)})))};r=n}return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i,o=this,s={context:o,subject:i,callbackFunc:t,scheduler:r};return new Ds((function(n){if(r){var a={args:e,subscriber:n,params:s};return r.schedule(Za,0,a)}if(!i){i=new ka;try{t.apply(o,e.concat([function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i.next(e.length<=1?e[0]:e),i.complete()}]))}catch(e){Cs(i)?i.error(e):console.warn(e)}}return i.subscribe(n)}))}},bindNodeCallback:function e(t,n,r){if(n){if(!ha(n))return function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];return e(t,r).apply(void 0,i).pipe(Ka((function(e){return Ts(e)?n.apply(void 0,e):n(e)})))};r=n}return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i={subject:void 0,args:e,callbackFunc:t,scheduler:r,context:this};return new Ds((function(n){var o=i.context,s=i.subject;if(r)return r.schedule(tu,0,{params:i,subscriber:n,context:o});if(!s){s=i.subject=new ka;try{t.apply(o,e.concat([function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e.shift();n?s.error(n):(s.next(e.length<=1?e[0]:e),s.complete())}]))}catch(e){Cs(s)?s.error(e):console.warn(e)}}return s.subscribe(n)}))}},combineLatest:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=void 0,r=void 0;return ha(e[e.length-1])&&(r=e.pop()),"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&Ts(e[0])&&(e=e[0]),ga(e,r).lift(new bu(n))},concat:Cu,config:Es,defer:Pu,empty:pa,forkJoin:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var n=e[0];if(Ts(n))return ju(n,null);if(As(n)&&Object.getPrototypeOf(n)===Object.prototype){var r=Object.keys(n);return ju(r.map((function(e){return n[e]})),r)}}if("function"==typeof e[e.length-1]){var i=e.pop();return ju(e=1===e.length&&Ts(e[0])?e[0]:e,null).pipe(Ka((function(e){return i.apply(void 0,e)})))}return ju(e,null)},from:Ou,fromEvent:function e(t,n,r,i){return _s(r)&&(i=r,r=void 0),i?e(t,n,r).pipe(Ka((function(e){return Ts(e)?i.apply(void 0,e):i(e)}))):new Ds((function(e){Lu(t,n,(function(t){arguments.length>1?e.next(Array.prototype.slice.call(arguments)):e.next(t)}),e,r)}))},fromEventPattern:function e(t,n,r){return r?e(t,n).pipe(Ka((function(e){return Ts(e)?r.apply(void 0,e):r(e)}))):new Ds((function(e){var r,i=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.next(1===t.length?t[0]:t)};try{r=t(i)}catch(t){return void e.error(t)}if(_s(n))return function(){return n(i,r)}}))},generate:function(e,t,n,r,i){var o,s;if(1==arguments.length){var a=e;s=a.initialState,t=a.condition,n=a.iterate,o=a.resultSelector||Ls,i=a.scheduler}else void 0===r||ha(r)?(s=e,o=Ls,i=r):(s=e,o=r);return new Ds((function(e){var r=s;if(i)return i.schedule(Uu,0,{subscriber:e,iterate:n,condition:t,resultSelector:o,state:r});for(;;){if(t){var a=void 0;try{a=t(r)}catch(t){return void e.error(t)}if(!a){e.complete();break}}var u=void 0;try{u=o(r)}catch(t){return void e.error(t)}if(e.next(u),e.closed)break;try{r=n(r)}catch(t){return void e.error(t)}}}))},identity:Ls,iif:function(e,t,n){return void 0===t&&(t=da),void 0===n&&(n=da),Pu((function(){return e()?t:n}))},interval:function(e,t){return void 0===e&&(e=0),void 0===t&&(t=Da),(!qu(e)||e<0)&&(e=0),t&&"function"==typeof t.schedule||(t=Da),new Ds((function(n){return n.add(t.schedule(Du,e,{subscriber:n,counter:0,period:e})),n}))},isObservable:function(e){return!!e&&(e instanceof Ds||"function"==typeof e.lift&&"function"==typeof e.subscribe)},merge:Vu,never:function(){return Fu},noop:za,observable:js,of:ya,onErrorResumeNext:function e(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(0===t.length)return da;var r=t[0],i=t.slice(1);return 1===t.length&&Ts(r)?e.apply(void 0,r):new Ds((function(t){var n=function(){return t.add(e.apply(void 0,i).subscribe(t))};return Ou(r).subscribe({next:function(e){t.next(e)},error:n,complete:n})}))},pairs:function(e,t){return new Ds(t?function(n){var r=Object.keys(e),i=new ks;return i.add(t.schedule(Hu,0,{keys:r,index:0,subscriber:n,subscription:i,obj:e})),i}:function(t){for(var n=Object.keys(e),r=0;r<n.length&&!t.closed;r++){var i=n[r];e.hasOwnProperty(i)&&t.next([i,e[i]])}t.complete()})},partition:function(e,t,n){return[Gu(t,n)(new Ds(pu(e))),Gu(Wu(t,n))(new Ds(pu(e)))]},pipe:Us,queue:fa,queueScheduler:la,race:Ju,range:function(e,t,n){return void 0===e&&(e=0),new Ds((function(r){void 0===t&&(t=e,e=0);var i=0,o=e;if(n)return n.schedule(Ku,0,{index:i,count:t,start:e,subscriber:r});for(;;){if(i++>=t){r.complete();break}if(r.next(o++),r.closed)break}}))},scheduled:Eu,throwError:_a,timer:Xu,using:function(e,t){return new Ds((function(n){var r,i;try{r=e()}catch(e){return void n.error(e)}try{i=t(r)}catch(e){return void n.error(e)}var o=(i?Ou(i):da).subscribe(n);return function(){o.unsubscribe(),r&&r.unsubscribe()}}))},zip:Zu}),sc=n(oc);var ac="undefined"!=typeof window&&window,uc="undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&self,cc="undefined"!=typeof global&&global,lc=ac||cc||uc;function fc(e,t){return void 0===t&&(t=null),new gc({method:"GET",url:e,headers:t})}function dc(e,t,n){return new gc({method:"POST",url:e,body:t,headers:n})}function pc(e,t){return new gc({method:"DELETE",url:e,headers:t})}function hc(e,t,n){return new gc({method:"PUT",url:e,body:t,headers:n})}function vc(e,t,n){return new gc({method:"PATCH",url:e,body:t,headers:n})}var bc=Ka((function(e,t){return e.response}));function mc(e,t){return bc(new gc({method:"GET",url:e,responseType:"json",headers:t}))}var gc=function(e){function t(t){var n=e.call(this)||this,r={async:!0,createXHR:function(){return this.crossDomain?function(){if(lc.XMLHttpRequest)return new lc.XMLHttpRequest;if(lc.XDomainRequest)return new lc.XDomainRequest;throw new Error("CORS is not supported by your browser")}():function(){if(lc.XMLHttpRequest)return new lc.XMLHttpRequest;var e=void 0;try{for(var t=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],n=0;n<3;n++)try{if(e=t[n],new lc.ActiveXObject(e))break}catch(e){}return new lc.ActiveXObject(e)}catch(e){throw new Error("XMLHttpRequest is not supported by your browser")}}()},crossDomain:!0,withCredentials:!1,headers:{},method:"GET",responseType:"json",timeout:0};if("string"==typeof t)r.url=t;else for(var i in t)t.hasOwnProperty(i)&&(r[i]=t[i]);return n.request=r,n}return gs(t,e),t.prototype._subscribe=function(e){return new yc(e,this.request)},t.create=function(){var e=function(e){return new t(e)};return e.get=fc,e.post=dc,e.delete=pc,e.put=hc,e.patch=vc,e.getJSON=mc,e}(),t}(Ds),yc=function(e){function t(t,n){var r=e.call(this,t)||this;r.request=n,r.done=!1;var i=n.headers=n.headers||{};return n.crossDomain||r.getHeader(i,"X-Requested-With")||(i["X-Requested-With"]="XMLHttpRequest"),r.getHeader(i,"Content-Type")||lc.FormData&&n.body instanceof lc.FormData||void 0===n.body||(i["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8"),n.body=r.serializeBody(n.body,r.getHeader(n.headers,"Content-Type")),r.send(),r}return gs(t,e),t.prototype.next=function(e){this.done=!0;var t,n=this,r=n.xhr,i=n.request,o=n.destination;try{t=new _c(e,r,i)}catch(e){return o.error(e)}o.next(t)},t.prototype.send=function(){var e=this.request,t=this.request,n=t.user,r=t.method,i=t.url,o=t.async,s=t.password,a=t.headers,u=t.body;try{var c=this.xhr=e.createXHR();this.setupEvents(c,e),n?c.open(r,i,o,n,s):c.open(r,i,o),o&&(c.timeout=e.timeout,c.responseType=e.responseType),"withCredentials"in c&&(c.withCredentials=!!e.withCredentials),this.setHeaders(c,a),u?c.send(u):c.send()}catch(e){this.error(e)}},t.prototype.serializeBody=function(e,t){if(!e||"string"==typeof e)return e;if(lc.FormData&&e instanceof lc.FormData)return e;if(t){var n=t.indexOf(";");-1!==n&&(t=t.substring(0,n))}switch(t){case"application/x-www-form-urlencoded":return Object.keys(e).map((function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])})).join("&");case"application/json":return JSON.stringify(e);default:return e}},t.prototype.setHeaders=function(e,t){for(var n in t)t.hasOwnProperty(n)&&e.setRequestHeader(n,t[n])},t.prototype.getHeader=function(e,t){for(var n in e)if(n.toLowerCase()===t.toLowerCase())return e[n]},t.prototype.setupEvents=function(e,t){var n=t.progressSubscriber;function r(e){var t,n=r,i=n.subscriber,o=n.progressSubscriber,s=n.request;o&&o.error(e);try{t=new Oc(this,s)}catch(e){t=e}i.error(t)}if(e.ontimeout=r,r.request=t,r.subscriber=this,r.progressSubscriber=n,e.upload&&"withCredentials"in e){var i,o;if(n)i=function(e){i.progressSubscriber.next(e)},lc.XDomainRequest?e.onprogress=i:e.upload.onprogress=i,i.progressSubscriber=n;o=function(e){var t,n=o,r=n.progressSubscriber,i=n.subscriber,s=n.request;r&&r.error(e);try{t=new wc("ajax error",this,s)}catch(e){t=e}i.error(t)},e.onerror=o,o.request=t,o.subscriber=this,o.progressSubscriber=n}function s(e){}function a(e){var t=a,n=t.subscriber,r=t.progressSubscriber,i=t.request;if(4===this.readyState){var o=1223===this.status?204:this.status,s="text"===this.responseType?this.response||this.responseText:this.response;if(0===o&&(o=s?200:0),o<400)r&&r.complete(),n.next(e),n.complete();else{r&&r.error(e);var u=void 0;try{u=new wc("ajax error "+o,this,i)}catch(e){u=e}n.error(u)}}}e.onreadystatechange=s,s.subscriber=this,s.progressSubscriber=n,s.request=t,e.onload=a,a.subscriber=this,a.progressSubscriber=n,a.request=t},t.prototype.unsubscribe=function(){var t=this.done,n=this.xhr;!t&&n&&4!==n.readyState&&"function"==typeof n.abort&&n.abort(),e.prototype.unsubscribe.call(this)},t}(Ns),_c=function(){return function(e,t,n){this.originalEvent=e,this.xhr=t,this.request=n,this.status=t.status,this.responseType=t.responseType||n.responseType,this.response=Ec(this.responseType,t)}}(),wc=function(){function e(e,t,n){return Error.call(this),this.message=e,this.name="AjaxError",this.xhr=t,this.request=n,this.status=t.status,this.responseType=t.responseType||n.responseType,this.response=Ec(this.responseType,t),this}return e.prototype=Object.create(Error.prototype),e}();function Ec(e,t){switch(e){case"json":return function(e){return"response"in e?e.responseType?e.response:JSON.parse(e.response||e.responseText||"null"):JSON.parse(e.responseText||"null")}(t);case"xml":return t.responseXML;default:return"response"in t?t.response:t.responseText}}var Oc=function(e,t){return wc.call(this,"ajax timeout",e,t),this.name="AjaxTimeoutError",this},Sc=function(){return gc.create}(),Tc={url:"",deserializer:function(e){return JSON.parse(e.data)},serializer:function(e){return JSON.stringify(e)}},Ac=function(e){function t(t,n){var r=e.call(this)||this;if(t instanceof Ds)r.destination=n,r.source=t;else{var i=r._config=ys({},Tc);if(r._output=new Gs,"string"==typeof t)i.url=t;else for(var o in t)t.hasOwnProperty(o)&&(i[o]=t[o]);if(!i.WebSocketCtor&&WebSocket)i.WebSocketCtor=WebSocket;else if(!i.WebSocketCtor)throw new Error("no WebSocket constructor can be found");r.destination=new Aa}return r}return gs(t,e),t.prototype.lift=function(e){var n=new t(this._config,this.destination);return n.operator=e,n.source=this,n},t.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new Aa),this._output=new Gs},t.prototype.multiplex=function(e,t,n){var r=this;return new Ds((function(i){try{r.next(e())}catch(e){i.error(e)}var o=r.subscribe((function(e){try{n(e)&&i.next(e)}catch(e){i.error(e)}}),(function(e){return i.error(e)}),(function(){return i.complete()}));return function(){try{r.next(t())}catch(e){i.error(e)}o.unsubscribe()}}))},t.prototype._connectSocket=function(){var e=this,t=this._config,n=t.WebSocketCtor,r=t.protocol,i=t.url,o=t.binaryType,s=this._output,a=null;try{a=r?new n(i,r):new n(i),this._socket=a,o&&(this._socket.binaryType=o)}catch(e){return void s.error(e)}var u=new ks((function(){e._socket=null,a&&1===a.readyState&&a.close()}));a.onopen=function(t){if(!e._socket)return a.close(),void e._resetState();var n=e._config.openObserver;n&&n.next(t);var r=e.destination;e.destination=Ns.create((function(t){if(1===a.readyState)try{var n=e._config.serializer;a.send(n(t))}catch(t){e.destination.error(t)}}),(function(t){var n=e._config.closingObserver;n&&n.next(void 0),t&&t.code?a.close(t.code,t.reason):s.error(new TypeError("WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }")),e._resetState()}),(function(){var t=e._config.closingObserver;t&&t.next(void 0),a.close(),e._resetState()})),r&&r instanceof Aa&&u.add(r.subscribe(e.destination))},a.onerror=function(t){e._resetState(),s.error(t)},a.onclose=function(t){e._resetState();var n=e._config.closeObserver;n&&n.next(t),t.wasClean?s.complete():s.error(t)},a.onmessage=function(t){try{var n=e._config.deserializer;s.next(n(t))}catch(e){s.error(e)}}},t.prototype._subscribe=function(e){var t=this,n=this.source;return n?n.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add((function(){var e=t._socket;0===t._output.observers.length&&(e&&1===e.readyState&&e.close(),t._resetState())})),e)},t.prototype.unsubscribe=function(){var t=this._socket;t&&1===t.readyState&&t.close(),this._resetState(),e.prototype.unsubscribe.call(this)},t}(Bs);function Ic(e){return new Ac(e)}var kc=function(e){function t(t,n,r){void 0===n&&(n=0),void 0===r&&(r=Ua);var i=e.call(this)||this;return i.source=t,i.delayTime=n,i.scheduler=r,(!qu(n)||n<0)&&(i.delayTime=0),r&&"function"==typeof r.schedule||(i.scheduler=Ua),i}return gs(t,e),t.create=function(e,n,r){return void 0===n&&(n=0),void 0===r&&(r=Ua),new t(e,n,r)},t.dispatch=function(e){var t=e.source,n=e.subscriber;return this.add(t.subscribe(n))},t.prototype._subscribe=function(e){var n=this.delayTime,r=this.source;return this.scheduler.schedule(t.dispatch,n,{source:r,subscriber:e})},t}(Ds);var xc=function(){return function(e,t){this.value=e,this.timestamp=t}}();function Mc(e,t){var n=!1;return arguments.length>=2&&(n=!0),function(r){return r.lift(new Nc(e,t,n))}}var Nc=function(){function e(e,t,n){void 0===n&&(n=!1),this.accumulator=e,this.seed=t,this.hasSeed=n}return e.prototype.call=function(e,t){return t.subscribe(new Rc(e,this.accumulator,this.seed,this.hasSeed))},e}(),Rc=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.accumulator=n,o._seed=r,o.hasSeed=i,o.index=0,o}return gs(t,e),Object.defineProperty(t.prototype,"seed",{get:function(){return this._seed},set:function(e){this.hasSeed=!0,this._seed=e},enumerable:!0,configurable:!0}),t.prototype._next=function(e){if(this.hasSeed)return this._tryNext(e);this.seed=e,this.destination.next(e)},t.prototype._tryNext=function(e){var t,n=this.index++;try{t=this.accumulator(this.seed,e,n)}catch(e){this.destination.error(e)}this.seed=t,this.destination.next(t)},t}(Ns);var Cc=function(){return function(e,t){this.value=e,this.interval=t}}(),Pc={leading:!0,trailing:!1};var jc=function(){function e(e,t,n){this.durationSelector=e,this.leading=t,this.trailing=n}return e.prototype.call=function(e,t){return t.subscribe(new Lc(e,this.durationSelector,this.leading,this.trailing))},e}(),Lc=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.destination=t,o.durationSelector=n,o._leading=r,o._trailing=i,o._hasValue=!1,o}return gs(t,e),t.prototype._next=function(e){this._hasValue=!0,this._sendValue=e,this._throttled||(this._leading?this.send():this.throttle(e))},t.prototype.send=function(){var e=this._hasValue,t=this._sendValue;e&&(this.destination.next(t),this.throttle(t)),this._hasValue=!1,this._sendValue=void 0},t.prototype.throttle=function(e){var t=this.tryDurationSelector(e);t&&this.add(this._throttled=Au(t,new Su(this)))},t.prototype.tryDurationSelector=function(e){try{return this.durationSelector(e)}catch(e){return this.destination.error(e),null}},t.prototype.throttlingDone=function(){var e=this._throttled,t=this._trailing;e&&e.unsubscribe(),this._throttled=void 0,t&&this.send()},t.prototype.notifyNext=function(){this.throttlingDone()},t.prototype.notifyComplete=function(){this.throttlingDone()},t}(Tu);var Uc,qc={e:{}};function Dc(e){return e instanceof Date&&!isNaN(+e)}function Vc(){qc.e=void 0;try{return Uc.apply(this,arguments)}catch(e){return qc.e=e,qc}finally{Uc=void 0}}var Fc,Hc=Object.freeze({__proto__:null,AjaxError:wc,AjaxObservable:gc,AjaxResponse:_c,AjaxSubscriber:yc,AjaxTimeoutError:Oc,AnonymousSubject:Bs,ArgumentOutOfRangeError:Ja,CombineLatestOperator:bu,EmptyError:Qa,GroupedObservable:na,Immediate:Ca,InnerSubscriber:ou,ObjectUnsubscribedError:Fs,OuterSubscriber:iu,Scheduler:aa,SubjectSubscription:Hs,SubscribeOnObservable:kc,Subscriber:Ns,TimeInterval:Cc,TimeoutError:Ya,Timestamp:xc,UnsubscriptionError:Is,WebSocketSubject:Ac,ajax:Sc,ajaxDelete:pc,ajaxGet:fc,ajaxGetJSON:mc,ajaxPatch:vc,ajaxPost:dc,ajaxPut:hc,applyMixins:function(e,t){for(var n=0,r=t.length;n<r;n++)for(var i=t[n],o=Object.getOwnPropertyNames(i.prototype),s=0,a=o.length;s<a;s++){var u=o[s];e.prototype[u]=i.prototype[u]}},config:Es,defaultThrottleConfig:Pc,dispatch:Ku,errorObject:qc,fromIterable:function(e,t){if(!e)throw new Error("Iterable cannot be null");return t?yu(e,t):new Ds(cu(e))},fromPromise:function(e,t){return t?gu(e,t):new Ds(su(e))},hostReportError:Os,identity:Ls,isArray:Ts,isArrayLike:fu,isDate:Dc,isFunction:_s,isIterable:wu,isNumeric:qu,isObject:As,isObservable:_u,isPromise:du,isScheduler:ha,iterator:uu,noop:za,not:Wu,observable:js,pipe:Us,root:lc,rxSubscriber:Ms,subscribeTo:pu,subscribeToArray:ba,subscribeToIterable:cu,subscribeToObservable:lu,subscribeToPromise:su,subscribeToResult:hu,toSubscriber:Ps,tryCatch:function(e){return Uc=e,Vc},webSocket:Ic}),Wc=n(Hc),Gc={};var Bc,zc={};var Jc,Qc={};var Yc,Kc={};var Xc,$c={};var Zc,el={};var tl,nl={};var rl,il={};var ol,sl={};var al,ul={};var cl,ll={};var fl,dl={};var pl,hl={};var vl,bl={};var ml,gl={};var yl,_l={};var wl,El={};var Ol,Sl={};var Tl,Al={};var Il,kl={};var xl,Ml={};var Nl,Rl={};var Cl,Pl={};var jl,Ll={};var Ul,ql={};var Dl,Vl={},Fl=n(Object.freeze({__proto__:null,AjaxError:wc,AjaxResponse:_c,AjaxTimeoutError:Oc,ajax:Sc}));var Hl,Wl={},Gl=n(Object.freeze({__proto__:null,WebSocketSubject:Ac,webSocket:Ic}));var Bl={},zl={};function Jl(e){return function(t){return t.lift(new Ql(e))}}var Ql=function(){function e(e){this.durationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Yl(e,this.durationSelector))},e}(),Yl=function(e){function t(t,n){var r=e.call(this,t)||this;return r.durationSelector=n,r.hasValue=!1,r}return gs(t,e),t.prototype._next=function(e){if(this.value=e,this.hasValue=!0,!this.throttled){var t=void 0;try{t=(0,this.durationSelector)(e)}catch(e){return this.destination.error(e)}var n=Au(t,new Su(this));!n||n.closed?this.clearThrottle():this.add(this.throttled=n)}},t.prototype.clearThrottle=function(){var e=this,t=e.value,n=e.hasValue,r=e.throttled;r&&(this.remove(r),this.throttled=void 0,r.unsubscribe()),n&&(this.value=void 0,this.hasValue=!1,this.destination.next(t))},t.prototype.notifyNext=function(){this.clearThrottle()},t.prototype.notifyComplete=function(){this.clearThrottle()},t}(Tu);function Kl(e,t){return void 0===t&&(t=Da),Jl((function(){return Xu(e,t)}))}var Xl=function(){function e(e){this.closingNotifier=e}return e.prototype.call=function(e,t){return t.subscribe(new $l(e,this.closingNotifier))},e}(),$l=function(e){function t(t,n){var r=e.call(this,t)||this;return r.buffer=[],r.add(Au(n,new Su(r))),r}return gs(t,e),t.prototype._next=function(e){this.buffer.push(e)},t.prototype.notifyNext=function(){var e=this.buffer;this.buffer=[],this.destination.next(e)},t}(Tu);function Zl(e,t){return void 0===t&&(t=null),function(n){return n.lift(new ef(e,t))}}var ef=function(){function e(e,t){this.bufferSize=e,this.startBufferEvery=t,this.subscriberClass=t&&e!==t?nf:tf}return e.prototype.call=function(e,t){return t.subscribe(new this.subscriberClass(e,this.bufferSize,this.startBufferEvery))},e}(),tf=function(e){function t(t,n){var r=e.call(this,t)||this;return r.bufferSize=n,r.buffer=[],r}return gs(t,e),t.prototype._next=function(e){var t=this.buffer;t.push(e),t.length==this.bufferSize&&(this.destination.next(t),this.buffer=[])},t.prototype._complete=function(){var t=this.buffer;t.length>0&&this.destination.next(t),e.prototype._complete.call(this)},t}(Ns),nf=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.bufferSize=n,i.startBufferEvery=r,i.buffers=[],i.count=0,i}return gs(t,e),t.prototype._next=function(e){var t=this,n=t.bufferSize,r=t.startBufferEvery,i=t.buffers,o=t.count;this.count++,o%r==0&&i.push([]);for(var s=i.length;s--;){var a=i[s];a.push(e),a.length===n&&(i.splice(s,1),this.destination.next(a))}},t.prototype._complete=function(){for(var t=this.buffers,n=this.destination;t.length>0;){var r=t.shift();r.length>0&&n.next(r)}e.prototype._complete.call(this)},t}(Ns);var rf=function(){function e(e,t,n,r){this.bufferTimeSpan=e,this.bufferCreationInterval=t,this.maxBufferSize=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new sf(e,this.bufferTimeSpan,this.bufferCreationInterval,this.maxBufferSize,this.scheduler))},e}(),of=function(){return function(){this.buffer=[]}}(),sf=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;s.bufferTimeSpan=n,s.bufferCreationInterval=r,s.maxBufferSize=i,s.scheduler=o,s.contexts=[];var a=s.openContext();if(s.timespanOnly=null==r||r<0,s.timespanOnly){var u={subscriber:s,context:a,bufferTimeSpan:n};s.add(a.closeAction=o.schedule(af,n,u))}else{var c={subscriber:s,context:a},l={bufferTimeSpan:n,bufferCreationInterval:r,subscriber:s,scheduler:o};s.add(a.closeAction=o.schedule(cf,n,c)),s.add(o.schedule(uf,r,l))}return s}return gs(t,e),t.prototype._next=function(e){for(var t,n=this.contexts,r=n.length,i=0;i<r;i++){var o=n[i],s=o.buffer;s.push(e),s.length==this.maxBufferSize&&(t=o)}t&&this.onBufferFull(t)},t.prototype._error=function(t){this.contexts.length=0,e.prototype._error.call(this,t)},t.prototype._complete=function(){for(var t=this.contexts,n=this.destination;t.length>0;){var r=t.shift();n.next(r.buffer)}e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.contexts=null},t.prototype.onBufferFull=function(e){this.closeContext(e);var t=e.closeAction;if(t.unsubscribe(),this.remove(t),!this.closed&&this.timespanOnly){e=this.openContext();var n=this.bufferTimeSpan,r={subscriber:this,context:e,bufferTimeSpan:n};this.add(e.closeAction=this.scheduler.schedule(af,n,r))}},t.prototype.openContext=function(){var e=new of;return this.contexts.push(e),e},t.prototype.closeContext=function(e){this.destination.next(e.buffer);var t=this.contexts;(t?t.indexOf(e):-1)>=0&&t.splice(t.indexOf(e),1)},t}(Ns);function af(e){var t=e.subscriber,n=e.context;n&&t.closeContext(n),t.closed||(e.context=t.openContext(),e.context.closeAction=this.schedule(e,e.bufferTimeSpan))}function uf(e){var t=e.bufferCreationInterval,n=e.bufferTimeSpan,r=e.subscriber,i=e.scheduler,o=r.openContext();r.closed||(r.add(o.closeAction=i.schedule(cf,n,{subscriber:r,context:o})),this.schedule(e,t))}function cf(e){var t=e.subscriber,n=e.context;t.closeContext(n)}var lf=function(){function e(e,t){this.openings=e,this.closingSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new ff(e,this.openings,this.closingSelector))},e}(),ff=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.closingSelector=r,i.contexts=[],i.add(hu(i,n)),i}return gs(t,e),t.prototype._next=function(e){for(var t=this.contexts,n=t.length,r=0;r<n;r++)t[r].buffer.push(e)},t.prototype._error=function(t){for(var n=this.contexts;n.length>0;){var r=n.shift();r.subscription.unsubscribe(),r.buffer=null,r.subscription=null}this.contexts=null,e.prototype._error.call(this,t)},t.prototype._complete=function(){for(var t=this.contexts;t.length>0;){var n=t.shift();this.destination.next(n.buffer),n.subscription.unsubscribe(),n.buffer=null,n.subscription=null}this.contexts=null,e.prototype._complete.call(this)},t.prototype.notifyNext=function(e,t){e?this.closeBuffer(e):this.openBuffer(t)},t.prototype.notifyComplete=function(e){this.closeBuffer(e.context)},t.prototype.openBuffer=function(e){try{var t=this.closingSelector.call(this,e);t&&this.trySubscribe(t)}catch(e){this._error(e)}},t.prototype.closeBuffer=function(e){var t=this.contexts;if(t&&e){var n=e.buffer,r=e.subscription;this.destination.next(n),t.splice(t.indexOf(e),1),this.remove(r),r.unsubscribe()}},t.prototype.trySubscribe=function(e){var t=this.contexts,n=new ks,r={buffer:[],subscription:n};t.push(r);var i=hu(this,e,r);!i||i.closed?this.closeBuffer(r):(i.context=r,this.add(i),n.add(i))},t}(iu);var df=function(){function e(e){this.closingSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new pf(e,this.closingSelector))},e}(),pf=function(e){function t(t,n){var r=e.call(this,t)||this;return r.closingSelector=n,r.subscribing=!1,r.openBuffer(),r}return gs(t,e),t.prototype._next=function(e){this.buffer.push(e)},t.prototype._complete=function(){var t=this.buffer;t&&this.destination.next(t),e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.buffer=void 0,this.subscribing=!1},t.prototype.notifyNext=function(){this.openBuffer()},t.prototype.notifyComplete=function(){this.subscribing?this.complete():this.openBuffer()},t.prototype.openBuffer=function(){var e=this.closingSubscription;e&&(this.remove(e),e.unsubscribe());var t,n=this.buffer;this.buffer&&this.destination.next(n),this.buffer=[];try{t=(0,this.closingSelector)()}catch(e){return this.error(e)}e=new ks,this.closingSubscription=e,this.add(e),this.subscribing=!0,e.add(Au(t,new Su(this))),this.subscribing=!1},t}(Tu);function hf(e){return function(t){var n=new vf(e),r=t.lift(n);return n.caught=r}}var vf=function(){function e(e){this.selector=e}return e.prototype.call=function(e,t){return t.subscribe(new bf(e,this.selector,this.caught))},e}(),bf=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.selector=n,i.caught=r,i}return gs(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=void 0;try{n=this.selector(t,this.caught)}catch(t){return void e.prototype.error.call(this,t)}this._unsubscribeAndRecycle();var r=new Su(this);this.add(r);var i=Au(n,r);i!==r&&this.add(i)}},t}(Tu);function mf(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=null;return"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&Ts(e[0])&&(e=e[0].slice()),function(t){return t.lift.call(Ou([t].concat(e)),new bu(n))}}function gf(e,t){return Iu(e,t,1)}var yf=function(){function e(e,t){this.predicate=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new _f(e,this.predicate,this.source))},e}(),_f=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.source=r,i.count=0,i.index=0,i}return gs(t,e),t.prototype._next=function(e){this.predicate?this._tryPredicate(e):this.count++},t.prototype._tryPredicate=function(e){var t;try{t=this.predicate(e,this.index++,this.source)}catch(e){return void this.destination.error(e)}t&&this.count++},t.prototype._complete=function(){this.destination.next(this.count),this.destination.complete()},t}(Ns);var wf=function(){function e(e){this.durationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Ef(e,this.durationSelector))},e}(),Ef=function(e){function t(t,n){var r=e.call(this,t)||this;return r.durationSelector=n,r.hasValue=!1,r}return gs(t,e),t.prototype._next=function(e){try{var t=this.durationSelector.call(this,e);t&&this._tryNext(e,t)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.emitValue(),this.destination.complete()},t.prototype._tryNext=function(e,t){var n=this.durationSubscription;this.value=e,this.hasValue=!0,n&&(n.unsubscribe(),this.remove(n)),(n=Au(t,new Su(this)))&&!n.closed&&this.add(this.durationSubscription=n)},t.prototype.notifyNext=function(){this.emitValue()},t.prototype.notifyComplete=function(){this.emitValue()},t.prototype.emitValue=function(){if(this.hasValue){var t=this.value,n=this.durationSubscription;n&&(this.durationSubscription=void 0,n.unsubscribe(),this.remove(n)),this.value=void 0,this.hasValue=!1,e.prototype._next.call(this,t)}},t}(Tu);function Of(e,t){return void 0===t&&(t=Da),function(n){return n.lift(new Sf(e,t))}}var Sf=function(){function e(e,t){this.dueTime=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new Tf(e,this.dueTime,this.scheduler))},e}(),Tf=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.dueTime=n,i.scheduler=r,i.debouncedSubscription=null,i.lastValue=null,i.hasValue=!1,i}return gs(t,e),t.prototype._next=function(e){this.clearDebounce(),this.lastValue=e,this.hasValue=!0,this.add(this.debouncedSubscription=this.scheduler.schedule(Af,this.dueTime,this))},t.prototype._complete=function(){this.debouncedNext(),this.destination.complete()},t.prototype.debouncedNext=function(){if(this.clearDebounce(),this.hasValue){var e=this.lastValue;this.lastValue=null,this.hasValue=!1,this.destination.next(e)}},t.prototype.clearDebounce=function(){var e=this.debouncedSubscription;null!==e&&(this.remove(e),e.unsubscribe(),this.debouncedSubscription=null)},t}(Ns);function Af(e){e.debouncedNext()}function If(e){return void 0===e&&(e=null),function(t){return t.lift(new kf(e))}}var kf=function(){function e(e){this.defaultValue=e}return e.prototype.call=function(e,t){return t.subscribe(new xf(e,this.defaultValue))},e}(),xf=function(e){function t(t,n){var r=e.call(this,t)||this;return r.defaultValue=n,r.isEmpty=!0,r}return gs(t,e),t.prototype._next=function(e){this.isEmpty=!1,this.destination.next(e)},t.prototype._complete=function(){this.isEmpty&&this.destination.next(this.defaultValue),this.destination.complete()},t}(Ns);var Mf=function(){function e(e,t){this.delay=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new Nf(e,this.delay,this.scheduler))},e}(),Nf=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.delay=n,i.scheduler=r,i.queue=[],i.active=!1,i.errored=!1,i}return gs(t,e),t.dispatch=function(e){for(var t=e.source,n=t.queue,r=e.scheduler,i=e.destination;n.length>0&&n[0].time-r.now()<=0;)n.shift().notification.observe(i);if(n.length>0){var o=Math.max(0,n[0].time-r.now());this.schedule(e,o)}else this.unsubscribe(),t.active=!1},t.prototype._schedule=function(e){this.active=!0,this.destination.add(e.schedule(t.dispatch,this.delay,{source:this,destination:this.destination,scheduler:e}))},t.prototype.scheduleNotification=function(e){if(!0!==this.errored){var t=this.scheduler,n=new Rf(t.now()+this.delay,e);this.queue.push(n),!1===this.active&&this._schedule(t)}},t.prototype._next=function(e){this.scheduleNotification(Ea.createNext(e))},t.prototype._error=function(e){this.errored=!0,this.queue=[],this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.scheduleNotification(Ea.createComplete()),this.unsubscribe()},t}(Ns),Rf=function(){return function(e,t){this.time=e,this.notification=t}}();var Cf=function(){function e(e){this.delayDurationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Pf(e,this.delayDurationSelector))},e}(),Pf=function(e){function t(t,n){var r=e.call(this,t)||this;return r.delayDurationSelector=n,r.completed=!1,r.delayNotifierSubscriptions=[],r.index=0,r}return gs(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.destination.next(e),this.removeSubscription(i),this.tryComplete()},t.prototype.notifyError=function(e,t){this._error(e)},t.prototype.notifyComplete=function(e){var t=this.removeSubscription(e);t&&this.destination.next(t),this.tryComplete()},t.prototype._next=function(e){var t=this.index++;try{var n=this.delayDurationSelector(e,t);n&&this.tryDelay(n,e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.completed=!0,this.tryComplete(),this.unsubscribe()},t.prototype.removeSubscription=function(e){e.unsubscribe();var t=this.delayNotifierSubscriptions.indexOf(e);return-1!==t&&this.delayNotifierSubscriptions.splice(t,1),e.outerValue},t.prototype.tryDelay=function(e,t){var n=hu(this,e,t);n&&!n.closed&&(this.destination.add(n),this.delayNotifierSubscriptions.push(n))},t.prototype.tryComplete=function(){this.completed&&0===this.delayNotifierSubscriptions.length&&this.destination.complete()},t}(iu),jf=function(e){function t(t,n){var r=e.call(this)||this;return r.source=t,r.subscriptionDelay=n,r}return gs(t,e),t.prototype._subscribe=function(e){this.subscriptionDelay.subscribe(new Lf(e,this.source))},t}(Ds),Lf=function(e){function t(t,n){var r=e.call(this)||this;return r.parent=t,r.source=n,r.sourceSubscribed=!1,r}return gs(t,e),t.prototype._next=function(e){this.subscribeToSource()},t.prototype._error=function(e){this.unsubscribe(),this.parent.error(e)},t.prototype._complete=function(){this.unsubscribe(),this.subscribeToSource()},t.prototype.subscribeToSource=function(){this.sourceSubscribed||(this.sourceSubscribed=!0,this.unsubscribe(),this.source.subscribe(this.parent))},t}(Ns);var Uf=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new qf(e))},e}(),qf=function(e){function t(t){return e.call(this,t)||this}return gs(t,e),t.prototype._next=function(e){e.observe(this.destination)},t}(Ns);function Df(e,t){return function(n){return n.lift(new Vf(e,t))}}var Vf=function(){function e(e,t){this.keySelector=e,this.flushes=t}return e.prototype.call=function(e,t){return t.subscribe(new Ff(e,this.keySelector,this.flushes))},e}(),Ff=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.keySelector=n,i.values=new Set,r&&i.add(Au(r,new Su(i))),i}return gs(t,e),t.prototype.notifyNext=function(){this.values.clear()},t.prototype.notifyError=function(e){this._error(e)},t.prototype._next=function(e){this.keySelector?this._useKeySelector(e):this._finalizeNext(e,e)},t.prototype._useKeySelector=function(e){var t,n=this.destination;try{t=this.keySelector(e)}catch(e){return void n.error(e)}this._finalizeNext(t,e)},t.prototype._finalizeNext=function(e,t){var n=this.values;n.has(e)||(n.add(e),this.destination.next(t))},t}(Tu);function Hf(e,t){return function(n){return n.lift(new Wf(e,t))}}var Wf=function(){function e(e,t){this.compare=e,this.keySelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Gf(e,this.compare,this.keySelector))},e}(),Gf=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.keySelector=r,i.hasKey=!1,"function"==typeof n&&(i.compare=n),i}return gs(t,e),t.prototype.compare=function(e,t){return e===t},t.prototype._next=function(e){var t;try{var n=this.keySelector;t=n?n(e):e}catch(e){return this.destination.error(e)}var r=!1;if(this.hasKey)try{r=(0,this.compare)(this.key,t)}catch(e){return this.destination.error(e)}else this.hasKey=!0;r||(this.key=t,this.destination.next(e))},t}(Ns);function Bf(e){return void 0===e&&(e=Qf),function(t){return t.lift(new zf(e))}}var zf=function(){function e(e){this.errorFactory=e}return e.prototype.call=function(e,t){return t.subscribe(new Jf(e,this.errorFactory))},e}(),Jf=function(e){function t(t,n){var r=e.call(this,t)||this;return r.errorFactory=n,r.hasValue=!1,r}return gs(t,e),t.prototype._next=function(e){this.hasValue=!0,this.destination.next(e)},t.prototype._complete=function(){if(this.hasValue)return this.destination.complete();var e=void 0;try{e=this.errorFactory()}catch(t){e=t}this.destination.error(e)},t}(Ns);function Qf(){return new Qa}function Yf(e){return function(t){return 0===e?pa():t.lift(new Kf(e))}}var Kf=function(){function e(e){if(this.total=e,this.total<0)throw new Ja}return e.prototype.call=function(e,t){return t.subscribe(new Xf(e,this.total))},e}(),Xf=function(e){function t(t,n){var r=e.call(this,t)||this;return r.total=n,r.count=0,r}return gs(t,e),t.prototype._next=function(e){var t=this.total,n=++this.count;n<=t&&(this.destination.next(e),n===t&&(this.destination.complete(),this.unsubscribe()))},t}(Ns);var $f=function(){function e(e,t,n){this.predicate=e,this.thisArg=t,this.source=n}return e.prototype.call=function(e,t){return t.subscribe(new Zf(e,this.predicate,this.thisArg,this.source))},e}(),Zf=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.predicate=n,o.thisArg=r,o.source=i,o.index=0,o.thisArg=r||o,o}return gs(t,e),t.prototype.notifyComplete=function(e){this.destination.next(e),this.destination.complete()},t.prototype._next=function(e){var t=!1;try{t=this.predicate.call(this.thisArg,e,this.index++,this.source)}catch(e){return void this.destination.error(e)}t||this.notifyComplete(!1)},t.prototype._complete=function(){this.notifyComplete(!0)},t}(Ns);var ed=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new td(e))},e}(),td=function(e){function t(t){var n=e.call(this,t)||this;return n.hasCompleted=!1,n.hasSubscription=!1,n}return gs(t,e),t.prototype._next=function(e){this.hasSubscription||(this.hasSubscription=!0,this.add(Au(e,new Su(this))))},t.prototype._complete=function(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete()},t.prototype.notifyComplete=function(){this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()},t}(Tu);var nd=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new rd(e,this.project))},e}(),rd=function(e){function t(t,n){var r=e.call(this,t)||this;return r.project=n,r.hasSubscription=!1,r.hasCompleted=!1,r.index=0,r}return gs(t,e),t.prototype._next=function(e){this.hasSubscription||this.tryNext(e)},t.prototype.tryNext=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this.hasSubscription=!0,this._innerSub(t)},t.prototype._innerSub=function(e){var t=new Su(this),n=this.destination;n.add(t);var r=Au(e,t);r!==t&&n.add(r)},t.prototype._complete=function(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()},t}(Tu);var id=function(){function e(e,t,n){this.project=e,this.concurrent=t,this.scheduler=n}return e.prototype.call=function(e,t){return t.subscribe(new od(e,this.project,this.concurrent,this.scheduler))},e}(),od=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.project=n,o.concurrent=r,o.scheduler=i,o.index=0,o.active=0,o.hasCompleted=!1,r<Number.POSITIVE_INFINITY&&(o.buffer=[]),o}return gs(t,e),t.dispatch=function(e){var t=e.subscriber,n=e.result,r=e.value,i=e.index;t.subscribeToProjection(n,r,i)},t.prototype._next=function(e){var n=this.destination;if(n.closed)this._complete();else{var r=this.index++;if(this.active<this.concurrent){n.next(e);try{var i=(0,this.project)(e,r);if(this.scheduler){var o={subscriber:this,result:i,value:e,index:r};this.destination.add(this.scheduler.schedule(t.dispatch,0,o))}else this.subscribeToProjection(i,e,r)}catch(e){n.error(e)}}else this.buffer.push(e)}},t.prototype.subscribeToProjection=function(e,t,n){this.active++,this.destination.add(Au(e,new Su(this)))},t.prototype._complete=function(){this.hasCompleted=!0,this.hasCompleted&&0===this.active&&this.destination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this._next(e)},t.prototype.notifyComplete=function(){var e=this.buffer;this.active--,e&&e.length>0&&this._next(e.shift()),this.hasCompleted&&0===this.active&&this.destination.complete()},t}(Tu);function sd(e){return function(t){return t.lift(new ad(e))}}var ad=function(){function e(e){this.callback=e}return e.prototype.call=function(e,t){return t.subscribe(new ud(e,this.callback))},e}(),ud=function(e){function t(t,n){var r=e.call(this,t)||this;return r.add(new ks(n)),r}return gs(t,e),t}(Ns);var cd=function(){function e(e,t,n,r){this.predicate=e,this.source=t,this.yieldIndex=n,this.thisArg=r}return e.prototype.call=function(e,t){return t.subscribe(new ld(e,this.predicate,this.source,this.yieldIndex,this.thisArg))},e}(),ld=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.predicate=n,s.source=r,s.yieldIndex=i,s.thisArg=o,s.index=0,s}return gs(t,e),t.prototype.notifyComplete=function(e){var t=this.destination;t.next(e),t.complete(),this.unsubscribe()},t.prototype._next=function(e){var t=this.predicate,n=this.thisArg,r=this.index++;try{t.call(n||this,e,r,this.source)&&this.notifyComplete(this.yieldIndex?r:e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.notifyComplete(this.yieldIndex?-1:void 0)},t}(Ns);var fd=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new dd(e))},e}(),dd=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return gs(t,e),t.prototype._next=function(e){},t}(Ns);var pd=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new hd(e))},e}(),hd=function(e){function t(t){return e.call(this,t)||this}return gs(t,e),t.prototype.notifyComplete=function(e){var t=this.destination;t.next(e),t.complete()},t.prototype._next=function(e){this.notifyComplete(!1)},t.prototype._complete=function(){this.notifyComplete(!0)},t}(Ns);function vd(e){return function(t){return 0===e?pa():t.lift(new bd(e))}}var bd=function(){function e(e){if(this.total=e,this.total<0)throw new Ja}return e.prototype.call=function(e,t){return t.subscribe(new md(e,this.total))},e}(),md=function(e){function t(t,n){var r=e.call(this,t)||this;return r.total=n,r.ring=new Array,r.count=0,r}return gs(t,e),t.prototype._next=function(e){var t=this.ring,n=this.total,r=this.count++;t.length<n?t.push(e):t[r%n]=e},t.prototype._complete=function(){var e=this.destination,t=this.count;if(t>0)for(var n=this.count>=this.total?this.total:this.count,r=this.ring,i=0;i<n;i++){var o=t++%n;e.next(r[o])}e.complete()},t}(Ns);function gd(e,t){var n=arguments.length>=2;return function(r){return r.pipe(e?Gu((function(t,n){return e(t,n,r)})):Ls,vd(1),n?If(t):Bf((function(){return new Qa})))}}function yd(e){return function(t){return t.lift(new _d(e))}}var _d=function(){function e(e){this.value=e}return e.prototype.call=function(e,t){return t.subscribe(new wd(e,this.value))},e}(),wd=function(e){function t(t,n){var r=e.call(this,t)||this;return r.value=n,r}return gs(t,e),t.prototype._next=function(e){this.destination.next(this.value)},t}(Ns);var Ed=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Od(e))},e}(),Od=function(e){function t(t){return e.call(this,t)||this}return gs(t,e),t.prototype._next=function(e){this.destination.next(Ea.createNext(e))},t.prototype._error=function(e){var t=this.destination;t.next(Ea.createError(e)),t.complete()},t.prototype._complete=function(){var e=this.destination;e.next(Ea.createComplete()),e.complete()},t}(Ns);function Sd(e,t){return arguments.length>=2?function(n){return Us(Mc(e,t),vd(1),If(t))(n)}:function(t){return Us(Mc((function(t,n,r){return e(t,n,r+1)})),vd(1))(t)}}function Td(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return t.lift.call(Vu.apply(void 0,[t].concat(e)))}}function Ad(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),"function"==typeof t?Iu((function(){return e}),t,n):("number"==typeof t&&(n=t),Iu((function(){return e}),n))}var Id=function(){function e(e,t,n){this.accumulator=e,this.seed=t,this.concurrent=n}return e.prototype.call=function(e,t){return t.subscribe(new kd(e,this.accumulator,this.seed,this.concurrent))},e}(),kd=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.accumulator=n,o.acc=r,o.concurrent=i,o.hasValue=!1,o.hasCompleted=!1,o.buffer=[],o.active=0,o.index=0,o}return gs(t,e),t.prototype._next=function(e){if(this.active<this.concurrent){var t=this.index++,n=this.destination,r=void 0;try{r=(0,this.accumulator)(this.acc,e,t)}catch(e){return n.error(e)}this.active++,this._innerSub(r)}else this.buffer.push(e)},t.prototype._innerSub=function(e){var t=new Su(this),n=this.destination;n.add(t);var r=Au(e,t);r!==t&&n.add(r)},t.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&(!1===this.hasValue&&this.destination.next(this.acc),this.destination.complete()),this.unsubscribe()},t.prototype.notifyNext=function(e){var t=this.destination;this.acc=e,this.hasValue=!0,t.next(e)},t.prototype.notifyComplete=function(){var e=this.buffer;this.active--,e.length>0?this._next(e.shift()):0===this.active&&this.hasCompleted&&(!1===this.hasValue&&this.destination.next(this.acc),this.destination.complete())},t}(Tu);function xd(e,t){return function(n){var r;if(r="function"==typeof e?e:function(){return e},"function"==typeof t)return n.lift(new Md(r,t));var i=Object.create(n,Ks);return i.source=n,i.subjectFactory=r,i}}var Md=function(){function e(e,t){this.subjectFactory=e,this.selector=t}return e.prototype.call=function(e,t){var n=this.selector,r=this.subjectFactory(),i=n(r).subscribe(e);return i.add(t.subscribe(r)),i},e}();var Nd=function(){function e(e){this.nextSources=e}return e.prototype.call=function(e,t){return t.subscribe(new Rd(e,this.nextSources))},e}(),Rd=function(e){function t(t,n){var r=e.call(this,t)||this;return r.destination=t,r.nextSources=n,r}return gs(t,e),t.prototype.notifyError=function(){this.subscribeToNextSource()},t.prototype.notifyComplete=function(){this.subscribeToNextSource()},t.prototype._error=function(e){this.subscribeToNextSource(),this.unsubscribe()},t.prototype._complete=function(){this.subscribeToNextSource(),this.unsubscribe()},t.prototype.subscribeToNextSource=function(){var e=this.nextSources.shift();if(e){var t=new Su(this),n=this.destination;n.add(t);var r=Au(e,t);r!==t&&n.add(r)}else this.destination.complete()},t}(Tu);var Cd=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Pd(e))},e}(),Pd=function(e){function t(t){var n=e.call(this,t)||this;return n.hasPrev=!1,n}return gs(t,e),t.prototype._next=function(e){var t;this.hasPrev?t=[this.prev,e]:this.hasPrev=!0,this.prev=e,t&&this.destination.next(t)},t}(Ns);function jd(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e.length;if(0===n)throw new Error("list of properties cannot be empty.");return function(t){return Ka(function(e,t){var n=function(n){for(var r=n,i=0;i<t;i++){var o=null!=r?r[e[i]]:void 0;if(void 0===o)return;r=o}return r};return n}(e,n))(t)}}function Ld(e){return e?xd((function(){return new Gs}),e):xd(new Gs)}function Ud(e,t,n,r){n&&"function"!=typeof n&&(r=n);var i="function"==typeof n?n:void 0,o=new Aa(e,t,r);return function(e){return xd((function(){return o}),i)(e)}}function qd(e){return void 0===e&&(e=-1),function(t){return 0===e?pa():e<0?t.lift(new Dd(-1,t)):t.lift(new Dd(e-1,t))}}var Dd=function(){function e(e,t){this.count=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new Vd(e,this.count,this.source))},e}(),Vd=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.count=n,i.source=r,i}return gs(t,e),t.prototype.complete=function(){if(!this.isStopped){var t=this.source,n=this.count;if(0===n)return e.prototype.complete.call(this);n>-1&&(this.count=n-1),t.subscribe(this._unsubscribeAndRecycle())}},t}(Ns);var Fd=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){return t.subscribe(new Hd(e,this.notifier,t))},e}(),Hd=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.notifier=n,i.source=r,i.sourceIsBeingSubscribedTo=!0,i}return gs(t,e),t.prototype.notifyNext=function(){this.sourceIsBeingSubscribedTo=!0,this.source.subscribe(this)},t.prototype.notifyComplete=function(){if(!1===this.sourceIsBeingSubscribedTo)return e.prototype.complete.call(this)},t.prototype.complete=function(){if(this.sourceIsBeingSubscribedTo=!1,!this.isStopped){if(this.retries||this.subscribeToRetries(),!this.retriesSubscription||this.retriesSubscription.closed)return e.prototype.complete.call(this);this._unsubscribeAndRecycle(),this.notifications.next(void 0)}},t.prototype._unsubscribe=function(){var e=this.notifications,t=this.retriesSubscription;e&&(e.unsubscribe(),this.notifications=void 0),t&&(t.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0},t.prototype._unsubscribeAndRecycle=function(){var t=this._unsubscribe;return this._unsubscribe=null,e.prototype._unsubscribeAndRecycle.call(this),this._unsubscribe=t,this},t.prototype.subscribeToRetries=function(){var t;this.notifications=new Gs;try{t=(0,this.notifier)(this.notifications)}catch(t){return e.prototype.complete.call(this)}this.retries=t,this.retriesSubscription=Au(t,new Su(this))},t}(Tu);var Wd=function(){function e(e,t){this.count=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new Gd(e,this.count,this.source))},e}(),Gd=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.count=n,i.source=r,i}return gs(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=this.source,r=this.count;if(0===r)return e.prototype.error.call(this,t);r>-1&&(this.count=r-1),n.subscribe(this._unsubscribeAndRecycle())}},t}(Ns);var Bd=function(){function e(e,t){this.notifier=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new zd(e,this.notifier,this.source))},e}(),zd=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.notifier=n,i.source=r,i}return gs(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=this.errors,r=this.retries,i=this.retriesSubscription;if(r)this.errors=void 0,this.retriesSubscription=void 0;else{n=new Gs;try{r=(0,this.notifier)(n)}catch(t){return e.prototype.error.call(this,t)}i=Au(r,new Su(this))}this._unsubscribeAndRecycle(),this.errors=n,this.retries=r,this.retriesSubscription=i,n.next(t)}},t.prototype._unsubscribe=function(){var e=this.errors,t=this.retriesSubscription;e&&(e.unsubscribe(),this.errors=void 0),t&&(t.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0},t.prototype.notifyNext=function(){var e=this._unsubscribe;this._unsubscribe=null,this._unsubscribeAndRecycle(),this._unsubscribe=e,this.source.subscribe(this)},t}(Tu);var Jd=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){var n=new Qd(e),r=t.subscribe(n);return r.add(Au(this.notifier,new Su(n))),r},e}(),Qd=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.hasValue=!1,t}return gs(t,e),t.prototype._next=function(e){this.value=e,this.hasValue=!0},t.prototype.notifyNext=function(){this.emitValue()},t.prototype.notifyComplete=function(){this.emitValue()},t.prototype.emitValue=function(){this.hasValue&&(this.hasValue=!1,this.destination.next(this.value))},t}(Tu);var Yd=function(){function e(e,t){this.period=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new Kd(e,this.period,this.scheduler))},e}(),Kd=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.period=n,i.scheduler=r,i.hasValue=!1,i.add(r.schedule(Xd,n,{subscriber:i,period:n})),i}return gs(t,e),t.prototype._next=function(e){this.lastValue=e,this.hasValue=!0},t.prototype.notifyNext=function(){this.hasValue&&(this.hasValue=!1,this.destination.next(this.lastValue))},t}(Ns);function Xd(e){var t=e.subscriber,n=e.period;t.notifyNext(),this.schedule(e,n)}var $d=function(){function e(e,t){this.compareTo=e,this.comparator=t}return e.prototype.call=function(e,t){return t.subscribe(new Zd(e,this.compareTo,this.comparator))},e}(),Zd=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.compareTo=n,i.comparator=r,i._a=[],i._b=[],i._oneComplete=!1,i.destination.add(n.subscribe(new ep(t,i))),i}return gs(t,e),t.prototype._next=function(e){this._oneComplete&&0===this._b.length?this.emit(!1):(this._a.push(e),this.checkValues())},t.prototype._complete=function(){this._oneComplete?this.emit(0===this._a.length&&0===this._b.length):this._oneComplete=!0,this.unsubscribe()},t.prototype.checkValues=function(){for(var e=this,t=e._a,n=e._b,r=e.comparator;t.length>0&&n.length>0;){var i=t.shift(),o=n.shift(),s=!1;try{s=r?r(i,o):i===o}catch(e){this.destination.error(e)}s||this.emit(!1)}},t.prototype.emit=function(e){var t=this.destination;t.next(e),t.complete()},t.prototype.nextB=function(e){this._oneComplete&&0===this._a.length?this.emit(!1):(this._b.push(e),this.checkValues())},t.prototype.completeB=function(){this._oneComplete?this.emit(0===this._a.length&&0===this._b.length):this._oneComplete=!0},t}(Ns),ep=function(e){function t(t,n){var r=e.call(this,t)||this;return r.parent=n,r}return gs(t,e),t.prototype._next=function(e){this.parent.nextB(e)},t.prototype._error=function(e){this.parent.error(e),this.unsubscribe()},t.prototype._complete=function(){this.parent.completeB(),this.unsubscribe()},t}(Ns);function tp(){return new Gs}function np(){return function(e){return zs()(xd(tp)(e))}}function rp(e,t,n){var r;return r=e&&"object"===y(e)?e:{bufferSize:e,windowTime:t,refCount:!1,scheduler:n},function(e){return e.lift(function(e){var t,n,r=e.bufferSize,i=void 0===r?Number.POSITIVE_INFINITY:r,o=e.windowTime,s=void 0===o?Number.POSITIVE_INFINITY:o,a=e.refCount,u=e.scheduler,c=0,l=!1,f=!1;return function(e){var r;c++,!t||l?(l=!1,t=new Aa(i,s,u),r=t.subscribe(this),n=e.subscribe({next:function(e){t.next(e)},error:function(e){l=!0,t.error(e)},complete:function(){f=!0,n=void 0,t.complete()}}),f&&(n=void 0)):r=t.subscribe(this),this.add((function(){c--,r.unsubscribe(),r=void 0,n&&!f&&a&&0===c&&(n.unsubscribe(),n=void 0,t=void 0)}))}}(r))}}var ip=function(){function e(e,t){this.predicate=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new op(e,this.predicate,this.source))},e}(),op=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.source=r,i.seenValue=!1,i.index=0,i}return gs(t,e),t.prototype.applySingleValue=function(e){this.seenValue?this.destination.error("Sequence contains more than one element"):(this.seenValue=!0,this.singleValue=e)},t.prototype._next=function(e){var t=this.index++;this.predicate?this.tryNext(e,t):this.applySingleValue(e)},t.prototype.tryNext=function(e,t){try{this.predicate(e,t,this.source)&&this.applySingleValue(e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){var e=this.destination;this.index>0?(e.next(this.seenValue?this.singleValue:void 0),e.complete()):e.error(new Qa)},t}(Ns);function sp(e){return function(t){return t.lift(new ap(e))}}var ap=function(){function e(e){this.total=e}return e.prototype.call=function(e,t){return t.subscribe(new up(e,this.total))},e}(),up=function(e){function t(t,n){var r=e.call(this,t)||this;return r.total=n,r.count=0,r}return gs(t,e),t.prototype._next=function(e){++this.count>this.total&&this.destination.next(e)},t}(Ns);var cp=function(){function e(e){if(this._skipCount=e,this._skipCount<0)throw new Ja}return e.prototype.call=function(e,t){return 0===this._skipCount?t.subscribe(new Ns(e)):t.subscribe(new lp(e,this._skipCount))},e}(),lp=function(e){function t(t,n){var r=e.call(this,t)||this;return r._skipCount=n,r._count=0,r._ring=new Array(n),r}return gs(t,e),t.prototype._next=function(e){var t=this._skipCount,n=this._count++;if(n<t)this._ring[n]=e;else{var r=n%t,i=this._ring,o=i[r];i[r]=e,this.destination.next(o)}},t}(Ns);var fp=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){return t.subscribe(new dp(e,this.notifier))},e}(),dp=function(e){function t(t,n){var r=e.call(this,t)||this;r.hasValue=!1;var i=new Su(r);r.add(i),r.innerSubscription=i;var o=Au(n,i);return o!==i&&(r.add(o),r.innerSubscription=o),r}return gs(t,e),t.prototype._next=function(t){this.hasValue&&e.prototype._next.call(this,t)},t.prototype.notifyNext=function(){this.hasValue=!0,this.innerSubscription&&this.innerSubscription.unsubscribe()},t.prototype.notifyComplete=function(){},t}(Tu);var pp=function(){function e(e){this.predicate=e}return e.prototype.call=function(e,t){return t.subscribe(new hp(e,this.predicate))},e}(),hp=function(e){function t(t,n){var r=e.call(this,t)||this;return r.predicate=n,r.skipping=!0,r.index=0,r}return gs(t,e),t.prototype._next=function(e){var t=this.destination;this.skipping&&this.tryCallPredicate(e),this.skipping||t.next(e)},t.prototype.tryCallPredicate=function(e){try{var t=this.predicate(e,this.index++);this.skipping=Boolean(t)}catch(e){this.destination.error(e)}},t}(Ns);function vp(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[e.length-1];return ha(n)?(e.pop(),function(t){return Cu(e,t,n)}):function(t){return Cu(e,t)}}var bp=function(){function e(e,t){this.scheduler=e,this.delay=t}return e.prototype.call=function(e,t){return new kc(t,this.delay,this.scheduler).subscribe(e)},e}();function mp(e,t){return"function"==typeof t?function(n){return n.pipe(mp((function(n,r){return Ou(e(n,r)).pipe(Ka((function(e,i){return t(n,e,r,i)})))})))}:function(t){return t.lift(new gp(e))}}var gp=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new yp(e,this.project))},e}(),yp=function(e){function t(t,n){var r=e.call(this,t)||this;return r.project=n,r.index=0,r}return gs(t,e),t.prototype._next=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this._innerSub(t)},t.prototype._innerSub=function(e){var t=this.innerSubscription;t&&t.unsubscribe();var n=new Su(this),r=this.destination;r.add(n),this.innerSubscription=Au(e,n),this.innerSubscription!==n&&r.add(this.innerSubscription)},t.prototype._complete=function(){var t=this.innerSubscription;t&&!t.closed||e.prototype._complete.call(this),this.unsubscribe()},t.prototype._unsubscribe=function(){this.innerSubscription=void 0},t.prototype.notifyComplete=function(){this.innerSubscription=void 0,this.isStopped&&e.prototype._complete.call(this)},t.prototype.notifyNext=function(e){this.destination.next(e)},t}(Tu);function _p(e,t){return t?mp((function(){return e}),t):mp((function(){return e}))}function wp(e){return function(t){return t.lift(new Ep(e))}}var Ep=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){var n=new Op(e),r=Au(this.notifier,new Su(n));return r&&!n.seenValue?(n.add(r),t.subscribe(n)):n},e}(),Op=function(e){function t(t){var n=e.call(this,t)||this;return n.seenValue=!1,n}return gs(t,e),t.prototype.notifyNext=function(){this.seenValue=!0,this.complete()},t.prototype.notifyComplete=function(){},t}(Tu);var Sp=function(){function e(e,t){this.predicate=e,this.inclusive=t}return e.prototype.call=function(e,t){return t.subscribe(new Tp(e,this.predicate,this.inclusive))},e}(),Tp=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.inclusive=r,i.index=0,i}return gs(t,e),t.prototype._next=function(e){var t,n=this.destination;try{t=this.predicate(e,this.index++)}catch(e){return void n.error(e)}this.nextOrComplete(e,t)},t.prototype.nextOrComplete=function(e,t){var n=this.destination;Boolean(t)?n.next(e):(this.inclusive&&n.next(e),n.complete())},t}(Ns);function Ap(e,t,n){return function(r){return r.lift(new Ip(e,t,n))}}var Ip=function(){function e(e,t,n){this.nextOrObserver=e,this.error=t,this.complete=n}return e.prototype.call=function(e,t){return t.subscribe(new kp(e,this.nextOrObserver,this.error,this.complete))},e}(),kp=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o._tapNext=za,o._tapError=za,o._tapComplete=za,o._tapError=r||za,o._tapComplete=i||za,_s(n)?(o._context=o,o._tapNext=n):n&&(o._context=n,o._tapNext=n.next||za,o._tapError=n.error||za,o._tapComplete=n.complete||za),o}return gs(t,e),t.prototype._next=function(e){try{this._tapNext.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.next(e)},t.prototype._error=function(e){try{this._tapError.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.error(e)},t.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(e){return void this.destination.error(e)}return this.destination.complete()},t}(Ns);function xp(e,t,n){return void 0===t&&(t=Da),void 0===n&&(n=Pc),function(r){return r.lift(new Mp(e,t,n.leading,n.trailing))}}var Mp=function(){function e(e,t,n,r){this.duration=e,this.scheduler=t,this.leading=n,this.trailing=r}return e.prototype.call=function(e,t){return t.subscribe(new Np(e,this.duration,this.scheduler,this.leading,this.trailing))},e}(),Np=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.duration=n,s.scheduler=r,s.leading=i,s.trailing=o,s._hasTrailingValue=!1,s._trailingValue=null,s}return gs(t,e),t.prototype._next=function(e){this.throttled?this.trailing&&(this._trailingValue=e,this._hasTrailingValue=!0):(this.add(this.throttled=this.scheduler.schedule(Rp,this.duration,{subscriber:this})),this.leading?this.destination.next(e):this.trailing&&(this._trailingValue=e,this._hasTrailingValue=!0))},t.prototype._complete=function(){this._hasTrailingValue?(this.destination.next(this._trailingValue),this.destination.complete()):this.destination.complete()},t.prototype.clearThrottle=function(){var e=this.throttled;e&&(this.trailing&&this._hasTrailingValue&&(this.destination.next(this._trailingValue),this._trailingValue=null,this._hasTrailingValue=!1),e.unsubscribe(),this.remove(e),this.throttled=null)},t}(Ns);function Rp(e){e.subscriber.clearThrottle()}function Cp(e,t,n){return void 0===n&&(n=Da),function(r){var i=Dc(e),o=i?+e-n.now():Math.abs(e);return r.lift(new Pp(o,i,t,n))}}var Pp=function(){function e(e,t,n,r){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new jp(e,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))},e}(),jp=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.absoluteTimeout=n,s.waitFor=r,s.withObservable=i,s.scheduler=o,s.scheduleTimeout(),s}return gs(t,e),t.dispatchTimeout=function(e){var t=e.withObservable;e._unsubscribeAndRecycle(),e.add(Au(t,new Su(e)))},t.prototype.scheduleTimeout=function(){var e=this.action;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(t.dispatchTimeout,this.waitFor,this))},t.prototype._next=function(t){this.absoluteTimeout||this.scheduleTimeout(),e.prototype._next.call(this,t)},t.prototype._unsubscribe=function(){this.action=void 0,this.scheduler=null,this.withObservable=null},t}(Tu);function Lp(e,t){return void 0===t&&(t=Da),Cp(e,_a(new Ya),t)}function Up(e,t,n){return 0===n?[t]:(e.push(t),e)}function qp(e){return function(t){return t.lift(new Dp(e))}}var Dp=function(){function e(e){this.windowBoundaries=e}return e.prototype.call=function(e,t){var n=new Vp(e),r=t.subscribe(n);return r.closed||n.add(Au(this.windowBoundaries,new Su(n))),r},e}(),Vp=function(e){function t(t){var n=e.call(this,t)||this;return n.window=new Gs,t.next(n.window),n}return gs(t,e),t.prototype.notifyNext=function(){this.openWindow()},t.prototype.notifyError=function(e){this._error(e)},t.prototype.notifyComplete=function(){this._complete()},t.prototype._next=function(e){this.window.next(e)},t.prototype._error=function(e){this.window.error(e),this.destination.error(e)},t.prototype._complete=function(){this.window.complete(),this.destination.complete()},t.prototype._unsubscribe=function(){this.window=null},t.prototype.openWindow=function(){var e=this.window;e&&e.complete();var t=this.destination,n=this.window=new Gs;t.next(n)},t}(Tu);var Fp=function(){function e(e,t){this.windowSize=e,this.startWindowEvery=t}return e.prototype.call=function(e,t){return t.subscribe(new Hp(e,this.windowSize,this.startWindowEvery))},e}(),Hp=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.destination=t,i.windowSize=n,i.startWindowEvery=r,i.windows=[new Gs],i.count=0,t.next(i.windows[0]),i}return gs(t,e),t.prototype._next=function(e){for(var t=this.startWindowEvery>0?this.startWindowEvery:this.windowSize,n=this.destination,r=this.windowSize,i=this.windows,o=i.length,s=0;s<o&&!this.closed;s++)i[s].next(e);var a=this.count-r+1;if(a>=0&&a%t==0&&!this.closed&&i.shift().complete(),++this.count%t==0&&!this.closed){var u=new Gs;i.push(u),n.next(u)}},t.prototype._error=function(e){var t=this.windows;if(t)for(;t.length>0&&!this.closed;)t.shift().error(e);this.destination.error(e)},t.prototype._complete=function(){var e=this.windows;if(e)for(;e.length>0&&!this.closed;)e.shift().complete();this.destination.complete()},t.prototype._unsubscribe=function(){this.count=0,this.windows=null},t}(Ns);var Wp=function(){function e(e,t,n,r){this.windowTimeSpan=e,this.windowCreationInterval=t,this.maxWindowSize=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new Bp(e,this.windowTimeSpan,this.windowCreationInterval,this.maxWindowSize,this.scheduler))},e}(),Gp=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._numberOfNextedValues=0,t}return gs(t,e),t.prototype.next=function(t){this._numberOfNextedValues++,e.prototype.next.call(this,t)},Object.defineProperty(t.prototype,"numberOfNextedValues",{get:function(){return this._numberOfNextedValues},enumerable:!0,configurable:!0}),t}(Gs),Bp=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;s.destination=t,s.windowTimeSpan=n,s.windowCreationInterval=r,s.maxWindowSize=i,s.scheduler=o,s.windows=[];var a=s.openWindow();if(null!==r&&r>=0){var u={subscriber:s,window:a,context:null},c={windowTimeSpan:n,windowCreationInterval:r,subscriber:s,scheduler:o};s.add(o.schedule(Qp,n,u)),s.add(o.schedule(Jp,r,c))}else{var l={subscriber:s,window:a,windowTimeSpan:n};s.add(o.schedule(zp,n,l))}return s}return gs(t,e),t.prototype._next=function(e){for(var t=this.windows,n=t.length,r=0;r<n;r++){var i=t[r];i.closed||(i.next(e),i.numberOfNextedValues>=this.maxWindowSize&&this.closeWindow(i))}},t.prototype._error=function(e){for(var t=this.windows;t.length>0;)t.shift().error(e);this.destination.error(e)},t.prototype._complete=function(){for(var e=this.windows;e.length>0;){var t=e.shift();t.closed||t.complete()}this.destination.complete()},t.prototype.openWindow=function(){var e=new Gp;return this.windows.push(e),this.destination.next(e),e},t.prototype.closeWindow=function(e){e.complete();var t=this.windows;t.splice(t.indexOf(e),1)},t}(Ns);function zp(e){var t=e.subscriber,n=e.windowTimeSpan,r=e.window;r&&t.closeWindow(r),e.window=t.openWindow(),this.schedule(e,n)}function Jp(e){var t=e.windowTimeSpan,n=e.subscriber,r=e.scheduler,i=e.windowCreationInterval,o=n.openWindow(),s=this,a={action:s,subscription:null},u={subscriber:n,window:o,context:a};a.subscription=r.schedule(Qp,t,u),s.add(a.subscription),s.schedule(e,i)}function Qp(e){var t=e.subscriber,n=e.window,r=e.context;r&&r.action&&r.subscription&&r.action.remove(r.subscription),t.closeWindow(n)}var Yp=function(){function e(e,t){this.openings=e,this.closingSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Kp(e,this.openings,this.closingSelector))},e}(),Kp=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.openings=n,i.closingSelector=r,i.contexts=[],i.add(i.openSubscription=hu(i,n,n)),i}return gs(t,e),t.prototype._next=function(e){var t=this.contexts;if(t)for(var n=t.length,r=0;r<n;r++)t[r].window.next(e)},t.prototype._error=function(t){var n=this.contexts;if(this.contexts=null,n)for(var r=n.length,i=-1;++i<r;){var o=n[i];o.window.error(t),o.subscription.unsubscribe()}e.prototype._error.call(this,t)},t.prototype._complete=function(){var t=this.contexts;if(this.contexts=null,t)for(var n=t.length,r=-1;++r<n;){var i=t[r];i.window.complete(),i.subscription.unsubscribe()}e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){var e=this.contexts;if(this.contexts=null,e)for(var t=e.length,n=-1;++n<t;){var r=e[n];r.window.unsubscribe(),r.subscription.unsubscribe()}},t.prototype.notifyNext=function(e,t,n,r,i){if(e===this.openings){var o=void 0;try{o=(0,this.closingSelector)(t)}catch(e){return this.error(e)}var s=new Gs,a=new ks,u={window:s,subscription:a};this.contexts.push(u);var c=hu(this,o,u);c.closed?this.closeWindow(this.contexts.length-1):(c.context=u,a.add(c)),this.destination.next(s)}else this.closeWindow(this.contexts.indexOf(e))},t.prototype.notifyError=function(e){this.error(e)},t.prototype.notifyComplete=function(e){e!==this.openSubscription&&this.closeWindow(this.contexts.indexOf(e.context))},t.prototype.closeWindow=function(e){if(-1!==e){var t=this.contexts,n=t[e],r=n.window,i=n.subscription;t.splice(e,1),r.complete(),i.unsubscribe()}},t}(iu);var Xp=function(){function e(e){this.closingSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new $p(e,this.closingSelector))},e}(),$p=function(e){function t(t,n){var r=e.call(this,t)||this;return r.destination=t,r.closingSelector=n,r.openWindow(),r}return gs(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.openWindow(i)},t.prototype.notifyError=function(e){this._error(e)},t.prototype.notifyComplete=function(e){this.openWindow(e)},t.prototype._next=function(e){this.window.next(e)},t.prototype._error=function(e){this.window.error(e),this.destination.error(e),this.unsubscribeClosingNotification()},t.prototype._complete=function(){this.window.complete(),this.destination.complete(),this.unsubscribeClosingNotification()},t.prototype.unsubscribeClosingNotification=function(){this.closingNotification&&this.closingNotification.unsubscribe()},t.prototype.openWindow=function(e){void 0===e&&(e=null),e&&(this.remove(e),e.unsubscribe());var t=this.window;t&&t.complete();var n,r=this.window=new Gs;this.destination.next(r);try{n=(0,this.closingSelector)()}catch(e){return this.destination.error(e),void this.window.error(e)}this.add(this.closingNotification=hu(this,n))},t}(iu);function Zp(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){var n;"function"==typeof e[e.length-1]&&(n=e.pop());var r=e;return t.lift(new eh(r,n))}}var eh=function(){function e(e,t){this.observables=e,this.project=t}return e.prototype.call=function(e,t){return t.subscribe(new th(e,this.observables,this.project))},e}(),th=function(e){function t(t,n,r){var i=e.call(this,t)||this;i.observables=n,i.project=r,i.toRespond=[];var o=n.length;i.values=new Array(o);for(var s=0;s<o;s++)i.toRespond.push(s);for(s=0;s<o;s++){var a=n[s];i.add(hu(i,a,void 0,s))}return i}return gs(t,e),t.prototype.notifyNext=function(e,t,n){this.values[n]=t;var r=this.toRespond;if(r.length>0){var i=r.indexOf(n);-1!==i&&r.splice(i,1)}},t.prototype.notifyComplete=function(){},t.prototype._next=function(e){if(0===this.toRespond.length){var t=[e].concat(this.values);this.project?this._tryProject(t):this.destination.next(t)}},t.prototype._tryProject=function(e){var t;try{t=this.project.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(iu);function nh(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return t.lift.call(Zu.apply(void 0,[t].concat(e)))}}var rh,ih,oh=Object.freeze({__proto__:null,audit:Jl,auditTime:Kl,buffer:function(e){return function(t){return t.lift(new Xl(e))}},bufferCount:Zl,bufferTime:function(e){var t=arguments.length,n=Da;ha(arguments[arguments.length-1])&&(n=arguments[arguments.length-1],t--);var r=null;t>=2&&(r=arguments[1]);var i=Number.POSITIVE_INFINITY;return t>=3&&(i=arguments[2]),function(t){return t.lift(new rf(e,r,i,n))}},bufferToggle:function(e,t){return function(n){return n.lift(new lf(e,t))}},bufferWhen:function(e){return function(t){return t.lift(new df(e))}},catchError:hf,combineAll:function(e){return function(t){return t.lift(new bu(e))}},combineLatest:mf,concat:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return t.lift.call(Cu.apply(void 0,[t].concat(e)))}},concatAll:Ru,concatMap:gf,concatMapTo:function(e,t){return gf((function(){return e}),t)},count:function(e){return function(t){return t.lift(new yf(e,t))}},debounce:function(e){return function(t){return t.lift(new wf(e))}},debounceTime:Of,defaultIfEmpty:If,delay:function(e,t){void 0===t&&(t=Da);var n=Dc(e)?+e-t.now():Math.abs(e);return function(e){return e.lift(new Mf(n,t))}},delayWhen:function(e,t){return t?function(n){return new jf(n,t).lift(new Cf(e))}:function(t){return t.lift(new Cf(e))}},dematerialize:function(){return function(e){return e.lift(new Uf)}},distinct:Df,distinctUntilChanged:Hf,distinctUntilKeyChanged:function(e,t){return Hf((function(n,r){return t?t(n[e],r[e]):n[e]===r[e]}))},elementAt:function(e,t){if(e<0)throw new Ja;var n=arguments.length>=2;return function(r){return r.pipe(Gu((function(t,n){return n===e})),Yf(1),n?If(t):Bf((function(){return new Ja})))}},endWith:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return Cu(t,ya.apply(void 0,e))}},every:function(e,t){return function(n){return n.lift(new $f(e,t,n))}},exhaust:function(){return function(e){return e.lift(new ed)}},exhaustMap:function e(t,n){return n?function(r){return r.pipe(e((function(e,r){return Ou(t(e,r)).pipe(Ka((function(t,i){return n(e,t,r,i)})))})))}:function(e){return e.lift(new nd(t))}},expand:function(e,t,n){return void 0===t&&(t=Number.POSITIVE_INFINITY),t=(t||0)<1?Number.POSITIVE_INFINITY:t,function(r){return r.lift(new id(e,t,n))}},filter:Gu,finalize:sd,find:function(e,t){if("function"!=typeof e)throw new TypeError("predicate is not a function");return function(n){return n.lift(new cd(e,n,!1,t))}},findIndex:function(e,t){return function(n){return n.lift(new cd(e,n,!0,t))}},first:function(e,t){var n=arguments.length>=2;return function(r){return r.pipe(e?Gu((function(t,n){return e(t,n,r)})):Ls,Yf(1),n?If(t):Bf((function(){return new Qa})))}},flatMap:Mu,groupBy:$s,ignoreElements:function(){return function(e){return e.lift(new fd)}},isEmpty:function(){return function(e){return e.lift(new pd)}},last:gd,map:Ka,mapTo:yd,materialize:function(){return function(e){return e.lift(new Ed)}},max:function(e){return Sd("function"==typeof e?function(t,n){return e(t,n)>0?t:n}:function(e,t){return e>t?e:t})},merge:Td,mergeAll:Nu,mergeMap:Iu,mergeMapTo:Ad,mergeScan:function(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),function(r){return r.lift(new Id(e,t,n))}},min:function(e){return Sd("function"==typeof e?function(t,n){return e(t,n)<0?t:n}:function(e,t){return e<t?e:t})},multicast:xd,observeOn:function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new Oa(e,t))}},onErrorResumeNext:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1===e.length&&Ts(e[0])&&(e=e[0]),function(t){return t.lift(new Nd(e))}},pairwise:function(){return function(e){return e.lift(new Cd)}},partition:function(e,t){return function(n){return[Gu(e,t)(n),Gu(Wu(e,t))(n)]}},pluck:jd,publish:Ld,publishBehavior:function(e){return function(t){return xd(new ia(e))(t)}},publishLast:function(){return function(e){return xd(new ka)(e)}},publishReplay:Ud,race:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return 1===e.length&&Ts(e[0])&&(e=e[0]),t.lift.call(Ju.apply(void 0,[t].concat(e)))}},reduce:Sd,refCount:zs,repeat:qd,repeatWhen:function(e){return function(t){return t.lift(new Fd(e))}},retry:function(e){return void 0===e&&(e=-1),function(t){return t.lift(new Wd(e,t))}},retryWhen:function(e){return function(t){return t.lift(new Bd(e,t))}},sample:function(e){return function(t){return t.lift(new Jd(e))}},sampleTime:function(e,t){return void 0===t&&(t=Da),function(n){return n.lift(new Yd(e,t))}},scan:Mc,sequenceEqual:function(e,t){return function(n){return n.lift(new $d(e,t))}},share:np,shareReplay:rp,single:function(e){return function(t){return t.lift(new ip(e,t))}},skip:sp,skipLast:function(e){return function(t){return t.lift(new cp(e))}},skipUntil:function(e){return function(t){return t.lift(new fp(e))}},skipWhile:function(e){return function(t){return t.lift(new pp(e))}},startWith:vp,subscribeOn:function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new bp(e,t))}},switchAll:function(){return mp(Ls)},switchMap:mp,switchMapTo:_p,take:Yf,takeLast:vd,takeUntil:wp,takeWhile:function(e,t){return void 0===t&&(t=!1),function(n){return n.lift(new Sp(e,t))}},tap:Ap,throttle:function(e,t){return void 0===t&&(t=Pc),function(n){return n.lift(new jc(e,!!t.leading,!!t.trailing))}},throttleTime:xp,throwIfEmpty:Bf,timeInterval:function(e){return void 0===e&&(e=Da),function(t){return Pu((function(){return t.pipe(Mc((function(t,n){var r=t.current;return{value:n,current:e.now(),last:r}}),{current:e.now(),value:void 0,last:void 0}),Ka((function(e){var t=e.current,n=e.last,r=e.value;return new Cc(r,t-n)})))}))}},timeout:Lp,timeoutWith:Cp,timestamp:function(e){return void 0===e&&(e=Da),Ka((function(t){return new xc(t,e.now())}))},toArray:function(){return Sd(Up,[])},window:qp,windowCount:function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new Fp(e,t))}},windowTime:function(e){var t=Da,n=null,r=Number.POSITIVE_INFINITY;return ha(arguments[3])&&(t=arguments[3]),ha(arguments[2])?t=arguments[2]:qu(arguments[2])&&(r=Number(arguments[2])),ha(arguments[1])?t=arguments[1]:qu(arguments[1])&&(n=Number(arguments[1])),function(i){return i.lift(new Wp(e,n,r,t))}},windowToggle:function(e,t){return function(n){return n.lift(new Yp(e,t))}},windowWhen:function(e){return function(t){return t.lift(new Xp(e))}},withLatestFrom:Zp,zip:nh,zipAll:function(e){return function(t){return t.lift(new ec(e))}}}),sh=n(oh);function ah(){if(ih)return Bl;ih=1,Object.defineProperty(Bl,"__esModule",{value:!0});var e=sc,t=function(){if(rh)return zl;rh=1,Object.defineProperty(zl,"__esModule",{value:!0});var e=sh;return zl.buffer=function(t){return e.buffer(t)(this)},zl}();return e.Observable.prototype.buffer=t.buffer,Bl}var uh,ch,lh={},fh={};function dh(){if(ch)return lh;ch=1,Object.defineProperty(lh,"__esModule",{value:!0});var e=sc,t=function(){if(uh)return fh;uh=1,Object.defineProperty(fh,"__esModule",{value:!0});var e=sh;return fh.bufferCount=function(t,n){return void 0===n&&(n=null),e.bufferCount(t,n)(this)},fh}();return e.Observable.prototype.bufferCount=t.bufferCount,lh}var ph,hh,vh={},bh={};function mh(){if(hh)return vh;hh=1,Object.defineProperty(vh,"__esModule",{value:!0});var e=sc,t=function(){if(ph)return bh;ph=1,Object.defineProperty(bh,"__esModule",{value:!0});var e=sc,t=Wc,n=sh;return bh.bufferTime=function(r){var i=arguments.length,o=e.asyncScheduler;t.isScheduler(arguments[arguments.length-1])&&(o=arguments[arguments.length-1],i--);var s=null;i>=2&&(s=arguments[1]);var a=Number.POSITIVE_INFINITY;return i>=3&&(a=arguments[2]),n.bufferTime(r,s,a,o)(this)},bh}();return e.Observable.prototype.bufferTime=t.bufferTime,vh}var gh,yh,_h={},wh={};function Eh(){if(yh)return _h;yh=1,Object.defineProperty(_h,"__esModule",{value:!0});var e=sc,t=function(){if(gh)return wh;gh=1,Object.defineProperty(wh,"__esModule",{value:!0});var e=sh;return wh.bufferToggle=function(t,n){return e.bufferToggle(t,n)(this)},wh}();return e.Observable.prototype.bufferToggle=t.bufferToggle,_h}var Oh,Sh,Th={},Ah={};function Ih(){if(Sh)return Th;Sh=1,Object.defineProperty(Th,"__esModule",{value:!0});var e=sc,t=function(){if(Oh)return Ah;Oh=1,Object.defineProperty(Ah,"__esModule",{value:!0});var e=sh;return Ah.bufferWhen=function(t){return e.bufferWhen(t)(this)},Ah}();return e.Observable.prototype.bufferWhen=t.bufferWhen,Th}var kh,xh,Mh={},Nh={};function Rh(){if(xh)return Mh;xh=1,Object.defineProperty(Mh,"__esModule",{value:!0});var e=sc,t=function(){if(kh)return Nh;kh=1,Object.defineProperty(Nh,"__esModule",{value:!0});var e=sh;return Nh._catch=function(t){return e.catchError(t)(this)},Nh}();return e.Observable.prototype.catch=t._catch,e.Observable.prototype._catch=t._catch,Mh}var Ch,Ph,jh={},Lh={};function Uh(){if(Ph)return jh;Ph=1,Object.defineProperty(jh,"__esModule",{value:!0});var e=sc,t=function(){if(Ch)return Lh;Ch=1,Object.defineProperty(Lh,"__esModule",{value:!0});var e=sh;return Lh.combineAll=function(t){return e.combineAll(t)(this)},Lh}();return e.Observable.prototype.combineAll=t.combineAll,jh}var qh,Dh,Vh={},Fh={};function Hh(){if(Dh)return Vh;Dh=1,Object.defineProperty(Vh,"__esModule",{value:!0});var e=sc,t=function(){if(qh)return Fh;qh=1,Object.defineProperty(Fh,"__esModule",{value:!0});var e=sc,t=Wc;return Fh.combineLatest=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var i=null;return"function"==typeof n[n.length-1]&&(i=n.pop()),1===n.length&&t.isArray(n[0])&&(n=n[0].slice()),this.lift.call(e.of.apply(void 0,[this].concat(n)),new t.CombineLatestOperator(i))},Fh}();return e.Observable.prototype.combineLatest=t.combineLatest,Vh}var Wh,Gh,Bh={},zh={};function Jh(){if(Gh)return Bh;Gh=1,Object.defineProperty(Bh,"__esModule",{value:!0});var e=sc,t=function(){if(Wh)return zh;Wh=1,Object.defineProperty(zh,"__esModule",{value:!0});var e=sc;return zh.concat=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return this.lift.call(e.concat.apply(void 0,[this].concat(t)))},zh}();return e.Observable.prototype.concat=t.concat,Bh}var Qh,Yh,Kh={},Xh={};function $h(){if(Yh)return Kh;Yh=1,Object.defineProperty(Kh,"__esModule",{value:!0});var e=sc,t=function(){if(Qh)return Xh;Qh=1,Object.defineProperty(Xh,"__esModule",{value:!0});var e=sh;return Xh.concatAll=function(){return e.concatAll()(this)},Xh}();return e.Observable.prototype.concatAll=t.concatAll,Kh}var Zh,ev,tv={},nv={};function rv(){if(ev)return tv;ev=1,Object.defineProperty(tv,"__esModule",{value:!0});var e=sc,t=function(){if(Zh)return nv;Zh=1,Object.defineProperty(nv,"__esModule",{value:!0});var e=sh;return nv.concatMap=function(t){return e.concatMap(t)(this)},nv}();return e.Observable.prototype.concatMap=t.concatMap,tv}var iv,ov,sv={},av={};function uv(){if(ov)return sv;ov=1,Object.defineProperty(sv,"__esModule",{value:!0});var e=sc,t=function(){if(iv)return av;iv=1,Object.defineProperty(av,"__esModule",{value:!0});var e=sh;return av.concatMapTo=function(t){return e.concatMapTo(t)(this)},av}();return e.Observable.prototype.concatMapTo=t.concatMapTo,sv}var cv,lv,fv={},dv={};function pv(){if(lv)return fv;lv=1,Object.defineProperty(fv,"__esModule",{value:!0});var e=sc,t=function(){if(cv)return dv;cv=1,Object.defineProperty(dv,"__esModule",{value:!0});var e=sh;return dv.count=function(t){return e.count(t)(this)},dv}();return e.Observable.prototype.count=t.count,fv}var hv,vv,bv={},mv={};function gv(){if(vv)return bv;vv=1,Object.defineProperty(bv,"__esModule",{value:!0});var e=sc,t=function(){if(hv)return mv;hv=1,Object.defineProperty(mv,"__esModule",{value:!0});var e=sh;return mv.dematerialize=function(){return e.dematerialize()(this)},mv}();return e.Observable.prototype.dematerialize=t.dematerialize,bv}var yv,_v,wv={},Ev={};function Ov(){if(_v)return wv;_v=1,Object.defineProperty(wv,"__esModule",{value:!0});var e=sc,t=function(){if(yv)return Ev;yv=1,Object.defineProperty(Ev,"__esModule",{value:!0});var e=sh;return Ev.debounce=function(t){return e.debounce(t)(this)},Ev}();return e.Observable.prototype.debounce=t.debounce,wv}var Sv,Tv,Av={},Iv={};function kv(){if(Tv)return Av;Tv=1,Object.defineProperty(Av,"__esModule",{value:!0});var e=sc,t=function(){if(Sv)return Iv;Sv=1,Object.defineProperty(Iv,"__esModule",{value:!0});var e=sc,t=sh;return Iv.debounceTime=function(n,r){return void 0===r&&(r=e.asyncScheduler),t.debounceTime(n,r)(this)},Iv}();return e.Observable.prototype.debounceTime=t.debounceTime,Av}var xv,Mv,Nv={},Rv={};function Cv(){if(Mv)return Nv;Mv=1,Object.defineProperty(Nv,"__esModule",{value:!0});var e=sc,t=function(){if(xv)return Rv;xv=1,Object.defineProperty(Rv,"__esModule",{value:!0});var e=sh;return Rv.defaultIfEmpty=function(t){return void 0===t&&(t=null),e.defaultIfEmpty(t)(this)},Rv}();return e.Observable.prototype.defaultIfEmpty=t.defaultIfEmpty,Nv}var Pv,jv,Lv={},Uv={};function qv(){if(jv)return Lv;jv=1,Object.defineProperty(Lv,"__esModule",{value:!0});var e=sc,t=function(){if(Pv)return Uv;Pv=1,Object.defineProperty(Uv,"__esModule",{value:!0});var e=sc,t=sh;return Uv.delay=function(n,r){return void 0===r&&(r=e.asyncScheduler),t.delay(n,r)(this)},Uv}();return e.Observable.prototype.delay=t.delay,Lv}var Dv,Vv,Fv={},Hv={};function Wv(){if(Vv)return Fv;Vv=1,Object.defineProperty(Fv,"__esModule",{value:!0});var e=sc,t=function(){if(Dv)return Hv;Dv=1,Object.defineProperty(Hv,"__esModule",{value:!0});var e=sh;return Hv.delayWhen=function(t,n){return e.delayWhen(t,n)(this)},Hv}();return e.Observable.prototype.delayWhen=t.delayWhen,Fv}var Gv,Bv,zv={},Jv={};function Qv(){if(Bv)return zv;Bv=1,Object.defineProperty(zv,"__esModule",{value:!0});var e=sc,t=function(){if(Gv)return Jv;Gv=1,Object.defineProperty(Jv,"__esModule",{value:!0});var e=sh;return Jv.distinct=function(t,n){return e.distinct(t,n)(this)},Jv}();return e.Observable.prototype.distinct=t.distinct,zv}var Yv,Kv,Xv={},$v={};function Zv(){if(Kv)return Xv;Kv=1,Object.defineProperty(Xv,"__esModule",{value:!0});var e=sc,t=function(){if(Yv)return $v;Yv=1,Object.defineProperty($v,"__esModule",{value:!0});var e=sh;return $v.distinctUntilChanged=function(t,n){return e.distinctUntilChanged(t,n)(this)},$v}();return e.Observable.prototype.distinctUntilChanged=t.distinctUntilChanged,Xv}var eb,tb,nb={},rb={};function ib(){if(tb)return nb;tb=1,Object.defineProperty(nb,"__esModule",{value:!0});var e=sc,t=function(){if(eb)return rb;eb=1,Object.defineProperty(rb,"__esModule",{value:!0});var e=sh;return rb.distinctUntilKeyChanged=function(t,n){return e.distinctUntilKeyChanged(t,n)(this)},rb}();return e.Observable.prototype.distinctUntilKeyChanged=t.distinctUntilKeyChanged,nb}var ob,sb,ab={},ub={};function cb(){if(sb)return ab;sb=1,Object.defineProperty(ab,"__esModule",{value:!0});var e=sc,t=function(){if(ob)return ub;ob=1,Object.defineProperty(ub,"__esModule",{value:!0});var e=sh;return ub._do=function(t,n,r){return e.tap(t,n,r)(this)},ub}();return e.Observable.prototype.do=t._do,e.Observable.prototype._do=t._do,ab}var lb,fb,db={},pb={};function hb(){if(fb)return db;fb=1,Object.defineProperty(db,"__esModule",{value:!0});var e=sc,t=function(){if(lb)return pb;lb=1,Object.defineProperty(pb,"__esModule",{value:!0});var e=sh;return pb.exhaust=function(){return e.exhaust()(this)},pb}();return e.Observable.prototype.exhaust=t.exhaust,db}var vb,bb,mb={},gb={};function yb(){if(bb)return mb;bb=1,Object.defineProperty(mb,"__esModule",{value:!0});var e=sc,t=function(){if(vb)return gb;vb=1,Object.defineProperty(gb,"__esModule",{value:!0});var e=sh;return gb.exhaustMap=function(t){return e.exhaustMap(t)(this)},gb}();return e.Observable.prototype.exhaustMap=t.exhaustMap,mb}var _b,wb,Eb={},Ob={};function Sb(){if(wb)return Eb;wb=1,Object.defineProperty(Eb,"__esModule",{value:!0});var e=sc,t=function(){if(_b)return Ob;_b=1,Object.defineProperty(Ob,"__esModule",{value:!0});var e=sh;return Ob.expand=function(t,n,r){return void 0===n&&(n=Number.POSITIVE_INFINITY),void 0===r&&(r=void 0),n=(n||0)<1?Number.POSITIVE_INFINITY:n,e.expand(t,n,r)(this)},Ob}();return e.Observable.prototype.expand=t.expand,Eb}var Tb,Ab,Ib={},kb={};function xb(){if(Ab)return Ib;Ab=1,Object.defineProperty(Ib,"__esModule",{value:!0});var e=sc,t=function(){if(Tb)return kb;Tb=1,Object.defineProperty(kb,"__esModule",{value:!0});var e=sh;return kb.elementAt=function(t,n){return e.elementAt.apply(void 0,arguments)(this)},kb}();return e.Observable.prototype.elementAt=t.elementAt,Ib}var Mb,Nb,Rb={},Cb={};function Pb(){if(Nb)return Rb;Nb=1,Object.defineProperty(Rb,"__esModule",{value:!0});var e=sc,t=function(){if(Mb)return Cb;Mb=1,Object.defineProperty(Cb,"__esModule",{value:!0});var e=sh;return Cb.filter=function(t,n){return e.filter(t,n)(this)},Cb}();return e.Observable.prototype.filter=t.filter,Rb}var jb,Lb,Ub={},qb={};function Db(){if(Lb)return Ub;Lb=1,Object.defineProperty(Ub,"__esModule",{value:!0});var e=sc,t=function(){if(jb)return qb;jb=1,Object.defineProperty(qb,"__esModule",{value:!0});var e=sh;return qb._finally=function(t){return e.finalize(t)(this)},qb}();return e.Observable.prototype.finally=t._finally,e.Observable.prototype._finally=t._finally,Ub}var Vb,Fb,Hb={},Wb={};function Gb(){if(Fb)return Hb;Fb=1,Object.defineProperty(Hb,"__esModule",{value:!0});var e=sc,t=function(){if(Vb)return Wb;Vb=1,Object.defineProperty(Wb,"__esModule",{value:!0});var e=sh;return Wb.find=function(t,n){return e.find(t,n)(this)},Wb}();return e.Observable.prototype.find=t.find,Hb}var Bb,zb,Jb={},Qb={};function Yb(){if(zb)return Jb;zb=1,Object.defineProperty(Jb,"__esModule",{value:!0});var e=sc,t=function(){if(Bb)return Qb;Bb=1,Object.defineProperty(Qb,"__esModule",{value:!0});var e=sh;return Qb.findIndex=function(t,n){return e.findIndex(t,n)(this)},Qb}();return e.Observable.prototype.findIndex=t.findIndex,Jb}var Kb,Xb,$b={},Zb={};function em(){if(Xb)return $b;Xb=1,Object.defineProperty($b,"__esModule",{value:!0});var e=sc,t=function(){if(Kb)return Zb;Kb=1,Object.defineProperty(Zb,"__esModule",{value:!0});var e=sh;return Zb.first=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.first.apply(void 0,t)(this)},Zb}();return e.Observable.prototype.first=t.first,$b}var tm,nm,rm={},im={};function om(){if(nm)return rm;nm=1,Object.defineProperty(rm,"__esModule",{value:!0});var e=sc,t=function(){if(tm)return im;tm=1,Object.defineProperty(im,"__esModule",{value:!0});var e=sh;return im.groupBy=function(t,n,r,i){return e.groupBy(t,n,r,i)(this)},im}();return e.Observable.prototype.groupBy=t.groupBy,rm}var am,um,cm={},lm={};function fm(){if(um)return cm;um=1,Object.defineProperty(cm,"__esModule",{value:!0});var e=sc,t=function(){if(am)return lm;am=1,Object.defineProperty(lm,"__esModule",{value:!0});var e=sh;return lm.ignoreElements=function(){return e.ignoreElements()(this)},lm}();return e.Observable.prototype.ignoreElements=t.ignoreElements,cm}var dm,pm,hm={},vm={};function bm(){if(pm)return hm;pm=1,Object.defineProperty(hm,"__esModule",{value:!0});var e=sc,t=function(){if(dm)return vm;dm=1,Object.defineProperty(vm,"__esModule",{value:!0});var e=sh;return vm.isEmpty=function(){return e.isEmpty()(this)},vm}();return e.Observable.prototype.isEmpty=t.isEmpty,hm}var mm,gm,ym={},_m={};function wm(){if(gm)return ym;gm=1,Object.defineProperty(ym,"__esModule",{value:!0});var e=sc,t=function(){if(mm)return _m;mm=1,Object.defineProperty(_m,"__esModule",{value:!0});var e=sh;return _m.audit=function(t){return e.audit(t)(this)},_m}();return e.Observable.prototype.audit=t.audit,ym}var Em,Om,Sm={},Tm={};function Am(){if(Om)return Sm;Om=1,Object.defineProperty(Sm,"__esModule",{value:!0});var e=sc,t=function(){if(Em)return Tm;Em=1,Object.defineProperty(Tm,"__esModule",{value:!0});var e=sc,t=sh;return Tm.auditTime=function(n,r){return void 0===r&&(r=e.asyncScheduler),t.auditTime(n,r)(this)},Tm}();return e.Observable.prototype.auditTime=t.auditTime,Sm}var Im,km,xm={},Mm={};function Nm(){if(km)return xm;km=1,Object.defineProperty(xm,"__esModule",{value:!0});var e=sc,t=function(){if(Im)return Mm;Im=1,Object.defineProperty(Mm,"__esModule",{value:!0});var e=sh;return Mm.last=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.last.apply(void 0,t)(this)},Mm}();return e.Observable.prototype.last=t.last,xm}var Rm,Cm,Pm={},jm={};function Lm(){if(Cm)return Pm;Cm=1,Object.defineProperty(Pm,"__esModule",{value:!0});var e=sc,t=(Rm||(Rm=1,Object.defineProperty(jm,"__esModule",{value:!0}),jm.letProto=function(e){return e(this)}),jm);return e.Observable.prototype.let=t.letProto,e.Observable.prototype.letBind=t.letProto,Pm}var Um,qm,Dm={},Vm={};function Fm(){if(qm)return Dm;qm=1,Object.defineProperty(Dm,"__esModule",{value:!0});var e=sc,t=function(){if(Um)return Vm;Um=1,Object.defineProperty(Vm,"__esModule",{value:!0});var e=sh;return Vm.every=function(t,n){return e.every(t,n)(this)},Vm}();return e.Observable.prototype.every=t.every,Dm}var Hm,Wm,Gm={},Bm={};function zm(){if(Wm)return Gm;Wm=1,Object.defineProperty(Gm,"__esModule",{value:!0});var e=sc,t=function(){if(Hm)return Bm;Hm=1,Object.defineProperty(Bm,"__esModule",{value:!0});var e=sh;return Bm.map=function(t,n){return e.map(t,n)(this)},Bm}();return e.Observable.prototype.map=t.map,Gm}var Jm,Qm,Ym={},Km={};function Xm(){if(Qm)return Ym;Qm=1,Object.defineProperty(Ym,"__esModule",{value:!0});var e=sc,t=function(){if(Jm)return Km;Jm=1,Object.defineProperty(Km,"__esModule",{value:!0});var e=sh;return Km.mapTo=function(t){return e.mapTo(t)(this)},Km}();return e.Observable.prototype.mapTo=t.mapTo,Ym}var $m,Zm,eg={},tg={};function ng(){if(Zm)return eg;Zm=1,Object.defineProperty(eg,"__esModule",{value:!0});var e=sc,t=function(){if($m)return tg;$m=1,Object.defineProperty(tg,"__esModule",{value:!0});var e=sh;return tg.materialize=function(){return e.materialize()(this)},tg}();return e.Observable.prototype.materialize=t.materialize,eg}var rg,ig,og={},sg={};function ag(){if(ig)return og;ig=1,Object.defineProperty(og,"__esModule",{value:!0});var e=sc,t=function(){if(rg)return sg;rg=1,Object.defineProperty(sg,"__esModule",{value:!0});var e=sh;return sg.max=function(t){return e.max(t)(this)},sg}();return e.Observable.prototype.max=t.max,og}var ug,cg,lg={},fg={};function dg(){if(cg)return lg;cg=1,Object.defineProperty(lg,"__esModule",{value:!0});var e=sc,t=function(){if(ug)return fg;ug=1,Object.defineProperty(fg,"__esModule",{value:!0});var e=sc;return fg.merge=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return this.lift.call(e.merge.apply(void 0,[this].concat(t)))},fg}();return e.Observable.prototype.merge=t.merge,lg}var pg,hg,vg={},bg={};function mg(){if(hg)return vg;hg=1,Object.defineProperty(vg,"__esModule",{value:!0});var e=sc,t=function(){if(pg)return bg;pg=1,Object.defineProperty(bg,"__esModule",{value:!0});var e=sh;return bg.mergeAll=function(t){return void 0===t&&(t=Number.POSITIVE_INFINITY),e.mergeAll(t)(this)},bg}();return e.Observable.prototype.mergeAll=t.mergeAll,vg}var gg,yg,_g={},wg={};function Eg(){if(yg)return _g;yg=1,Object.defineProperty(_g,"__esModule",{value:!0});var e=sc,t=function(){if(gg)return wg;gg=1,Object.defineProperty(wg,"__esModule",{value:!0});var e=sh;return wg.mergeMap=function(t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),e.mergeMap(t,n)(this)},wg}();return e.Observable.prototype.mergeMap=t.mergeMap,e.Observable.prototype.flatMap=t.mergeMap,_g}var Og,Sg,Tg={},Ag={};function Ig(){if(Sg)return Tg;Sg=1,Object.defineProperty(Tg,"__esModule",{value:!0});var e=sc,t=function(){if(Og)return Ag;Og=1,Object.defineProperty(Ag,"__esModule",{value:!0});var e=sh;return Ag.mergeMapTo=function(t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),e.mergeMapTo(t,n)(this)},Ag}();return e.Observable.prototype.flatMapTo=t.mergeMapTo,e.Observable.prototype.mergeMapTo=t.mergeMapTo,Tg}var kg,xg,Mg={},Ng={};function Rg(){if(xg)return Mg;xg=1,Object.defineProperty(Mg,"__esModule",{value:!0});var e=sc,t=function(){if(kg)return Ng;kg=1,Object.defineProperty(Ng,"__esModule",{value:!0});var e=sh;return Ng.mergeScan=function(t,n,r){return void 0===r&&(r=Number.POSITIVE_INFINITY),e.mergeScan(t,n,r)(this)},Ng}();return e.Observable.prototype.mergeScan=t.mergeScan,Mg}var Cg,Pg,jg={},Lg={};function Ug(){if(Pg)return jg;Pg=1,Object.defineProperty(jg,"__esModule",{value:!0});var e=sc,t=function(){if(Cg)return Lg;Cg=1,Object.defineProperty(Lg,"__esModule",{value:!0});var e=sh;return Lg.min=function(t){return e.min(t)(this)},Lg}();return e.Observable.prototype.min=t.min,jg}var qg,Dg,Vg={},Fg={};function Hg(){if(Dg)return Vg;Dg=1,Object.defineProperty(Vg,"__esModule",{value:!0});var e=sc,t=function(){if(qg)return Fg;qg=1,Object.defineProperty(Fg,"__esModule",{value:!0});var e=sh;return Fg.multicast=function(t,n){return e.multicast(t,n)(this)},Fg}();return e.Observable.prototype.multicast=t.multicast,Vg}var Wg,Gg,Bg={},zg={};function Jg(){if(Gg)return Bg;Gg=1,Object.defineProperty(Bg,"__esModule",{value:!0});var e=sc,t=function(){if(Wg)return zg;Wg=1,Object.defineProperty(zg,"__esModule",{value:!0});var e=sh;return zg.observeOn=function(t,n){return void 0===n&&(n=0),e.observeOn(t,n)(this)},zg}();return e.Observable.prototype.observeOn=t.observeOn,Bg}var Qg,Yg,Kg={},Xg={};function $g(){if(Yg)return Kg;Yg=1,Object.defineProperty(Kg,"__esModule",{value:!0});var e=sc,t=function(){if(Qg)return Xg;Qg=1,Object.defineProperty(Xg,"__esModule",{value:!0});var e=sh;return Xg.onErrorResumeNext=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.onErrorResumeNext.apply(void 0,t)(this)},Xg}();return e.Observable.prototype.onErrorResumeNext=t.onErrorResumeNext,Kg}var Zg,ey,ty={},ny={};function ry(){if(ey)return ty;ey=1,Object.defineProperty(ty,"__esModule",{value:!0});var e=sc,t=function(){if(Zg)return ny;Zg=1,Object.defineProperty(ny,"__esModule",{value:!0});var e=sh;return ny.pairwise=function(){return e.pairwise()(this)},ny}();return e.Observable.prototype.pairwise=t.pairwise,ty}var iy,oy,sy={},ay={};function uy(){if(oy)return sy;oy=1,Object.defineProperty(sy,"__esModule",{value:!0});var e=sc,t=function(){if(iy)return ay;iy=1,Object.defineProperty(ay,"__esModule",{value:!0});var e=sh;return ay.partition=function(t,n){return e.partition(t,n)(this)},ay}();return e.Observable.prototype.partition=t.partition,sy}var cy,ly,fy={},dy={};function py(){if(ly)return fy;ly=1,Object.defineProperty(fy,"__esModule",{value:!0});var e=sc,t=function(){if(cy)return dy;cy=1,Object.defineProperty(dy,"__esModule",{value:!0});var e=sh;return dy.pluck=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.pluck.apply(void 0,t)(this)},dy}();return e.Observable.prototype.pluck=t.pluck,fy}var hy,vy,by={},my={};function gy(){if(vy)return by;vy=1,Object.defineProperty(by,"__esModule",{value:!0});var e=sc,t=function(){if(hy)return my;hy=1,Object.defineProperty(my,"__esModule",{value:!0});var e=sh;return my.publish=function(t){return e.publish(t)(this)},my}();return e.Observable.prototype.publish=t.publish,by}var yy,_y,wy={},Ey={};function Oy(){if(_y)return wy;_y=1,Object.defineProperty(wy,"__esModule",{value:!0});var e=sc,t=function(){if(yy)return Ey;yy=1,Object.defineProperty(Ey,"__esModule",{value:!0});var e=sh;return Ey.publishBehavior=function(t){return e.publishBehavior(t)(this)},Ey}();return e.Observable.prototype.publishBehavior=t.publishBehavior,wy}var Sy,Ty,Ay={},Iy={};function ky(){if(Ty)return Ay;Ty=1,Object.defineProperty(Ay,"__esModule",{value:!0});var e=sc,t=function(){if(Sy)return Iy;Sy=1,Object.defineProperty(Iy,"__esModule",{value:!0});var e=sh;return Iy.publishReplay=function(t,n,r,i){return e.publishReplay(t,n,r,i)(this)},Iy}();return e.Observable.prototype.publishReplay=t.publishReplay,Ay}var xy,My,Ny={},Ry={};function Cy(){if(My)return Ny;My=1,Object.defineProperty(Ny,"__esModule",{value:!0});var e=sc,t=function(){if(xy)return Ry;xy=1,Object.defineProperty(Ry,"__esModule",{value:!0});var e=sh;return Ry.publishLast=function(){return e.publishLast()(this)},Ry}();return e.Observable.prototype.publishLast=t.publishLast,Ny}var Py,jy,Ly={},Uy={};function qy(){if(jy)return Ly;jy=1,Object.defineProperty(Ly,"__esModule",{value:!0});var e=sc,t=function(){if(Py)return Uy;Py=1,Object.defineProperty(Uy,"__esModule",{value:!0});var e=sh;return Uy.race=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.race.apply(void 0,t)(this)},Uy}();return e.Observable.prototype.race=t.race,Ly}var Dy,Vy,Fy={},Hy={};function Wy(){if(Vy)return Fy;Vy=1,Object.defineProperty(Fy,"__esModule",{value:!0});var e=sc,t=function(){if(Dy)return Hy;Dy=1,Object.defineProperty(Hy,"__esModule",{value:!0});var e=sh;return Hy.reduce=function(t,n){return arguments.length>=2?e.reduce(t,n)(this):e.reduce(t)(this)},Hy}();return e.Observable.prototype.reduce=t.reduce,Fy}var Gy,By,zy={},Jy={};function Qy(){if(By)return zy;By=1,Object.defineProperty(zy,"__esModule",{value:!0});var e=sc,t=function(){if(Gy)return Jy;Gy=1,Object.defineProperty(Jy,"__esModule",{value:!0});var e=sh;return Jy.repeat=function(t){return void 0===t&&(t=-1),e.repeat(t)(this)},Jy}();return e.Observable.prototype.repeat=t.repeat,zy}var Yy,Ky,Xy={},$y={};function Zy(){if(Ky)return Xy;Ky=1,Object.defineProperty(Xy,"__esModule",{value:!0});var e=sc,t=function(){if(Yy)return $y;Yy=1,Object.defineProperty($y,"__esModule",{value:!0});var e=sh;return $y.repeatWhen=function(t){return e.repeatWhen(t)(this)},$y}();return e.Observable.prototype.repeatWhen=t.repeatWhen,Xy}var e_,t_,n_={},r_={};function i_(){if(t_)return n_;t_=1,Object.defineProperty(n_,"__esModule",{value:!0});var e=sc,t=function(){if(e_)return r_;e_=1,Object.defineProperty(r_,"__esModule",{value:!0});var e=sh;return r_.retry=function(t){return void 0===t&&(t=-1),e.retry(t)(this)},r_}();return e.Observable.prototype.retry=t.retry,n_}var o_,s_,a_={},u_={};function c_(){if(s_)return a_;s_=1,Object.defineProperty(a_,"__esModule",{value:!0});var e=sc,t=function(){if(o_)return u_;o_=1,Object.defineProperty(u_,"__esModule",{value:!0});var e=sh;return u_.retryWhen=function(t){return e.retryWhen(t)(this)},u_}();return e.Observable.prototype.retryWhen=t.retryWhen,a_}var l_,f_,d_={},p_={};function h_(){if(f_)return d_;f_=1,Object.defineProperty(d_,"__esModule",{value:!0});var e=sc,t=function(){if(l_)return p_;l_=1,Object.defineProperty(p_,"__esModule",{value:!0});var e=sh;return p_.sample=function(t){return e.sample(t)(this)},p_}();return e.Observable.prototype.sample=t.sample,d_}var v_,b_,m_={},g_={};function y_(){if(b_)return m_;b_=1,Object.defineProperty(m_,"__esModule",{value:!0});var e=sc,t=function(){if(v_)return g_;v_=1,Object.defineProperty(g_,"__esModule",{value:!0});var e=sc,t=sh;return g_.sampleTime=function(n,r){return void 0===r&&(r=e.asyncScheduler),t.sampleTime(n,r)(this)},g_}();return e.Observable.prototype.sampleTime=t.sampleTime,m_}var __,w_,E_={},O_={};function S_(){if(w_)return E_;w_=1,Object.defineProperty(E_,"__esModule",{value:!0});var e=sc,t=function(){if(__)return O_;__=1,Object.defineProperty(O_,"__esModule",{value:!0});var e=sh;return O_.scan=function(t,n){return arguments.length>=2?e.scan(t,n)(this):e.scan(t)(this)},O_}();return e.Observable.prototype.scan=t.scan,E_}var T_,A_,I_={},k_={};function x_(){if(A_)return I_;A_=1,Object.defineProperty(I_,"__esModule",{value:!0});var e=sc,t=function(){if(T_)return k_;T_=1,Object.defineProperty(k_,"__esModule",{value:!0});var e=sh;return k_.sequenceEqual=function(t,n){return e.sequenceEqual(t,n)(this)},k_}();return e.Observable.prototype.sequenceEqual=t.sequenceEqual,I_}var M_,N_,R_={},C_={};function P_(){if(N_)return R_;N_=1,Object.defineProperty(R_,"__esModule",{value:!0});var e=sc,t=function(){if(M_)return C_;M_=1,Object.defineProperty(C_,"__esModule",{value:!0});var e=sh;return C_.share=function(){return e.share()(this)},C_}();return e.Observable.prototype.share=t.share,R_}var j_,L_,U_={},q_={};function D_(){if(L_)return U_;L_=1,Object.defineProperty(U_,"__esModule",{value:!0});var e=sc,t=function(){if(j_)return q_;j_=1,Object.defineProperty(q_,"__esModule",{value:!0});var e=sh;return q_.shareReplay=function(t,n,r){return t&&"object"===y(t)?e.shareReplay(t)(this):e.shareReplay(t,n,r)(this)},q_}();return e.Observable.prototype.shareReplay=t.shareReplay,U_}var V_,F_,H_={},W_={};function G_(){if(F_)return H_;F_=1,Object.defineProperty(H_,"__esModule",{value:!0});var e=sc,t=function(){if(V_)return W_;V_=1,Object.defineProperty(W_,"__esModule",{value:!0});var e=sh;return W_.single=function(t){return e.single(t)(this)},W_}();return e.Observable.prototype.single=t.single,H_}var B_,z_,J_={},Q_={};function Y_(){if(z_)return J_;z_=1,Object.defineProperty(J_,"__esModule",{value:!0});var e=sc,t=function(){if(B_)return Q_;B_=1,Object.defineProperty(Q_,"__esModule",{value:!0});var e=sh;return Q_.skip=function(t){return e.skip(t)(this)},Q_}();return e.Observable.prototype.skip=t.skip,J_}var K_,X_,$_={},Z_={};function ew(){if(X_)return $_;X_=1,Object.defineProperty($_,"__esModule",{value:!0});var e=sc,t=function(){if(K_)return Z_;K_=1,Object.defineProperty(Z_,"__esModule",{value:!0});var e=sh;return Z_.skipLast=function(t){return e.skipLast(t)(this)},Z_}();return e.Observable.prototype.skipLast=t.skipLast,$_}var tw,nw,rw={},iw={};function ow(){if(nw)return rw;nw=1,Object.defineProperty(rw,"__esModule",{value:!0});var e=sc,t=function(){if(tw)return iw;tw=1,Object.defineProperty(iw,"__esModule",{value:!0});var e=sh;return iw.skipUntil=function(t){return e.skipUntil(t)(this)},iw}();return e.Observable.prototype.skipUntil=t.skipUntil,rw}var sw,aw,uw={},cw={};function lw(){if(aw)return uw;aw=1,Object.defineProperty(uw,"__esModule",{value:!0});var e=sc,t=function(){if(sw)return cw;sw=1,Object.defineProperty(cw,"__esModule",{value:!0});var e=sh;return cw.skipWhile=function(t){return e.skipWhile(t)(this)},cw}();return e.Observable.prototype.skipWhile=t.skipWhile,uw}var fw,dw,pw={},hw={};function vw(){if(dw)return pw;dw=1,Object.defineProperty(pw,"__esModule",{value:!0});var e=sc,t=function(){if(fw)return hw;fw=1,Object.defineProperty(hw,"__esModule",{value:!0});var e=sh;return hw.startWith=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.startWith.apply(void 0,t)(this)},hw}();return e.Observable.prototype.startWith=t.startWith,pw}var bw,mw,gw={},yw={};function _w(){if(mw)return gw;mw=1,Object.defineProperty(gw,"__esModule",{value:!0});var e=sc,t=function(){if(bw)return yw;bw=1,Object.defineProperty(yw,"__esModule",{value:!0});var e=sh;return yw.subscribeOn=function(t,n){return void 0===n&&(n=0),e.subscribeOn(t,n)(this)},yw}();return e.Observable.prototype.subscribeOn=t.subscribeOn,gw}var ww,Ew,Ow={},Sw={};function Tw(){if(Ew)return Ow;Ew=1,Object.defineProperty(Ow,"__esModule",{value:!0});var e=sc,t=function(){if(ww)return Sw;ww=1,Object.defineProperty(Sw,"__esModule",{value:!0});var e=sh;return Sw._switch=function(){return e.switchAll()(this)},Sw}();return e.Observable.prototype.switch=t._switch,e.Observable.prototype._switch=t._switch,Ow}var Aw,Iw,kw={},xw={};function Mw(){if(Iw)return kw;Iw=1,Object.defineProperty(kw,"__esModule",{value:!0});var e=sc,t=function(){if(Aw)return xw;Aw=1,Object.defineProperty(xw,"__esModule",{value:!0});var e=sh;return xw.switchMap=function(t){return e.switchMap(t)(this)},xw}();return e.Observable.prototype.switchMap=t.switchMap,kw}var Nw,Rw,Cw={},Pw={};function jw(){if(Rw)return Cw;Rw=1,Object.defineProperty(Cw,"__esModule",{value:!0});var e=sc,t=function(){if(Nw)return Pw;Nw=1,Object.defineProperty(Pw,"__esModule",{value:!0});var e=sh;return Pw.switchMapTo=function(t){return e.switchMapTo(t)(this)},Pw}();return e.Observable.prototype.switchMapTo=t.switchMapTo,Cw}var Lw,Uw,qw={},Dw={};function Vw(){if(Uw)return qw;Uw=1,Object.defineProperty(qw,"__esModule",{value:!0});var e=sc,t=function(){if(Lw)return Dw;Lw=1,Object.defineProperty(Dw,"__esModule",{value:!0});var e=sh;return Dw.take=function(t){return e.take(t)(this)},Dw}();return e.Observable.prototype.take=t.take,qw}var Fw,Hw,Ww={},Gw={};function Bw(){if(Hw)return Ww;Hw=1,Object.defineProperty(Ww,"__esModule",{value:!0});var e=sc,t=function(){if(Fw)return Gw;Fw=1,Object.defineProperty(Gw,"__esModule",{value:!0});var e=sh;return Gw.takeLast=function(t){return e.takeLast(t)(this)},Gw}();return e.Observable.prototype.takeLast=t.takeLast,Ww}var zw,Jw,Qw={},Yw={};function Kw(){if(Jw)return Qw;Jw=1,Object.defineProperty(Qw,"__esModule",{value:!0});var e=sc,t=function(){if(zw)return Yw;zw=1,Object.defineProperty(Yw,"__esModule",{value:!0});var e=sh;return Yw.takeUntil=function(t){return e.takeUntil(t)(this)},Yw}();return e.Observable.prototype.takeUntil=t.takeUntil,Qw}var Xw,$w,Zw={},eE={};function tE(){if($w)return Zw;$w=1,Object.defineProperty(Zw,"__esModule",{value:!0});var e=sc,t=function(){if(Xw)return eE;Xw=1,Object.defineProperty(eE,"__esModule",{value:!0});var e=sh;return eE.takeWhile=function(t){return e.takeWhile(t)(this)},eE}();return e.Observable.prototype.takeWhile=t.takeWhile,Zw}var nE,rE,iE={},oE={};function sE(){if(rE)return iE;rE=1,Object.defineProperty(iE,"__esModule",{value:!0});var e=sc,t=function(){if(nE)return oE;nE=1,Object.defineProperty(oE,"__esModule",{value:!0});var e=sh,t=Wc;return oE.throttle=function(n,r){return void 0===r&&(r=t.defaultThrottleConfig),e.throttle(n,r)(this)},oE}();return e.Observable.prototype.throttle=t.throttle,iE}var aE,uE,cE={},lE={};function fE(){if(uE)return cE;uE=1,Object.defineProperty(cE,"__esModule",{value:!0});var e=sc,t=function(){if(aE)return lE;aE=1,Object.defineProperty(lE,"__esModule",{value:!0});var e=sc,t=Wc,n=sh;return lE.throttleTime=function(r,i,o){return void 0===i&&(i=e.asyncScheduler),void 0===o&&(o=t.defaultThrottleConfig),n.throttleTime(r,i,o)(this)},lE}();return e.Observable.prototype.throttleTime=t.throttleTime,cE}var dE,pE,hE={},vE={};function bE(){if(pE)return hE;pE=1,Object.defineProperty(hE,"__esModule",{value:!0});var e=sc,t=function(){if(dE)return vE;dE=1,Object.defineProperty(vE,"__esModule",{value:!0});var e=sc,t=sh;return vE.timeInterval=function(n){return void 0===n&&(n=e.asyncScheduler),t.timeInterval(n)(this)},vE}();return e.Observable.prototype.timeInterval=t.timeInterval,hE}var mE,gE,yE={},_E={};function wE(){if(gE)return yE;gE=1,Object.defineProperty(yE,"__esModule",{value:!0});var e=sc,t=function(){if(mE)return _E;mE=1,Object.defineProperty(_E,"__esModule",{value:!0});var e=sc,t=sh;return _E.timeout=function(n,r){return void 0===r&&(r=e.asyncScheduler),t.timeout(n,r)(this)},_E}();return e.Observable.prototype.timeout=t.timeout,yE}var EE,OE,SE={},TE={};function AE(){if(OE)return SE;OE=1,Object.defineProperty(SE,"__esModule",{value:!0});var e=sc,t=function(){if(EE)return TE;EE=1,Object.defineProperty(TE,"__esModule",{value:!0});var e=sc,t=sh;return TE.timeoutWith=function(n,r,i){return void 0===i&&(i=e.asyncScheduler),t.timeoutWith(n,r,i)(this)},TE}();return e.Observable.prototype.timeoutWith=t.timeoutWith,SE}var IE,kE,xE={},ME={};function NE(){if(kE)return xE;kE=1,Object.defineProperty(xE,"__esModule",{value:!0});var e=sc,t=function(){if(IE)return ME;IE=1,Object.defineProperty(ME,"__esModule",{value:!0});var e=sc,t=sh;return ME.timestamp=function(n){return void 0===n&&(n=e.asyncScheduler),t.timestamp(n)(this)},ME}();return e.Observable.prototype.timestamp=t.timestamp,xE}var RE,CE,PE={},jE={};function LE(){if(CE)return PE;CE=1,Object.defineProperty(PE,"__esModule",{value:!0});var e=sc,t=function(){if(RE)return jE;RE=1,Object.defineProperty(jE,"__esModule",{value:!0});var e=sh;return jE.toArray=function(){return e.toArray()(this)},jE}();return e.Observable.prototype.toArray=t.toArray,PE}var UE,qE,DE={},VE={};function FE(){if(qE)return DE;qE=1,Object.defineProperty(DE,"__esModule",{value:!0});var e=sc,t=function(){if(UE)return VE;UE=1,Object.defineProperty(VE,"__esModule",{value:!0});var e=sh;return VE.window=function(t){return e.window(t)(this)},VE}();return e.Observable.prototype.window=t.window,DE}var HE,WE,GE={},BE={};function zE(){if(WE)return GE;WE=1,Object.defineProperty(GE,"__esModule",{value:!0});var e=sc,t=function(){if(HE)return BE;HE=1,Object.defineProperty(BE,"__esModule",{value:!0});var e=sh;return BE.windowCount=function(t,n){return void 0===n&&(n=0),e.windowCount(t,n)(this)},BE}();return e.Observable.prototype.windowCount=t.windowCount,GE}var JE,QE,YE={},KE={};function XE(){if(QE)return YE;QE=1,Object.defineProperty(YE,"__esModule",{value:!0});var e=sc,t=function(){if(JE)return KE;JE=1,Object.defineProperty(KE,"__esModule",{value:!0});var e=sc,t=Wc,n=sh;return KE.windowTime=function(r){var i=e.asyncScheduler,o=null,s=Number.POSITIVE_INFINITY;return t.isScheduler(arguments[3])&&(i=arguments[3]),t.isScheduler(arguments[2])?i=arguments[2]:t.isNumeric(arguments[2])&&(s=Number(arguments[2])),t.isScheduler(arguments[1])?i=arguments[1]:t.isNumeric(arguments[1])&&(o=Number(arguments[1])),n.windowTime(r,o,s,i)(this)},KE}();return e.Observable.prototype.windowTime=t.windowTime,YE}var $E,ZE,eO={},tO={};function nO(){if(ZE)return eO;ZE=1,Object.defineProperty(eO,"__esModule",{value:!0});var e=sc,t=function(){if($E)return tO;$E=1,Object.defineProperty(tO,"__esModule",{value:!0});var e=sh;return tO.windowToggle=function(t,n){return e.windowToggle(t,n)(this)},tO}();return e.Observable.prototype.windowToggle=t.windowToggle,eO}var rO,iO,oO={},sO={};function aO(){if(iO)return oO;iO=1,Object.defineProperty(oO,"__esModule",{value:!0});var e=sc,t=function(){if(rO)return sO;rO=1,Object.defineProperty(sO,"__esModule",{value:!0});var e=sh;return sO.windowWhen=function(t){return e.windowWhen(t)(this)},sO}();return e.Observable.prototype.windowWhen=t.windowWhen,oO}var uO,cO,lO={},fO={};function dO(){if(cO)return lO;cO=1,Object.defineProperty(lO,"__esModule",{value:!0});var e=sc,t=function(){if(uO)return fO;uO=1,Object.defineProperty(fO,"__esModule",{value:!0});var e=sh;return fO.withLatestFrom=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.withLatestFrom.apply(void 0,t)(this)},fO}();return e.Observable.prototype.withLatestFrom=t.withLatestFrom,lO}var pO,hO,vO={},bO={};function mO(){if(hO)return vO;hO=1,Object.defineProperty(vO,"__esModule",{value:!0});var e=sc,t=function(){if(pO)return bO;pO=1,Object.defineProperty(bO,"__esModule",{value:!0});var e=sc;return bO.zipProto=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return this.lift.call(e.zip.apply(void 0,[this].concat(t)))},bO}();return e.Observable.prototype.zip=t.zipProto,vO}var gO,yO,_O={},wO={};function EO(){if(yO)return _O;yO=1,Object.defineProperty(_O,"__esModule",{value:!0});var e=sc,t=function(){if(gO)return wO;gO=1,Object.defineProperty(wO,"__esModule",{value:!0});var e=sh;return wO.zipAll=function(t){return e.zipAll(t)(this)},wO}();return e.Observable.prototype.zipAll=t.zipAll,_O}var OO,SO,TO=function(){return function(e,t){void 0===t&&(t=Number.POSITIVE_INFINITY),this.subscribedFrame=e,this.unsubscribedFrame=t}}(),AO=function(e){function t(t,n){var r=e.call(this,(function(e){var t=this,n=t.logSubscribedFrame(),r=new ks;return r.add(new ks((function(){t.logUnsubscribedFrame(n)}))),t.scheduleMessages(e),r}))||this;return r.messages=t,r.subscriptions=[],r.scheduler=n,r}return gs(t,e),t.prototype.scheduleMessages=function(e){for(var t=this.messages.length,n=0;n<t;n++){var r=this.messages[n];e.add(this.scheduler.schedule((function(e){var t=e.message,n=e.subscriber;t.notification.observe(n)}),r.frame,{message:r,subscriber:e}))}},t}(Ds),IO=function(e){function t(t,n){var r=e.call(this)||this;return r.messages=t,r.subscriptions=[],r.scheduler=n,r}return gs(t,e),t.prototype._subscribe=function(t){var n=this,r=n.logSubscribedFrame(),i=new ks;return i.add(new ks((function(){n.logUnsubscribedFrame(r)}))),i.add(e.prototype._subscribe.call(this,t)),i},t.prototype.setup=function(){for(var e=this,t=e.messages.length,n=0;n<t;n++)!function(){var t=e.messages[n];e.scheduler.schedule((function(){t.notification.observe(e)}),t.frame)}()},t}(Gs),kO=function(e){function t(t){var n=e.call(this,Ba,750)||this;return n.assertDeepEqual=t,n.hotObservables=[],n.coldObservables=[],n.flushTests=[],n.runMode=!1,n}return gs(t,e),t.prototype.createTime=function(e){var n=e.indexOf("|");if(-1===n)throw new Error('marble diagram for time should have a completion marker "|"');return n*t.frameTimeFactor},t.prototype.createColdObservable=function(e,n,r){if(-1!==e.indexOf("^"))throw new Error('cold observable cannot have subscription offset "^"');if(-1!==e.indexOf("!"))throw new Error('cold observable cannot have unsubscription marker "!"');var i=t.parseMarbles(e,n,r,void 0,this.runMode),o=new AO(i,this);return this.coldObservables.push(o),o},t.prototype.createHotObservable=function(e,n,r){if(-1!==e.indexOf("!"))throw new Error('hot observable cannot have unsubscription marker "!"');var i=t.parseMarbles(e,n,r,void 0,this.runMode),o=new IO(i,this);return this.hotObservables.push(o),o},t.prototype.materializeInnerObservable=function(e,t){var n=this,r=[];return e.subscribe((function(e){r.push({frame:n.frame-t,notification:Ea.createNext(e)})}),(function(e){r.push({frame:n.frame-t,notification:Ea.createError(e)})}),(function(){r.push({frame:n.frame-t,notification:Ea.createComplete()})})),r},t.prototype.expectObservable=function(e,n){var r=this;void 0===n&&(n=null);var i,o=[],s={actual:o,ready:!1},a=t.parseMarblesAsSubscriptions(n,this.runMode),u=a.subscribedFrame===Number.POSITIVE_INFINITY?0:a.subscribedFrame,c=a.unsubscribedFrame;this.schedule((function(){i=e.subscribe((function(e){var t=e;e instanceof Ds&&(t=r.materializeInnerObservable(t,r.frame)),o.push({frame:r.frame,notification:Ea.createNext(t)})}),(function(e){o.push({frame:r.frame,notification:Ea.createError(e)})}),(function(){o.push({frame:r.frame,notification:Ea.createComplete()})}))}),u),c!==Number.POSITIVE_INFINITY&&this.schedule((function(){return i.unsubscribe()}),c),this.flushTests.push(s);var l=this.runMode;return{toBe:function(e,n,r){s.ready=!0,s.expected=t.parseMarbles(e,n,r,!0,l)}}},t.prototype.expectSubscriptions=function(e){var n={actual:e,ready:!1};this.flushTests.push(n);var r=this.runMode;return{toBe:function(e){var i="string"==typeof e?[e]:e;n.ready=!0,n.expected=i.map((function(e){return t.parseMarblesAsSubscriptions(e,r)}))}}},t.prototype.flush=function(){for(var t=this,n=this.hotObservables;n.length>0;)n.shift().setup();e.prototype.flush.call(this),this.flushTests=this.flushTests.filter((function(e){return!e.ready||(t.assertDeepEqual(e.actual,e.expected),!1)}))},t.parseMarblesAsSubscriptions=function(e,t){var n=this;if(void 0===t&&(t=!1),"string"!=typeof e)return new TO(Number.POSITIVE_INFINITY);for(var r,i=e.length,o=-1,s=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,u=0,c=function(i){var c=u,f=function(e){c+=e*n.frameTimeFactor},d=e[i];switch(d){case" ":t||f(1);break;case"-":f(1);break;case"(":o=u,f(1);break;case")":o=-1,f(1);break;case"^":if(s!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");s=o>-1?o:u,f(1);break;case"!":if(a!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");a=o>-1?o:u;break;default:if(t&&d.match(/^[0-9]$/)&&(0===i||" "===e[i-1])){var p=e.slice(i).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(p){i+=p[0].length-1;var h=parseFloat(p[1]),v=void 0;switch(p[2]){case"ms":v=h;break;case"s":v=1e3*h;break;case"m":v=1e3*h*60}f(v/l.frameTimeFactor);break}}throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+d+"'.")}u=c,r=i},l=this,f=0;f<i;f++)c(f),f=r;return a<0?new TO(s):new TO(s,a)},t.parseMarbles=function(e,t,n,r,i){var o=this;if(void 0===r&&(r=!1),void 0===i&&(i=!1),-1!==e.indexOf("!"))throw new Error('conventional marble diagrams cannot have the unsubscription marker "!"');for(var s,a=e.length,u=[],c=i?e.replace(/^[ ]+/,"").indexOf("^"):e.indexOf("^"),l=-1===c?0:c*-this.frameTimeFactor,f="object"!==y(t)?function(e){return e}:function(e){return r&&t[e]instanceof AO?t[e].messages:t[e]},d=-1,p=function(t){var r=l,a=function(e){r+=e*o.frameTimeFactor},c=void 0,p=e[t];switch(p){case" ":i||a(1);break;case"-":case"^":a(1);break;case"(":d=l,a(1);break;case")":d=-1,a(1);break;case"|":c=Ea.createComplete(),a(1);break;case"#":c=Ea.createError(n||"error"),a(1);break;default:if(i&&p.match(/^[0-9]$/)&&(0===t||" "===e[t-1])){var v=e.slice(t).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(v){t+=v[0].length-1;var b=parseFloat(v[1]),m=void 0;switch(v[2]){case"ms":m=b;break;case"s":m=1e3*b;break;case"m":m=1e3*b*60}a(m/h.frameTimeFactor);break}}c=Ea.createNext(f(p)),a(1)}c&&u.push({frame:d>-1?d:l,notification:c}),l=r,s=t},h=this,v=0;v<a;v++)p(v),v=s;return u},t.prototype.run=function(e){var n=t.frameTimeFactor,r=this.maxFrames;t.frameTimeFactor=1,this.maxFrames=Number.POSITIVE_INFINITY,this.runMode=!0,ua.delegate=this;var i={cold:this.createColdObservable.bind(this),hot:this.createHotObservable.bind(this),flush:this.flush.bind(this),expectObservable:this.expectObservable.bind(this),expectSubscriptions:this.expectSubscriptions.bind(this)};try{var o=e(i);return this.flush(),o}finally{t.frameTimeFactor=n,this.maxFrames=r,this.runMode=!1,ua.delegate=void 0}},t}(Ga),xO=n(Object.freeze({__proto__:null,TestScheduler:kO}));function MO(){if(OO)return bs;OO=1,Object.defineProperty(bs,"__esModule",{value:!0});var e=sc;bs.Observable=e.Observable,bs.Subject=e.Subject;var t=Wc;bs.AnonymousSubject=t.AnonymousSubject;var n=Wc;bs.config=n.config,function(){if(Fc)return Gc;Fc=1,Object.defineProperty(Gc,"__esModule",{value:!0});var e=sc;e.Observable.bindCallback=e.bindCallback}(),function(){if(Bc)return zc;Bc=1,Object.defineProperty(zc,"__esModule",{value:!0});var e=sc;e.Observable.bindNodeCallback=e.bindNodeCallback}(),function(){if(Jc)return Qc;Jc=1,Object.defineProperty(Qc,"__esModule",{value:!0});var e=sc;e.Observable.combineLatest=e.combineLatest}(),function(){if(Yc)return Kc;Yc=1,Object.defineProperty(Kc,"__esModule",{value:!0});var e=sc;e.Observable.concat=e.concat}(),function(){if(Xc)return $c;Xc=1,Object.defineProperty($c,"__esModule",{value:!0});var e=sc;e.Observable.defer=e.defer}(),function(){if(Zc)return el;Zc=1,Object.defineProperty(el,"__esModule",{value:!0});var e=sc;e.Observable.empty=e.empty}(),function(){if(tl)return nl;tl=1,Object.defineProperty(nl,"__esModule",{value:!0});var e=sc;e.Observable.forkJoin=e.forkJoin}(),function(){if(rl)return il;rl=1,Object.defineProperty(il,"__esModule",{value:!0});var e=sc;e.Observable.from=e.from}(),function(){if(ol)return sl;ol=1,Object.defineProperty(sl,"__esModule",{value:!0});var e=sc;e.Observable.fromEvent=e.fromEvent}(),function(){if(al)return ul;al=1,Object.defineProperty(ul,"__esModule",{value:!0});var e=sc;e.Observable.fromEventPattern=e.fromEventPattern}(),function(){if(cl)return ll;cl=1,Object.defineProperty(ll,"__esModule",{value:!0});var e=sc;e.Observable.fromPromise=e.from}(),function(){if(fl)return dl;fl=1,Object.defineProperty(dl,"__esModule",{value:!0});var e=sc;e.Observable.generate=e.generate}(),function(){if(pl)return hl;pl=1,Object.defineProperty(hl,"__esModule",{value:!0});var e=sc;e.Observable.if=e.iif}(),function(){if(vl)return bl;vl=1,Object.defineProperty(bl,"__esModule",{value:!0});var e=sc;e.Observable.interval=e.interval}(),function(){if(ml)return gl;ml=1,Object.defineProperty(gl,"__esModule",{value:!0});var e=sc;e.Observable.merge=e.merge}(),function(){if(yl)return _l;yl=1,Object.defineProperty(_l,"__esModule",{value:!0});var e=sc;e.Observable.race=e.race}(),function(){if(wl)return El;wl=1,Object.defineProperty(El,"__esModule",{value:!0});var e=sc;function t(){return e.NEVER}El.staticNever=t,e.Observable.never=t}(),function(){if(Ol)return Sl;Ol=1,Object.defineProperty(Sl,"__esModule",{value:!0});var e=sc;e.Observable.of=e.of}(),function(){if(Tl)return Al;Tl=1,Object.defineProperty(Al,"__esModule",{value:!0});var e=sc;e.Observable.onErrorResumeNext=e.onErrorResumeNext}(),function(){if(Il)return kl;Il=1,Object.defineProperty(kl,"__esModule",{value:!0});var e=sc;e.Observable.pairs=e.pairs}(),function(){if(xl)return Ml;xl=1,Object.defineProperty(Ml,"__esModule",{value:!0});var e=sc;e.Observable.range=e.range}(),function(){if(Nl)return Rl;Nl=1,Object.defineProperty(Rl,"__esModule",{value:!0});var e=sc;e.Observable.using=e.using}(),function(){if(Cl)return Pl;Cl=1,Object.defineProperty(Pl,"__esModule",{value:!0});var e=sc;e.Observable.throw=e.throwError,e.Observable.throwError=e.throwError}(),function(){if(jl)return Ll;jl=1,Object.defineProperty(Ll,"__esModule",{value:!0});var e=sc;e.Observable.timer=e.timer}(),function(){if(Ul)return ql;Ul=1,Object.defineProperty(ql,"__esModule",{value:!0});var e=sc;e.Observable.zip=e.zip}(),function(){if(Dl)return Vl;Dl=1,Object.defineProperty(Vl,"__esModule",{value:!0});var e=Fl;sc.Observable.ajax=e.ajax}(),function(){if(Hl)return Wl;Hl=1,Object.defineProperty(Wl,"__esModule",{value:!0});var e=Gl;sc.Observable.webSocket=e.webSocket}(),ah(),dh(),mh(),Eh(),Ih(),Rh(),Uh(),Hh(),Jh(),$h(),rv(),uv(),pv(),gv(),Ov(),kv(),Cv(),qv(),Wv(),Qv(),Zv(),ib(),cb(),hb(),yb(),Sb(),xb(),Pb(),Db(),Gb(),Yb(),em(),om(),fm(),bm(),wm(),Am(),Nm(),Lm(),Fm(),zm(),Xm(),ng(),ag(),dg(),mg(),Eg(),Ig(),Rg(),Ug(),Hg(),Jg(),$g(),ry(),uy(),py(),gy(),Oy(),ky(),Cy(),qy(),Wy(),Qy(),Zy(),i_(),c_(),h_(),y_(),S_(),x_(),P_(),D_(),G_(),Y_(),ew(),ow(),lw(),vw(),_w(),Tw(),Mw(),jw(),Vw(),Bw(),Kw(),tE(),sE(),fE(),bE(),wE(),AE(),NE(),LE(),FE(),zE(),XE(),nO(),aO(),dO(),mO(),EO();var r=sc;bs.Subscription=r.Subscription,bs.ReplaySubject=r.ReplaySubject,bs.BehaviorSubject=r.BehaviorSubject,bs.Notification=r.Notification,bs.EmptyError=r.EmptyError,bs.ArgumentOutOfRangeError=r.ArgumentOutOfRangeError,bs.ObjectUnsubscribedError=r.ObjectUnsubscribedError,bs.UnsubscriptionError=r.UnsubscriptionError,bs.pipe=r.pipe;var i=xO;bs.TestScheduler=i.TestScheduler;var o=sc;bs.Subscriber=o.Subscriber,bs.AsyncSubject=o.AsyncSubject,bs.ConnectableObservable=o.ConnectableObservable,bs.TimeoutError=o.TimeoutError,bs.VirtualTimeScheduler=o.VirtualTimeScheduler;var s=Fl;bs.AjaxResponse=s.AjaxResponse,bs.AjaxError=s.AjaxError,bs.AjaxTimeoutError=s.AjaxTimeoutError;var a=sc,u=Wc,c=Wc;bs.TimeInterval=c.TimeInterval,bs.Timestamp=c.Timestamp;var l=sh;bs.operators=l;var f={asap:a.asapScheduler,queue:a.queueScheduler,animationFrame:a.animationFrameScheduler,async:a.asyncScheduler};bs.Scheduler=f;var d={rxSubscriber:u.rxSubscriber,observable:u.observable,iterator:u.iterator};return bs.Symbol=d,bs}function NO(){return SO||(SO=1,e=vs,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(MO())),vs;var e}var RO=NO(),CO=t(RO),PO=sm.visitorId,jO=function(){return PO},LO=new CO.Subject(1),UO=function(){return LO.asObservable().startWith(jO()).distinctUntilChanged()},qO=function(e){PO=e,LO.next(e),sm.visitorId=e},DO=function(){return sm.siteId},VO=new CO.BehaviorSubject(sm.authenticatedExternally||!1),FO=function(){return VO.value},HO=function(e){VO.next(Boolean(e))},WO=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];try{var n=new URL(e);return Array.from(n.searchParams.keys()).forEach((function(e){t.includes(e)||n.searchParams.set(e,"FILTERED")})),n.toString()}catch(t){return e}},GO=window,BO=new function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.publishInterval,n=void 0===t?3e3:t,r=e.maximumBatchSize,i=void 0===r?50:r,o=e.maximumBufferSize,s=void 0===o?1e3:o,a=e.maximumConsecutiveRetries,u=void 0===a?10:a,c=e.transports,l=void 0===c?[]:c,f={},d={},p=function e(t){var n=t.transports,r=t.payload;return 0===n.length?Promise.reject():n[0].process({payload:r}).catch((function(){return e({payload:r,transports:n.slice(1)})}))},h=function(e){return 0===Object.keys(e).length||(t=e,Object.keys(t).map((function(e){return t[e]}))).every((function(e){return 0===e.length}));var t},v=function(){var e={};return Object.keys(f).forEach((function(t){e[t]=f[t].splice(0,i)})),h(e)?Promise.resolve():p({transports:l,payload:e}).then((function(){return Object.keys(d).forEach((function(e){return d[e]=0})),Promise.resolve()})).catch((function(){return Object.keys(e).forEach((function(t){d[t]++,d[t]<u?f[t]=e[t].concat(f[t]):d[t]=0})),Promise.reject()}))},b=!1,m=null,g=!1;return{start:function(){if(b)throw new Error("Publisher is already started");b=!0,m=setInterval((function(){g||(g=!0,v().then((function(){return g=!1}),(function(){return g=!1})))}),n),window.addEventListener("unload",v)},stop:function(){b=!1,clearInterval(m)},addToBucket:function(e,t){f[e]||(d[e]||(d[e]=0),f[e]=[]),f[e].push(t),f[e].splice(s)},flush:v,buckets:f,addTransport:function(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).position;void 0===t&&(t=l.length),l.splice(t,0,e)},transports:l}}({publishInterval:sm.conf.log_publish_interval_ms||3e3});BO.start(),BO.addTransport(new ls.HttpTransport({url:sm.conf.client_logger_url,method:"POST",encode:function(e){var t=e.logs,n=e.stats;return JSON.stringify({logs:t||[],stats:n||[]})}}));var zO=new function e(t){var n=arguments,r=t.publisher,i=t.tags,o=void 0===i?{}:i,s=t.currentIsoDate,a=void 0===s?function(){return(new Date).toISOString()}:s,u=t.maxObjectDepth,c=void 0===u?3:u,l=t.maxArrayLength,f=void 0===l?10:l,d=t.windowConsole,p=void 0===d?window.console:d,h=t.localStorage,v=void 0===h?window.localStorage:h,b=t.liveLogsKey,m=void 0===b?"sm.live_logs":b,g=t.liveLogsEnabled,y=void 0!==g&&g,_=t.whitelist,w=void 0===_?{}:_,E=0===Object.keys(w).length,O=new as,S=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(c===t)return["-pruned-"];for(var r=[],i=0;i<e.length;i++){if(i===f){var o=e[i-1];Array.isArray(o)?r.push(["-pruned-"]):o&&"object"===rs(o)?r.push({pruned:!0}):r.push("-pruned-");break}r.push(I(e[i],t+1,n))}return r},T=function(e,t){var n,r=e,i=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=os(e))||t){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}(t);try{for(i.s();!(n=i.n()).done;){var o=n.value;if(!r||!r.hasOwnProperty(o))return;r=r[o]}}catch(e){i.e(e)}finally{i.f()}return r},A=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(t===c)return"-pruned-";var r={};return function(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n)}(e,(function(i){var o=e[i];E||T(w,[].concat(is(n),[i]))?r[i]=I(o,t+1,[].concat(is(n),[i])):Array.isArray(o)?r[i]=["-redacted-"]:o&&"object"===rs(o)?r[i]={redacted:!0}:r[i]="-redacted-"})),r},I=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return-1!==cs.indexOf(rs(e))?e:"function"==typeof e?"<Function>":null===e?null:e instanceof Error?{message:(t=e).message,stack:t.stack}:Array.isArray(e)?S(e,n,r):A(e,n,r)},k=function(e){return function(){if(p&&(y||"1"===v[m])){var t=p[e]||p.log;t.apply(t,arguments)}var n,i=Array.prototype.slice.call(arguments).map((function(e){return I(e,0)})).filter((function(e){return void 0!==e})),s=function(e){var t={};for(var n in e){var r=e[n];t[n]="function"==typeof r?r():r}return t}(o);s=us(s,{level:e,attributes:i,timestamp:a()}),"error"===e?s=us(s,{breadcrumbs:O.list}):O.add(s),n=s,r.addToBucket("logs",n)}};this.debug=k("debug"),this.log=k("info"),this.info=k("info"),this.warn=k("warn"),this.error=function(){var e=Array.prototype.slice.call(arguments),t=function(e){return e.filter((function(e){return e instanceof Error}))[0]}(e);if(!t||!t._acked)return"string"!=typeof e[0]||t||(e[0]=new Error(e[0])),k("error").apply(null,e)},this.withTags=function(t){return new e(us(n[0],{tags:us(o,t)}))},this.enableLiveLogs=function(){return v[m]="1"}}({publisher:BO,tags:{actor:"visitor",site_id:sm.siteId,visitor_id:function(){return jO()},tab_id:function(){return sm.tabId},user_agent:window.navigator.userAgent,url:function(){return WO(String(window.location))},client_version:function(e){e||(e="visitor/bootstrapper-02766f85f.js");var t=e.split("-")[1];if(t)return t.slice(0,-3)}()},whitelist:{"@timestamp":!0,accurate_difference:!0,accurate_recording_time:!0,accurate_start_time:!0,action:!0,activeTicket:{id:!0},actor:!0,app:!0,application:!0,applied_background_type:!0,asset_url:!0,assumed_visitor_id:!0,attributes:!0,audio_direction:!0,audio_permissions_required:!0,audio_type:!0,blank_attributes:!0,browser:!0,caller:!0,canReceive:{audio:!0,video:!0},canSend:{audio:!0,video:!0},canShareScreen:!0,candidate:!0,category:!0,cause:!0,channelUrl:!0,channel_url:!0,clear_previous:!0,client_version:!0,code:!0,component_name:!0,compressed_size:!0,conferenceId:!0,conference_id:!0,configured_background_type:!0,constraints:{audio:!0,video:!0},countClientButtons:!0,createdAt:!0,current_result:!0,custom_command_id:!0,difference:!0,duration:!0,early_recording:!0,ended_engagements:{capabilities:!0,end_reason:!0,id:!0,restarted_from_engagement_id:!0,site_id:!0,status:!0,sub_engagement_id:!0,visitor:!0},engagementId:!0,engagement_id:!0,engagement_requests:{id:!0,operator_id:!0,outcome:!0,site_id:!0},engagements:{capabilities:!0,id:!0,restarted_from_engagement_id:!0,site_id:!0,status:!0,sub_engagement_id:!0,visitor:!0},enqueuedInCurrentTab:!0,err:{cause:!0,message:!0,stack:!0,error:!0,type:!0},error:!0,error_count:!0,error_status_code:!0,event:{isTrusted:!0},eventName:!0,feature:!0,fn:!0,found_tab_id:!0,glia_team:!0,ice_connection_state:!0,id:!0,identifier:!0,identity:!0,idle_for:!0,iframe_src:!0,index_name:!0,interval_seconds:!0,isAsyncTransfer:!0,isEngaged:!0,isReestablishing:!0,isTransfer:!0,isVisitorAuthenticatedExternally:!0,is_active_tab:!0,kube_container:!0,kube_host:!0,kube_namespace:!0,kube_pod:!0,label:!0,level:!0,localVideoProvider:!0,localVideoType:!0,locale:!0,major_browser_version:!0,media:!0,media_options:{one_way:!0,oneWay:!0},medra_version:!0,message:!0,"message-1":{capabilities:{text:!0},channel_url:!0,engagement_request_id:!0,entrypoint:!0,id:!0,media:{audio:!0},operator:{id:!0,media_type:!0,teams:!0},platform:!0,restarted_from_engagement_id:!0,site_id:!0,start_time:!0,status:!0,sub_engagement_id:!0,sub_engagement_legacy_id:!0,transferrable_sites:!0,visitor:{authenticated:!0,browser_tab_id:!0}},message_id:!0,modified_url:!0,newScreenSessionId:!0,new_result:!0,new_tab_id:!0,new_transport:!0,observations:{id:!0,operator_id:!0,site_id:!0},oldScreenSessionId:!0,online:!0,operator:{assignment:{type:!0},id:!0,state:{available:!0,media:!0,medias:!0,oneWayMedias:!0}},operatorId:!0,operatorMedia:!0,operator_id:!0,options:{oneWay:!0,operatorId:!0,source:!0},origin:!0,original_url:!0,params:{tabId:!0,visitor_priority:!0,URL:!0,account_actions:!0,arg:!0,"engagement id":!0,engagement_id:!0,engagement_media:!0,operator_id:!0,proactive_reactive:!0,"site id":!0,source:!0,starting_media:!0,type:!0,url:!0,"visitor id":!0,visitor_id:!0,accountAction:!0,dealerId:!0,overseerID:!0,overseerName:!0,sm_url:!0,elementClassName:!0,showVisitorCode:!0,elementId:!0,queueID:!0,elementText:!0,elementTagName:!0,custom:!0,site:!0,visitor:!0},pubsub_data:{allow_rejection:!0,dispatched_at:!0,engagement:{ended_engagements:!0,engagements:!0,observations:!0,requests:!0},event_id:!0,event_type:!0,headers:{accept:!0,"content-type":!0,"x-salemove-tab-id":!0},idle_timeout_seconds:!0,isTrusted:!0,joins:{self:!0},leaves:{self:!0},medias:!0,method:!0,page_description:!0,page_url:!0,payload:{action:!0,media:!0,media_options:!0,queue_id:!0,site_id:!0,source:!0,visitor_id:!0,visitor_metadata:!0,queue_ids:!0},queue_id:!0,response:{headers:!0,status:!0},self:{metas:!0},state:!0,status:!0,tab_id:!0,topics:!0,url:!0,visitor_metadata:{browser_name:!0,browser_type:!0,device_type:!0,os_type:!0},authentication_requests:!0,omniq:{queue_tickets:!0},message:{engagement_id:!0,id:!0,sender:!0,status:!0,sub_engagement:!0,sub_engagement_id:!0,target:!0,timestamp:!0,type:!0},typing_indicator:{clock:!0,engagement_id:!0,sender:!0,sub_engagement_id:!0,typing:!0},undelivered_messages:!0},q2_user_id:!0,queueState:{medias:!0,state:!0},queue_ids:!0,queue_state:!0,queue_ticket_id:!0,queue_tickets:{id:!0,site_id:!0,state:!0},queued:!0,reason:!0,recording_time:!0,remoteVideoProvider:!0,remoteVideoType:!0,response_body:!0,route:!0,routing:{queues:!0},rule_id:!0,rule_name:!0,screenId:!0,screenSessionId:!0,sdp:!0,sdpMLineIndex:!0,sdpMid:!0,send_to_server:!0,siteId:!0,site_id:!0,source:!0,source_id:!0,stack:!0,start_time:!0,startingMedia:!0,status:!0,stream:!0,subEngagementId:!0,sub_engagement_uuid:!0,tab_id:!0,team_ids:!0,timestamp:!0,topic:!0,total:!0,transport:!0,twilio_error_code:!0,twilio_error_description:!0,type:!0,updated_webcomponents:!0,upgrade_request:{id:!0,video:!0,audio:!0},url:!0,user_agent:!0,video_direction:!0,video_permissions_required:!0,video_type:!0,visibility_state:!0,visitorLeftReason:!0,visitor_code:!0,visitor_id:!0,visitor_metadata:{browser_name:!0,browser_type:!0,device_type:!0,os_type:!0},warningName:!0,webrtc_mode:!0,window_name:!0,attempt:!0,authentication_provider_id:!0,constructor:!0,engagement_request_id:!0,offer:{video:!0},payload:{media:!0,queue_id:!0,queue_ids:!0,source:!0},remoteAudioType:!0,request:{audio:!0,video:!0},status_text:!0,webhooks:!0,candidate_info:{candidate:!0,sdpMLineIndex:!0,sdpMid:!0},component:!0,description_info:{sdp:!0,type:!0},foundation:!0,prefix:!0,priority:!0,protocol:!0,readyState:!0,relatedAddress:!0,relatedPort:!0,responseURL:!0,state:!0,statusText:!0,tcpType:!0,timeout:!0,toJSON:!0,cached_queues_length:!0,error_cause:!0,error_message:!0,response:{error:!0,stack:!0},target:!0,generation:!0,iframe_class:!0,"network-cost":!0,source_attributes:{element_class_name:!0,element_id:!0,element_tag_name:!0,element_text:!0},tag_name:!0,ufrag:!0,custom_code_url:!0,dependencies:!0,details:{site_ids:!0},elementSelector:!0,element_selector:!0,new_url:!0,queue_id:!0,queue_states:{id:!0,status:!0},queue_status:!0,selector:!0,source_type:!0,tagFunction:!0,tagId:!0,url_length:!0,debug_message:!0,ref:!0,rx_version:!0,sub_engagement_id:!0,context:!0,rejoin_count:!0,action_attributes:{browser_event_conditions:{queue_ids:!0},frequency:{type:!0,filters:{timeframe:!0}},id:!0,in_browser:!0,rule_name:!0,type:!0,duration:!0,horizontal_offset:!0,no_operators_online_text:!0,text:!0,vertical_offset:!0,clear_previous:!0,operator_team_id:!0,priority:!0,fields:!0,provider:!0,tag_function:!0,tag_id:!0,action:!0,category:!0},__sm__mutation_summary_node_map_id__:!0,browser_event_conditions:{queue_ids:!0},client_webrtc_mode:!0,fields:!0,frequency:{filters:!0,max_occurrences:!0,type:!0},in_browser:!0,lastSelectedTimeframe:!0,provider:!0,server_webrtc_mode:!0,tag_function:!0,tag_id:!0,webrtc_modes_different:!0,session_id:!0,sm_version:!0,error_details:{resource:!0},to_save_key:!0,to_save_value:!0,relayProtocol:!0,transitionReason:!0}}),JO=zO.error;zO.error=function(e,t){"unauthorized"!==(null==t?void 0:t.error)&&"unauthorized"!==(null==t?void 0:t.reason)||(t.glia_team="sudo");for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return JO.call.apply(JO,[GO,e,t].concat(r))};var QO=zO.warn;zO.warn=function(e,t){"unauthorized"===(null==t?void 0:t.error)&&(t.glia_team="sudo");for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return QO.call.apply(QO,[GO,e,t].concat(r))},sm.logger=zO;var YO,KO=new function e(t){var n=t.publisher,r=t.globalTags,i=void 0===r?[]:r,o=function(e){return n.addToBucket("stats",e)},s=function(e,t,n,r){return r||(r=[]),{stat:e,params:[t,n,i.concat(r)]}};this.increment=function(e,t,n){isNaN(parseInt(t))&&(n=t,t=1),o(s("increment",e,t,n))},this.decrement=function(e,t,n){isNaN(parseInt(t))&&(n=t,t=1),o(s("decrement",e,t,n))},this.gauge=function(e,t,n){o(s("gauge",e,t,n))},this.histogram=function(e,t,n){o(s("histogram",e,t,n))},this.timing=function(e,t,n){o(s("timing",e,t,n))},this.set=function(e,t,n){o(s("set",e,t,n))},this.withTags=function(t){return new e({publisher:n,globalTags:i.concat(t)})}}({publisher:BO,globalTags:["application:visitor","visitor_page_adaption:".concat(sm.conf.engagement.visitor_page_adaption)]}),XO=new hs(KO,(YO={},{record:function(e){YO[e]=Number(new Date)},currentLatencyFrom:function(e){var t=YO[e];return t?Number(new Date)-t:-1}})),$O="sm.app.visitor_api.dynamic_import",ZO="default"===sm.conf.communications.lib,eS=function(e){return-1!==sm.conf.assets.server.indexOf("libs.")?"".concat(sm.conf.assets.server,"/").concat(e):[sm.conf.assets.server,sm.conf.assets.prepend||"/",e].join("")},tS={Medra:{url:ZO?"https://libs.salemove.com/medra-5.8.5.min.js":sm.conf.communications.lib,returning:function(){return sm.Medra},integrity:ZO?es({name:"medra"}):null,gliaTeam:"media"},Comms:{url:eS("visitor_app/comms/app-02766f85f.js"),integrity:es({name:"comms"}),gliaTeam:"media"},Cobra:{url:"".concat(sm.conf.cobra.lib.visitor,".js"),returning:function(){return sm.Cobra},integrity:es({name:"visitor_cobra"}),gliaTeam:"nexus"},webcomponents:{url:eS("visitor/webcomponents-02766f85f.js"),integrity:es({name:"webcomponents"}),gliaTeam:"nexus"},webcomponents_es5:{url:eS("visitor/webcomponents_es5-02766f85f.js"),integrity:es({name:"webcomponents_es5"}),gliaTeam:"nexus"},legacy_webcomponents:{url:eS("visitor/legacy_webcomponents-02766f85f.js"),integrity:es({name:"legacy_webcomponents"}),gliaTeam:"nexus"}},nS={},rS=function(e){var t,n=tS,r=ts,i=XO,o=nS;"string"==typeof e?t=e:(t=e.target,e.loader&&(r=e.loader),e.possibleTargets&&(n=e.possibleTargets),e.stats&&(i=e.stats),e.loaded&&(o=e.loaded));var s=n[t];if(!s)return CO.Observable.throw("Invalid target");if(o[t]){if(s.returning){var a=s.returning();return void 0===a?CO.Observable.throw(new Error("An error occurred while loading ".concat(t,", as it is undefined"))):CO.Observable.of(a)}return CO.Observable.of(null)}return CO.Observable.create((function(e){r({fileUrl:s.url,integrity:s.integrity,onAttempt:function(){i.increment($O,["action:attempted","module:".concat(t),"glia_team:".concat(s.gliaTeam)])},onLoad:function(){if(o[t]=!0,s.returning){var n=s.returning();void 0===n?(i.increment($O,["action:failed","module:".concat(t),"glia_team:".concat(s.gliaTeam)]),e.error(new Error("An error occurred while loading ".concat(t,", as it is undefined")))):(i.increment($O,["action:succeeded","module:".concat(t),"glia_team:".concat(s.gliaTeam)]),e.next(n),e.complete())}else i.increment($O,["action:succeeded","module:".concat(t),"glia_team:".concat(s.gliaTeam)]),e.next(),e.complete()},onError:function(){i.increment($O,["action:warning","module:".concat(t),"glia_team:".concat(s.gliaTeam)])},onGiveUp:function(){i.increment($O,["action:failed","module:".concat(t),"glia_team:".concat(s.gliaTeam)]);var n=new Error("Loading ".concat(t," failed"));zO.warn(n,{target:t}),n._acked=!0,e.error(n)},retryLimit:3,backoffDelay:500})}))},iS={MSG:{PROACTIVE_REQUEST:"proactive_call:request",PROACTIVE_ACCEPT:"proactive_call:accept",PROACTIVE_DECLINE:"proactive_call:decline",REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT:"reactive_engagement_request_timeout",ENGAGEMENT_PREPARE:"engagement:prepare",ENGAGEMENT_CLEANUP:"engagement:cleanup",DISCONNECT:"connection_lost",RECONNECTED:"connection_restored",MEDIA_SELECTED:"media_selected",ENGAGEMENT_TRANSFERRED:"engagement:transferred",ENGAGEMENT_END_POPUP_CLOSED:"engagement:end:popup:closed",PUBLIC:{ENGAGEMENT_START:"sm:engagement:start",ENGAGEMENT_END:"sm:engagement:end",ENGAGEMENT_GET_AUDIO_TYPE:"sm:engagement:get_audio_type",ENGAGEMENT_GET_UPGRADE_MEDIA_TYPE:"sm:engagement:get_upgrade_media_type",ENGAGEMENT_MEDIA_UPGRADE_REQUEST:"sm:engagement:media_upgrade_request",ENGAGEMENT_SELECT_MEDIA_TYPE:"sm:engagement:select_media_type",ENGAGEMENT_ERROR:"sm:engagement:error"},WILL_ASK_MEDIA_PERMISSION:"engagement:media_permission:will_ask",SHOW_PERMISSION_ARROW:"communication:show_permission_arrow",HIDE_PERMISSION_ARROW:"communication:hide_permission_arrow",ALLOW_STREAM:"engagement:media_permission:allow",DENY_STREAM:"engagement:media_permission:_deny",IS_ENGAGED:"engagement:is_engaged",PHONE_STATUSES:{CONNECTED:"connected",CONNECTING:"connecting"},ENGAGEMENT_REMOVE_AUDIO:"engagement:remove_audio"}},oS=new CO.Subject;iS.vent={trigger:function(e,t){oS.next({eventName:e,eventBody:t})},observable:function(e){return oS.filter((function(t){return t.eventName===e})).map((function(e){return e.eventBody}))}};var sS={};iS.request=function(e,t){var n=sS[e];if(n)return n(t)},iS.reqres={setHandler:function(e,t){sS[e]=t},removeHandler:function(e){delete sS[e]}};var aS,uS,cS=[],lS=null,fS=function(){(lS=document.createElement("SPAN")).id="cobrowsing-mouse-container",document.body.appendChild(lS);var e=new MutationObserver((function(){var e,t,n=document.body.childNodes[document.body.childNodes.length-1];n!==lS&&-1===cS.indexOf(n)&&(e=document.body,(t=e.childNodes[e.childNodes.length-1])!==lS&&(cS.push(t),setTimeout((function(){cS=[]}),1e4),e.appendChild(lS)))}));return e.observe(document.body,{childList:!0}),{unsubscribe:function(){e.disconnect()}}},dS={},pS={};function hS(){return uS||(uS=1,e=dS,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(aS)return pS;aS=1,Object.defineProperty(pS,"__esModule",{value:!0});var e=sc;return pS.Observable=e.Observable,pS}())),dS;var e}var vS,bS,mS=hS(),gS={},yS={};function _S(){return bS||(bS=1,e=gS,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(vS)return yS;vS=1,Object.defineProperty(yS,"__esModule",{value:!0});var e=sc;return yS.combineLatest=e.combineLatest,yS}())),gS;var e}var wS,ES,OS=_S(),SS={},TS={};function AS(){return ES||(ES=1,e=SS,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(wS)return TS;wS=1,Object.defineProperty(TS,"__esModule",{value:!0});var e=sc;return TS.from=e.from,TS}())),SS;var e}var IS,kS,xS=AS(),MS={},NS={};function RS(){return kS||(kS=1,e=MS,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(IS)return NS;IS=1,Object.defineProperty(NS,"__esModule",{value:!0});var e=sc;return NS.Subject=e.Subject,NS}())),MS;var e}var CS,PS,jS=RS(),LS=function(){function e(t){var n=t.duration;i(this,e),this.duration=n}return s(e,[{key:"perform",value:function(){iS.vent.trigger("trigger_expand_reactive",{duration:this.duration})}}]),e}(),US=function(){function e(t){var n=t.text,r=t.no_operators_online_text,o=t.duration,s=t.priority;i(this,e),this.text=n,this.noOperatorsOnlineText=r,this.duration=o,this.priority=s}return s(e,[{key:"perform",value:function(){iS.vent.trigger("trigger_reactive_callout",{text:this.text,noOperatorsOnlineText:this.noOperatorsOnlineText,duration:this.duration,priority:this.priority})}}]),e}(),qS=function(){function e(t){var n=t.text;i(this,e),this.text=n}return s(e,[{key:"perform",value:function(){iS.vent.trigger("trigger_media_selection",{text:this.text,source:"callout"})}}]),e}(),DS=function(){function e(){i(this,e)}return s(e,[{key:"perform",value:function(){iS.vent.trigger("reactive_bar:enable")}}]),e}(),VS=function(){function e(){i(this,e)}return s(e,[{key:"perform",value:function(){iS.vent.trigger("reactive_bar:disable")}}]),e}(),FS=function(){function e(t){var n=t.vertical_offset,r=t.horizontal_offset;i(this,e),this.verticalOffset=n,this.horizontalOffset=r}return s(e,[{key:"perform",value:function(){iS.vent.trigger("reactive_bar:set_position",{verticalOffset:this.verticalOffset,horizontalOffset:this.horizontalOffset})}}]),e}(),HS=function(e){var t=e.category,n=e.action,r=e.label;zO.info("Tracking Google Analytics Event",{category:t,action:n,label:r}),"function"==typeof window.gtag?window.gtag("event",n,{event_category:t,event_label:r}):window._gaq&&window._gaq.push?window._gaq.push(["_trackEvent",t,n,r]):"function"==typeof window.ga&&window.ga("send","event",t,n,r)},WS=function(){function e(t){i(this,e),this.options=t}return s(e,[{key:"perform",value:function(){switch(this.options.provider){case"google":this.trackGoogle(this.options);break;case"omniture":this.trackOmniture(this.options);break;default:zO.error("Unknown analytics provider",h(h({},this.options.provider),{},{glia_team:"automaton"}))}}},{key:"trackGoogle",value:function(e){var t=e.category,n=e.action,r=e.fields;HS({category:t,action:n,label:r?JSON.stringify(r):void 0})}},{key:"trackOmniture",value:function(e){!function(e){var t=e.tagFunction,n=e.tagId,r=e.params;try{var i=Object.keys(r||{}).reduce((function(e,t){return t.match(/url/i)&&"string"==typeof r[t]?e[t]=WO(r[t]):e[t]=r[t],e}),{});zO.info("Tracking Omniture Analytics Event",{tagFunction:t,tagId:n,params:i}),"function"==typeof window[t]&&window[t](n,nt(r))}catch(e){zO.warn("Client error occurred during Omniture event tracking",e)}}({tagFunction:e.tag_function,tagId:e.tag_id,params:e.fields})}}]),e}(),GS=function(e,t){var n=t.operator;return n&&-1!==n.teamNames.indexOf(e)},BS=function(){function e(t){var n=t.operator_team;i(this,e),this.operatorTeam=n}return s(e,[{key:"perform",value:function(e){e.cobraObservable.filter(Ei(GS,this.operatorTeam)).pluck("cobraSourceInitializer").subscribe((function(e){return e.block()}))}}]),e}(),zS=function(){function e(t){var n=t.text,r=t.duration;i(this,e),this.text=n,this.duration=r}return s(e,[{key:"perform",value:function(){iS.vent.trigger("show_engagement_invitation",{text:this.text,duration:this.duration})}}]),e}(),JS={},QS={};function YS(){return PS||(PS=1,e=JS,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(CS)return QS;CS=1,Object.defineProperty(QS,"__esModule",{value:!0});var e=sc;return QS.empty=e.empty,QS}())),JS;var e}var KS,XS,$S=YS(),ZS={},eT={};function tT(){return XS||(XS=1,e=ZS,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(KS)return eT;KS=1,Object.defineProperty(eT,"__esModule",{value:!0});var e=sc;return eT.of=e.of,eT}())),ZS;var e}var nT=tT(),rT=dt(Sr,oo);(sm.BusinessRules={}).ACTION_TYPES={SHOW_OPERATORS_IN_SELECTOR_V2:"show_operators_in_selector_v2"};var iT=function(e){var t=e.event,n=e.site_id,r=e.tab_id;return"business_rules"===t&&n===sm.siteId&&(!r||r===sm.tabId)},oT=function(){function e(){i(this,e)}return s(e,[{key:"perform",value:function(){}}]),e}(),sT=function(){function e(t){i(this,e),this.expectedAction=t}return s(e,[{key:"perform",value:function(){throw new Error("No handler found for action ".concat(this.expectedAction))}}]),e}(),aT={expand_operator_selector:LS,reactive_callout:US,media_selection:qS,show_reactive_tab_only_when:DS,hide_reactive_tab:VS,set_reactive_tab_position:FS,show_operators_in_selector_v2:oT,send_analytics_event:WS,hide_page_from_operators:BS,show_engagement_invitation:zS},uT=new jS.Subject,cT=uT.pipe(Ud());cT.connect();var lT=function(){function e(t){var n=t.volatileNotifications,r=t.cobraObservable,o=t.routingObservable;i(this,e),this._performAction=this._performAction.bind(this),this.cobraObservable=r,this.routingObservable=o,this.actionsObservable=cT.pipe(Td(n.pipe(Gu(iT),Ka(ge("payload"))))),this._routingUpdateTimeout=sm.conf.overseer.routing_update_timeout_in_milliseconds}return s(e,[{key:"start",value:function(){return this.actionsObservable.subscribe(this._performAction)}},{key:"_performAction",value:function(e){var t=e.type,n=e.rule_id,r=e.browser_event_conditions,i=this.cobraObservable,o=function(e,t){var n=aT[e];return n?new n(t):new sT(e)}(t,e),s=function(e){var t=e.expectedQueueIds,n=e.routingObservable,r=e.routingUpdateTimeout,i=e.loggerMetadata,o=void 0===i?{}:i,s=e.logger,a=void 0===s?zO:s;return t?n.pipe(Gu((function(e){var n=e.queue_ids;return!(!n||!t)&&rT(n,t)})),Yf(1),Lp(r),hf((function(e){return"TimeoutError"===e.name?a.warn("In-browser business rule action not triggered, expected queue ids not received",Jr(o,{queue_ids:t})):a.error("In-browser business rule action triggering error",h(h({},e),{},{glia_team:"automaton"})),$S.empty()}))):nT.of(null)}({expectedQueueIds:ge("queue_ids",r),routingUpdateTimeout:this._routingUpdateTimeout,routingObservable:this.routingObservable,loggerMetadata:{type:t,rule_id:n}});s.subscribe((function(){var t;t={rule_id:ge("rule_id",e)},zO.log("In-browser business rule action triggered",t),o.perform(i)}),(function(e){return zO.error("Error from should trigger in-browser action subscription",h(h({},e),{},{glia_team:"automaton"}))}))}}],[{key:"triggerAction",value:function(e){uT.next(e)}},{key:"actionTriggers",value:function(e,t){return cT.pipe(Td(e.pipe(Gu(iT),Ka(ge("payload")))),Gu((function(e){return e.type===t})))}}]),e}();sm.BusinessRules.Controller=lT;var fT,dT,pT={},hT={};function vT(){return dT||(dT=1,e=pT,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(fT)return hT;fT=1,Object.defineProperty(hT,"__esModule",{value:!0});var e=sc;return hT.merge=e.merge,hT}())),pT;var e}var bT=vT(),mT=function(e){return{element_text:e.textContent,element_id:e.id,element_tag_name:e.tagName,element_class_name:e.className}},gT=function(e){return!function(e){return 0===e.offsetWidth&&0===e.offsetHeight||e.style&&"none"===e.style.display}(e)},yT=function(e){for(var t=e.parentElement,n=[];null!==t;)n.push(t),t=t.parentElement;return n},_T=function(e){return Array.prototype.slice.call(e)},wT=function(e,t){return(e.matches||e.msMatchesSelector).call(e,t)},ET=1,OT=10;function ST(e){if(!e)return null;for(var t=[];e&&e.nodeType===ET;e=e.parentNode){for(var n=0,r=e.previousSibling;r;r=r.previousSibling)r.nodeType!==OT&&r.nodeName===e.nodeName&&++n;var i=(e.prefix?e.prefix+":":"")+e.localName,o="["+(n+1)+"]";t.splice(0,0,i+o)}return t.length?"/"+t.join("/"):null}var TT=new RegExp(/\/([^/[]+)\[(\d+)\]/g),AT=new RegExp(/:nth-of-type\(1\)/g);function IT(e,t){if("/"===t)return e;if(t){var n=t.replace(TT,"$1:nth-of-type($2) > ").slice(0,-2).replace(AT,"");return e.querySelector(n)}return null}var kT,xT,MT=function(e,t){return CO.Observable.fromEventPattern((function(n){return e.addEventListener(t,n)}),(function(n){return e.removeEventListener(t,n)}))},NT=function(e,t){return CO.Observable.fromEventPattern((function(n){return e.on(t,n)}),(function(n){return e.off(t,n)}))},RT=function(e){return CO.Observable.create((function(t){var n=e.subscribe(t);return function(){return n.unsubscribe()}}))},CT=function(e){return CO.Observable.create((function(t){var n=e.subscribe(t.next.bind(t),t.error.bind(t),t.complete.bind(t));return function(){return n.dispose()}}))},PT=function(e){return e.flatMap((function(e){return CO.Observable.throw(e)}))},jT=function(e){return CO.Observable.create((function(t){e.connect(),e.subscribe(t)}))},LT=function(e,t){var n=t.maxRetries,r=t.calculateDelay,i=t.shouldRetry,o=void 0===i?Ee(!0):i,s=t.scheduler,a=void 0===s?CO.Scheduler.asap:s;return e.retryWhen((function(e){return function(e,t){return e.scan((function(e,n){return u({count:e.count+1},t,n)}),{count:0})}(e,"error").flatMap((function(e){var t=e.count,i=e.error;return o(i)&&t<=n?CO.Observable.timer(r(t),a):CO.Observable.throw(i)}))}))},UT=function(e){var t=e.target,n=e.selector;return"function"==typeof t.msMatchesSelector?t.msMatchesSelector(n):"function"==typeof t.matches&&t.matches(n)},qT=function(e){var t=e.pattern;return-1!==e.element.textContent.indexOf(t)},DT=function(e){return e&&e.nodeType===ET},VT=function(e){var t=e.selector;return t&&-1!==t.indexOf(":contains")},FT=function(e){var t=e.selector,n=t.replace(/'/g,'"').match(/(.*):contains\("([^"]+)"/);if(De(n))throw new Error("Failed to match :contains selector - ".concat(t));var r=n[1].trim(),i=n[2].trim();if(Sr(r))throw new Error("The :contains selector has no tag to match");return{cssSelector:r,containsText:i}},HT=function(e){return VT({selector:e})?function(e){var t=e.selector,n=FT({selector:t}),r=n.cssSelector,i=n.containsText,o=_T(document.querySelectorAll(r));return Lt((function(e){return qT({pattern:i,element:e})}),o)}({selector:e}):_T(document.querySelectorAll(e))},WT=function(e,t){return bT.merge.apply(void 0,m(pe((function(t){return MT(t,e)}),t)))},GT=function(e){var t=e.elementSelector,n=e.eventName;return WT(n,HT(t))},BT=function(e){var t=e.target,n=e.selector;if(!DT(t))return!1;if(VT({selector:n})){var r=FT({selector:n}),i=r.cssSelector,o=r.containsText;return UT({target:t,selector:i})&&qT({pattern:o,element:t})}return!Sr(n)&&UT({target:t,selector:n})},zT=function(){function e(t){var n=t.id,r=t.form_selector,o=t.input_selector,s=t.value;i(this,e),this.filteredValueOrFocusout=this.filteredValueOrFocusout.bind(this),this._valueMatching=this._valueMatching.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.formSelector=r,this.inputSelector=o,this.value=s}return s(e,[{key:"track",value:function(){return bT.merge(this._trackTextFields(),this._trackChangeableFields(),this._trackCheckableFields()).pipe(Ka(this._formatEvent))}},{key:"_trackTextFields",value:function(){var e;try{e=WT("keyup",this._getObservableFields("input[type=text], input:not([type]), textarea"))}catch(t){this._recordInvalidSelector(t),e=$S.empty()}return e.pipe(Gu(this._valueChangingKey),Ka(this._extractValueFromInput),Hf(At),Gu(this._valueMatching),mp(this.filteredValueOrFocusout))}},{key:"_trackChangeableFields",value:function(){var e;try{e=WT("change",this._getObservableFields("select"))}catch(t){this._recordInvalidSelector(t),e=$S.empty()}return e.pipe(Ka(this._extractValueFromOption),Hf(At),Gu(this._valueMatching))}},{key:"_trackCheckableFields",value:function(){var e;try{e=WT("change",this._getObservableFields("input[type=radio], input[type=checkbox]"))}catch(t){this._recordInvalidSelector(t),e=$S.empty()}return e.pipe(Ka(this._extractValueFromInput),Gu(this._valueMatching))}},{key:"_getObservableFields",value:function(e){if(this.inputSelector)return _T(document.querySelectorAll(this.inputSelector)).filter((function(t){return BT({target:t,selector:e})}));if(this.formSelector){var t=_T(document.querySelectorAll("form"+this.formSelector));return Co(pe((function(t){return _T(t.querySelectorAll(e))}),t))}return _T(document.body.querySelectorAll(e))}},{key:"filteredValueOrFocusout",value:function(e){return this.value?nT.of(e):MT(e.target,"focusout").pipe(yd(e))}},{key:"_valueChangingKey",value:function(e){return e.keyCode>=45}},{key:"_valueMatching",value:function(e){var t=e.target.value;return!this.value||t.match(new RegExp(this.value))}},{key:"_extractValueFromInput",value:function(e){return{target:e.target,value:e.target.value}}},{key:"_extractValueFromOption",value:function(e){var t=jn((function(e){return e.selected}),_T(e.target.querySelectorAll("option")));return{target:e.target,value:t&&t.value}}},{key:"_formatEvent",value:function(e){var t=e.target,n=e.value;return{id:this.id,type:"form_filling",source_attributes:Jr(mT(t),{value:n})}}},{key:"_recordInvalidSelector",value:function(e){XO.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:form_filling","reason:invalid_selector"]),zO.warn("Failed to track form filling. Invalid selector",{error:e,form_selector:this.formSelector,input_selector:this.inputSelector,source_id:this.id})}}]),e}(),JT="clicking",QT=function(){function e(t){var n=t.id,r=t.element_selector,o=t.element_tag,s=t.number,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:zO,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:500;i(this,e),this._isTargetElementsOrItsChild=this._isTargetElementsOrItsChild.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.elementSelector=r,this.elementTag=o,this.number=s,this.logger=a,this.throttleTime=u}return s(e,[{key:"track",value:function(){var e,t,n=this,r=(e=document,t="click",CO.Observable.fromEventPattern((function(n){return e.addEventListener(t,n,!0)}),(function(n){return e.removeEventListener(t,n,!0)}))).pipe(Gu((function(e){return n._isTargetElementsOrItsChild(e.target)}))),i=this.number||1;return function(e,t){var n=e.events,r=e.throttleTime,i=e.numberToTrigger;return n.pipe(xp(r,t),sp(i-1))}({events:r,throttleTime:this.throttleTime,numberToTrigger:i}).map(this._formatEvent)}},{key:"_isTargetElementsOrItsChild",value:function(e){var t=this._getElementsSelector();try{var n=HT(t);return dr(n,function(e){for(var t=[];e;)t.push(e),e=e.parentElement;return t}(e)).length>0}catch(e){return XO.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(JT),"reason:invalid_selector"]),this.logger.warn(e,"Failed to query DOM element",{elementSelector:t}),!1}}},{key:"_getElementsSelector",value:function(){return this._tagConstraint()+this._selectorConstraint()}},{key:"_tagConstraint",value:function(){return this.elementTag||""}},{key:"_selectorConstraint",value:function(){return this.elementSelector?"".concat(this.elementSelector):""}},{key:"_formatEvent",value:function(e){return{id:this.id,type:JT,source_attributes:mT(e.target)}}}]),e}(),YT={},KT={};function XT(){return xT||(xT=1,e=YT,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(kT)return KT;kT=1,Object.defineProperty(KT,"__esModule",{value:!0});var e=sc;return KT.timer=e.timer,KT}())),YT;var e}var $T=XT();var ZT=function(){function e(t){var n=t.source_id;i(this,e),this.saveNavigationEvent=this.saveNavigationEvent.bind(this),this.clear=this.clear.bind(this),this._getHistory=this._getHistory.bind(this),this._formatHistory=this._formatHistory.bind(this),this.key="sm_navigations-"+n,this.storage=window.sessionStorage}return s(e,[{key:"saveNavigationEvent",value:function(e){this.storage.setItem(this.key,this._formatHistory(e))}},{key:"anyMatch",value:function(e){return Te((function(t){return t.match(e)}))(this._getHistory())}},{key:"clear",value:function(){this.storage.removeItem(this.key)}},{key:"_getHistory",value:function(){try{return JSON.parse(this.storage.getItem(this.key))||[]}catch(e){return sm.logger.error("Unexpected format for navigation history in sessionStorage",h(h({},e),{},{glia_team:"automaton"})),this.clear(),[]}}},{key:"_formatHistory",value:function(e){var t=xn(2,Ne(e,this._getHistory()));return JSON.stringify(t)}}]),e}();var eA=!1;try{var tA=Object.defineProperty({},"passive",{get:function(){return eA=!0}});window.addEventListener("sm-passive-test",null,tA),window.removeEventListener("sm-passive-test",null,tA)}catch(e){}var nA=function(e,t){return CO.Observable.fromEventPattern((function(n){return e.addEventListener(t,n,!!eA&&{passive:!0})}),(function(n){return e.removeEventListener(t,n)}))},rA={getStream:function(e){var t,n=pe((function(e){return nA(document,e)}),e);return CO.Observable.merge((t=CO.Observable).merge.apply(t,m(n)),nA(window,"focus"),nA(window,"pageshow"))}};sm.PeriodicalActivityTracker=rA;var iA=function(){var e=b(void 0!==document.hidden?["hidden","visibilitychange"]:void 0!==document.mozHidden?["mozHidden","mozvisibilitychange"]:void 0!==document.msHidden?["msHidden","msvisibilitychange"]:["webkitHidden","webkitvisibilitychange"],2),t=e[0],n=e[1];if(void 0===document.addEventListener||void 0===t)return CO.Observable.of({focused:void 0});var r=function(){return{visible:!document[t]}};return nA(document,n).map(r).startWith(r())},oA=function(){var e=(window.crypto||window.msCrypto).getRandomValues(new Uint8Array(16));e[6]=15&e[6]|64,e[8]=191&e[8]|128;for(var t="",n=0;n<e.length;n++)e[n]<16&&(t+="0"),t+=e[n].toString(16),[3,5,7,9].indexOf(n)>-1&&(t+="-");return t},sA=function(e){return"object"===y(e)&&Boolean(e&&e.messageName)},aA=function(e,t,n){var r={messageName:e,payload:t};return n&&(r.options=n),r};function uA(e){var t=this,n=new cA({allowedSource:e});["on","off","start","stop","respondTo"].forEach((function(e){t[e]=n[e].bind(n)})),this.observable=function(e){return NT(n,e)},this.emit=function(t,n,r){e.postMessage(aA(t,n,r),"*")},this.request=function(e,n,r){var i=e+":response",o=oA();t.on(i,(function e(n,s,a,u){u&&u.requestId===o&&(t.off(i,e),r(n,s,a))})),t.emit(e,n,{requestId:o})}}function cA(e){var t=this,n=e.allowAnySource,r=e.allowedSource;if(n&&r)throw new Error("Pass allowedSource or allowAnySource, not both");if(!n&&!r)throw new Error("Pass allowedSource or allowAnySource");var i=function(e){if((n||e.source===r)&&sA(e.data)){var i=e.data,o=i.messageName,s=i.payload,a=i.options;return t.emitEvent(o,[s,e.source,e.origin,a])}};this.start=function(){window.addEventListener("message",i)},this.stop=function(){window.removeEventListener("message",i),t.removeEvent()},this.respondTo=function(e,n){var r=function(t,r,i,o){n(t,(function(t){return r.postMessage(aA(e+":response",t,o),i)}),r,i)};return t.on(e,r),function(){return t.off(e,r)}}}cA.prototype=Object.create(A.prototype);var lA=null,fA=function(){if(!lA){var e=rA.getStream(["scroll","keyup","mousemove","touchstart","orientationchange"]).share(),t=new cA({allowAnySource:!0});t.start();var n=NT(t,"activity_from_cobrowsable_iframe"),r=iA().filter(ji("visible",!0));(lA=CO.Observable.merge(e,n,r).publish()).connect()}return lA};var dA,pA,hA={},vA={};function bA(){return pA||(pA=1,e=hA,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(dA)return vA;dA=1,Object.defineProperty(vA,"__esModule",{value:!0});var e=sc;return vA.interval=e.interval,vA}())),hA;var e}var mA=bA(),gA=function(e){return e?parseFloat(e.replace(/[^\d\.]+/,"")):null},yA="number",_A=function(){function e(t){var n=t.id,r=t.element_selector,o=t.minimum_value;i(this,e),this._elementValues=this._elementValues.bind(this),this._numberMatching=this._numberMatching.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.elementSelector=r,this.minimumValue=o}return s(e,[{key:"track",value:function(){return mA.interval(100).pipe(Mu(this._elementValues),Gu(this._numberMatching),Ka(this._formatEvent),Yf(1))}},{key:"_elementValues",value:function(){var e;try{e=_T(document.querySelectorAll(this.elementSelector))}catch(t){XO.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(yA),"reason:invalid_selector"]),zO.warn("Failed to track number. Invalid selector",{error:t,element_selector:this.elementSelector,source_id:this.id}),e=[]}return xS.from(Hn(e.map(this._elementValue)))}},{key:"_elementValue",value:function(e){return[{element:e,value:gA(e.innerHTML)},{element:e,value:gA(e.value)}]}},{key:"_numberMatching",value:function(e){var t=e.value;return"number"==typeof t&&t>=this.minimumValue}},{key:"_formatEvent",value:function(e){var t=e.element,n=e.value;return{id:this.id,type:yA,source_attributes:Jr(mT(t),{value:n})}}}]),e}();var wA={attributes:!0,characterData:!1,childList:!1,subtree:!1,attributeOldValue:!1,characterDataOldValue:!1};var EA,OA,SA={},TA={};function AA(){return OA||(OA=1,e=SA,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(EA)return TA;EA=1,Object.defineProperty(TA,"__esModule",{value:!0});var e=sc;return TA.fromPromise=e.from,TA}())),SA;var e}var IA=AA();var kA={text:"chat",audio:"voice",phone:"phone",video:"video"};var xA=function(){function e(){i(this,e)}return s(e,[{key:"track",value:function(){return $S.empty()}}]),e}(),MA={form_filling:zT,clicking:QT,time_on_page:function(e){var t=e.id,n=e.seconds,r=function(){return{id:t,type:"time_on_page",source_attributes:{}}};this.track=function(){return $T.timer(1e3*n).pipe(Ka(r))}},mouse_in:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"mouse_in",source_attributes:mT(e.target)}};this.track=function(){try{return GT({elementSelector:n,eventName:"mouseenter"}).pipe(Ka(r))}catch(e){return XO.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:mouse_in","reason:invalid_selector"]),zO.warn("Failed to track mouse in. Invalid selector",{error:(null==e?void 0:e.message)||e,element_selector:n,source_id:t}),$S.empty()}}},mouse_out:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"mouse_out",source_attributes:mT(e.target)}};this.track=function(){try{return GT({elementSelector:n,eventName:"mouseleave"}).pipe(Ka(r))}catch(e){return XO.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:mouse_out","reason:invalid_selector"]),zO.warn("Failed to track mouse out. Invalid selector",{error:e,element_selector:n,source_id:t}),$S.empty()}}},scrolling:function(e){var t=e.id,n=e.percentage,r=function(){return{id:t,type:"scrolling",source_attributes:{}}},i=function(){var e=window.pageYOffset,t=window.innerHeight;return e/(document.documentElement.scrollHeight-t)*100>n};this.track=function(){return MT(window,"scroll").pipe(Gu(i),Ka(r),Yf(1))}},navigation:function(e){var t=e.id,n=e.path,r=function(){return{id:t,type:"navigation",source_attributes:{}}};this.track=function(){var e=new RegExp(n,"i");return sm.hrefObservable.pipe(Gu((function(t){return t.match(e)})),Ka(r))}},activity:function(e){var t=e.id,n=function(){return{id:t,type:"activity",source_attributes:{}}};this.track=function(){return $T.timer(6e4).pipe(Ad(fA()),Yf(1),qd(),Ka(n))}},number:_A,element_created:function(e){var t=e.id,n=e.element_selector,r=e.on_page_load;this.track=function(e){var i=e.options;return n?i.initialLoad&&!r?$S.empty():nT.of({id:t,type:"element_created",source_attributes:{}}):$S.empty()}},element_changed:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"element_changed",source_attributes:mT(e.target)}};this.track=function(e){var i=e.options,o=i.triggerObservable,s=i.mutationObserver;try{HT(n).forEach((function(e){s.observe(e,wA)}))}catch(e){XO.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:element_changed","reason:invalid_selector"]),zO.warn("Failed to observe element changes. Invalid selector",{error:e,element_selector:n,source_id:t})}return o.pipe(Ka(r))}},transfer:function(e){var t=e.id,n=function(e){return{id:t,type:"transfer",source_attributes:{operator_id:e.operatorId,operator_name:e.operatorName,starting_media:e.startingMedia}}};this.track=function(){return iS.vent.observable(iS.MSG.ENGAGEMENT_TRANSFERRED).pipe(Ka(n))}},proactive_accept:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"proactive_accept",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return iS.vent.observable(iS.MSG.PROACTIVE_ACCEPT).pipe(Df(ge("engagement_request_id")),Ka(n))}},proactive_decline:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"proactive_decline",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return iS.vent.observable(iS.MSG.PROACTIVE_DECLINE).pipe(Ka(n))}},engagement_start:function(e){var t=e.id,n=function(e){var n=e.operator,r=e.startingMedia,i=e.engagementId,o=e.type;return{id:t,type:"engagement_start",source_attributes:{operator_id:n.id,operator_name:n.name,proactive_or_reactive:o,engagement_media:kA[r],engagement_id:i}}};this.track=function(){return IA.fromPromise(sm.getApi({version:"v1"})).pipe(Mu((function(e){return e.observable(e.EVENTS.ENGAGEMENT_START)})),Gu(ot(ge("isReestablishing"))),Ka(n))}},reactive_engagement_request_timeout:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"reactive_engagement_request_timeout",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return iS.vent.observable(iS.MSG.REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT).pipe(Ka(n))}},consecutive_navigation:function(e,t){var n=e.id,r=e.to,i=e.from,o=t||new ZT({source_id:n}),s=function(){return o.anyMatch(new RegExp(i,"i"))},a=function(){return{id:n,type:"consecutive_navigation",source_attributes:{}}};this.track=function(){return sm.hrefObservable.pipe(Gu((function(e){return e.match(new RegExp(i,"i"))}))).subscribe(o.saveNavigationEvent),sm.hrefObservable.pipe(Gu(ze((function(e){return e.match(new RegExp(r,"i"))}),s)),Ap(o.clear),Ka(a))}},enqueued:function(e){var t=e.id;this.track=function(e){var n=e.internalVisitorStateObservable,r=["enqueued","request_sent"],i=ji("site_id",sm.siteId),o=dt(Lt(i),Ai([],["omniq","queue_tickets"])),s=dt(ve(0),Lt((function(e){var t=Cr(["visitor","browser_tab_id"]);return dt(At(sm.tabId),Uo(t))(e)})),Lt((function(e){return-1!==r.indexOf(e.state)})),o);return n.pipe(Ka(s),Gu(gt),Hf(null,ge("id")),Ka((function(e){return{id:t,type:"enqueued",source_attributes:{ticket_id:e.id}}})))}}},NA={buildObservable:Je((function(e,t,n){var r,i,o=function(e){var t=e.sources,n=e.internalVisitorStateObservable,r=e.options;return 0===Object.keys(t).length?$S.empty():new(MA[t.type]||xA)(t).track({internalVisitorStateObservable:n,options:r})}({sources:t.sources,internalVisitorStateObservable:e,options:n});return t.url_matcher?o.pipe(Zp((r=t.url_matcher,i=new RegExp(r,"i"),sm.hrefObservable.pipe(Ka((function(e){return e.match(i)})),Hf(At))),(function(e,t){return{value:e,isMatching:t}})),Gu(ge("isMatching")),Ka(ge("value"))):o}))},RA=function(){function e(){i(this,e)}return s(e,null,[{key:"observable",value:function(e,t){var n=this._selectorsToObserveOnElementCreated(e.sources);return n.length>0?this._trackCreatedElements(e,n,t):nT.of({})}},{key:"_trackCreatedElements",value:function(e,t,n){var r=this._initiateSourceAttributes(e.sources);return n.pipe(Ka((function(e){return{target:e,initialLoad:!1}})),vp({target:document.body,initialLoad:!0}),Gu(this._filterBySourceType({source:e.sources,selectors:t,rawRule:e})),Ka(ki(["initialLoad"])),Ka(Jr(r)))}},{key:"_filterBySourceType",value:function(e){var t=this,n=e.source,r=e.selectors,i=e.rawRule;return function(e){var o=e.target;return!(!e.initialLoad||"element_created"===n.type)||t._targetMatchesAny(o,r,i,n)}}},{key:"_initiateSourceAttributes",value:function(e){return"element_changed"===e.type?this._getElementChangedAttributes(e):{}}},{key:"_getElementChangedAttributes",value:function(e){var t=new jS.Subject,n=new MutationObserver((function(n){return Gn((function(n){if(BT({target:n.target,selector:e.desired_selector}))return t.next(n)}),n)}));return{triggerObservable:t.asObservable(),mutationObserver:n}}},{key:"_selectorsToObserveOnElementCreated",value:function(e){switch(e.type){case"form_filling":return[e.form_selector,e.input_selector];case"mouse_in":case"mouse_out":case"element_changed":case"element_created":return[e.element_selector];default:return[]}}},{key:"_targetMatchesAny",value:function(e,t,n,r){return Te((function(t){try{return BT({target:e,selector:t})||function(e){var t=e.target,n=e.selector;return!(!DT(t)||!t.hasChildNodes())&&Te((function e(t){var r=BT({target:t,selector:n});return!r&&t.hasChildNodes()?Te(e,t.childNodes):r}),t.childNodes)}({target:e,selector:t})}catch(e){return XO.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(r.type),"reason:invalid_selector"]),zO.warn("Failed to track element. Invalid selector",{error:e&&e.message,selector:t,source_type:r.type,rule_id:n.id}),!1}}),t)}}]),e}();function CA(e){return CA="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},CA(e)}function PA(e){return function(e){if(Array.isArray(e))return jA(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return jA(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return jA(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function jA(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var LA,UA=function(e,t,n){var r={};for(var i in n)r[i]=n[i];return r[e]=t,r},qA=function(e){return function t(n){return 0===arguments.length?t:e.apply(this,arguments)}},DA=qA((function(e){return null===e||"object"!==CA(e)?e:Array.isArray(e)?e.map((function(e){return DA(e)})):Object.keys(e).reduce((function(t,n){return UA([(r=n.split("_"))[0]].concat(PA(r.slice(1).map((function(e){return function(e){return"".concat(e.slice(0,1).toUpperCase()).concat(e.slice(1).toLowerCase())}(e)})))).join(""),DA(e[n]),t);var r}),{})})),VA=qA((function(e){return null===e||"object"!==CA(e)?e:Array.isArray(e)?e.map((function(e){return VA(e)})):Object.keys(e).reduce((function(t,n){return UA(n.replace(/\W+/g," ").split(RegExp(" |\\B(?=[A-Z])")).map((function(e){return e.toLowerCase()})).join("_"),VA(e[n]),t)}),{})})),FA=(LA=function(e,t){return Object.keys(t).reduce((function(n,r){var i=e[r];if(Array.isArray(i)){var o=t[r];if(!o||"object"!==CA(o))throw new Error("Nested value should be an object");return UA(i[0]||r,FA(i[1],o),n)}return UA(i||r,t[r],n)}),{})},function e(t,n){return 0===arguments.length?e:1===arguments.length?qA((function(e){return LA(t,e)})):LA(t,n)}),HA=s((function e(t){var n=t.status,r=t.medias;i(this,e),this.status=n,this.medias=r}));HA.prototype.STATUSES={OPEN:"open",CLOSED:"closed",FULL:"full",UNSTAFFED:"unstaffed"};var WA=function(e){return"opened"===e?HA.prototype.STATUSES.OPEN:e},GA=s((function e(t){var n=t.id,r=t.name,o=t.status,s=t.medias;i(this,e),this.id=n,this.name=r,this.state=new HA({status:o,medias:s})})),BA={SALEMOVE:{ALREADY_QUEUED:"already queued",INVALID_INPUT:"invalid input",OPERATOR_UNAVAILABLE:"operator unavailable",INTERNAL_ERROR:"internal error",RESOURCE_NOT_FOUND:"not found",OPERATOR_DECLINED:"operator declined",DECLINE:"decline",CANCEL:"cancel",TIMEOUT:"timeout",NETWORK_TIMEOUT:"network timeout",CONNECTION_LOST:"connection lost",TOO_MANY_REQUESTS:"too many requests",FORBIDDEN:"forbidden",NOT_SUPPORTED:"not supported",DISABLED:"disabled",ALREADY_ENGAGED:"already engaged",CONFLICT:"conflict",FILE_CONTENT_TYPE_NOT_ALLOWED:"file content type not allowed",FILE_TOO_LARGE:"file too large",DENIED_BY_PERMISSIONS_POLICY:"denied by permissions policy",DEVICE_ACCESS_ERROR:"device access error",DENIED_BY_SYSTEM:"denied by system",UNAUTHORIZED:"unauthorized"}},zA=5e3,JA=["text","phone","audio","video"],QA=[502,503],YA=[400,413,422],KA=[401,403],XA="sm_change_element_attributes",$A="omnicore",ZA="omnibrowse",eI={"content-type":"application/json",accept:"application/vnd.salemove.v1+json"},tI=["af","al","dz","as","ad","ao","ai","ag","ar","am","aw","au","at","az","bs","bh","bd","bb","by","be","bz","bj","bm","bt","bo","ba","bw","br","io","vg","bn","bg","bf","bi","kh","cm","ca","cv","bq","ky","cf","td","cl","cn","cx","cc","co","km","cd","cg","ck","cr","ci","hr","cu","cw","cy","cz","dk","dj","dm","do","ec","eg","sv","gq","er","ee","et","fk","fo","fj","fi","fr","gf","pf","ga","gm","ge","de","gh","gi","gr","gl","gd","gp","gu","gt","gg","gn","gw","gy","ht","hn","hk","hu","is","in","id","ir","iq","ie","im","il","it","jm","jp","je","jo","kz","ke","ki","xk","kw","kg","la","lv","lb","ls","lr","ly","li","lt","lu","mo","mk","mg","mw","my","mv","ml","mt","mh","mq","mr","mu","yt","mx","fm","md","mc","mn","me","ms","ma","mz","mm","na","nr","np","nl","nc","nz","ni","ne","ng","nu","nf","kp","mp","no","om","pk","pw","ps","pa","pg","py","pe","ph","pl","pt","pr","qa","re","ro","ru","rw","bl","sh","kn","lc","mf","pm","vc","ws","sm","st","sa","sn","rs","sc","sl","sg","sx","sk","si","sb","so","za","kr","ss","es","lk","sd","sr","sj","sz","se","ch","sy","tw","tj","tz","th","tl","tg","tk","to","tt","tn","tr","tm","tc","tv","vi","ug","ua","ae","gb","us","uy","uz","vu","va","ve","vn","wf","eh","ye","zm","zw","ax"],nI=dt(Xe(Ce),Ce)(BA),rI=s((function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(i(this,e),this.cause=n.cause,n.message&&(this.message=n.message),this.cause&&Gt(this.cause,nI))||(this.cause=BA.SALEMOVE.INTERNAL_ERROR,(t=sm.logger).error.apply(t,["Incorrect Error usage"].concat(Array.prototype.slice.call(arguments))))})),iI=function(e){var t=String(e);if(0===t.indexOf("[object "))try{t=JSON.stringify(e)}catch(e){t=e instanceof TypeError?"Unable to parse param: ".concat(e.message):"Unexpected parse error ".concat(e)}return t},oI=function(e,t){t||(t={});var n,r=t.logger||zO;return n=e.cause,Gt(n,Ce(BA.SALEMOVE))?e:function(e,t){if(e||(e={}),t||(t=zO),Gt(e.status,QA))return new rI({cause:BA.SALEMOVE.INTERNAL_ERROR});if(Gt(e.status,KA))return new rI({cause:BA.SALEMOVE.UNAUTHORIZED});if(0===e.status||0===e.readyState)return new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT});var n="Uncaught error in 'public' observable. Wrapping as an internal error.";return e.details&&(n+=" Details: ".concat(iI(e.details),".")),e.error&&(n+=" Error: ".concat(iI(e.error),".")),e.debug_message&&(n+=" Debug message: ".concat(iI(e.debug_message),".")),e.message&&(n+=" Message: ".concat(iI(e.message))),t.error(n.substr(0,1e3),e),new rI({cause:BA.SALEMOVE.INTERNAL_ERROR})}(e,r)},sI=function(e){return e||(e={}),CO.Observable.throw(oI(e))},aI=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e instanceof rI)return CO.Observable.throw(e);var n=Gt(e.status,YA)?new rI({cause:BA.SALEMOVE.INVALID_INPUT}):409===e.status?new rI({cause:BA.SALEMOVE.CONFLICT}):e.cause===BA.SALEMOVE.NETWORK_TIMEOUT?e:oI(e);return t.allowedCauses&&n.cause!==BA.SALEMOVE.INTERNAL_ERROR&&!Gt(n.cause,t.allowedCauses)?(zO.error("Unhandled error treated as internal error",{status:e.status,message:e.message,debug_message:e.debugMessage}),CO.Observable.throw(new rI({cause:BA.SALEMOVE.INTERNAL_ERROR}))):CO.Observable.throw(n)},uI="queue:multi",cI={channelObservable:null,topicNotifications:{}},lI=function(e){var t=e.queueId,n=e.name,r=e.state,i=e.medias;return new GA({id:t,name:n,status:WA(r),medias:i})},fI=function(e){var t=e.pubsub,n=e.cache;n||(n=cI);var r=n.channelObservable,i=n.topicNotifications||{};return function(e){var o=pe(Vt("queue:"),e);return CO.Observable.create((function(s){if(r){!function(e){var t=e.queueIds,n=e.observer;t.forEach((function(e){var t=i[e];if(t)return n.next(t)}))}({queueIds:e,observer:s}),r.flatMap((function(e){return e.watchNewTopics(o)})).toPromise().catch((function(e){return zO.warn("Unable to update queue pubsub channel topics ",e)}))}else(r=t.joinChannel(uI,{topics:o}).do((function(){return zO.info("Joined ".concat(uI," topic"))})).publishReplay(1)).connect(),n.channelObservable=r;return r.flatMap((function(e){return e.observable("change")})).map(FA({queue_id:"queueId"})).filter((function(t){var n=t.queueId;return-1!==e.indexOf(n)})).map(lI).do((function(e){i[e.id]=e})).subscribe(s)}))}},dI=function(e){var t=e.queueIds;return(0,e.observeQueueStateUpdates)(t).pipe(Mc((function(e,t){var n=Un(ji("id",t.id))(e);return-1===n?Ne(t,e):At(jn(ji("id",t.id))(e),t)?e:on(n,t,e)}),[]),Hf((function(e,t){return e===t})))};var pI=function(e){var t=e.queueIds;return(0,e.observeQueueStateUpdates)(t).pipe($s(ge("id")),Mu((function(e){return e.distinctUntilChanged()})))},hI=function(e,t){if(!e)throw new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Queue IDs list is undefined"});if(Sr(e))throw new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Queue IDs list is empty"});if(!t)throw new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Listener is undefined"})},vI=function(e){var t=e.enabled,n=e.createQueueStateObservable,r=e.createQueueStateAccumulateObservable,i=e.pubsub;r||(r=dI),n||(n=pI);var o=function(e){var n=e.queueIds,o=e.listener;if(t){var s=new CO.Subscription;hI(n,o);try{var a=r({queueIds:n,observeQueueStateUpdates:fI({pubsub:i})});s.add(a.subscribe(o,zO.error.bind(zO,"Failed to receive queue state list updates")))}catch(e){zO.error("Failed subscribe to queue state list updates",e)}return s}};return{subscribe:function(e,r){if(t){var o=new CO.Subscription;hI(e,r);try{var s=n({queueIds:e,observeQueueStateUpdates:fI({pubsub:i})}).publish();o.add(s.subscribe(r,zO.error.bind(zO,"Failed to receive queue state updates"))),o.add(function(e,t){var n=new CO.Subscription;return n.add(t.bufferCount(e.length).take(1).subscribe((function(e){return zO.info("Received initial queue states",{queue_states:pe((function(e){return{id:e.id,status:e.state.status}}),e)})}))),n.add(t.skip(e.length).subscribe((function(e){return zO.info("Received queue state update",{queue_id:e.id,queue_status:e.state.status})}))),n}(e,s)),o.add(s.connect())}catch(e){zO.error("Failed subscribe to queue state updates",e)}}},subscribeToList:o,subscribeToListAsObservable:function(e){var t=e.queueIds,n=e.subscribeToListFn;return n||(n=o),t?CO.Observable.create((function(e){return n({queueIds:t,listener:e.next.bind(e)})})):CO.Observable.empty()}}},bI=function(){function e(){i(this,e)}return s(e,[{key:"start",value:function(e,t){var n=t.routingObservable;return this.ruleTracker(t,e).pipe(Mu((function(r){var i,o=t.queuesAvailabilityObservable.pipe(Of(100,i));return OS.combineLatest(t.currentStatusObservable,o).pipe(Yf(1),Ka((function(t){var i=b(t,2),o=i[0],s=i[1];return{overseerApi:e,bufferedEvents:r,currentStatus:o,queuesState:s,routingObservable:n}})))}))).concatMap(this.actUponRules).subscribe(null,(function(e){e&&"unauthorized"===e.error?zO.warn("Error from business rule subscription likely due to visitor authentication occurring.",{glia_team:"sudo"}):zO.error("Error from business rule subscription: ".concat(ge("message",e)||e),h(h({},e),{},{glia_team:"automaton"}))}))}},{key:"ruleTracker",value:function(t,n,r){var i=t.rules,o=t.domInsertObservable,s=t.buildRuleObservable,a=xS.from(i).pipe(Mu(gI),Mu(function(e){var t=e.domInsertObservable,n=e.buildRuleObservable;return function(e){return RA.observable(e,t).pipe(mp((function(t){return n(e,t)})),Ka((function(t){return Jr({attrs:t},e)})))}}({domInsertObservable:o,buildRuleObservable:s})),rp(1)),u=mS.Observable.merge(a.pipe(Kl(e.BUFFER_TIME,r)),a.pipe(gd(null,null)));return a.pipe(qp(u),Iu((function(e){return e.toArray()})),nh(u,(function(e,t){return e})),Gu((function(e){return e.length>0})))}},{key:"actUponRules",value:function(e){var t=e.overseerApi,n=e.currentStatus,r=e.queuesState,i=e.bufferedEvents,o=e.controller,s=void 0===o?lT:o,a=["visitor_status"];r&&a.push("queues_availability"),i=pe((function(e){var t=function(e){var t=Te((function(e){return"send_analytics_event"===e.type}),e.actions);return t?e:yi(Cr(["attrs","source_attributes"]),hi(["element_text","element_id","element_tag_name","element_class_name"]))(e)}(e),n=pe(ge("type"),t.conditions);return!Sr(en(n,a))?Jr(t,{actions:[],send_to_server:!0}):t}),i);var u=Lt((function(e){return function(e){var t=e.event,n=e.currentStatus,r=e.queuesState,i=B((function(e){return function(e,t,n){return"visitor_status"===e.type?-1!==e.status.indexOf(t):"queues_availability"!==e.type||function(e,t){var n=Si(Ti(["state","status"],"open"))(t),r=b(n,2),i=r[0],o=r[1],s=function(t){var n=t.id;return Gt(n,e.queueIds)};if("can_enqueue"===e.compareType)return Te(s,i);if("cannot_enqueue"===e.compareType)return Te(s,o)}(FA({queue_ids:"queueIds",compare_type:"compareType"},e),n)}(e,n,r)}),t.conditions);i&&zO.log("Business rule source matched: ",{send_to_server:t.send_to_server,rule_name:t.name,url:WO(window.location.href),source_id:t.attrs.id,rule_id:t.id});return i}({event:e,currentStatus:n,queuesState:r})}),i),c=Jn((function(e){return e.send_to_server?"serverEvents":"browserEvents"}))(u),l=c.serverEvents||[],f=c.browserEvents||[];u.forEach((function(e){var t=e.actions,n=e.attrs,r=e.id,i=e.name,o=e.browser_event_conditions;if(!Sr(t))return function(e,t,n,r,i,o){e.forEach((function(e){var s=Jr({rule_id:n,rule_name:r,browser_event_conditions:o},function(e,t){t||(t={});if(e.fields){var n=function(e,t){var n={};return t.forEach((function(t){var r=t.key,i=t.value,o=t.custom_value,s="custom"===i?o:e[i];n[r]=s})),n}(Jr({visitor_id:jO(),site_id:DO(),url:window.location.href},t),e.fields);return Jr(e,{fields:n})}return e}(e,t));i.triggerAction(s)}))}(t,n.source_attributes,r,i,s,o)}));var d=Lt((function(e){var t=e.actions;return!Sr(t)}),f),p=pe((function(e){var t=e.actions;return{ruleId:e.id,actionTypes:ye("type",t)}}),d);return Sr(p)||function(e){var t=e.overseerApi,n=e.browserEvents;t.sendOverseerMetrics({browserEvents:n})}({overseerApi:t,browserEvents:p}),Sr(l)?mS.Observable.of(null):function(e,t,n){return e.sourcesTriggered({events:n,resolvedConditions:t,tabId:sm.tabId})}(t,a,pe((function(e){var t=e.attrs,n=e.id;return qe("rule_id",n,t)}))(l)).pipe(hf((function(e){return e instanceof window.Error?mS.Observable.throwError(e):mS.Observable.of(null)})))}}],[{key:"init",value:function(t,n){var r=n.currentStatusObservable,i=n.internalVisitorStateObservable,o=n.rules,s=n.queuesAvailabilityObservable,a=n.routingObservable,u=mS.Observable.create((function(e){var t=new MutationObserver((function(t){return Gn((function(t){return Gn((function(t){if(t instanceof HTMLElement)return e.next(t)}),t.addedNodes)}),t)}));return t.observe(document.body,{attributes:!1,characterData:!1,childList:!0,subtree:!0,attributeOldValue:!1,characterDataOldValue:!1}),function(){return t.disconnect()}})),c=NA.buildObservable(i);return(new e).start(t,{currentStatusObservable:r,queuesAvailabilityObservable:s,rules:o,domInsertObservable:u,buildRuleObservable:c,routingObservable:a})}}]),e}();function mI(e){return e.operator?mI(e.left).concat(mI(e.right)):[e]}function gI(e){var t;t=Array.isArray(e.sources)?e.sources:mI(e.sources);var n=pe((function(t){return qe("sources",t,e)}),t);return xS.from(n)}bI.BUFFER_TIME=100,bI.INIT_TIMESTAMP=(new Date).getTime();var yI,_I,wI={},EI={};function OI(){return _I||(_I=1,e=wI,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(yI)return EI;yI=1,Object.defineProperty(EI,"__esModule",{value:!0});var e=sc;return EI._throw=e.throwError,EI}())),wI;var e}var SI=OI(),TI=[sm.conf.api_url,"libs.salemove.com","libs.glia.com","visitor.local.dev"],AI=function(e){return Te((function(t){return Gt(t,e)}),TI)},II=function(e){if("string"!=typeof e&&(t=e,n=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i"),!Boolean(n.test(t))))return zO.warn("Invalid URL provided",{rawUrl:e}),!1;var t,n;try{var r=new window.URL(e);return AI(r.origin)}catch(t){try{var i=e.trim();return Boolean(i)&&i.length>2&&AI(i)}catch(t){return zO.warn("Error validating URL",{rawUrl:e,error:t}),!1}}},kI=ki(["response","status","statusText","readyState","responseURL"]),xI=function(e){var t=e.method,n=e.url,r=e.payload,i=e.responseType,o=e.getRequestHeaders,s=e.onUploadProgress,a=e.onSuccess,u=e.onError,c=new XMLHttpRequest;if(c.open(t,n,!0),o){var l=o();r="application/json"===l["Content-Type"]&&"string"!=typeof r?JSON.stringify(r):r,Object.keys(l).forEach((function(e){var t=l[e];c.setRequestHeader(e,t)}))}return c.responseType=i,c.onreadystatechange=function(){if(4===c.readyState)if(c.status>=200&&c.status<300)if("json"===i&&"string"==typeof c.response)try{var e=qe("response",c.response.length>0?JSON.parse(c.response):"",c);a(e)}catch(e){zO.error("Could not parse response json in IE11",{error:e,server_response:c.response}),u(c)}else a(c);else u(c)},s&&c.upload.addEventListener("progress",(function(e){e.lengthComputable&&s({loaded:e.loaded,total:e.total})}),!1),II(n)?c.send("GET"===t?void 0:r):(zO.error("Trying to fetch from invalid URL",{rawUrl:n}),u(c)),function(){return c.abort()}},MI=function(e){var t=e.method,n=e.url,r=e.payload,i=e.responseType,o=e.getRequestHeaders,s=e.onUploadProgress,a=e.sendRequest,u=e.contentType;return II(n)?(t=t||"GET",i=i||"json",a=a||xI,o||(o=function(){return{Accept:"application/vnd.salemove.private+json",Authorization:"Bearer "+sm.accessToken}}),mS.Observable.create((function(e){return a({method:t,url:n,payload:r,responseType:i,getRequestHeaders:u?function(){return Jr(o(),{"Content-Type":u})}:o,onUploadProgress:s,onSuccess:function(t){e.next(t),e.complete()},onError:function(t){return e.error(kI(t))}})}))):(zO.error("Trying to fetch from invalid URL",{rawUrl:n}),SI._throw(new rI({cause:BA.SALEMOVE.INTERNAL_ERROR,message:"Request URL is invalid"})))},NI=function(e){var t=e.url,n=e.method,r=e.payload,i=e.responseType,o=e.contentType,s=e.getRequestHeaders,a=e.calculateAttemptDelay,u=e.retryLimit,c=void 0===u?5:u,l=e.onSuccess,f=e.onError,d=void 0===f?function(){}:f,p=e.onAttempt,h=void 0===p?function(){}:p,v=e.onAttemptError,b=void 0===v?function(){}:v,m=e.shouldRetry,g=void 0===m?function(){return!0}:m;$o({calculateAttemptDelay:a,attempt:function(e){var a=e.repeat;h(),xI({method:n,url:t,payload:r,responseType:i,getRequestHeaders:o?function(){return Jr(s(),{"Content-Type":o})}:s,onError:function(e){var t=g(e.status);b(t,e),(t?a:d)(e)},onSuccess:l})},onGiveUp:d,retryLimit:c})},RI=function(e,t){var n=e.url,r=e.assetKey,i=e.onError,o=e.onSuccess,s=e.identifier,a=e.skipErrorReport;NI(Jr({method:"GET",responseType:"json",onSuccess:function(e){t.increment("sm.assets.load",["action:succeeded","asset:".concat(r)]),o(e)},onAttempt:function(){t.increment("sm.assets.load",["action:attempted","asset:".concat(r)])},onAttemptError:function(e,i){var o=i.status,a=i.statusText,u=i.responseURL,c=i.response;zO.warn("Failed fetching ".concat(r).concat(e?", retrying":""),{asset_url:n,identifier:s,status:o,statusText:a,responseURL:u,response:c}),t.increment("sm.assets.load",["action:warning","asset:".concat(r)])},onError:function(){a||(zO.warn("Error fetching ".concat(r),{asset_url:n,identifier:s}),t.increment("sm.assets.load",["action:failed","asset:".concat(r)])),"function"==typeof i&&i()}},e))},CI=function(){return{Accept:"application/vnd.salemove.private+json",Authorization:"Bearer "+sm.accessToken}};function PI(e){var t=e.stats,n=function(e){return t.increment("sm.service.overseer_api.action_shortcircuited",["type:".concat(e)])},r=function(){t.increment("sm.lib.overseer",["action:attempted"])};return{sourcesTriggered:function(e){var n=e.events,i=e.tabId,o=e.resolvedConditions,s=e.xhrWithRetry,a=void 0===s?NI:s;return mS.Observable.create((function(e){var s=Jr({site_id:DO(),url:window.location.href},{events:n,tab_id:i,resolved_conditions:o});a({method:"POST",url:"".concat(sm.conf.api_url,"/overseer/sources_triggered"),payload:s,contentType:"application/json",responseType:"json",getRequestHeaders:CI,onAttempt:r,onSuccess:function(){var n,r,i;r=(n={resource:"overseer",method:"sources_triggered"}).resource,i=n.method,zO.log("Successfully executed '".concat(i,"' on resource ").concat(r)),t.increment("sm.lib.overseer",["action:succeeded"]),e.next(null),e.complete()},onError:function(n){var r,i,o;i=(r={resource:"overseer",method:"sources_triggered"}).resource,o=r.method,zO.warn("Failed to execute '".concat(o,"' on resource ").concat(i)),t.increment("sm.lib.overseer",["action:failed"]),e.error(n)},calculateAttemptDelay:Ko(100),shouldRetry:function(e){return 422!==e}})}))},sendOverseerMetrics:function(e){var t=e.browserEvents;Gn(n,t.flatMap((function(e){return e.actionTypes})))}}}var jI=function(e){var t=function(e){return dt(Ut(De),Xe(ge("queue_ids")),Xe(ge("conditions")))(e)}(e)||[],n=function(e){return dt(Ut(De),Xe(me(["browser_event_conditions","queue_ids"])))(e)}(e)||[],r=t.concat(n);return fr(r)},LI=function(e){return Lt(dt(An(Sr,De),Xe(Ui([],"queue_ids")),ge("conditions")))(e)},UI=function(e){return Lt(dt(Sr,Ai([],["browser_event_conditions","queue_ids"])))(e)};function qI(e){var t=e.cobraObservable,n=e.internalVisitorStateObservable,r=e.volatileNotifications,i=e.stats,o=e.currentStatusObservable,s=e.queuesStateUpdatesObservable,a=e.routingObservable;new lT({volatileNotifications:r,cobraObservable:t,routingObservable:a}).start();var u=new PI({stats:i}),c=sm.conf.overseer.rules,l=sm.conf.omniq.omniq_enabled?c:function(e){return dt(LI,UI)(e)}(c),f=jI(l),d=function(){if(it(Sr(f))){var e=new CO.ReplaySubject(1);return s.subscribeToList({queueIds:f,listener:e.next.bind(e)}),e}return CO.Observable.of(null)}();bI.init(u,{currentStatusObservable:o.startWith("available"),internalVisitorStateObservable:n,queuesAvailabilityObservable:d,rules:l,routingObservable:a})}function DI(e,t,n){var r=!1!==(arguments.length>3&&void 0!==arguments[3]?arguments[3]:{}).rethrow;return function(){try{return n.apply(this,arguments)}catch(n){if(XO.clientHandlerError(t),zO.warn(e,n),r)throw n;console.error(n)}}}var VI=j(2,(function(e,t){return dt(Gn((function(t){var n=b(t,2),r=n[0],i=n[1];return e(r,i)})),bo)(t)})),FI=function(){var e={},t=function(e,t){return DI("Event handler for ".concat(e," threw an error"),e,t,{rethrow:!1})},n=function(n,r){var i=(e[n]||{}).listenerEntries||[],o=dt(pe((function(e){var i=e.listener;return{listener:i,subscription:r.subscribe(t(n,i),(function(e){return zO.error("ObservableToEventEmitterAdapter failed in proxy",e)}))}})),Gn((function(e){return e.subscription.unsubscribe()})))(i);e[n]={observable:r,listenerEntries:o}};return{observable:function(t){return e[t].observable},addEventListener:function(n,r){var i=e[n]||{},o=i.listenerEntries||[],s=i.observable;if(!Te(ji("listener",r),o)){var a=s?s.subscribe(t(n,r),(function(e){return zO.error("ObservableToEventEmitterAdapter failed in addEventListener",e)})):CO.Subscription.EMPTY,u=Ne({listener:r,subscription:a},o);return e[n]={listenerEntries:u,observable:s},null}},removeEventListener:function(t,n){var r=e[t]||{},i=r.listenerEntries||[],o=r.observable,s=jn(ji("listener",n))(i);if(s){s.subscription.unsubscribe();var a=Fo([s])(i);e[t]={observable:o,listenerEntries:a}}return null},proxy:n,proxyAll:VI(n),eventWithoutListenerObservable:function(t){return(e[t]||{}).observable.pipe(Gu((function(){return!function(t){var n=(e[t]||{}).listenerEntries||[];return it(Sr(n))}(t)})))},stop:function(){dt(Gn((function(e){return e.unsubscribe()})),pe(ge("subscription")),Xe(ge("listenerEntries")),Ce)(e),e={}}}},HI=function(){var e=new CO.Subscription,t=FI(),n=function(n,r){var i=r.publishReplay(1);e.add(i.connect()),t.proxy(n,i)};return{addEventListener:t.addEventListener,removeEventListener:t.removeEventListener,eventWithoutListenerObservable:t.eventWithoutListenerObservable,proxy:n,proxyAll:VI(n),stop:function(){e.unsubscribe(),t.stop()},observable:t.observable}};function WI(e){var t=HI();return t.proxy("change",e),{addEventListener:t.addEventListener,removeEventListener:t.removeEventListener}}var GI=function(){return WI((arguments.length>0&&void 0!==arguments[0]?arguments[0]:sm.tracker).getUserIsActiveTabObservable())},BI=function(){return WI(CO.Observable.of(!0))};function zI(e){var t=e.channelObservable,n=e.logger.withTags({feature:"cobra"}),r=t.flatMap((function(e){var t=e.channel,n=e.operator;return rS("Cobra").map((function(e){return{Cobra:e,channel:t,operator:n}}))})).distinctUntilChanged(null,(function(e){return e.channel.url})).switchMap((function(e){var t=e.Cobra,r=e.channel,i=e.operator,o=new t.SourceInitializer(r,GI(),i.id,n),s=o.initialize(),a=function(){return o.stop()};return r.addDestroyListener((function(){return a()})),CO.Observable.create((function(e){return e.next({cobraSourceInitializer:o,cobraSource:s,operator:i}),function(){return a()}}))})).do((function(e){var t=e.operator;return n.info("Cobra: Started successfully",{operator_id:t.id})}),n.warn.bind(n,"Cobra: Failed to start"),(function(){return n.info("Cobra: Stopped and will not start again")})),i=r.publishReplay(1);return sm.cobraSubscription=i.connect(),{cobraObservable:r=i.filter(Ti(["cobraSource","status"],"started"))}}var JI,QI={UNKNOWN:"unknown",NESTED_COBROWSABLE_IFRAME:"nested_cobrowsable_visitor",ENGAGEMENT_IFRAME:"main_visitor"},YI="cobrowsable_iframe_id",KI="sm:source:nested_cobrowsable_iframe:channel_url",XI="sm:iframe_context_check",$I=function e(t,n){var r=function(e,t){for(var n=e.querySelectorAll("iframe"),r=0;r<n.length;r++){var i=n[r];if(i.contentWindow===t)return i}}(t,n);if(r)return r;for(var i=t.querySelectorAll("*"),o=0;o<i.length;++o){var s=i[o];if(s.shadowRoot){var a=e(s.shadowRoot,n);if(a)return a}}return null},ZI=new CO.ReplaySubject(1);JI=new Set,ZI.next(JI);var ek=function(e){JI.has(e)||(JI.add(e),ZI.next(JI))};function tk(e){var t={parent:{},top:{}},n=new uA(window.parent);this.start=function(){n.start()},this.stop=function(){n.stop()},this.request=function(){n.request(XI,{tab_id:e},(function(e){e.context?(t.parent[e.context]=!0,ek(e.tabId)):(zO.warn("Received iframe identity check with unexpected payload"),t.parent[e]=!0)})),n.request(KI,{},(function(e){var n=e.url;t.nestedCobrowsableVisitorIframeChannelUrl=n}))},this.getCurrentContext=function(){return t},this.getParentWindowMessenger=function(){return n}}var nk=function(e){var t=new cA({allowAnySource:!0});return t.start(),t.respondTo(XI,(function(t,n,r){var i=$I(document,r);i&&function(e){var t=e.attributes[YI];t&&t.value||e.setAttribute(YI,oA())}(i),t.tab_id?ek(t.tab_id):zO.warn("Received iframe identity check with unexpected payload",t),n({context:"visitor_page",tabId:e})})),t.stop.bind(t)},rk=function(e){var t=new cA({allowAnySource:!0});return t.start(),t.respondTo(XI,(function(t,n,r){n({context:"visitor_browser",tabId:e})})),t.stop.bind(t)};function ik(e,t){var n=t.visitor_api.iframe_identity_detection_timeout||5e3,r=t.visitor_api.iframe_identity_validity_check_timeout||3e4,i=function(){var t=e.getCurrentContext();return t.parent.visitor_page?QI.NESTED_COBROWSABLE_IFRAME:t.parent.visitor_browser?QI.ENGAGEMENT_IFRAME:void 0};return{detect:i,identityObservable:function(t){var o=CO.Observable.interval(200,t).take(Math.round(n/200)).do((function(t){if(!t)return e.request()})).map(i).startWith(i()).filter((function(e){return Boolean(e)})).take(1).defaultIfEmpty(QI.UNKNOWN).share(),s=o.filter((function(e){return e===QI.UNKNOWN})).flatMap((function(){return CO.Observable.interval(r/2,t).take(2).do((function(t){t||e.request()})).map(i).filter((function(e){return Boolean(e)})).take(1)}));return o.merge(s)},IDENTITIES:QI}}var ok=function(){var e,t,n=new CO.Subject;e=window.history,(t=e?e.pushState:void 0)&&(e.pushState=function(r){var i=t.apply(e,arguments);return n.next({state:r}),i}),function(){var e=window.history,t=e?e.replaceState:void 0;t&&(e.replaceState=function(r){var i=t.apply(e,arguments);return n.next({state:r}),i})}(),MT(window,"popstate").subscribe(n);var r=n.startWith({}).map((function(){return window.location.href})).distinctUntilChanged();sm.hrefObservable=r},sk=function(e){if("function"==typeof e)return e;return function(){return e}},ak="undefined"!=typeof self?self:null,uk="undefined"!=typeof window?window:null,ck=ak||uk||ck,lk=0,fk=1,dk=2,pk=3,hk="closed",vk="errored",bk="joined",mk="joining",gk="leaving",yk="phx_close",_k="phx_error",wk="phx_join",Ek="phx_reply",Ok="phx_leave",Sk="longpoll",Tk="websocket",Ak=4,Ik=function(){function e(t,n,r,o){i(this,e),this.channel=t,this.event=n,this.payload=r||function(){return{}},this.receivedResp=null,this.timeout=o,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}return s(e,[{key:"resend",value:function(e){this.timeout=e,this.reset(),this.send()}},{key:"send",value:function(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}},{key:"receive",value:function(e,t){return this.hasReceived(e)&&t(this.receivedResp.response),this.recHooks.push({status:e,callback:t}),this}},{key:"reset",value:function(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}},{key:"matchReceive",value:function(e){var t=e.status,n=e.response;e._ref,this.recHooks.filter((function(e){return e.status===t})).forEach((function(e){return e.callback(n)}))}},{key:"cancelRefEvent",value:function(){this.refEvent&&this.channel.off(this.refEvent)}},{key:"cancelTimeout",value:function(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}},{key:"startTimeout",value:function(){var e=this;this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,(function(t){e.cancelRefEvent(),e.cancelTimeout(),e.receivedResp=t,e.matchReceive(t)})),this.timeoutTimer=setTimeout((function(){e.trigger("timeout",{})}),this.timeout)}},{key:"hasReceived",value:function(e){return this.receivedResp&&this.receivedResp.status===e}},{key:"trigger",value:function(e,t){this.channel.trigger(this.refEvent,{status:e,response:t})}}]),e}(),kk=function(){function e(t,n){i(this,e),this.callback=t,this.timerCalc=n,this.timer=null,this.tries=0}return s(e,[{key:"reset",value:function(){this.tries=0,clearTimeout(this.timer)}},{key:"scheduleTimeout",value:function(){var e=this;clearTimeout(this.timer),this.timer=setTimeout((function(){e.tries=e.tries+1,e.callback()}),this.timerCalc(this.tries+1))}}]),e}(),xk=function(){function e(t,n,r){var o=this;i(this,e),this.state=hk,this.topic=t,this.params=sk(n||{}),this.socket=r,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new Ik(this,wk,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new kk((function(){o.socket.isConnected()&&o.rejoin()}),this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError((function(){return o.rejoinTimer.reset()}))),this.stateChangeRefs.push(this.socket.onOpen((function(){o.rejoinTimer.reset(),o.isErrored()&&o.rejoin()}))),this.joinPush.receive("ok",(function(){o.state=bk,o.rejoinTimer.reset(),o.pushBuffer.forEach((function(e){return e.send()})),o.pushBuffer=[]})),this.joinPush.receive("error",(function(){o.state=vk,o.socket.isConnected()&&o.rejoinTimer.scheduleTimeout()})),this.onClose((function(){o.rejoinTimer.reset(),o.socket.hasLogger()&&o.socket.log("channel","close ".concat(o.topic," ").concat(o.joinRef())),o.state=hk,o.socket.remove(o)})),this.onError((function(e){o.socket.hasLogger()&&o.socket.log("channel","error ".concat(o.topic),e),o.isJoining()&&o.joinPush.reset(),o.state=vk,o.socket.isConnected()&&o.rejoinTimer.scheduleTimeout()})),this.joinPush.receive("timeout",(function(){o.socket.hasLogger()&&o.socket.log("channel","timeout ".concat(o.topic," (").concat(o.joinRef(),")"),o.joinPush.timeout),new Ik(o,Ok,sk({}),o.timeout).send(),o.state=vk,o.joinPush.reset(),o.socket.isConnected()&&o.rejoinTimer.scheduleTimeout()})),this.on(Ek,(function(e,t){o.trigger(o.replyEventName(t),e)}))}return s(e,[{key:"join",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=e,this.joinedOnce=!0,this.rejoin(),this.joinPush}},{key:"onClose",value:function(e){this.on(yk,e)}},{key:"onError",value:function(e){return this.on(_k,(function(t){return e(t)}))}},{key:"on",value:function(e,t){var n=this.bindingRef++;return this.bindings.push({event:e,ref:n,callback:t}),n}},{key:"off",value:function(e,t){this.bindings=this.bindings.filter((function(n){return!(n.event===e&&(void 0===t||t===n.ref))}))}},{key:"canPush",value:function(){return this.socket.isConnected()&&this.isJoined()}},{key:"push",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.timeout;if(t=t||{},!this.joinedOnce)throw new Error("tried to push '".concat(e,"' to '").concat(this.topic,"' before joining. Use channel.join() before pushing events"));var r=new Ik(this,e,(function(){return t}),n);return this.canPush()?r.send():(r.startTimeout(),this.pushBuffer.push(r)),r}},{key:"leave",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=gk;var n=function(){e.socket.hasLogger()&&e.socket.log("channel","leave ".concat(e.topic)),e.trigger(yk,"leave")},r=new Ik(this,Ok,sk({}),t);return r.receive("ok",(function(){return n()})).receive("timeout",(function(){return n()})),r.send(),this.canPush()||r.trigger("ok",{}),r}},{key:"onMessage",value:function(e,t,n){return t}},{key:"isMember",value:function(e,t,n,r){return this.topic===e&&(!r||r===this.joinRef()||(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:e,event:t,payload:n,joinRef:r}),!1))}},{key:"joinRef",value:function(){return this.joinPush.ref}},{key:"rejoin",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.isLeaving()||(this.socket.leaveOpenTopic(this.topic),this.state=mk,this.joinPush.resend(e))}},{key:"trigger",value:function(e,t,n,r){var i=this.onMessage(e,t,n,r);if(t&&!i)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");for(var o=this.bindings.filter((function(t){return t.event===e})),s=0;s<o.length;s++){o[s].callback(i,n,r||this.joinRef())}}},{key:"replyEventName",value:function(e){return"chan_reply_".concat(e)}},{key:"isClosed",value:function(){return this.state===hk}},{key:"isErrored",value:function(){return this.state===vk}},{key:"isJoined",value:function(){return this.state===bk}},{key:"isJoining",value:function(){return this.state===mk}},{key:"isLeaving",value:function(){return this.state===gk}}]),e}(),Mk=function(){function e(){i(this,e)}return s(e,null,[{key:"request",value:function(e,t,n,r,i,o,s){if(ck.XDomainRequest){var a=new ck.XDomainRequest;return this.xdomainRequest(a,e,t,r,i,o,s)}var u=new ck.XMLHttpRequest;return this.xhrRequest(u,e,t,n,r,i,o,s)}},{key:"xdomainRequest",value:function(e,t,n,r,i,o,s){var a=this;return e.timeout=i,e.open(t,n),e.onload=function(){var t=a.parseJSON(e.responseText);s&&s(t)},o&&(e.ontimeout=o),e.onprogress=function(){},e.send(r),e}},{key:"xhrRequest",value:function(e,t,n,r,i,o,s,a){var u=this;return e.open(t,n,!0),e.timeout=o,e.setRequestHeader("Content-Type",r),e.onerror=function(){return a&&a(null)},e.onreadystatechange=function(){if(e.readyState===Ak&&a){var t=u.parseJSON(e.responseText);a(t)}},s&&(e.ontimeout=s),e.send(i),e}},{key:"parseJSON",value:function(e){if(!e||""===e)return null;try{return JSON.parse(e)}catch(t){return console&&console.log("failed to parse JSON response",e),null}}},{key:"serialize",value:function(e,t){var n=[];for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=t?"".concat(t,"[").concat(r,"]"):r,o=e[r];"object"===y(o)?n.push(this.serialize(o,i)):n.push(encodeURIComponent(i)+"="+encodeURIComponent(o))}return n.join("&")}},{key:"appendParams",value:function(e,t){if(0===Object.keys(t).length)return e;var n=e.match(/\?/)?"&":"?";return"".concat(e).concat(n).concat(this.serialize(t))}}]),e}(),Nk=function(){function e(t){i(this,e),this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.reqs=new Set,this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(t),this.readyState=lk,this.poll()}return s(e,[{key:"normalizeEndpoint",value:function(e){return e.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+Tk),"$1/"+Sk)}},{key:"endpointURL",value:function(){return Mk.appendParams(this.pollEndpoint,{token:this.token})}},{key:"closeAndRetry",value:function(e,t,n){this.close(e,t,n),this.readyState=lk}},{key:"ontimeout",value:function(){this.onerror("timeout"),this.closeAndRetry(1005,"timeout",!1)}},{key:"isActive",value:function(){return this.readyState===fk||this.readyState===lk}},{key:"poll",value:function(){var e=this;this.ajax("GET",null,(function(){return e.ontimeout()}),(function(t){if(t){var n=t.status,r=t.token,i=t.messages;e.token=r}else n=0;switch(n){case 200:i.forEach((function(t){setTimeout((function(){return e.onmessage({data:t})}),0)})),e.poll();break;case 204:e.poll();break;case 410:e.readyState=fk,e.onopen({}),e.poll();break;case 403:e.onerror(403),e.close(1008,"forbidden",!1);break;case 0:case 500:e.onerror(500),e.closeAndRetry(1011,"internal server error",500);break;default:e.onerror(n),e.close()}}))}},{key:"send",value:function(e){var t=this;this.ajax("POST",e,(function(){return t.onerror("timeout")}),(function(e){e&&200===e.status||(t.onerror(e&&e.status),t.closeAndRetry(1011,"internal server error",!1))}))}},{key:"close",value:function(e,t,n){var r,i=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_(e))||t){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}(this.reqs);try{for(i.s();!(r=i.n()).done;){r.value.abort()}}catch(e){i.e(e)}finally{i.f()}this.readyState=pk;var o=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:e,reason:t,wasClean:n});"undefined"!=typeof CloseEvent?this.onclose(new CloseEvent("close",o)):this.onclose(o)}},{key:"ajax",value:function(e,t,n,r){var i,o=this;i=Mk.request(e,this.endpointURL(),"application/json",t,this.timeout,(function(){o.reqs.delete(i),n()}),(function(e){o.reqs.delete(i),o.isActive()&&r(e)})),this.reqs.add(i)}}]),e}(),Rk=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,e);var o=r.events||{state:"presence_state",diff:"presence_diff"};this.state={},this.pendingDiffs=[],this.channel=t,this.joinRef=null,this.caller={onChange:null,onJoin:null,onLeave:null,onSync:function(){}},this.channel.on(o.state,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.joinRef=n.channel.joinRef(),o||s?e.syncState(n.state,t,o,s):e.synchronizeState(n.state,t,i),n.pendingDiffs.forEach((function(t){o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i)})),n.pendingDiffs=[],a()})),this.channel.on(o.diff,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.inPendingSyncState()?n.pendingDiffs.push(t):(o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i),a())}))}return s(e,[{key:"onJoin",value:function(e){console&&console.warn&&console.warn("onJoin is deprecated, use onChange instead"),this.caller.onJoin=e}},{key:"onLeave",value:function(e){console&&console.warn&&console.warn("onLeave is deprecated, use onChange instead"),this.caller.onLeave=e}},{key:"onChange",value:function(e){this.caller.onChange=e}},{key:"onSync",value:function(e){this.caller.onSync=e}},{key:"list",value:function(t){return e.list(this.state,t)}},{key:"inPendingSyncState",value:function(){return!this.joinRef||this.joinRef!==this.channel.joinRef()}}],[{key:"synchronizeState",value:function(e,t,n){var r={},i={};return this.map(e,(function(e,n){t[e]||(i[e]=n)})),this.map(t,(function(t,n){var o=e[t];if(o){var s=n.metas.map((function(e){return e.phx_ref})),a=o.metas.map((function(e){return e.phx_ref})),u=n.metas.filter((function(e){return a.indexOf(e.phx_ref)<0})),c=o.metas.filter((function(e){return s.indexOf(e.phx_ref)<0}));u.length>0&&(r[t]=n,r[t].metas=u),c.length>0&&(u.length>0?i[t]={metas:c}:(i[t]=n,i[t].metas=c))}else r[t]=n})),this.synchronizeDiff(e,{joins:r,leaves:i},n)}},{key:"syncState",value:function(e,t,n,r){var i=this,o=this.clone(e),s={},a={};return this.map(o,(function(e,n){t[e]||(a[e]=n)})),this.map(t,(function(e,t){var n=o[e];if(n){var r=t.metas.map((function(e){return e.phx_ref})),u=n.metas.map((function(e){return e.phx_ref})),c=t.metas.filter((function(e){return u.indexOf(e.phx_ref)<0})),l=n.metas.filter((function(e){return r.indexOf(e.phx_ref)<0}));c.length>0&&(s[e]=t,s[e].metas=c),l.length>0&&(a[e]=i.clone(n),a[e].metas=l)}else s[e]=t})),this.syncDiff(o,{joins:s,leaves:a},n,r)}},{key:"synchronizeDiff",value:function(e,t,n){var r=t.joins,i=t.leaves,o={};return this.map(r,(function(e,t){o[e]={joinedMetas:t.metas,leftMetas:[],update:t}})),this.map(i,(function(e,t){o[e]?o[e].leftMetas=t.metas:o[e]={joinedMetas:[],leftMetas:t.metas,update:{}}})),this.map(o,(function(t,r){var i=r.joinedMetas,o=r.leftMetas,s=r.update,a=i.map((function(e){return e.phx_ref})),u=o.map((function(e){return e.phx_ref})),c=e[t],l=c?h({},c):{metas:[]};l.metas=l.metas.filter((function(e){return-1===a.indexOf(e.phx_ref)})).concat(i).filter((function(e){return-1===u.indexOf(e.phx_ref)})),Object.keys(s).forEach((function(e){"metas"!==e&&(l[e]=s[e])})),0===l.metas.length?delete e[t]:e[t]=l,n&&n(t,c,l)})),e}},{key:"syncDiff",value:function(e,t,n,r){var i=this,o=this.clone(t),s=o.joins,a=o.leaves;return n||(n=function(){}),r||(r=function(){}),this.map(s,(function(t,r){var o=e[t];if(e[t]=i.clone(r),o){var s,a=e[t].metas.map((function(e){return e.phx_ref})),u=o.metas.filter((function(e){return a.indexOf(e.phx_ref)<0}));(s=e[t].metas).unshift.apply(s,m(u))}n(t,o,r)})),this.map(a,(function(t,n){var i=e[t];if(i){var o=n.metas.map((function(e){return e.phx_ref}));i.metas=i.metas.filter((function(e){return o.indexOf(e.phx_ref)<0})),r(t,i,n),0===i.metas.length&&delete e[t]}})),e}},{key:"list",value:function(e,t){return t||(t=function(e,t){return t}),this.map(e,(function(e,n){return t(e,n)}))}},{key:"map",value:function(e,t){return Object.getOwnPropertyNames(e).map((function(n){return t(n,e[n])}))}},{key:"clone",value:function(e){return JSON.parse(JSON.stringify(e))}}]),e}(),Ck={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode:function(e,t){if(e.payload.constructor===ArrayBuffer)return t(this.binaryEncode(e));var n=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(n))},decode:function(e,t){if(e.constructor===ArrayBuffer)return t(this.binaryDecode(e));var n=b(JSON.parse(e),5);return t({join_ref:n[0],ref:n[1],topic:n[2],event:n[3],payload:n[4]})},binaryEncode:function(e){var t=e.join_ref,n=e.ref,r=e.event,i=e.topic,o=e.payload,s=this.META_LENGTH+t.length+n.length+i.length+r.length,a=new ArrayBuffer(this.HEADER_LENGTH+s),u=new DataView(a),c=0;u.setUint8(c++,this.KINDS.push),u.setUint8(c++,t.length),u.setUint8(c++,n.length),u.setUint8(c++,i.length),u.setUint8(c++,r.length),Array.from(t,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(n,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(i,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(r,(function(e){return u.setUint8(c++,e.charCodeAt(0))}));var l=new Uint8Array(a.byteLength+o.byteLength);return l.set(new Uint8Array(a),0),l.set(new Uint8Array(o),a.byteLength),l.buffer},binaryDecode:function(e){var t=new DataView(e),n=t.getUint8(0),r=new TextDecoder;switch(n){case this.KINDS.push:return this.decodePush(e,t,r);case this.KINDS.reply:return this.decodeReply(e,t,r);case this.KINDS.broadcast:return this.decodeBroadcast(e,t,r)}},decodePush:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=this.HEADER_LENGTH+this.META_LENGTH-1,a=n.decode(e.slice(s,s+r));s+=r;var u=n.decode(e.slice(s,s+i));s+=i;var c=n.decode(e.slice(s,s+o));return s+=o,{join_ref:a,ref:null,topic:u,event:c,payload:e.slice(s,e.byteLength)}},decodeReply:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=t.getUint8(4),a=this.HEADER_LENGTH+this.META_LENGTH,u=n.decode(e.slice(a,a+r));a+=r;var c=n.decode(e.slice(a,a+i));a+=i;var l=n.decode(e.slice(a,a+o));a+=o;var f=n.decode(e.slice(a,a+s));a+=s;var d=e.slice(a,e.byteLength);return{join_ref:u,ref:c,topic:l,event:Ek,payload:{status:f,response:d}}},decodeBroadcast:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=this.HEADER_LENGTH+2,s=n.decode(e.slice(o,o+r));o+=r;var a=n.decode(e.slice(o,o+i));return o+=i,{join_ref:null,ref:null,topic:s,event:a,payload:e.slice(o,e.byteLength)}}},Pk=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,e),this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=r.timeout||1e4,this.transport=r.transport||ck.WebSocket||Nk,this.establishedConnections=0,this.defaultEncoder=Ck.encode.bind(Ck),this.defaultDecoder=Ck.decode.bind(Ck),this.closeWasClean=!1,this.binaryType=r.binaryType||"arraybuffer",this.connectClock=1,this.transport!==Nk?(this.encode=r.encode||this.defaultEncoder,this.decode=r.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);var o=null;uk&&uk.addEventListener&&(uk.addEventListener("pagehide",(function(e){n.conn&&(n.disconnect(),o=n.connectClock)})),uk.addEventListener("pageshow",(function(e){o===n.connectClock&&(o=null,n.connect())}))),this.heartbeatIntervalMs=r.heartbeatIntervalMs||3e4,this.rejoinAfterMs=function(e){return r.rejoinAfterMs?r.rejoinAfterMs(e):[1e3,2e3,5e3][e-1]||1e4},this.reconnectAfterMs=function(e){return r.reconnectAfterMs?r.reconnectAfterMs(e):[10,50,100,150,200,250,500,1e3,2e3][e-1]||5e3},this.logger=r.logger||null,this.longpollerTimeout=r.longpollerTimeout||2e4,this.params=sk(r.params||{}),this.endPoint="".concat(t,"/").concat(Tk),this.vsn=r.vsn||"2.0.0",this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new kk((function(){n.teardown((function(){return n.connect()}))}),this.reconnectAfterMs)}return s(e,[{key:"getLongPollTransport",value:function(){return Nk}},{key:"replaceTransport",value:function(e){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.sendBuffer=[],this.conn&&(this.conn.close(),this.conn=null),this.transport=e}},{key:"protocol",value:function(){return location.protocol.match(/^https/)?"wss":"ws"}},{key:"endPointURL",value:function(){var e=Mk.appendParams(Mk.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return"/"!==e.charAt(0)?e:"/"===e.charAt(1)?"".concat(this.protocol(),":").concat(e):"".concat(this.protocol(),"://").concat(location.host).concat(e)}},{key:"disconnect",value:function(e,t,n){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.teardown(e,t,n)}},{key:"connect",value:function(e){var t=this;e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=sk(e)),this.conn||(this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=function(){return t.onConnOpen()},this.conn.onerror=function(e){return t.onConnError(e)},this.conn.onmessage=function(e){return t.onConnMessage(e)},this.conn.onclose=function(e){return t.onConnClose(e)})}},{key:"log",value:function(e,t,n){this.logger(e,t,n)}},{key:"hasLogger",value:function(){return null!==this.logger}},{key:"onOpen",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}},{key:"onClose",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}},{key:"onError",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.error.push([t,e]),t}},{key:"onMessage",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.message.push([t,e]),t}},{key:"ping",value:function(e){var t=this;if(!this.isConnected())return!1;var n=this.makeRef(),r=Date.now();this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:n});var i=this.onMessage((function(o){o.ref===n&&(t.off([i]),e(Date.now()-r))}));return!0}},{key:"clearHeartbeats",value:function(){clearTimeout(this.heartbeatTimer),clearTimeout(this.heartbeatTimeoutTimer)}},{key:"onConnOpen",value:function(){if(this.hasLogger()){var e=this.endPointURL().replace(/access_token=([^&#/]+)/,"access_token=-pruned-");this.log("transport","connected to ".concat(e))}this.closeWasClean=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach((function(e){return(0,b(e,2)[1])()}))}},{key:"heartbeatTimeout",value:function(){var e=this;this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.triggerChanError(),this.closeWasClean=!1,this.teardown((function(){return e.reconnectTimer.scheduleTimeout()}),1e3,"heartbeat timeout"))}},{key:"resetHeartbeat",value:function(){var e=this;this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,this.clearHeartbeats(),this.heartbeatTimer=setTimeout((function(){return e.sendHeartbeat()}),this.heartbeatIntervalMs))}},{key:"teardown",value:function(e,t,n){var r=this;if(!this.conn)return e&&e();this.waitForBufferDone((function(){r.conn&&(t?r.conn.close(t,n||""):r.conn.close()),r.waitForSocketClosed((function(){r.conn&&(r.conn.onopen=function(){},r.conn.onerror=function(){},r.conn.onmessage=function(){},r.conn.onclose=function(){},r.conn=null),e&&e()}))}))}},{key:"waitForBufferDone",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.bufferedAmount?setTimeout((function(){t.waitForBufferDone(e,n+1)}),150*n):e()}},{key:"waitForSocketClosed",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.readyState!==pk?setTimeout((function(){t.waitForSocketClosed(e,n+1)}),150*n):e()}},{key:"onConnClose",value:function(e){this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),this.clearHeartbeats(),this.closeWasClean||this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach((function(t){return(0,b(t,2)[1])(e)}))}},{key:"onConnError",value:function(e){this.hasLogger()&&this.log("transport",e);var t=this.transport,n=this.establishedConnections;this.stateChangeCallbacks.error.forEach((function(r){(0,b(r,2)[1])(e,t,n)})),(t===this.transport||n>0)&&this.triggerChanError()}},{key:"triggerChanError",value:function(){this.channels.forEach((function(e){e.isErrored()||e.isLeaving()||e.isClosed()||e.trigger(_k)}))}},{key:"connectionState",value:function(){switch(this.conn&&this.conn.readyState){case lk:return"connecting";case fk:return"open";case dk:return"closing";default:return"closed"}}},{key:"isConnected",value:function(){return"open"===this.connectionState()}},{key:"remove",value:function(e){this.off(e.stateChangeRefs),this.channels=this.channels.filter((function(t){return t.joinRef()!==e.joinRef()}))}},{key:"off",value:function(e){for(var t in this.stateChangeCallbacks)this.stateChangeCallbacks[t]=this.stateChangeCallbacks[t].filter((function(t){var n=b(t,1)[0];return-1===e.indexOf(n)}))}},{key:"channel",value:function(e){var t=new xk(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},this);return this.channels.push(t),t}},{key:"push",value:function(e){var t=this;if(this.hasLogger()){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;this.log("push","".concat(n," ").concat(r," (").concat(s,", ").concat(o,")"),i)}this.isConnected()?this.encode(e,(function(e){return t.conn.send(e)})):this.sendBuffer.push((function(){return t.encode(e,(function(e){return t.conn.send(e)}))}))}},{key:"makeRef",value:function(){var e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}},{key:"sendHeartbeat",value:function(){var e=this;this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout((function(){return e.heartbeatTimeout()}),this.heartbeatIntervalMs))}},{key:"flushSendBuffer",value:function(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach((function(e){return e()})),this.sendBuffer=[])}},{key:"onConnMessage",value:function(e){var t=this;this.decode(e.data,(function(e){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;o&&o===t.pendingHeartbeatRef&&(t.clearHeartbeats(),t.pendingHeartbeatRef=null,t.heartbeatTimer=setTimeout((function(){return t.sendHeartbeat()}),t.heartbeatIntervalMs)),t.hasLogger()&&t.log("receive","".concat(i.status||""," ").concat(n," ").concat(r," ").concat(o&&"("+o+")"||""),i);for(var a=0;a<t.channels.length;a++){var u=t.channels[a];u.isMember(n,r,i,s)&&u.trigger(r,i,o,s)}for(var c=0;c<t.stateChangeCallbacks.message.length;c++){(0,b(t.stateChangeCallbacks.message[c],2)[1])(e)}}))}},{key:"leaveOpenTopic",value:function(e){for(var t,n=0;n<this.channels.length;n++){var r=this.channels[n];if(r.topic===e&&(r.isJoined()||r.isJoining())){t=r;break}}t&&(this.hasLogger()&&this.log("transport",'leaving duplicate topic "'.concat(e,'"')),t.leave())}}]),e}(),jk=function(){return"hidden"===document.visibilityState},Lk=function(){return navigator.onLine},Uk=function(e,t){return t.onlyLongPollEnabled?Nk:window.WebSocket?Lk()?e.transport===window.WebSocket?Nk:window.WebSocket:e.transport:Nk};function qk(e){var t,n={onlyLongPollEnabled:!1,connectionTriedOnce:!1,avoidLongPollWorkerInterval:6e5},r=function(t,r){n.onlyLongPollEnabled=!0,e.disconnect((function(){e.transport=Nk,r&&r(t),e.connect()}))};return{ensureConnected:function(i){var o=i.onInitialTry,s=i.onInitialError,a=i.avoidLongPollWorkerInterval;if(!n.connectionTriedOnce){o&&o(),"number"==typeof a&&(n.avoidLongPollWorkerInterval=a);try{e.connect(),e.conn.readyState===WebSocket.CLOSED&&r(null,s)}catch(e){r(e,s)}n.connectionTriedOnce=!0,t=function(e,t){if(t.avoidLongPollWorkerInterval>0&&!t.onlyLongPollEnabled){var n=setInterval((function(){if("open"===e.connectionState()&&e.transport===Nk){var n=Uk(e,t);if(e.transport!==n)return e.transport=n,e.disconnect((function(){return e.connect()}))}}),t.avoidLongPollWorkerInterval);return function(){return clearInterval(n)}}}(e,n)}},selectNewTransport:function(){Lk()&&!jk()&&(e.transport=Uk(e,n))},stop:function(){t&&t()}}}var Dk=function(e){return e===window.WebSocket?"WebSocket":e===Nk?"LongPoll":"unknown"},Vk=function(e){return"object"===y(e)?null==e?void 0:e.reason:e},Fk={metrics:{}};function Hk(e,t,n){var r=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:{logPrefix:"PubSub"}).logPrefix,i=0,o=!1;n=n||Fk;var s=function(e){n.metrics.connectionMetric&&n.increment(n.metrics.connectionMetric,e)},a=function(t){return h(h({},{transport:Dk(e.transport),online:Lk(),visibility_state:document.visibilityState,error_count:i}),t)},u=function(t,n){var r=(n||{}).transport;return["transport:".concat(r||Dk(e.transport)),"online:".concat(Lk())].concat(t)};return{onOpen:function(){o=!0,s(u(["action:connected"])),t.info("".concat(r," socket opened"),a({}))},onClose:function(e){if(e){var n=Dk(window.WebSocket),i=a({reason:e.reason,type:e.type,code:e.code&&e.code.toString(),transport:n}),o=u(["action:disconnected","type:".concat(e.type),"code:".concat(e.code)],{transport:n});e.wasClean?(s(o.concat(["reason:closed"])),t.info("".concat(r," connection disconnected cleanly"),i)):jk()?(s(o.concat(["reason:closed"])),t.info("".concat(r," connection disconnected while tab was hidden"),i)):(s(o.concat(["reason:closed"])),t.info("".concat(r," connection disconnected"),i))}else{var c=Dk(Nk),l=a({reason:"unknown",type:"unknown",code:"unknown",transport:c}),f=u(["action:disconnected","type:unknown","reason:unknown","code:unknown"],{transport:c});s(f),t.info("".concat(r," connection disconnected"),l)}},onError:function(e){var n=e&&e.type||"unknown";i+=1;var c=e&&e.target?a({type:n}):a({type:n,error:e});jk()?t.info("".concat(r," connection error while tab was hidden"),c):Lk()?1!==i||o?(s(u(["action:error"])),t.warn("".concat(r," socket connection error"),c)):t.info("".concat(r," socket connection error while attempting to establish the connection first time"),c):t.info("".concat(r," connection error while user was offline"),c)},onInitialTry:function(){return s(u(["action:connect"]))},onInitialConnectError:function(n){return t.info("".concat(r," failed to connect with initial transport"),{new_transport:Dk(e.transport),error:Vk(n)})}}}var Wk=function(e,t){var n=t.enabled,r=t.logPrefix;return n?function(t,n,i){var o=null!=i&&i.token?h(h({},i),{},{token:"-pruned-"}):i;e.info("".concat(r," ").concat(t,": ").concat(n),{pubsub_data:o})}:function(){}},Gk="sm.app.visitor_api.pubsub",Bk="".concat(Gk,".connection"),zk="".concat(Gk,".push"),Jk=2147483647,Qk=function(e){var t=e.server,n=e.socket,r=e.stats,i=e.logsEnabled,o=e.getAccessToken,s=e.visitorIdObservable,a=void 0===s?UO():s,u=e.reconnectConf,c=void 0===u?{}:u,l=e.getVisitorPriority,f=e.renewAccessToken,d=null;c={initialDelay:c.initialDelay||3e3,maxDelay:c.maxDelay||6e4,delayFactor:c.delayFactor||1.5};var p=Ko(c.initialDelay,c.maxDelay,c.delayFactor),h=0,v=Date.now(),b=c.maxDelay+1e4+1e3;n||(n=new Pk("".concat(t,"/notifications"),{logger:Wk(zO,{enabled:i,logPrefix:"[PubSub]"}),params:function(){return{access_token:o(),priority:l()}},reconnectAfterMs:function(e){return Date.now()-v>b&&(h=0,v=Date.now()),p(h)},heartbeatIntervalMs:1e4}));var m=new qk(n),g=new Hk(n,zO,{increment:r.increment.bind(r),metrics:{connectionMetric:Bk}},{logPrefix:"PubSub"}),_=new CO.ReplaySubject(1),w=sm.conf.engagement.api_timeout_milliseconds||1e4;n.onOpen((function(){!function(e){var t=!1;e.channels.forEach((function(e){e.isJoined()&&(t||zO.info("Detected joined channels during socket open callback, forcing re-join"),t=!0,e.trigger("phx_error","missed_close"))}))}(n),_.next(!0),g.onOpen()})),n.onClose((function(e){_.next(!1),h+=1,v=Date.now(),g.onClose(e),d&&n.disconnect()})),n.onError((function(e){if(_.next(!1),"number"==typeof e)switch(e){case 403:zO.info("Detected likely pubsub authentication error, reconnecting after max delay"),p.setNextDelayMinimum(c.maxDelay);break;case 410:break;case 500:zO.info("PubSub connection disconnected with error 500");break;case 503:var t=c.maxDelay/2;zO.info("PubSub unavailable, postponing reconnecting for at least ".concat(t," ms")),p.setNextDelayMinimum(t);break;default:return zO.error("Received unhandled pubsub error status ".concat(e,", stopping reconnecting")),void n.disconnect()}g.onError(e),m.selectNewTransport()}));var E=function(e){return"object"===y(e)?null==e?void 0:e.reason:e},O=function(e,t,i,o){var s=function(e){if("function"==typeof e)return e.modify=function(){throw new Error("Cannot modify channel params because it is a closure already")},e;var t=nt(e||{}),n=function(){return t};return n.modify=function(e,n){t[e]=n(t[e])},n}(t);o||(o={}),i||(i=[]);var a=CO.Observable.create((function(a){var u=!1,c=(t||{}).timeout||Jk,l=n.channel(e,s);return l.join(c).receive("ok",(function(){u=!0,a.next(function(e,t){var n=function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=i.disableStats,s=i.timeout;s||(s=w);var a=function(e,t){o||r.increment(e,t)};return CO.Observable.create((function(r){return e.push(t,n,s).receive("ok",(function(e){r.next(e),r.complete()})).receive("error",(function(e){a(zk,["action:error"]),r.error({type:"error",error:e})})).receive("timeout",(function(){a(zk,["action:timeout"]),r.error({type:"timeout"})})),function(){}}))};return{observable:function(t,n){return n||(n={}),CO.Observable.create((function(r){var i=e.on(t,(function(e){return r.next(e)}));return function(){e.off(t,i),n.leaveChannelOnDispose&&e.leave()}}))},push:n,phoenixChannel:e,leave:function(){return e.leave()},watchNewTopics:function(e){return t.modify("topics",(function(t){return xo(t||[],e)})),n("watch",{topics:e},{timeout:Jk})}}}(l,s)),a.complete()})).receive("error",(function(t){t&&"join crashed"===t.reason?zO.info("Joining Pubsub channel failed with crash, retrying",{reason:"error",error:E(t),topic:e}):t&&"overload"===t.reason?zO.info("Joining Pubsub channel failed because of overload, retrying",{topic:e}):(t&&-1!==i.indexOf(t.reason)?zO.info("Joining Pubsub channel failed with expected reason",{reason:"error",error:E(t),topic:e}):zO.warn("Joining Pubsub channel failed",{reason:"error",error:E(t),topic:e}),a.error({type:"error",error:t}))})).receive("timeout",(function(){return zO.warn("Joining Pubsub channel failed",{reason:"timeout",topic:e})})),function(){u&&!o.leaveChannelOnDispose||l.leave()}}));return CO.Observable.defer((function(){return m.ensureConnected({onInitialTry:function(){return g.onInitialTry},onInitialError:function(e){return g.onInitialConnectError(e)}}),CO.Observable.of({})})).flatMapTo(_).filter(At(!0)).take(1).flatMapTo(a)},S=function(e){return CO.Observable.create((function(t){return t.next(e),function(){return e.leave()}}))},T=a.switchMap((function(e){return O("visitor_volatile:".concat(e)).flatMap(S)})).publishReplay(1);T.connect(),T.flatMap((function(e){return e.observable("system:avoid_reconnection")})).subscribe((function(e){var t,r,i=e.duration_in_seconds;r=.5,i=(t=i)+Math.floor(Math.random()*r*t),zO.info("Disabling reconnections to pubsub",{duration_in_seconds:i}),d&&clearTimeout(d),d=setTimeout((function(){zO.info("Enabling reconnections to pubsub"),d=null,n.connect()}),1e3*i)}));var A,I,k,x=dt(it,Sr,oo),M=function(e,t){return pe((function(t){return"site_visitor:".concat(e,":").concat(t)}),t)},N=[];return{joinChannel:O,volatileChannelObservable:T,joinSiteVisitorNotifications:function(e,t){return!Sr(N)&&A&&I===e||(I=e,N=t,(A=O("site_visitor:".concat(e),{topics:M(e,N)}).publishReplay(1)).connect(),(k=A.flatMap((function(e){return(0,e.observable)("message")})).filter(gt).publishReplay(50)).connect()),x(t,N)&&(N=xo(t,N),A.take(1).flatMap((function(t){return(0,t.watchNewTopics)(M(e,N))})).subscribe((function(){return zO.debug("Subscribed to additional sites",N)}),(function(e){return zO.warn("Error subscribing to additional sites",e,N)}))),k},connectedObservable:_.distinctUntilChanged(),disconnect:n.disconnect.bind(n),connect:n.connect.bind(n),reconnect:function(){return n.disconnect((function(){return n.connect()}))},renewTokenAndReconnectWaitForTeardown:function(e){var t=e.consolidationSecret;return f({consolidationSecret:t}).flatMap((function(){return CO.Observable.create((function(e){n.disconnect((function(){n.connect(),e.next(),e.complete()}))}))}))},allowReconnection:function(){return null===d},__socket__:n}};function Yk(e,t){var n=t.visitorId,r=t.visitorIdObservable,i=t.tabId,o=t.idleTimeoutSeconds,s=t.visitorMetadata;n=n||jO(),r=(r||UO()).share();var a="JOIN_NOT_REQUESTED",u="JOINING_ALLOW_REJECTION",c="JOINING_ALLOW_REJECTION_BUT_NO_REJECTION_REQUESTED",l="JOINING_NO_REJECTION",f="JOIN_REJECTED",d="JOINED",p="JOIN_ERROR",v="JOIN_REQUESTED_ALLOW_REJECTION",m="JOIN_REJECTED",g="JOIN_ERROR",y="JOIN_SUCCESSFUL",_="JOIN_REQUESTED_NO_REJECTION",w="VISITOR_ID_CHANGED",E="too_many_tracked",O=new CO.ReplaySubject(1),S=function(t,n,a){var u="visitor_presence:".concat(t),c=n?[E]:[],l=!1;e.joinChannel(u,(function(){return{tab_id:i,page_url:location.href,page_description:document.title,idle_timeout_seconds:o,visitor_metadata:ki(["location"],s),allow_rejection:n&&!l}}),c).take(1).takeUntil(r).map((function(e){var t=e.phoenixChannel,n=e.leave;return[new Rk(t),n]})).subscribe((function(e){var t=b(e,2),n=t[0],r=t[1];l=!0,a(y,{presence:n,leavePresence:r})}),(function(e){Ti(["error","reason"],E,e)?a(m):a(g)}))},T={joinState:a,visitorId:n},A=function e(t,n){var r=function(e,t,n){switch(t){case v:return e.joinState===a?[h(h({},e),{},{joinState:u}),function(t){return S(e.visitorId,!0,t)}]:[e];case _:switch(e.joinState){case a:case f:return[h(h({},e),{},{joinState:l}),function(t){return S(e.visitorId,!1,t)}];case u:return[h(h({},e),{},{joinState:c})];default:return[e]}case m:switch(e.joinState){case c:return[h(h({},e),{},{joinState:l}),function(t){return S(e.visitorId,!1,t)}];case u:return[h(h({},e),{},{joinState:f})];case l:return zO.error("Request to join visitor presence channel was rejected, although we did not allow rejection"),[h(h({},e),{},{joinState:f})];default:return zO.error("Received join rejection while we were not joining channel",{currentState:e}),[e]}case g:switch(e.joinState){case u:case l:case c:return[h(h({},e),{},{joinState:p})];default:return zO.error("Received join error while we were not joining channel",{currentState:e}),[e]}case y:switch(e.joinState){case u:case l:case c:return[h(h({},e),{},{joinState:d,leavePresence:n.leavePresence}),function(){return O.next(n.presence)}];default:return zO.error("Received join successful while we were not joining channel",{currentState:e}),[e]}case w:var r=n;if(r===e.visitorId)return[e];switch(e.joinState){case u:case l:case c:var i=e.joinState===u;return[h(h({},e),{},{visitorId:r}),function(e){return S(r,i,e)}];case d:return[h(h({},e),{},{visitorId:r,joinState:l}),function(t){e.leavePresence(),S(r,!1,t)}];default:return zO.info("Visitor ID changed, but not joining visitor presence"),[h(h({},e),{},{visitorId:r})]}default:return zO.error("Received invalid action",{action:t}),[e]}}(T,t,n),i=b(r,2),o=i[0],s=i[1];T=o,s&&s(e)};r.subscribe((function(e){return A(w,e)}),zO.error.bind(zO,"Error from visitor ID subscription in visitor presence channel")),this.requestJoin=function(){A(_)},this.requestJoinAllowRejection=function(){A(v)},this.getPresenceObservable=function(){return O.asObservable()};var I=O.switchMap((function(e){return CO.Observable.create((function(t){e.onSync((function(){var n=e.list();n[0]?Te(At(void 0),n[0].metas)?zO.warn("Visitor Presence metas included undefined value"):t.next(n[0].metas):t.next([])}))}))})).publishReplay(1);I=jT(I),this.getSameVisitorConnections=function(){return I}}var Kk="function"==typeof Symbol&&"symbol"===y(Symbol.iterator)?function(e){return y(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":y(e)},Xk=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},$k=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),Zk=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},ex=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},tx=function(e){if("function"==typeof e)return e;return function(){return e}},nx="undefined"!=typeof self?self:null,rx="undefined"!=typeof window?window:null,ix=nx||rx||ix,ox=0,sx=1,ax=2,ux=3,cx="closed",lx="errored",fx="joined",dx="joining",px="leaving",hx="phx_close",vx="phx_error",bx="phx_join",mx="phx_reply",gx="phx_leave",yx="longpoll",_x="websocket",wx=4,Ex=function(){function e(t,n,r,i){Xk(this,e),this.channel=t,this.event=n,this.payload=r||function(){return{}},this.receivedResp=null,this.timeout=i,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}return $k(e,[{key:"resend",value:function(e){this.timeout=e,this.reset(),this.send()}},{key:"send",value:function(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}},{key:"receive",value:function(e,t){return this.hasReceived(e)&&t(this.receivedResp.response),this.recHooks.push({status:e,callback:t}),this}},{key:"reset",value:function(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}},{key:"matchReceive",value:function(e){var t=e.status,n=e.response;e._ref,this.recHooks.filter((function(e){return e.status===t})).forEach((function(e){return e.callback(n)}))}},{key:"cancelRefEvent",value:function(){this.refEvent&&this.channel.off(this.refEvent)}},{key:"cancelTimeout",value:function(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}},{key:"startTimeout",value:function(){var e=this;this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,(function(t){e.cancelRefEvent(),e.cancelTimeout(),e.receivedResp=t,e.matchReceive(t)})),this.timeoutTimer=setTimeout((function(){e.trigger("timeout",{})}),this.timeout)}},{key:"hasReceived",value:function(e){return this.receivedResp&&this.receivedResp.status===e}},{key:"trigger",value:function(e,t){this.channel.trigger(this.refEvent,{status:e,response:t})}}]),e}(),Ox=function(){function e(t,n){Xk(this,e),this.callback=t,this.timerCalc=n,this.timer=null,this.tries=0}return $k(e,[{key:"reset",value:function(){this.tries=0,clearTimeout(this.timer)}},{key:"scheduleTimeout",value:function(){var e=this;clearTimeout(this.timer),this.timer=setTimeout((function(){e.tries=e.tries+1,e.callback()}),this.timerCalc(this.tries+1))}}]),e}(),Sx=function(){function e(t,n,r){var i=this;Xk(this,e),this.state=cx,this.topic=t,this.params=tx(n||{}),this.socket=r,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new Ex(this,bx,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new Ox((function(){i.socket.isConnected()&&i.rejoin()}),this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError((function(){return i.rejoinTimer.reset()}))),this.stateChangeRefs.push(this.socket.onOpen((function(){i.rejoinTimer.reset(),i.isErrored()&&i.rejoin()}))),this.joinPush.receive("ok",(function(){i.state=fx,i.rejoinTimer.reset(),i.pushBuffer.forEach((function(e){return e.send()})),i.pushBuffer=[]})),this.joinPush.receive("error",(function(){i.state=lx,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.onClose((function(){i.rejoinTimer.reset(),i.socket.hasLogger()&&i.socket.log("channel","close "+i.topic+" "+i.joinRef()),i.state=cx,i.socket.remove(i)})),this.onError((function(e){i.socket.hasLogger()&&i.socket.log("channel","error "+i.topic,e),i.isJoining()&&i.joinPush.reset(),i.state=lx,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.joinPush.receive("timeout",(function(){i.socket.hasLogger()&&i.socket.log("channel","timeout "+i.topic+" ("+i.joinRef()+")",i.joinPush.timeout),new Ex(i,gx,tx({}),i.timeout).send(),i.state=lx,i.joinPush.reset(),i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.on(mx,(function(e,t){i.trigger(i.replyEventName(t),e)}))}return $k(e,[{key:"join",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=e,this.joinedOnce=!0,this.rejoin(),this.joinPush}},{key:"onClose",value:function(e){this.on(hx,e)}},{key:"onError",value:function(e){return this.on(vx,(function(t){return e(t)}))}},{key:"on",value:function(e,t){var n=this.bindingRef++;return this.bindings.push({event:e,ref:n,callback:t}),n}},{key:"off",value:function(e,t){this.bindings=this.bindings.filter((function(n){return!(n.event===e&&(void 0===t||t===n.ref))}))}},{key:"canPush",value:function(){return this.socket.isConnected()&&this.isJoined()}},{key:"push",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.timeout;if(t=t||{},!this.joinedOnce)throw new Error("tried to push '"+e+"' to '"+this.topic+"' before joining. Use channel.join() before pushing events");var r=new Ex(this,e,(function(){return t}),n);return this.canPush()?r.send():(r.startTimeout(),this.pushBuffer.push(r)),r}},{key:"leave",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=px;var n=function(){e.socket.hasLogger()&&e.socket.log("channel","leave "+e.topic),e.trigger(hx,"leave")},r=new Ex(this,gx,tx({}),t);return r.receive("ok",(function(){return n()})).receive("timeout",(function(){return n()})),r.send(),this.canPush()||r.trigger("ok",{}),r}},{key:"onMessage",value:function(e,t,n){return t}},{key:"isMember",value:function(e,t,n,r){return this.topic===e&&(!r||r===this.joinRef()||(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:e,event:t,payload:n,joinRef:r}),!1))}},{key:"joinRef",value:function(){return this.joinPush.ref}},{key:"rejoin",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.isLeaving()||(this.socket.leaveOpenTopic(this.topic),this.state=dx,this.joinPush.resend(e))}},{key:"trigger",value:function(e,t,n,r){var i=this.onMessage(e,t,n,r);if(t&&!i)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");for(var o=this.bindings.filter((function(t){return t.event===e})),s=0;s<o.length;s++){o[s].callback(i,n,r||this.joinRef())}}},{key:"replyEventName",value:function(e){return"chan_reply_"+e}},{key:"isClosed",value:function(){return this.state===cx}},{key:"isErrored",value:function(){return this.state===lx}},{key:"isJoined",value:function(){return this.state===fx}},{key:"isJoining",value:function(){return this.state===dx}},{key:"isLeaving",value:function(){return this.state===px}}]),e}(),Tx=function(){function e(){Xk(this,e)}return $k(e,null,[{key:"request",value:function(e,t,n,r,i,o,s){if(ix.XDomainRequest){var a=new ix.XDomainRequest;return this.xdomainRequest(a,e,t,r,i,o,s)}var u=new ix.XMLHttpRequest;return this.xhrRequest(u,e,t,n,r,i,o,s)}},{key:"xdomainRequest",value:function(e,t,n,r,i,o,s){var a=this;return e.timeout=i,e.open(t,n),e.onload=function(){var t=a.parseJSON(e.responseText);s&&s(t)},o&&(e.ontimeout=o),e.onprogress=function(){},e.send(r),e}},{key:"xhrRequest",value:function(e,t,n,r,i,o,s,a){var u=this;return e.open(t,n,!0),e.timeout=o,e.setRequestHeader("Content-Type",r),e.onerror=function(){return a&&a(null)},e.onreadystatechange=function(){if(e.readyState===wx&&a){var t=u.parseJSON(e.responseText);a(t)}},s&&(e.ontimeout=s),e.send(i),e}},{key:"parseJSON",value:function(e){if(!e||""===e)return null;try{return JSON.parse(e)}catch(t){return console&&console.log("failed to parse JSON response",e),null}}},{key:"serialize",value:function(e,t){var n=[];for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=t?t+"["+r+"]":r,o=e[r];"object"===(void 0===o?"undefined":Kk(o))?n.push(this.serialize(o,i)):n.push(encodeURIComponent(i)+"="+encodeURIComponent(o))}return n.join("&")}},{key:"appendParams",value:function(e,t){if(0===Object.keys(t).length)return e;var n=e.match(/\?/)?"&":"?";return""+e+n+this.serialize(t)}}]),e}(),Ax=function(){function e(t){Xk(this,e),this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.reqs=new Set,this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(t),this.readyState=ox,this.poll()}return $k(e,[{key:"normalizeEndpoint",value:function(e){return e.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+_x),"$1/"+yx)}},{key:"endpointURL",value:function(){return Tx.appendParams(this.pollEndpoint,{token:this.token})}},{key:"closeAndRetry",value:function(e,t,n){this.close(e,t,n),this.readyState=ox}},{key:"ontimeout",value:function(){this.onerror("timeout"),this.closeAndRetry(1005,"timeout",!1)}},{key:"isActive",value:function(){return this.readyState===sx||this.readyState===ox}},{key:"poll",value:function(){var e=this;this.ajax("GET",null,(function(){return e.ontimeout()}),(function(t){if(t){var n=t.status,r=t.token,i=t.messages;e.token=r}else n=0;switch(n){case 200:i.forEach((function(t){setTimeout((function(){return e.onmessage({data:t})}),0)})),e.poll();break;case 204:e.poll();break;case 410:e.readyState=sx,e.onopen({}),e.poll();break;case 403:e.onerror(403),e.close(1008,"forbidden",!1);break;case 0:case 500:e.onerror(500),e.closeAndRetry(1011,"internal server error",500);break;default:e.onerror(n),e.close()}}))}},{key:"send",value:function(e){var t=this;this.ajax("POST",e,(function(){return t.onerror("timeout")}),(function(e){e&&200===e.status||(t.onerror(e&&e.status),t.closeAndRetry(1011,"internal server error",!1))}))}},{key:"close",value:function(e,t,n){var r=!0,i=!1,o=void 0;try{for(var s,a=this.reqs[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){s.value.abort()}}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}this.readyState=ux;var u=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:e,reason:t,wasClean:n});"undefined"!=typeof CloseEvent?this.onclose(new CloseEvent("close",u)):this.onclose(u)}},{key:"ajax",value:function(e,t,n,r){var i=this,o=void 0;o=Tx.request(e,this.endpointURL(),"application/json",t,this.timeout,(function(){i.reqs.delete(o),n()}),(function(e){i.reqs.delete(o),i.isActive()&&r(e)})),this.reqs.add(o)}}]),e}(),Ix=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Xk(this,e);var i=r.events||{state:"presence_state",diff:"presence_diff"};this.state={},this.pendingDiffs=[],this.channel=t,this.joinRef=null,this.caller={onChange:null,onJoin:null,onLeave:null,onSync:function(){}},this.channel.on(i.state,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.joinRef=n.channel.joinRef(),o||s?e.syncState(n.state,t,o,s):e.synchronizeState(n.state,t,i),n.pendingDiffs.forEach((function(t){o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i)})),n.pendingDiffs=[],a()})),this.channel.on(i.diff,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.inPendingSyncState()?n.pendingDiffs.push(t):(o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i),a())}))}return $k(e,[{key:"onJoin",value:function(e){console&&console.warn&&console.warn("onJoin is deprecated, use onChange instead"),this.caller.onJoin=e}},{key:"onLeave",value:function(e){console&&console.warn&&console.warn("onLeave is deprecated, use onChange instead"),this.caller.onLeave=e}},{key:"onChange",value:function(e){this.caller.onChange=e}},{key:"onSync",value:function(e){this.caller.onSync=e}},{key:"list",value:function(t){return e.list(this.state,t)}},{key:"inPendingSyncState",value:function(){return!this.joinRef||this.joinRef!==this.channel.joinRef()}}],[{key:"synchronizeState",value:function(e,t,n){var r={},i={};return this.map(e,(function(e,n){t[e]||(i[e]=n)})),this.map(t,(function(t,n){var o=e[t];if(o){var s=n.metas.map((function(e){return e.phx_ref})),a=o.metas.map((function(e){return e.phx_ref})),u=n.metas.filter((function(e){return a.indexOf(e.phx_ref)<0})),c=o.metas.filter((function(e){return s.indexOf(e.phx_ref)<0}));u.length>0&&(r[t]=n,r[t].metas=u),c.length>0&&(u.length>0?i[t]={metas:c}:(i[t]=n,i[t].metas=c))}else r[t]=n})),this.synchronizeDiff(e,{joins:r,leaves:i},n)}},{key:"syncState",value:function(e,t,n,r){var i=this,o=this.clone(e),s={},a={};return this.map(o,(function(e,n){t[e]||(a[e]=n)})),this.map(t,(function(e,t){var n=o[e];if(n){var r=t.metas.map((function(e){return e.phx_ref})),u=n.metas.map((function(e){return e.phx_ref})),c=t.metas.filter((function(e){return u.indexOf(e.phx_ref)<0})),l=n.metas.filter((function(e){return r.indexOf(e.phx_ref)<0}));c.length>0&&(s[e]=t,s[e].metas=c),l.length>0&&(a[e]=i.clone(n),a[e].metas=l)}else s[e]=t})),this.syncDiff(o,{joins:s,leaves:a},n,r)}},{key:"synchronizeDiff",value:function(e,t,n){var r=t.joins,i=t.leaves,o={};return this.map(r,(function(e,t){o[e]={joinedMetas:t.metas,leftMetas:[],update:t}})),this.map(i,(function(e,t){o[e]?o[e].leftMetas=t.metas:o[e]={joinedMetas:[],leftMetas:t.metas,update:{}}})),this.map(o,(function(t,r){var i=r.joinedMetas,o=r.leftMetas,s=r.update,a=i.map((function(e){return e.phx_ref})),u=o.map((function(e){return e.phx_ref})),c=e[t],l=c?Zk({},c):{metas:[]};l.metas=l.metas.filter((function(e){return-1===a.indexOf(e.phx_ref)})).concat(i).filter((function(e){return-1===u.indexOf(e.phx_ref)})),Object.keys(s).forEach((function(e){"metas"!==e&&(l[e]=s[e])})),0===l.metas.length?delete e[t]:e[t]=l,n&&n(t,c,l)})),e}},{key:"syncDiff",value:function(e,t,n,r){var i=this,o=this.clone(t),s=o.joins,a=o.leaves;return n||(n=function(){}),r||(r=function(){}),this.map(s,(function(t,r){var o=e[t];if(e[t]=i.clone(r),o){var s,a=e[t].metas.map((function(e){return e.phx_ref})),u=o.metas.filter((function(e){return a.indexOf(e.phx_ref)<0}));(s=e[t].metas).unshift.apply(s,function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(u))}n(t,o,r)})),this.map(a,(function(t,n){var i=e[t];if(i){var o=n.metas.map((function(e){return e.phx_ref}));i.metas=i.metas.filter((function(e){return o.indexOf(e.phx_ref)<0})),r(t,i,n),0===i.metas.length&&delete e[t]}})),e}},{key:"list",value:function(e,t){return t||(t=function(e,t){return t}),this.map(e,(function(e,n){return t(e,n)}))}},{key:"map",value:function(e,t){return Object.getOwnPropertyNames(e).map((function(n){return t(n,e[n])}))}},{key:"clone",value:function(e){return JSON.parse(JSON.stringify(e))}}]),e}(),kx={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode:function(e,t){if(e.payload.constructor===ArrayBuffer)return t(this.binaryEncode(e));var n=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(n))},decode:function(e,t){if(e.constructor===ArrayBuffer)return t(this.binaryDecode(e));var n=JSON.parse(e),r=ex(n,5);return t({join_ref:r[0],ref:r[1],topic:r[2],event:r[3],payload:r[4]})},binaryEncode:function(e){var t=e.join_ref,n=e.ref,r=e.event,i=e.topic,o=e.payload,s=this.META_LENGTH+t.length+n.length+i.length+r.length,a=new ArrayBuffer(this.HEADER_LENGTH+s),u=new DataView(a),c=0;u.setUint8(c++,this.KINDS.push),u.setUint8(c++,t.length),u.setUint8(c++,n.length),u.setUint8(c++,i.length),u.setUint8(c++,r.length),Array.from(t,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(n,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(i,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(r,(function(e){return u.setUint8(c++,e.charCodeAt(0))}));var l=new Uint8Array(a.byteLength+o.byteLength);return l.set(new Uint8Array(a),0),l.set(new Uint8Array(o),a.byteLength),l.buffer},binaryDecode:function(e){var t=new DataView(e),n=t.getUint8(0),r=new TextDecoder;switch(n){case this.KINDS.push:return this.decodePush(e,t,r);case this.KINDS.reply:return this.decodeReply(e,t,r);case this.KINDS.broadcast:return this.decodeBroadcast(e,t,r)}},decodePush:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=this.HEADER_LENGTH+this.META_LENGTH-1,a=n.decode(e.slice(s,s+r));s+=r;var u=n.decode(e.slice(s,s+i));s+=i;var c=n.decode(e.slice(s,s+o));return s+=o,{join_ref:a,ref:null,topic:u,event:c,payload:e.slice(s,e.byteLength)}},decodeReply:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=t.getUint8(4),a=this.HEADER_LENGTH+this.META_LENGTH,u=n.decode(e.slice(a,a+r));a+=r;var c=n.decode(e.slice(a,a+i));a+=i;var l=n.decode(e.slice(a,a+o));a+=o;var f=n.decode(e.slice(a,a+s));a+=s;var d=e.slice(a,e.byteLength);return{join_ref:u,ref:c,topic:l,event:mx,payload:{status:f,response:d}}},decodeBroadcast:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=this.HEADER_LENGTH+2,s=n.decode(e.slice(o,o+r));o+=r;var a=n.decode(e.slice(o,o+i));return o+=i,{join_ref:null,ref:null,topic:s,event:a,payload:e.slice(o,e.byteLength)}}},xx=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Xk(this,e),this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=r.timeout||1e4,this.transport=r.transport||ix.WebSocket||Ax,this.establishedConnections=0,this.defaultEncoder=kx.encode.bind(kx),this.defaultDecoder=kx.decode.bind(kx),this.closeWasClean=!1,this.binaryType=r.binaryType||"arraybuffer",this.connectClock=1,this.transport!==Ax?(this.encode=r.encode||this.defaultEncoder,this.decode=r.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);var i=null;rx&&rx.addEventListener&&(rx.addEventListener("pagehide",(function(e){n.conn&&(n.disconnect(),i=n.connectClock)})),rx.addEventListener("pageshow",(function(e){i===n.connectClock&&(i=null,n.connect())}))),this.heartbeatIntervalMs=r.heartbeatIntervalMs||3e4,this.rejoinAfterMs=function(e){return r.rejoinAfterMs?r.rejoinAfterMs(e):[1e3,2e3,5e3][e-1]||1e4},this.reconnectAfterMs=function(e){return r.reconnectAfterMs?r.reconnectAfterMs(e):[10,50,100,150,200,250,500,1e3,2e3][e-1]||5e3},this.logger=r.logger||null,this.longpollerTimeout=r.longpollerTimeout||2e4,this.params=tx(r.params||{}),this.endPoint=t+"/"+_x,this.vsn=r.vsn||"2.0.0",this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new Ox((function(){n.teardown((function(){return n.connect()}))}),this.reconnectAfterMs)}return $k(e,[{key:"getLongPollTransport",value:function(){return Ax}},{key:"replaceTransport",value:function(e){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.sendBuffer=[],this.conn&&(this.conn.close(),this.conn=null),this.transport=e}},{key:"protocol",value:function(){return location.protocol.match(/^https/)?"wss":"ws"}},{key:"endPointURL",value:function(){var e=Tx.appendParams(Tx.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return"/"!==e.charAt(0)?e:"/"===e.charAt(1)?this.protocol()+":"+e:this.protocol()+"://"+location.host+e}},{key:"disconnect",value:function(e,t,n){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.teardown(e,t,n)}},{key:"connect",value:function(e){var t=this;e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=tx(e)),this.conn||(this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=function(){return t.onConnOpen()},this.conn.onerror=function(e){return t.onConnError(e)},this.conn.onmessage=function(e){return t.onConnMessage(e)},this.conn.onclose=function(e){return t.onConnClose(e)})}},{key:"log",value:function(e,t,n){this.logger(e,t,n)}},{key:"hasLogger",value:function(){return null!==this.logger}},{key:"onOpen",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}},{key:"onClose",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}},{key:"onError",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.error.push([t,e]),t}},{key:"onMessage",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.message.push([t,e]),t}},{key:"ping",value:function(e){var t=this;if(!this.isConnected())return!1;var n=this.makeRef(),r=Date.now();this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:n});var i=this.onMessage((function(o){o.ref===n&&(t.off([i]),e(Date.now()-r))}));return!0}},{key:"clearHeartbeats",value:function(){clearTimeout(this.heartbeatTimer),clearTimeout(this.heartbeatTimeoutTimer)}},{key:"onConnOpen",value:function(){if(this.hasLogger()){var e=this.endPointURL().replace(/access_token=([^&#/]+)/,"access_token=-pruned-");this.log("transport","connected to "+e)}this.closeWasClean=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach((function(e){return(0,ex(e,2)[1])()}))}},{key:"heartbeatTimeout",value:function(){var e=this;this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.triggerChanError(),this.closeWasClean=!1,this.teardown((function(){return e.reconnectTimer.scheduleTimeout()}),1e3,"heartbeat timeout"))}},{key:"resetHeartbeat",value:function(){var e=this;this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,this.clearHeartbeats(),this.heartbeatTimer=setTimeout((function(){return e.sendHeartbeat()}),this.heartbeatIntervalMs))}},{key:"teardown",value:function(e,t,n){var r=this;if(!this.conn)return e&&e();this.waitForBufferDone((function(){r.conn&&(t?r.conn.close(t,n||""):r.conn.close()),r.waitForSocketClosed((function(){r.conn&&(r.conn.onopen=function(){},r.conn.onerror=function(){},r.conn.onmessage=function(){},r.conn.onclose=function(){},r.conn=null),e&&e()}))}))}},{key:"waitForBufferDone",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.bufferedAmount?setTimeout((function(){t.waitForBufferDone(e,n+1)}),150*n):e()}},{key:"waitForSocketClosed",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.readyState!==ux?setTimeout((function(){t.waitForSocketClosed(e,n+1)}),150*n):e()}},{key:"onConnClose",value:function(e){this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),this.clearHeartbeats(),this.closeWasClean||this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach((function(t){return(0,ex(t,2)[1])(e)}))}},{key:"onConnError",value:function(e){this.hasLogger()&&this.log("transport",e);var t=this.transport,n=this.establishedConnections;this.stateChangeCallbacks.error.forEach((function(r){(0,ex(r,2)[1])(e,t,n)})),(t===this.transport||n>0)&&this.triggerChanError()}},{key:"triggerChanError",value:function(){this.channels.forEach((function(e){e.isErrored()||e.isLeaving()||e.isClosed()||e.trigger(vx)}))}},{key:"connectionState",value:function(){switch(this.conn&&this.conn.readyState){case ox:return"connecting";case sx:return"open";case ax:return"closing";default:return"closed"}}},{key:"isConnected",value:function(){return"open"===this.connectionState()}},{key:"remove",value:function(e){this.off(e.stateChangeRefs),this.channels=this.channels.filter((function(t){return t.joinRef()!==e.joinRef()}))}},{key:"off",value:function(e){for(var t in this.stateChangeCallbacks)this.stateChangeCallbacks[t]=this.stateChangeCallbacks[t].filter((function(t){var n=ex(t,1)[0];return-1===e.indexOf(n)}))}},{key:"channel",value:function(e){var t=new Sx(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},this);return this.channels.push(t),t}},{key:"push",value:function(e){var t=this;if(this.hasLogger()){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;this.log("push",n+" "+r+" ("+s+", "+o+")",i)}this.isConnected()?this.encode(e,(function(e){return t.conn.send(e)})):this.sendBuffer.push((function(){return t.encode(e,(function(e){return t.conn.send(e)}))}))}},{key:"makeRef",value:function(){var e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}},{key:"sendHeartbeat",value:function(){var e=this;this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout((function(){return e.heartbeatTimeout()}),this.heartbeatIntervalMs))}},{key:"flushSendBuffer",value:function(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach((function(e){return e()})),this.sendBuffer=[])}},{key:"onConnMessage",value:function(e){var t=this;this.decode(e.data,(function(e){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;o&&o===t.pendingHeartbeatRef&&(t.clearHeartbeats(),t.pendingHeartbeatRef=null,t.heartbeatTimer=setTimeout((function(){return t.sendHeartbeat()}),t.heartbeatIntervalMs)),t.hasLogger()&&t.log("receive",(i.status||"")+" "+n+" "+r+" "+(o&&"("+o+")"||""),i);for(var a=0;a<t.channels.length;a++){var u=t.channels[a];u.isMember(n,r,i,s)&&u.trigger(r,i,o,s)}for(var c=0;c<t.stateChangeCallbacks.message.length;c++){(0,ex(t.stateChangeCallbacks.message[c],2)[1])(e)}}))}},{key:"leaveOpenTopic",value:function(e){for(var t=void 0,n=0;n<this.channels.length;n++){var r=this.channels[n];if(r.topic===e&&(r.isJoined()||r.isJoining())){t=r;break}}t&&(this.hasLogger()&&this.log("transport",'leaving duplicate topic "'+e+'"'),t.leave())}}]),e}(),Mx=function(){function e(t){var n=t.id,r=t.socketId,i=t.tags;Xk(this,e),this.id=n,this.socketId=r,this.tags=i}return $k(e,null,[{key:"build",value:function(t){var n=t.tags.map((function(e){return e._name}));return new e({id:t.id,socketId:t.socketId,tags:n})}}]),e}(),Nx=function(e,t){return t.onlyLongPollEnabled?Ax:window.WebSocket?window.navigator.onLine?e.transport===window.WebSocket?Ax:window.WebSocket:e.transport:Ax},Rx=function(e){return!function(e){return e&&"error"===e.type}(e)};function Cx(e){var t={onlyLongPollEnabled:!1,connectionTriedOnce:!1,avoidLongPollWorkerInterval:6e5},n=void 0,r=function(n,r){t.onlyLongPollEnabled=!0,e.disconnect((function(){e.transport=Ax,r&&r(n),e.connect()}))},i=void 0;return{ensureConnected:function(i){var o=i.onInitialTry,s=i.onInitialError,a=i.avoidLongPollWorkerInterval;if(!t.connectionTriedOnce){o&&o(),"number"==typeof a&&(t.avoidLongPollWorkerInterval=a);try{e.connect(),e.conn.readyState===window.WebSocket.CLOSED&&r(null,s)}catch(e){r(e,s)}t.connectionTriedOnce=!0,n=function(e,t){if(t.avoidLongPollWorkerInterval>0&&!t.onlyLongPollEnabled){var n=setInterval((function(){if("open"===e.connectionState()&&e.transport===Ax){var n=Nx(e,t);if(e.transport!==n)return e.transport=n,e.disconnect((function(){return e.connect()}))}}),t.avoidLongPollWorkerInterval);return function(){return clearInterval(n)}}}(e,t)}},selectNewTransport:function(n){Rx(n)&&Rx(i)||(e.transport=Nx(e,t),i=n)},stop:function(){n&&n()}}}var Px=function(){return"hidden"===document.visibilityState},jx=function(){return window.navigator.onLine},Lx=function(e){return"object"===(void 0===e?"undefined":Kk(e))?e&&e.reason:e},Ux=function(e){for(var t=[],n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)t.push(e[n][r]);return t},qx=function(e){return e===window.WebSocket?"WebSocket":e===Ax?"LongPoll":"unknown"},Dx=function(e){return"object"===(void 0===e?"undefined":Kk(e))?e&&e.reason:e},Vx={metrics:{}};function Fx(e,t,n){var r=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:{logPrefix:"PubSub"}).logPrefix,i=0,o=!1;n=n||Vx;var s=function(e){n.metrics.connectionMetric&&n.increment(n.metrics.connectionMetric,e)},a=function(t){var n={transport:qx(e.transport),online:jx(),visibility_state:document.visibilityState,error_count:i};return Zk({},n,t)},u=function(t,n){return["transport:"+((n||{}).transport||qx(e.transport)),"online:"+jx()].concat(t)};return{onOpen:function(){o=!0,s(u(["action:connected"])),t.info(r+" socket opened",a({}))},onClose:function(e){if(e){var n=qx(window.WebSocket),i=a({reason:e.reason,type:e.type,code:e.code&&e.code.toString(),transport:n}),o=u(["action:disconnected","type:"+e.type,"code:"+e.code],{transport:n});e.wasClean?(s(o.concat(["reason:closed"])),t.info(r+" connection disconnected cleanly",i)):Px()?(s(o.concat(["reason:closed"])),t.info(r+" connection disconnected while tab was hidden",i)):(s(o.concat(["reason:closed"])),t.info(r+" connection disconnected",i))}else{var c=qx(Ax),l=a({reason:"unknown",type:"unknown",code:"unknown",transport:c}),f=u(["action:disconnected","type:unknown","reason:unknown","code:unknown"],{transport:c});s(f),t.info(r+" connection disconnected",l)}},onError:function(e){var n=e&&e.type||"unknown";i+=1;var c=e&&e.target?a({type:n}):a({type:n,error:e});Px()?t.info(r+" connection error while tab was hidden",c):jx()?1!==i||o?(s(u(["action:error"])),t.warn(r+" socket connection error",c)):t.info(r+" socket connection error while attempting to establish the connection first time",c):t.info(r+" connection error while user was offline",c)},onInitialTry:function(){return s(u(["action:connect"]))},onInitialConnectError:function(n){return t.info(r+" failed to connect with initial transport",{new_transport:qx(e.transport),error:Dx(n)})}}}var Hx=function(e,t){var n=t.enabled,r=t.logPrefix;return n?function(t,n,i){return e.info(r+" "+t+": "+n,{pubsub_data:i})}:function(){}},Wx=function(e,t){window.addEventListener("offline",t),window.addEventListener("online",e)},Gx="join rate limited",Bx="[Channel Phoenix]",zx={initialDelay:500,maxDelay:1e4,factor:1.2};function Jx(e){var t=e.logger,n=e.serverURL,r=e.phoenixLogsEnabled,i=e.getAccessToken,o=e.transport,s=e.socketOverride,a=function(e){var t=e.initialDelay,n=e.maxDelay,r=e.factor,i=e.jitter,o=e.random;n||(n=6e4),void 0===i&&(i=.5),o||(o=Math.random);var s=null,a=function(e){var a=t*Math.pow(r,e);s&&(a=Math.max(a,s),s=null);var u=o(),c=Math.floor(u*i*a),l=Math.floor(10*u)%2==0?a-c:a+c;return Math.min(l,n)};return a.setNextDelayMinimum=function(e){s=e},a.maximizeNextDelay=function(){return a.setNextDelayMinimum(n)},a}(zx),u=n.split("?")[0],c={logger:Hx(t,{enabled:r,logPrefix:Bx}),params:function(){return{access_token:i()}},reconnectAfterMs:a,timeout:864e5,transport:o};o&&o.customSerializer&&(c.decode=o.decode,c.encode=o.encode);var l=s||new xx("wss://"+u,c),f=new Cx(l),d=new Fx(l,t,null,{logPrefix:Bx});l.onOpen((function(){d.onOpen()})),l.onClose((function(e){d.onClose(e)})),l.onError((function(e){if("number"==typeof e)switch(e){case 403:t.info(Bx+" Detected likely pubsub authentication error, reconnecting after max delay"),a.setNextDelayMinimum(zx.maxDelay);break;case 410:break;case 500:t.info(Bx+" PubSub connection disconnected with error 500");break;case 503:var n=zx.maxDelay/2;t.info(Bx+" PubSub unavailable, postponing reconnecting for at least "+n+" ms"),a.setNextDelayMinimum(n);break;default:return t.error(Bx+" Received unhandled pubsub error status "+e+", stopping reconnecting"),void l.disconnect()}d.onError(e),f.selectNewTransport(e)}));var p=void 0,h=function(){var e,n,r,i,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};f.ensureConnected({onInitialTry:function(){return d.onInitialTry},onInitialError:function(e){return d.onInitialConnectError(e)}}),l.connect(),o.idleDisconnectCutoff>0&&(e={checkInterval:o.idleCheckInterval,cutoff:o.idleDisconnectCutoff},n=e.checkInterval,r=e.cutoff,i=Date.now(),clearInterval(p),p=setInterval((function(){if(l.channels.length>0)i=Date.now();else{var e=Date.now()-i;e>=r&&(t.info(Bx+" Disconnecting from PubSub due to idle",{idle_for:e}),l.disconnect(),clearInterval(p))}}),n||6e4))},v=l.disconnect.bind(l),b=l.channel.bind(l),m=function(e,t){var n=e.disconnect,r=e.connect,i=e.triggerChanError,o=!1;return function(e){if(!e&&!o){t.info("Forcefully reconnecting to the socket"),o=!0;try{i()}catch(e){t.warn("Unable to triggerChanError",e)}n((function(){r(),o=!1}))}}}({disconnect:v,connect:h,triggerChanError:l.triggerChanError.bind(l)},t);return{connect:h,disconnect:v,channel:b,forceReconnect:m,socket:l}}var Qx="phoenix_signaler.proxy_channel",Yx=function(e,t){return e.channels.find((function(e){return e.topic===t&&(e.isJoined()||e.isJoining())}))},Kx=function(e){return Zk({},e,{event:"phx_reply",payload:{response:{},status:"ok"}})};function Xx(e,t){var n=this;this.skipHeartbeat=!0,this.readyState=1,setTimeout((function(){return n.onopen()})),e.onmessage=function(e){n.onmessage(e)},this.send=function(t){e.postMessage(t)},this.close=function(){}}var $x=function(e){var t=Xx.bind(null,e);return t.customSerializer=!0,t.decode=function(e,t){return t(e)},t.encode=function(e,t){return t(e)},t};function Zx(){var e=void 0;return{listenForProxyTransport:function(t){var n=t.logger,r=t.allowedOrigin,i=t.checkOrigin;i=i||function(e){return e===r};var o=function(t){if(t.source===window.parent&&t.data===Qx)if(i(t.origin)){var r=t.ports[0];e=$x(r)}else n.warn("Received CrossFrameMultiplexer message from unexpected origin, discarding",{origin:t.origin})};window.addEventListener("message",o);return function(){return window.removeEventListener("message",o)}},getProxyTransport:function(){return e},createProxyTransport:$x}}var eM=function(){function e(){Xk(this,e),this.joinRefs={},this.outboundMessageRefs={}}return $k(e,[{key:"registerInnerJoin",value:function(e,t,n){this.joinRefs[e]={innerJoinRef:t,channel:n}}},{key:"registerInnerLeave",value:function(e){var t=this.joinRefs[e].channel;return delete this.joinRefs[e],t}},{key:"isFresh",value:function(e,t){return this.joinRefs[e]&&this.joinRefs[e].innerJoinRef===t}},{key:"registerOutboundMessage",value:function(e,t,n){return this.outboundMessageRefs[t]=n,this.joinRefs[e].channel}},{key:"processMessageFromBackend",value:function(e){var t=e.topic,n=e.event,r=e.payload,i=e.ref,o=this.joinRefs[t];if(o&&(!i||this.outboundMessageRefs[i])){var s=i&&this.outboundMessageRefs[i];return delete this.outboundMessageRefs[i],{topic:t,event:n,payload:r,ref:s,join_ref:o.innerJoinRef}}}}]),e}();function tM(){return{proxyTo:function(e){var t=e.allowedDomain,n=e.phoenixSocket,r=e.iFrame,i=e.logger,o=new MessageChannel,s=new eM,a=[];o.port1.onmessage=function(e){var t=e.data,r=t.topic,u=t.event,c=t.join_ref,l=t.ref;if("phx_join"===u){var f=Yx(n,r);if(f)return s.registerInnerJoin(r,c,f),void o.port1.postMessage(Kx(e.data));var d=n.channel(r);return d.join().receive("ok",(function(){o.port1.postMessage(Kx(e.data))})).receive("error",(function(e){i.warn("Failed to join extra channel in proxy transport",{topic:r,error:e})})),a.push(d),void s.registerInnerJoin(r,c,d)}if("phx_leave"!==u)if(s.isFresh(r,c)){var p=n.makeRef(),h=s.registerOutboundMessage(r,p,l);e.data.ref=p,e.data.join_ref=h.joinRef(),n.push(e.data)}else i.info("Discarding stale proxy push",{topic:r,event:u});else{if(s.isFresh(r,c)){var v=s.registerInnerLeave(r);v&&-1!==a.indexOf(v)&&(a.splice(a.indexOf(v),1),v.leave())}else i.info("Discarding stale proxy phx_leave instruction",{topic:r});o.port1.postMessage(Kx(e.data))}},r.contentWindow.postMessage(Qx,t,[o.port2]);var u=n.onMessage((function(e){var t=s.processMessageFromBackend(e);t&&o.port1.postMessage(t)}));return function(){a.forEach((function(e){return e.leave()})),n.off([u]),o.port1.close()}}}}var nM=void 0,rM=new function(){return{asInner:new Zx,asOuter:new tM}},iM=function(e){if(e)return[{name:"cobrowse",unique:!0}]},oM=function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return{emit:function(e,i){var o={0:e,1:i};r.length>0&&(o[2]=r),t.push("send",o).receive("error",(function(r){t.isClosed()||n.warn("Failed to push channel message",{eventName:e,error:r})})).receive("timeout",(function(){t.isClosed()||n.warn("Failed to push channel message due to timeout",{eventName:e})}))},toTag:function(i){return e(t,n,r.concat([i]))}}},sM=function(e,t,n){var r={},i=!1;return{on:function(o,s){if(i)t.warn("Tried to add eventHandler to stopped channel",{topic:n,eventName:o});else{var a=e.on(o,function(e){return function(t){t&&t.__value?e(t.__value):e(t)}}(s));!function(e,t,n){r[e]=r[e]||[],r[e].push({handler:t,ref:n})}(o,s,a)}},off:function(t,n){var i=function(e,t){var n=(r[e]||[]).filter((function(e){return e.handler===t}));return 1===n.length?(r[e]=r[e].filter((function(e){return e.handler!==t})),n[0].ref):null}(t,n);i&&e.off(t,i)},stop:function(){i=!0,r={}}}};function aM(e){var t=e.url,n=e.getAccessToken,r=e.isActiveTab,i=e.logger,o=e.callback,s=e.clientOverride,a=e.idleDisconnectCutoff,u=nM,c=rM.asInner.getProxyTransport();u||(u=s||new Jx({logger:i,serverURL:t,phoenixLogsEnabled:!1,getAccessToken:n,transport:c}),nM=u);var l=[],f=!1,d=function(e){try{return e.split("?")[1].match(/topic=([^&]+)/)[1]}catch(e){throw new Error("Cannot find topic in channel URL params")}}(t),p=u.channel(d,(function(){return{tags:iM(r)}})),h=oM(p,i),v=sM(p,i,d),b=function(e){var t=[],n=new Ix(e),r=function(e,t){return t.metas.map((function(t){return new Mx({id:e.match(/visitor/)?"visitor":e,socketId:t.connection_id,tags:t.tags.map((function(e){return e.name}))})}))},i=Ux(n.list(r));return n.onSync((function(){i=Ux(n.list(r)),t.forEach((function(e){return e(i)}))})),{onParticipantState:function(e){return t.push(e),e(i),function(){t=t.filter((function(t){return t!==e}))}}}}(p),m=b.onParticipantState,g=function(){p.leave(),l.forEach((function(e){return e.call()})),l=[],v.stop(),f=!0},y=function(e){var t=e.name,n=e.unique?[{name:t,unique:!0}]:[{name:t}];p.push("register_tags",n).receive("error",(function(e){i.warn("Failed to register tag",{error:e,tag_name:t})})).receive("timeout",(function(){i.warn("Failed to register tag due to timeout",{tag_name:t})}))},_={url:t,on:v.on,off:v.off,onParticipantState:m,emit:h.emit,emitAll:h.emit,toTag:h.toTag,registerTag:y,registerUniqueTag:function(e){var t=e.name;y({name:t,unique:!0})},authorize:function(){},proxyToIframe:function(e,t){return rM.asOuter.proxyTo({allowedDomain:t,phoenixSocket:p.socket,logger:i,iFrame:e})},close:g,destroy:g,addDestroyListener:function(e){l.push(e)},isStopped:function(){return f}};return function(e){var t=!1;(arguments.length>1&&void 0!==arguments[1]?arguments[1]:Wx)((function(){if(t)return t=!1,e()}),(function(){t=!0}))}((function(){return function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e3,r=!1,i=void 0,o=function(t){r||(r=!0,e(t))};t.ping((function(e){clearTimeout(i),o(!0)}))?i=setTimeout((function(){return o(!1)}),n):o(!1)}(u.forceReconnect,u.socket)})),{start:function(){u.connect({idleDisconnectCutoff:a||3e5});var e=void 0,t=!1;p.join().receive("ok",(function(){t||o(null,_),t=!0,i.info("Joining engagement channel succeeded",{topic:d})})).receive("error",(function(t){t&&"join crashed"===t.reason?i.info("Joining engagement channel failed with crash, retrying",{topic:d}):t&&t.reason===Gx?(i.info("Joining engagement channel failed due to rate limiting of joins",{topic:d}),p.leave(),o({reason:Gx},null)):"unauthorized"===t&&(!e||e<Date.now()-1e4)?(i.info("Joining engagement channel failed due to unauthorized, reconnecting to refresh server side user state",{topic:d}),e=Date.now(),u.disconnect((function(){return u.connect()}))):(i.warn("Joining engagement channel failed",{topic:d,error:Lx(t)}),p.leave(),o({reason:t},null))})).receive("timeout",(function(){i.warn("Joining engagement channel failed",{topic:d,reason:"timeout"}),o({reason:"timeout"},null)}))}}}var uM=function(){function e(){Xk(this,e)}return $k(e,null,[{key:"join",value:function(e){var t=e.url,n=e.isInitiallyActive,r=e.callback,i=e.getAccessToken,o=e.logger,s=e.idleDisconnectCutoff;o=o||sm.logger,t.match(/engagement_signaler/)?new aM({url:t,getAccessToken:i,isActiveTab:n,logger:o,callback:r,idleDisconnectCutoff:s}).start():r(new Error("Unexpected engagement-signaler channel"),null)}}]),e}();uM.listenForProxyTransport=function(e){return rM.asInner.listenForProxyTransport(e)};var cM=function(){},lM={},fM=function(e){return lM[e]?lM[e].promise:void 0},dM=function(e,t){fM(t)===e&&function(e){delete lM[e]}(t)},pM=function(e,t,n){n.then((function(e){e.addDestroyListener((function(){return dM(n,e.otherId)}))}),cM),lM[e]={promise:n,url:t}},hM=fM,vM="Engagement.Kluster",bM=function(e){var t=e.isActiveTab,n=e.operatorId,r=e.channelUrl,i=e.getAccessToken,o=e.stats,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:uM,a=o.withTags(["protocol:websocket"]).instrument({namespace:"join-channel"}).attempted(),u={operator_id:n,channel_url:r,is_active_tab:t};zO.log("".concat(vM,": Channel join started"),u);var c=new Promise((function(e,n){s.join({url:r,isInitiallyActive:t,getAccessToken:i,logger:zO,callback:function(t,r){t?(zO.warn("".concat(vM,": Channel join failed"),Jr(u,{error:t})),a.failed(),n(t)):(r.authorize(i),zO.info("".concat(vM,": Channel join succeeded"),u),a.succeeded(),r.observable=function(e){return NT(r,e)},e(r))}})}));return pM(n,r,c),CO.Observable.fromPromise(c)},mM=["scroll","keyup","mousemove"];function gM(e){var t=e.getAccessToken,n=e.stats,r=e.start,i=e.stop,o=e.hideMouse,s=e.createChannelObservable,a=e.dynamicImport;s||(s=bM),a||(a=rS);var u=r.pipe(Hf(),mp((function(e){return s({channelUrl:e,isActiveTab:!0,getAccessToken:t,stats:n})})),Ud(1),zs());this.sourceObservable=u.pipe(Mu((function(e){return a("Cobra").map((function(t){return{Cobra:t,channel:e}}))})),Ka((function(e){var t=e.Cobra,n=e.channel;return new t.SourceInitializer(n,BI()).initialize()})),Ud(),zs()),this.stopSourceObservable=this.sourceObservable.pipe(mp((function(e){return i.pipe(Yf(1),Ka((function(){return e})))})),hf((function(){return CO.Observable.empty()}))),this.hideMouseObservable=u.pipe(mp((function(e){return o.pipe(wp(i),Ka((function(){return e})))})),hf((function(){return CO.Observable.empty()})))}var yM,_M,wM=function(){function e(t,n,r,o){i(this,e),this._sendActivityFromCobrowsableIframe=this._sendActivityFromCobrowsableIframe.bind(this),this.windowMessenger=t,this.channelUrl=n,this.getAccessToken=r,this.stats=o}return s(e,[{key:"boot",value:function(){this._activityObservable().subscribe(this._sendActivityFromCobrowsableIframe);var e=new gM({getAccessToken:this.getAccessToken,stats:this.stats,start:this._startObservable(),stop:this._stopObservable(),hideMouse:this._hideMouseObservable()});e.sourceObservable.subscribe((function(){return zO.log("Source started for cobrowsable iframe")}),(function(e){return zO.error("Couldn't start visitor cobrowsable iframe",e)})),e.stopSourceObservable.subscribe((function(e){return e.stop()}),zO.error.bind(zO,"cobra stop subscription error")),e.hideMouseObservable.subscribe((function(e){return e.toTag("cobrowse").emit("cobra:hide_mouse")}),zO.error.bind(zO,"cobra hide mouse subscription error")),zO.info("Started for visitor Nested CoBrowsable iFrame")}},{key:"_startObservable",value:function(){var e=this.channelUrl?CO.Observable.of(this.channelUrl):CO.Observable.empty();return this._cobrowsableFrameInviteObservable(this.windowMessenger).share().merge(e)}},{key:"_stopObservable",value:function(){return this.windowMessenger.observable("cobra:cobrowsable_iframe:stop")}},{key:"_hideMouseObservable",value:function(){return this.windowMessenger.observable("cobra:hide_mouse")}},{key:"_activityObservable",value:function(){return sm.PeriodicalActivityTracker.getStream(mM)}},{key:"_cobrowsableFrameInviteObservable",value:function(e){return CO.Observable.create((function(t){return e.respondTo("cobra:cobrowsable_iframe:join_channel_and_cobrowse",(function(e,n){var r=e.url;return n(),t.next(r)}))}))}},{key:"_sendActivityFromCobrowsableIframe",value:function(){return this.windowMessenger.emit("activity_from_cobrowsable_iframe")}}]),e}(),EM=new Error("Tried to connect internal visitor state subscription after already connected"),OM=null,SM=dt(pe(ki(["id","site_id","operator_id"])),Ai([],["engagement","observations"])),TM=dt(pe(ki(["id","site_id","operator_id","outcome"])),Ai([],["engagement","requests"])),AM=["id","site_id","status","sub_engagement_id","visitor","restarted_from_engagement_id","capabilities"],IM=function(e){return pe(ki(e))},kM=pe((function(e){return Jr(e,{visitor:ki(["authenticated","browser_tab_id"],e.visitor)})})),xM=dt(kM,IM(AM),Ai([],["engagement","engagements"])),MM=dt(pe(ki(["id","site_id","state"])),Ai([],["omniq","queue_tickets"])),NM=function(e,t){return Ai({},["routing","".concat(sm.siteId),"".concat(t)],e)},RM=dt(kM,IM(Ne("end_reason",AM)),Ai([],["engagement","ended_engagements"])),CM=function(e){var t=e.pubsub,n=e.tabId,r=e.allowConnectingMultipleTimes,i=e.visitorIdObservable,o=void 0===i?UO():i;return OM&&!r?zO.error(EM):(OM=o.switchMap((function(e){return t.joinChannel("visitor_state:".concat(e)).flatMap((function(e){return(0,e.observable)("change",{leaveChannelOnDispose:!0})})).map((function(t){return h(h({},t||{}),{},{visitor_id:e})}))})).do((function(e){return function(e,t){return zO.info("Received internal visitor state",{routing:NM(e,t),observations:SM(e),engagement_requests:TM(e),engagements:xM(e),ended_engagements:RM(e),queue_tickets:MM(e)})}(e,n)})).publishReplay(1),OM.connect(),OM)},PM=sm.logger,jM=function(e){var t=e.status,n=e.body,r=e.error;if(t>=200&&t<300)return CO.Observable.of(n);var i=jn(dt(it,De),[r,n,"unknown"]);return Or(String,i)?CO.Observable.throw({status:t,reason:i}):CO.Observable.throw(Jr({status:t},i))},LM=function(e){return Or(Object,e)&&"timeout"===e.type?CO.Observable.throw(new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT})):CO.Observable.throw(e)},UM=ji("persisted",!0);$n("onpagehide",window)?(yM=CO.Observable.fromEvent(window,"pageshow").share(),_M=CO.Observable.fromEvent(window,"pagehide").share()):(yM=CO.Observable.fromEvent(window,"load").share(),_M=CO.Observable.fromEvent(window,"unload").share());var qM={unloadMaybeToPageCache:_M,loadFromPageCache:yM.filter(UM)},DM=new RegExp("sm."),VM=function(e){return"sm.".concat(e)},FM={set:function(e,t){sessionStorage.setItem(VM(e),function(e){return JSON.stringify(e)}(t))},get:function(e){return function(e){try{return JSON.parse(e)}catch(e){return null}}(sessionStorage.getItem(VM(e)))},remove:function(e){sessionStorage.removeItem(VM(e))},removeAll:function(){for(var e=0;e<sessionStorage.length;e++){var t=sessionStorage.key(e);DM.test(t)&&sessionStorage.removeItem(t)}}};var HM=function(){function e(t){var n=t.urlParams,r=t.storage,o=t.unloadMaybeToPageCache,s=t.loadFromPageCache,a=t.windowNameStorage,u=t.sessionContext,c=t.tabIdFromConfiguration;i(this,e),this.markAsAlive=this.markAsAlive.bind(this),this.markAsUnloaded=this.markAsUnloaded.bind(this),this.urlParams=n,this.storage=r,this.unloadMaybeToPageCache=o,this.loadFromPageCache=s,this.windowNameStorage=a,this.sessionContext=u,this.tabIdFromConfiguration=c}return s(e,[{key:"init",value:function(){this.localTabId=this._createOrReuseId(),this.markAsAlive(),this.unloadMaybeToPageCache.subscribe(this.markAsUnloaded,(function(e){return sm.logger.error("unloadMaybeToPageCache failed",e)})),this.loadFromPageCache.subscribe(this.markAsAlive,(function(e){return sm.logger.error("loadFromPageCache failed",e)}))}},{key:"markAsAlive",value:function(){this._changeTabStatus("alive")}},{key:"markAsUnloaded",value:function(){this._changeTabStatus("unloaded")}},{key:"getId",value:function(){return this.localTabId}},{key:"getSessionTabIds",value:function(){return Object.keys(this.storage.get("tab_ids")||{})}},{key:"_createOrReuseId",value:function(){var e;if(e=this._findIdFromConfiguration()||this._findIdFromSessionContext()||this._findIdFromWindowName()||this._findIdFromUrlParams()||this._findIdFromStorage())return e;var t,n=(t=new Uint32Array(2),(window.crypto||window.msCrypto).getRandomValues(t),(t[0]*t[1]).toString(36).replace(".","").substring(0,11));return sm.logger.info("No existing tab ID found, generated new tab ID",{new_tab_id:n}),n}},{key:"_changeTabStatus",value:function(e){var t=this.storage.get("tab_ids")||{};return t[this.localTabId]=e,this.storage.set("tab_ids",t),this.windowNameStorage.setItem("tab_ids",t)}},{key:"_findIdFromConfiguration",value:function(){var e;return(e=this.tabIdFromConfiguration)?(sm.logger.info("Found tab ID from configuration",{found_tab_id:e}),this.tabIdFromConfiguration):null}},{key:"_findIdFromStorage",value:function(){var e,t=this.storage.get("tab_ids")||{};return(e=this._findIdFromTabIds(t))?(sm.logger.info("Found tab ID from session storage",{found_tab_id:e,tab_id_candidates:t}),e):null}},{key:"_findIdFromSessionContext",value:function(){if(this.sessionContext){var e=this.sessionContext.tab_id;return sm.logger.info("Found tab ID from sessionContext",{found_tab_id:e}),e}return null}},{key:"_findIdFromWindowName",value:function(){var e,t=this.windowNameStorage.getItem("tab_ids")||{};return(e=this._anyFromTabIds(t))?(sm.logger.info('Found tab ID from "window.name"',{window_name:window.name,found_tab_id:e}),e):null}},{key:"_findIdFromTabIds",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var r=t[n];if("unloaded"===e[r])return r}}},{key:"_anyFromTabIds",value:function(e){return Object.keys(e)[0]}},{key:"_findIdFromUrlParams",value:function(){var e;return(e=this.urlParams.tabId)?(sm.logger.info("Found tab ID from url params",{found_tab_id:e}),e):null}}],[{key:"setup",value:function(t,n){var r=n.sessionContext,i=n.tabIdFromConfiguration,o=new e({urlParams:sm.urlParams,storage:FM,windowNameStorage:t,unloadMaybeToPageCache:qM.unloadMaybeToPageCache,loadFromPageCache:qM.loadFromPageCache,sessionContext:r,tabIdFromConfiguration:i});return o.init(),o}}]),e}(),WM=function(e){return function(e){var t=ji("site_id",sm.siteId),n=dt(Te(ji("id",sm.siteId)),Ui([],"transferrable_sites")),r=Ai([],["engagement","engagements"],e);try{return dt(ot(Sr),Lt(In(t,n)))(r)}catch(t){return void zO.error("Engagements were undefined in state",{state:e,engagements:r})}}(e)?"engaged":function(e){return dt(ot(Sr),Lt(ji("site_id",sm.siteId)),Ai([],["engagement","observations"]))(e)}(e)?"observed":"available"},GM=function(e){return e.map(WM).distinctUntilChanged()},BM="high",zM="low",JM="visitor_priority",QM=Ai([],["omniq","queue_tickets"]),YM=Ai([],["engagement","requests"]),KM=Ai([],["engagement","engagements"]),XM=function(e){return function(e){return QM(e).length>0||YM(e).length>0||KM(e).length>0}(e)?BM:zM},$M=function(e,t){var n=e.indexOf(t);return n>-1?[e.substring(0,n),e.substring(n+1)]:[e]},ZM=function(e,t,n){n||(n="");var r=b($M(e,"#"),2),i=r[0],o=r[1],s=b($M(i,"?"),2),a=s[0],u=s[1],c=dt(Tr("&"),pe(Vt(n)),pe(Tr("=")),pe(pe(encodeURIComponent)),bo)(t),l=u?"".concat(a,"?").concat(u,"&").concat(c):"".concat(a,"?").concat(c);return o?"".concat(l,"#").concat(o):l},eN=function(){var e=function(){try{return window.getGliaContext||window.top.getGliaContext}catch(e){return window.getGliaContext}}();if("function"!=typeof e)return Promise.resolve({sessionId:null,idToken:null,accessToken:null});try{var t=e();"function"!=typeof t.then&&(t=Promise.resolve(t));return t.then((function(e){return Promise.resolve(h(h({},{sessionId:null,idToken:null,accessToken:null}),e))}),(function(e){return zO.warn("getGliaContext() promise rejected",{error:e}),Promise.resolve({sessionId:null,idToken:null,accessToken:null})})).catch((function(e){return zO.warn("Unexpected error in getGliaContext() promise",{error:e}),Promise.resolve({sessionId:null,idToken:null,accessToken:null})}))}catch(e){return zO.warn("Unexpected error in getGliaContext()",{error:e}),Promise.resolve({sessionId:null,idToken:null,accessToken:null})}},tN=function(){return CO.Observable.create((function(e){eN().then((function(t){e.next(t),e.complete()}))}))},nN=function(e){var t=e.split(".")[1],n=decodeURIComponent(atob(t).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""));return JSON.parse(n)},rN=function(e){return 1e3*nN(e).exp},iN=function(e){try{var t=nN(e);return(t.exp-t.iat)/2*1e3}catch(e){return zO.warn("Fetching interval from access token failed",e),864e5}},oN=function(e){return e&&"string"==typeof e},sN=function(e){var t=e.priority,n=e.accessToken,r=e.consolidationSecret,i=e.url,o=e.tabId,s=e.includeIdToken,a=void 0===s||s,u=e.sessionTabIds;return i||(i=sm.visitorConfigUrl),i=ZM(i,{priority:t,tab_id:o}),CO.Observable.create((function(e){var t=new XMLHttpRequest;return t.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){var n=JSON.parse(t.responseText);e.next({accessToken:n.access_token,visitorId:n.visitor_id,authenticatedExternally:Boolean(n.authenticated_externally)}),e.complete()}else e.error({responseText:t.responseText,status:t.status})},eN().then((function(e){var t=e.sessionId,n=e.idToken,r=e.accessToken;return[oN(t)?"external_session_id=".concat(t):"",oN(n)?"id_token=".concat(n):"",oN(r)?"external_access_token=".concat(r):""]})).then((function(e){var o,s=b(e,3),c=s[0],l=s[1],f=s[2],d=""!==l?"tab_id=".concat(sm.tabId):"",p=(o=u)?o.map((function(e){return"session_tab_ids[]="+e})).join("&"):null,h=[r?"consolidation_token=".concat(encodeURIComponent(r)):null,n?"access_token=".concat(encodeURIComponent(n)):null,c,a?l:"",f,p,d].filter(gt).join("&");t.open("POST",i,!0),t.withCredentials=!0,t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(h)})),function(){return t.abort()}}))},aN=function(){function e(t){i(this,e),this.attributes=nt(t),this.id=this.attributes.id}return s(e,[{key:"get",value:function(e){return this.attributes[e]}},{key:"set",value:function(e){var t=this;Object.keys(e).forEach((function(n){var r=e[n];t.attributes[n]=r}))}},{key:"getId",value:function(){return this.get("id")}},{key:"getName",value:function(){return this.get("name")}},{key:"getFormattedName",value:function(){return this.get("formattedName")}},{key:"getMediaType",value:function(){return this.get("media_type")}},{key:"isOnline",value:function(){return!this.isUnavailable()}},{key:"currentlyAvailable",value:function(){return!this.currentlyUnavailable()}},{key:"currentlyUnavailable",value:function(){return this.isEngaged()||this.isUnavailable()}},{key:"isEngaged",value:function(){return"engaged"===this.get("status")}},{key:"mediaRank",value:function(){switch(this.getMediaType()){case"text":return.8;case"audio":return.9;case"video":return 1;default:return 0}}},{key:"getPictureUrl",value:function(){var e=this.get("picture")&&this.get("picture").url,t=sm.conf.visitor_app.always_use_default_operator_picture,n=sm.conf.visitor_app.default_operator_picture.url;if(!n||!t&&e){var r=-1!==sm.conf.assets.server.indexOf("libs.")?"/":sm.conf.assets.prepend;return e||[sm.conf.assets.server,r||"/","default_operator_picture-02766f85f.png"].join("")}return n}},{key:"isUnavailable",value:function(){return!1===this.get("available")}}]),e}(),uN=function(e){return Lt(Gt(I,["video"]),e)};function cN(e){return/iPad|iPhone|iPod/.test(e)&&!window.MSStream}function lN(e){return/^((?!CriOS|Chrome|Android).)+Safari/.test(e)}function fN(e){return 0===e.length}function dN(e,t){return-1!==t.indexOf(e)}function pN(e){var t=e.match(/OS ((\d+_?){2,3})\s/);if(!t)return!1;var n=t[1].split("_"),r=n[0]+"."+n[1];return parseFloat(r)>=11.3}function hN(e){if(cN(e))return pN(e);var t=function(e){var t=e.match(/Version\/([0-9]+\.[0-9]*)/);return t&&parseFloat(t[1],10)}(e);return!!t&&t>=11}function vN(){return[{name:"RTCPeerConnection",pass:Boolean(window.RTCPeerConnection)},{name:"RTCIceCandidate",pass:Boolean(window.RTCIceCandidate)},{name:"AudioContext",pass:Boolean(window.AudioContext)||Boolean(window.webkitAudioContext)},{name:"MediaStream",pass:Boolean(window.MediaStream)}]}var bN={video:"camera",audio:"microphone"};function mN(){var e=window.navigator.userAgent;if(lN(e)&&cN(e)&&!pN(e))return!1;var t=vN().filter((function(e){return!e.pass}));return fN(t)}function gN(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.media,n=e.iframeAllow,r=window.navigator.userAgent;if(!function(e,t,n){if(null==n)return!0;var r=bN[t];return!(!dN(r,n)||lN(e)&&dN("".concat(r," *"),n))}(r,t,n))return!1;if(lN(r)&&!hN(r))return!1;var i=[].concat(m(vN()),[{name:"getUserMedia",pass:Boolean(window.navigator.mediaDevices)&&Boolean(window.navigator.mediaDevices.getUserMedia)}]).filter((function(e){return!e.pass}));return fN(i)}var yN=Object.freeze({__proto__:null,canReceiveMedia:mN,canSendMedia:gN}),_N="none",wN="receiver",EN="duplex",ON=function(){return mN()?gN()?EN:wN:_N},SN=["video","audio"],TN={video:["video","audio","phone","text"],audio:["audio","phone","text"],phone:["phone","text"],text:["text"]},AN=Cr(["state","medias"]),IN=Cr(["state","oneWayMedias"]),kN=function(e,t){var n=en(e.state[t],SN);return Ve(["state",t],n,e)},xN=Je((function(e,t){return e===EN||e===wN?t:kN(t,"oneWayMedias")})),MN=Je((function(e,t){return e===EN?t:kN(t,"medias")})),NN=function(e){return Ve(["state","media"],e.state.medias,e)},RN=Je((function(e,t){var n=e.enabledMediaType,r=e.webRtcMode;return dt(NN,xN(r),MN(r),yi(IN,dr(uN(TN[n]))),function(e){return yi(AN,dr(TN[e]))}(n))(t)})),CN=s((function e(t){var n=t.id,r=t.name,o=t.formattedName,s=t.picture,a=t.state;i(this,e),this.id=n,this.name=r,this.formattedName=o||(null==r?void 0:r.split(" ")[0]),this.picture=s,this.state=a,this.assignment={type:"direct"}})),PN=function(e){f(n,e);var t=a(n);function n(){return i(this,n),t.apply(this,arguments)}return s(n,[{key:"serialize",value:function(){return new CN({id:this.getId(),name:this.getName(),formattedName:this.getFormattedName(),picture:this._getPicture(),state:this._getState()})}},{key:"_getPicture",value:function(){return{url:this.getPictureUrl()}}},{key:"_getState",value:function(){var e=TN[this.getMediaType()];return{available:this.currentlyAvailable(),medias:e,oneWayMedias:uN(e)}}}]),n}(aN),jN=Je((function(e,t){var n=e.enabledMediaType,r=e.webRtcMode,i=new PN(t.attributes).serialize();return RN({enabledMediaType:n,webRtcMode:r},i)})),LN=function(e){var t=e.id,n=e.name,r=e.formattedName,i=e.picture,o=e.mediaType,s=e.webRtcMode,a=e.enabledMediaType,u=new PN({id:t,name:n,formattedName:r,picture:i,media_type:o});return jN({enabledMediaType:a,webRtcMode:s},u)},UN=function(e){var t=e.enabledMediaLevel,n=e.webRtcMode,r=function(e,t){return{operator:e,isVisible:void 0!==e.state.available&&e.reactiveEnabled&&(Sr(t)||!Sr(dr(e.teamIds,t)))}};return{fromPresence:function(e,i,o){var s=i.state,a=Ai("operator",["operator_information","name"],s),u=Ai(null,["operator_information","picture","url"],s),c=Ai([],["operator_information","teams"],s),l=pe(ge("id"),c),f=Ai(!0,["operator_information","reactive_enabled"],s),d=Ai([],["engagement","media"],s),p=$n("engagement",s);-1!==d.indexOf("audio")&&d.push("phone");var h={id:e,name:a,picture:{url:u},state:{available:p?!Sr(d):void 0,media:d,medias:d,oneWayMedias:d},teamIds:l,reactiveEnabled:f};return h=RN({enabledMediaType:t,webRtcMode:n},h),r(h,o)},updateVisibility:r}},qN=function e(t,n){t||(t={}),n||(n={});return{omit:function(r){return e(nn(r,t),nn(r,n))},set:function(r){var i=r.operator,o=r.isVisible?qe(i.id,i,n):nn(i.id,n);return e(qe(i.id,i,t),o)},forEach:function(e){return Ce(t).forEach(e)},immutableFacade:function(){return{get:function(e){var t=n[e];return t?new CN(t):t},values:function(){return pe(Wt(CN),Ce(n))}}}}},DN=function(e){var t=e.presence,n=e.presenceMapper,r=e.visibleTeamsObservable,i=e.onChange,o=qN(),s=[],a=r.subscribe((function(e){s=e,o.forEach((function(e){var t=n.updateVisibility(e,s),r=t.operator,i=t.isVisible;o=o.set({operator:r,isVisible:i})})),i(o.immutableFacade())}));t.list((function(e,t){return n.fromPresence(e,t,s)})).forEach((function(e){var t=e.operator,n=e.isVisible;o=o.set({operator:t,isVisible:n})})),i(o.immutableFacade()),t.onChange((function(e,t,r){if(r.metas.length>0){var a=n.fromPresence(e,r,s),u=a.operator,c=a.isVisible;o=o.set({operator:u,isVisible:c})}else o=o.omit(e);i(o.immutableFacade())}));return{stop:function(){return a.unsubscribe()}}},VN="salemove",FN=function(e){try{return JSON.parse(e.name)||{}}catch(e){return{}}},HN=function(e){return""===e.name},WN=function(e){return HN(e)||function(e){return FN(e).hasOwnProperty(VN)}(e)},GN=function(e){return Cr([VN,e])},BN=[void 0,null,"javascript:;",""],zN=!1,JN=function(e,t){if(t||(t=sm.conf.navigatable_hostnames),Gt(e,BN))return!0;var n=zN?t.engaged:t.available;return Te((function(t){return e.indexOf(t)>-1}))(n)},QN={isInEngagement:zN,setEngagedStatus:function(e){zN=e},extractLinkFromEvent:function(e){try{var t=e.target;return t&&(t=function(e,t){t=t.toUpperCase();do{if(e.nodeName===t)return e}while(e=e.parentNode);return null}(t,"a")),t}catch(e){return null}},isAllowedToNavigate:JN},YN=function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).isAllowed,t=void 0===e?JN:e;_T(document.querySelectorAll('a[target="_blank"]')).filter((function(e){return"javascript:void(0)"!==e.href})).filter((function(e){return t(e.hostname)})).forEach((function(e){return e.setAttribute("target","_self")}))},KN=["target","defaultPrevented","ctrlKey","shiftKey","metaKey","button"],XN=function(e){var t=e.getCurrentUrl,n=e.linkHandler,r=e.clicks,i=e.navigate,o={},s=function(e){var t=e.event,n=e.link;try{var r,s=n.href,a=null!==(r=o)&&void 0!==r&&r.accessToken?h(h({},o),{},{accessToken:"-pruned-"}):o;sm.logger.info("XDomainUrlStorage: adding params to URL",{params:a});var u=ZM(s,o,"__sm.");sm.logger.info("XDomainUrlStorage: navigating to modified URL",{original_url:WO(s),modified_url:WO(u)}),t.preventDefault(),i(u)}catch(e){sm.logger.error("XDomainUrlStorage: error trying to store values in URL",e)}},a=function(e){return"_blank"!==e.link.target},u=function(e){var t=e.link;return!Sr(t.href)&&!De(t.href)&&Gt(t.protocol,["http:","https:"])},c=function(e){var n=e.link;return!Gt(n.hostname,t())},l=function(e){var t=e.link;return n.isAllowedToNavigate(t.hostname)},f=function(e){var t=e.event;return!(t.ctrlKey||t.shiftKey||t.metaKey)},d=function(e){return 0===e.event.button},p=function(e){try{return KN.forEach((function(t){return e[t]})),!0}catch(e){return!1}},v=function(e){return!e.defaultPrevented},b=function(e){for(var t=e.target;t&&t.nodeName&&"a"!==t.nodeName.toLowerCase();)t=t.parentElement;return t};return{start:function(){return r.pipe(Gu((function(){return!Sr(o)})),Gu(p),Gu(v),Ka((function(e){return{event:e,link:b(e)}})),Gu(Do({link:ot(De)})),Gu(u),Gu(a),Gu(c),Gu(f),Gu(d),Gu(l)).subscribe(s,(function(e){return sm.logger.error("XDomainUrlStorage: error while filtering user click event",e)}),(function(){return sm.logger.error("XDomainUrlStorage: clicks observable was completed")}))},setItem:function(e,t){o=qe(e,t,o)},getItem:function(e){return sm.urlParams?sm.urlParams[e]:void 0}}},$N="sm.",ZN=function(){return{getItem:function(e){return window.localStorage.getItem($N+e)},setItem:function(e,t){return window.localStorage.setItem($N+e,t)},removeItem:function(e){return window.localStorage.removeItem($N+e)}}},eR=function(){var e,t,n=(e=window,{getItem:function(t){if(!HN(e))return Uo(GN(t),FN(e))},setItem:function(t,n){if(WN(e)){var r=FN(e),i=Yi(GN(t),n,r);e.name=JSON.stringify(i)}}}),r=(t=CO.Observable.merge(MT(document,"click"),MT(document,"mousedown")),new XN({getCurrentUrl:function(){return window.location.href},linkHandler:QN,clicks:t,navigate:function(e){window.location.href=e}}));sm.conf.visitor_api&&sm.conf.visitor_api.persist_visitor_session_in_url&&r.start();var i,o=new ZN,s=(i={prioritizedStorages:[n,r,o]}.prioritizedStorages,{getItem:function(e){return function(e,t){for(var n=0;n<e.length;n++){var r=e[n].getItem(t);if(null!=r)return r}}(i,e)},setItem:function(e,t){return i.forEach((function(n){return n.setItem(e,t)}))}});return{bestEffortXDomainStorage:s,windowNameStorage:n,xDomainUrlStorage:r,localStorage:o}},tR=function(e){var t=e.internalVisitorStateObservable,n=e.defaultQueues;return t.pipe(Ka((function(e){return function(e,t){var n,r,i=Ai({},["routing",sm.siteId,sm.tabId],e);if($n("queues",i))return i.queues.length>1&&null!==(n=sm.conf)&&void 0!==n&&null!==(r=n.omniq)&&void 0!==r&&r.disable_multi_queueing&&zO.warn("Multiple queues set when multi-queueing is disabled",{site_id:sm.siteId,queue_ids:i.queues}),{queue_ids:i.queues};if(t.length>0){var o,s,a=t.map((function(e){return e.id}));return t.length>1&&null!==(o=sm.conf)&&void 0!==o&&null!==(s=o.omniq)&&void 0!==s&&s.disable_multiple_default_queues&&zO.warn("Multiple default queues set when multi-queueing is disabled",{site_id:sm.siteId,queue_ids:a}),{queue_ids:a}}return{}}(e,n)})),Hf(At))},nR="sm.app.visitor_api.custom_code",rR=function(e){var t=e.stats,n=e.loadCustomCodeScript,r=sm.conf.customCodeFile?sm.conf.customCodeFile.url:void 0;return r?(n||(n=ts),new Promise((function(e,i){var o={integrity:Zo()?sm.conf.customCodeFile.sri:null,fileUrl:r,beforeLoad:function(){return e({ignored:!1})},onAttempt:function(){return t.increment(nR,["action:attempted"])},onLoad:function(){return t.increment(nR,["action:succeeded"])},onError:function(){return t.increment(nR,["action:warning"])},onGiveUp:function(){return t.increment(nR,["action:failed"]),sm.logger.warn(new Error("Failed to load custom code"),{custom_code_url:r})}};return n(o)}))):Promise.resolve({ignored:!0})},iR=function(e,t){return e.increment("sm.gva.assets.load",t)},oR=function(e){var t=e.stats,n=((sm.conf||{}).gva||{}).assets||{},r=sm.conf.visitor_api.load_gva_custom_renderer;return new Promise((function(e){return r&&n.js&&n.css?(n.js.forEach((function(e){return function(e,t){return ts({fileUrl:t,integrity:es({versionedName:t.split("/").pop()}),onLoad:function(){return iR(e,["action:succeeded","asset:js"])},onError:function(){return iR(e,["action:warning","asset:js"])},onAttempt:function(){return iR(e,["action:attempted","asset:js"])},onGiveUp:function(){return iR(e,["action:failed","asset:js"]),sm.logger.warn(new Error("Failed to load script file from sm.conf.gva.assets"),{asset_url:t})}})}(t,encodeURI(e))})),n.css.forEach((function(e){return function(e,t){return ns({fileUrl:t,integrity:es({versionedName:t.split("/").pop()}),onError:function(){return iR(e,["action:warning","asset:css"])},onAttempt:function(){return iR(e,["action:attempted","asset:css"])},onGiveUp:function(){return iR(e,["action:failed","asset:css"]),sm.logger.warn(new Error("Failed to load css file from sm.conf.gva.assets"),{asset_url:t})}})}(t,encodeURI(e))})),e({gvaAssetsRequested:!0})):e({gvaAssetsRequested:!1})}))};function sR(e,t){var n=t.targetWindow,r=t.logger,i="__sm.",o=n.location.search,s=n.location.href;try{var a=o.replace("?","").split("&").filter((function(e){return e.indexOf(i)>-1})),u=a.map((function(e){return e.split("=")})).map((function(e){var t=b(e,2),n=t[0],r=t[1];return{key:n.replace(i,""),value:r}})).map((function(e){var t=e.key,n=e.value;return{key:decodeURIComponent(t),value:decodeURIComponent(n)}})).reduce((function(e,t){var n=t.key,r=t.value;return e[n]=r,e}),{}),c=function(t){return Object.keys(e).filter((function(e){return Boolean(t[e])})).map((function(n){return{key:n,value:t[n],regex:e[n]}})).reduce((function(e,t){var n=t.key,i=t.value,o=t.regex;return i.match(o)?e[n]=i:r.error("URL query param does no satisfy provided regex",{param_key:n,param_value:i,regex:o}),e}),{})}(u),l=a.reduce((function(e,t){return e.replace("?".concat(t),"").replace("&".concat(t),"")}),s);if(l!==s){var f=null!=c&&c.accessToken?h(h({},c),{},{accessToken:"-pruned-"}):c;r.info("Found sm params in URL",{params:f,url_length:s.length}),(n.history?n.history.replaceState:void 0)&&(r.info("Replacing page URL",{original_url:WO(s),new_url:WO(l)}),n.history.replaceState(n.history.state,n.document.title,l))}return c}catch(e){return r.error("Error reading sm params from URL",e),{}}}function aR(e,t){var n,r=t.salemovePresentInParent,i=function(){var t={url:e.location.href,page_title:e.title};if(r)return window.parent.postMessage(JSON.stringify({"sm-xdr-url":t.url}),"*")};this.start=function(){return n=sm.hrefObservable.subscribe(i,(function(e){return zO.error("sm.hrefObservable failed",e)}))},this.stop=function(){n&&n.unsubscribe()}}var uR=function(e){return _e(Hr(ge("activity_at")),e[0],e)},cR=function(e,t){return t?!e||e.activity_at<t.activity_at?t:e:(zO.warn("New active tab is not defined",{new_active_tab:t}),e)};function lR(e,t,n){var r=this,i=t.salemovePresentInParent,o=t.renewFrequency,s=t.visitorPresenceChannel,a=t.tabId,u=void 0===a?sm.tabId:a;this.onStart=n;var c,l=1e3*o,f=CO.Observable.timer(1e4).mapTo({tab_id:u,page_url:location.href}).do((function(){return zO.warn("Defaulting active tab to true, multi-tab cobrowsing can misbehave")})),d=s.getSameVisitorConnections().filter(ot(Sr)),p=d.map(uR).scan(cR).merge(f.takeUntil(d)).publishReplay(1),h=p.combineLatest(ZI.asObservable()).map((function(e){var t=b(e,2),n=t[0],r=t[1];return n.tab_id===u||r.has(n.tab_id)})).distinctUntilChanged(At),v=new aR(e,{salemovePresentInParent:i}),m=fA(),g=h.switchMap((function(e){var t=e?l:1500;return m.throttleTime(t)})).map((function(e){return{value:e,timestamp:Date.now()}})).share(),y=function(){return s.getPresenceObservable().take(1).switchMap((function(e){return p.take(1).map((function(t){return{presence:e,activeTab:t}}))})).subscribe((function(t){var n=t.presence,r=t.activeTab,i={page_description:e.title};return r.tab_id!==u&&(i.set_active_tab=!0,i.page_url=location.href),r.tab_id===u&&r.page_url!==location.href&&(i.page_url=location.href),n.channel.push("activity",i,5e3).receive("error",(function(e){return zO.warn("Unable to send activity update to presence",e)})).receive("timeout",(function(){}))}),(function(e){return zO.warn("Unable to send activity update to presence",{error:e})}))},_=function(){if(!r.started){r.started=!0,zO.info("Starting activity tracker"),v.start(),g.skip(1).subscribe((function(){return y()}),(function(e){return zO.error("userActivityObservable failed",e)}));var e,t=new CO.Subscription([p.connect(),(e=v,new CO.Subscription((function(){return e.stop()})))]);r.onStart(t)}};this.requestStart=function(){s.requestJoin(),s.getPresenceObservable().take(1).subscribe((function(){return _()}))},this.requestStartWhenSpaceAvailable=function(){s.requestJoinAllowRejection(),s.getPresenceObservable().take(1).subscribe((function(){return _()}))},this.getUserIsActiveTabObservable=function(){return r.requestStart(),h},this.avoidGoingIdle=function(){r.requestStart(),c&&clearInterval(c),c=setInterval((function(){return y()}),5e3)}}lR.NavigationUpdater=aR;var fR,dR,pR=function(){},hR=ji("site_id",sm.siteId),vR=dt(Te(ji("id",sm.siteId)),Ui([],"transferrable_sites")),bR=dt(ve(0),Lt(In(hR,vR)),Ai([],["engagement","engagements"])),mR=dt(ve(0),Lt((function(e){return!e.outcome})),Lt(hR),Ai([],["engagement","requests"])),gR=dt(ve(0),Lt(ji("site_id",sm.siteId)),Ai([],["engagement","observations"])),yR=function(e){var t=e.visitor;if(t)return{name:t.name,email:t.email}},_R=function(e){var t=e.operator,n=pe(ge("name"),t.teams);return{id:t.id,teamNames:n}},wR=function(e){var t,n,r;return(t=bR(e))?{interaction:"engagement",channelUrl:t.channel_url,operator:_R(t),visitor:yR(t),engagement:t}:(n=mR(e))?{interaction:"engagement",channelUrl:n.channel_url,operator:_R(n),visitor:yR(n)}:(r=gR(e))?{interaction:"observation",channelUrl:r.channel_url,operator:_R(r),visitor:yR(r)}:{}},ER=function(e){var t=b(e,2),n=t[0],r=t[1],i=n.operator?n.operator.id:void 0,o=n.channelUrl,s=r.channelUrl;if(i&&o&&o!==s){var a=hM(i);if(a)return a.then((function(e){return e.destroy()}),pR)}},OR=function(e){var t,n,r,i=e.internalVisitorStateObservable,o=e.getAccessToken,s=e.stats,a=e.visitorPresenceChannel,u=e.salemovePresentInParent;if(sm.trackerSubscription=new CO.Subscription,sm.tracker=t=new lR(document,{renewFrequency:(n=sm.conf.engagement.visitor_time_to_inactive_sec,r=sm.conf.engagement.renew_freq_muliplier||.8,Math.max(10,Math.round(n*r))),salemovePresentInParent:u,visitorPresenceChannel:a},(function(e){return sm.trackerSubscription.add(e)})),sm.conf.visitor_api.visitor_presence_join_limited){var c=Ai([],["engagement","observations"]),l=Ai([],["engagement","requests"]),f=Ai([],["engagement","engagements"]),d=Ai([],["omniq","queue_tickets"]),p=function(e){return c(e).length>0||l(e).length>0||f(e).length>0||d(e).length>0};i.filter(p).take(1).subscribe((function(){return t.requestStart()})),i.take(1).filter(ot(p)).subscribe((function(){return t.requestStartWhenSpaceAvailable()}))}else t.requestStart();var h,v=(h={internalVisitorStateObservable:i},h.internalVisitorStateObservable.pipe(Ka(wR),Hf(At)).pipe(vp({}),Zl(2,1),Ap(ER),Ka((function(e){var t=b(e,2);return t[0],t[1]})),vp({}))).publishReplay(1);v.subscribe((function(e){QN.setEngagedStatus("engagement"===e.interaction)}));var m=function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:UO();return e.pipe(Hf(null,(function(e){return e.channelUrl})),mp((function(e){return i.pipe(Ka((function(){return e})))})),Ap(null,zO.warn.bind(zO,"Failed to setup channel observable")),Gu((function(e){return Boolean(e.interaction)})),mp((function(e){return t.getUserIsActiveTabObservable().pipe(Yf(1),Ka((function(t){return{status:e,isActiveTab:t}})))})),mp((function(e){var t=e.status,i=e.isActiveTab;return bM({channelUrl:t.channelUrl,operatorId:t.operator.id,isActiveTab:i,getAccessToken:n,stats:r}).pipe(hf((function(){return CO.Observable.empty()})),Ka((function(e){return{channel:e,operator:t.operator}})))})),np())}(v,t,o,s).publishReplay(1);return sm.channelSubscription=m.connect(),v.connect(),{statusObservable:v,channelObservable:m.filter((function(e){var t=e.channel,n=e.operator;return!t.isStopped()||(zO.warn("Filtering out stopped channel in channelObservable",{channelUrl:t.url,operator:n,siteId:sm.siteId}),!1)})),tracker:t}},SR={get:function(e){return e.checked},set:function(e,t){e.checked=t}},TR={select:{get:function(e){return dt(zn,pe((function(e){return[e.index,e.selected]})))(e.options)},set:function(e,t){Gn((function(e){e.selected=t[e.index]}))(e.options)}},option:{get:function(e){return e.selected},set:function(e,t){e.selected=t}},radio:SR,checkbox:SR,default:{get:function(e){return e.value},set:function(e,t){if("function"==typeof Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(e,"value")&&Object.getOwnPropertyDescriptor(e,"value").set)try{return Object.getOwnPropertyDescriptor(e.constructor.prototype,"value").set.call(e,t)}catch(n){e.value=t}else e.value=t}}},AR=function(e){var t=TR[e.type]||TR[e.nodeName&&e.nodeName.toLowerCase()]||TR.default,n=t.get,r=t.set;return{get:function(){return n(e)},set:function(t){r(e,t)}}},IR="sm_engagement_serialized_inputs",kR=function(e,t){return dt(Gn((function(t){var n=t.destInput,r=t.value;return t.hook.set(r),function(e,t){var n=e.createEvent("HTMLEvents");return n.initEvent("change",!0,!1),t.dispatchEvent(n)}(e,n)})),Lt((function(e){var t=e.hook,n=e.value;return!At(t.get(),n)})),pe((function(e){var t=e.destInput;return{destInput:t,value:e.value,hook:AR(t)}})),Lt((function(e){var t=e.destInput;return Boolean(t)})),pe((function(t){var n=t.value,r=t.xpath;return{value:n,destInput:IT(e,r)}})))(t)},xR=function(e){var t=dt((function(e){return Array.prototype.slice.call(e)}),(function(t){return e.getElementsByTagName(t)})),n=Xe(t,["INPUT","TEXTAREA","SELECT","PASSWORD","CHECKBOX","RADIO"]);return pe((function(e){return{value:AR(e).get(),xpath:ST(e)}}),n)},MR=[tr(me(["state","available"]),Ee(1),Ee(0)),dt(Mr,me(["state","media"]))],NR=_e(Hr((function(e){return Ie(MR,[e])})),null),RR=function(e){return sm.conf.api_url+e},CR=function(e){return function(e){return e.pipe(Gu(ji("connected",!1)))}(e).pipe(mp((function(){return e.pipe(Gu(ji("connected",!0)),Yf(1))})))},PR=function(e,t,n){t||(t=MI);var r=FO()?"/messaging/chat_transcript?_=".concat(Date.now()):"/engagements/".concat(e,"/chat_transcript?_=").concat(Date.now());return t({url:RR(r)}).pipe(Ka(ge("response")),rp(),hf((function(t){return zO.warn("Failed to fetch chat history",{error:t,engagement_id:e}),nT.of([])})))},jR=function(e){var t=e.engagementId,n=e.connectionStatusObservable,r=e.requestAsObservable;return CR(n).pipe(Mu((function(){return PR(t,r)})),np())},LR=CO.Observable.throw(new rI({cause:BA.SALEMOVE.INTERNAL_ERROR})).pipe(Ap(null,(function(){return zO.warn("Operators observable timed out!")}))),UR=function(e,t){t||(t=[]);return e.increment("engagement.flow",["entrypoint:reactive-request"].concat(t))},qR=function(e,t,n,r){r||(r=CO.Scheduler.asap);var i=t||{},o=i.operatorId,s=i.phoneNumber,a=i.phoneExtension,u=i.source,c=i.oneWay,l=i.siteId;l||(l=sm.siteId);var f=n.api,d=n.operatorsObservable,p=n.serverResponseTimeout,h=n.engagementCoreObservable,v=n.mediaValidation,m=n.statsClient;zO.info("Engagement: Reactive request initiated",{media:e,options:t});var g=o?jn(ji("id",o)):NR,y=d.pipe(Cp(p,LR,r),Ka(g),Mu((function(e){return e?CO.Observable.of(e):CO.Observable.throw(new rI({cause:BA.SALEMOVE.OPERATOR_UNAVAILABLE}))})));return CO.Observable.combineLatest(y,h).pipe(Mu((function(n){return function(n){var i=n.state.medias,o=n.state.oneWayMedias,s=v({media:e,options:t,availableMediaTypes:i,availableOneWayMediaTypes:o});return(s instanceof CO.Observable?s:CO.Observable.from(s,r)).pipe(Ka(Ee(n)))}(b(n,1)[0])})),Mu((function(t){var n={phoneNumber:s,phoneExtension:a,oneWay:c};return UR(m,["action:reach","stage:create-request"]),f.create({operatorId:t.id,siteId:l,media:e,source:u,mediaOptions:n}).pipe(Ka((function(r){return Jr(r,{operator:t,media:e,mediaOptions:n})})))})))},DR=function(e,t){t||(t=CO.Scheduler.asap);var n=e.media,r=e.mediaOptions,i=e.mediaValidation,o=e.api,s=e.notifyOfTimeout,a=e.operatorsObservable,u=e.engagementCoreObservable,c=e.channelObservable,l=e.serverResponseTimeout,f=e.communicationLib,d=e.engagementApi,p=e.webRtcMode,h=e.enabledMediaLevel,v=e.statsClient,b=qR(n,r,{api:o,operatorsObservable:a,serverResponseTimeout:l,engagementCoreObservable:u,mediaValidation:i,statsClient:v},t).pipe(Ud()),m=b.connect();UR(v,["action:begin"]);var g=b.pipe(Mu((function(e){var n=e.engagementRequestId,r=e.acknowledgeTimeoutSeconds,i=e.operator;return UR(v,["action:reach","stage:requested"]),o.acceptedObservable.pipe(Cp(1e3*r+l,function(e,t){return CO.Observable.throw(new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT})).pipe(Ap(null,(function(){return zO.warn("Engagement request timed out! Some internal listener must be missing.")})),Ap(null,(function(){return e.notifyOfReactiveFailure({id:t})})))}(o,n),t),Td(PT(function(e){return CO.Observable.merge(o.declinedObservable.pipe(Ka(Ee(new rI({cause:BA.SALEMOVE.OPERATOR_DECLINED})))),o.timedOutObservable.pipe(Ap((function(){return s({operator:e})})),Ka(Ee(new rI({cause:BA.SALEMOVE.TIMEOUT})))))}(i))),Yf(1),sd((function(){return m.unsubscribe()})))})),Ap(null,tr(ji("cause",BA.SALEMOVE.INTERNAL_ERROR),zO.warn.bind(zO,"Engagement: Reactive request failed"),zO.info.bind(zO,"Engagement: Reactive request failed"))),Ap(null,(function(e){return UR(v,["action:end"].concat(function(e){return e&&e.cause===BA.SALEMOVE.OPERATOR_UNAVAILABLE?["stage:pre-request","expected:true","reason:target-unavailable"]:e&&e.cause===BA.SALEMOVE.INVALID_INPUT?["stage:pre-request","reason:invalid-input"]:e&&e.cause===BA.SALEMOVE.INTERNAL_ERROR?["stage:create-request","reason:internal-error"]:e&&e.cause===BA.SALEMOVE.TIMEOUT?["stage:requested","expected:true","reason:accept-timeout"]:e&&e.cause===BA.SALEMOVE.OPERATOR_DECLINED?["stage:requested","expected:true","reason:decline"]:e&&e.cause===BA.SALEMOVE.NETWORK_TIMEOUT?["stage:create-request","reason:network-error"]:["stage:pre-request","reason:script-load-error"]}(e)))})),Ka((function(e){var t,r,i,o,s,a,u,l,v;r=e.engagementId,v=e.subEngagementId,n=e.media,o=e.operatorId,a=e.operatorName,u=e.operatorFormattedName,l=e.operatorPicture,s=e.operatorMediaType,i=e.entrypoint,t=e.createdAt;var b=LN({id:o,name:a,formattedName:u,picture:l,mediaType:s,webRtcMode:p,enabledMediaType:h});return zO.info("Engagement: Reactive request accepted",{engagementId:r,subEngagementId:v,operator:b}),{engagementId:r,subEngagementId:v,startingMedia:n,type:"reactive",isReestablishing:!1,initialChatHistoryObservable:PR(r),operator:b,communicationLib:f,channelObservable:c,engagementApi:d,entrypoint:i,createdAt:t}})),Yf(1));return{requestObservable:b,resultObservable:g}},VR={},FR={};function HR(){return dR||(dR=1,e=VR,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(fR)return FR;fR=1,Object.defineProperty(FR,"__esModule",{value:!0});var e=sc;return FR.Subscription=e.Subscription,FR}())),VR;var e}var WR=HR(),GR=s((function e(t){var n=t.id,r=t.content,o=t.status,s=t.attachment,a=t.created_at;if(i(this,e),this.id=n,this.content=r,this.sender="visitor",this.sender_details={type:"visitor"},this.status=null,this.attachment=s,this.created_at=a,o){if(!jn(At(o),Ce(this.STATUSES)))throw new rI({cause:BA.SALEMOVE.INTERNAL_ERROR,message:"Unknown status ".concat(o)});this.status=o}})),BR=ji("sender","visitor");GR.prototype.STATUSES={SENDING:"sending",DELIVERED:"delivered",FAILED:"failed"},GR.prototype.ATTACHMENT_RESPONSE_TYPES={SINGLE_CHOICE_RESPONSE:"single_choice_response",FILES:"files"};var zR=s((function e(t){var n=t.id,r=t.content,o=t.attachment,s=t.metadata,a=t.created_at,u=t.sender,c=void 0===u?{}:u;i(this,e),this.id=n,this.content=r,this.sender="operator",this.sender_details={type:"operator",name:c.name,picture:c.picture?c.picture.url:"",id:c.id},this.attachment=o,this.metadata=s,this.created_at=a}));zR.prototype.ATTACHMENT_TYPES={SINGLE_CHOICE:"single_choice",FILES:"files"};var JR=s((function e(t){var n=t.id,r=t.content,o=t.attachment,s=t.metadata,a=t.created_at;i(this,e),this.id=n,this.content=r,this.sender="system",this.sender_details={type:"system"},this.attachment=o,this.metadata=s,this.created_at=a}));JR.prototype.ATTACHMENT_TYPES={SINGLE_CHOICE:"single_choice",FILES:"files"};var QR=sm.conf.visitor_app_option,YR=function(e,t){return e===t},KR={VISITOR:"visitor",OPERATOR:"operator",SYSTEM:"system"},XR={PUBSUB:oA(),TRANSCRIPT:oA()},$R=oA(),ZR=function(e,t){var n=tn(Rn("id"),e,t);return 0===n.length?t:Vt(n,t)},eC=function(e,t,n){var r=e.pipe(Td(t),Mc((function(e,t){var n=Un(ji("id",t.id),e);return-1!==n?on(n,t,e):Ni(t,e)}),[]),vp([]));return OS.combineLatest(r,n,ZR).pipe(Hf(YR))},tC=function(e){var t=e.sender.type;return t===KR.VISITOR?new GR(e):t===KR.OPERATOR?new zR(e):t===KR.SYSTEM?new JR(e):void 0},nC=function(e){var t=e.sender.type;return tC(h(h({},e),{},u(t===KR.VISITOR?{content:e.message,status:GR.prototype.STATUSES.DELIVERED}:{content:e.message},$R,XR.TRANSCRIPT)))},rC=function(e){return pe(nC,e).reverse()},iC=function(e){var t=e.chatHistoryObservable,n=e.ownMessages,r=e.otherMessages,i=e.statsClient,o=e.fetchExtraOperatorInfo,s=n.pipe(Ka((function(e){var t=e.id,n=e.content,r=e.attachment;return new GR({id:t,content:n,attachment:r,status:null})}))),a=n.pipe(Mu((function(e){var t=e.id,n=e.content,r=e.status,i=e.attachment;return r.pipe(Ka((function(e){return new GR({id:t,content:n,attachment:i,status:e})})))}))),u=r.pipe(Df(ge("id")),Mu((function(e){var t=me(["sender","type"],e);if(t===KR.OPERATOR){var n=e.sender.id;return o(n).pipe(Ka((function(t){return Cn({sender:Jr(t)})(e)})))}return t===KR.SYSTEM?nT.of(e):(zO.warn("Received other chat message of unknown sender origin",{id:e.id,sender_type:t}),$S.empty())})),Ka(tC)),c=t.pipe(Ka(rC)),l=eC(a,u,c).pipe(Ap((function(){i.increment("sm.app.visitor_api.chat.messages",["action:emitted","visitor_app:".concat(QR)])})));return{messages:eC(s,u,c),messagesWithStatusUpdates:l}},oC=s((function e(t){var n=t.typing;i(this,e),this.typing=n})),sC="visitor";function aC(e){this.recordChatMessageSent=function(t){1===t?e.increment("sm.".concat(sC,".communication.chat.message.sent")):e.increment("sm.".concat(sC,".communication.chat.message.retry"))},this.recordChatMessageDeliveryFailed=function(t){e.increment("sm.".concat(sC,".communication.chat.message.delivery_failed"),t)},this.recordChatMessageDelivered=function(){e.increment("sm.".concat(sC,".communication.chat.message.delivered"))}}var uC,cC,lC={},fC={};function dC(){return cC||(cC=1,e=lC,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(uC)return fC;uC=1,Object.defineProperty(fC,"__esModule",{value:!0});var e=sc;return fC.ReplaySubject=e.ReplaySubject,fC}())),lC;var e}var pC,hC,vC=dC(),bC={},mC={};function gC(){return hC||(hC=1,e=bC,Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(function(){if(pC)return mC;pC=1,Object.defineProperty(mC,"__esModule",{value:!0});var e=sc;return mC.defer=e.defer,mC}())),bC;var e}var yC=gC(),_C={SENDING:"sending",DELIVERED:"delivered",FAILED:"failed"},wC="Chat",EC=function(){function e(t){var n=t.chatApi,r=t.messagesToSend,o=t.previewToSend,s=t.deliveryTimeout,a=void 0===s?sm.conf.chat_message_send_timeout_ms||15e3:s,u=t.history,c=t.guid,l=void 0===c?oA:c,f=t.stats,d=t.logger;i(this,e),this._chatApi=n,this._previewToSend=o,this._history=u,this._generateGuid=l,this._messagesToSend=r,this._deliveryTimeout=a,this.stats=f,this.logger=d,this._messengerStoppedSubject=new jS.Subject,this._sentMessages=new jS.Subject,this._deliveryEvents=this._chatEvents("deliveredMessages"),this._receivedMessageIds=[],this._subscription=new WR.Subscription,this._undeliveredMessageIds=new Set,this._markMessageAsDeliveredAsObservable=this._markMessageAsDeliveredAsObservable.bind(this)}return s(e,[{key:"start",value:function(){var e=this;this._subscription.add(this._messagesToSend.subscribe(this._sendMessage.bind(this),(function(t){return e.logger.error("_messagesToSend failed ",t)}))),this._subscription.add(this._previewToSend.subscribe((function(t){return e._chatApi.sendPreview({content:t})}),(function(t){return e.logger.error("_previewToSend failed ",t)}))),this._subscription.add(this._messagesReceivedFromHistory().subscribe(this._acceptReceivedMessage("history"),(function(t){return e.logger.warn("".concat(wC,": Failed to fetch chat history"),t)}))),this._subscription.add(iA().subscribe((function(t){t.visible&&Array.from(e._undeliveredMessageIds).forEach((function(t){e._markMessageAsDeliveredAsObservable(t).subscribe((function(){e._undeliveredMessageIds.delete(t),e.logger.info("".concat(wC,": Marked message as delivered upon tab focus"),{messageId:t})}),(function(n){e.logger.error("".concat(wC,": Failed to mark message as delivered"),{error:n,messageId:t,glia_team:"messenger"})}))}))})))}},{key:"stop",value:function(){this._chatApi.stop(),this._messengerStoppedSubject.next(),this._subscription.unsubscribe()}},{key:"observables",value:function(){return{ownMessages:this._sentMessages.pipe(Td(this._receivedVisitorMessages())),otherMessages:this._receivedOtherMessages(),operatorTypingIndicator:this._chatApi.operatorTypingIndicator}}},{key:"_markMessageAsDeliveredAsObservable",value:function(e){var t=this;return new mS.Observable((function(n){t._chatApi.markMessageAsDelivered(e,(function(){n.next(),n.complete()}),(function(e){n.error(e)}))}))}},{key:"_chatEvents",value:function(e){return this._chatApi[e].pipe(wp(this._messengerStoppedSubject))}},{key:"_receivedVisitorMessages",value:function(){return this._chatEvents("receivedVisitorMessages").pipe(Ka(Jr({status:nT.of(_C.DELIVERED)})))}},{key:"_sendMessageAndWaitForAcknowledgement",value:function(e){var t=this,n=e.message,r=this._deliveryEvents.pipe(Gu((function(e){return At(n.id,e.id)})),Yf(1),np()),i=r.subscribe(Ee);return this._chatApi.sendMessage(n).pipe(_p(r.pipe(yd(_C.DELIVERED),Cp(this._deliveryTimeout,yC.defer((function(){return t.stats.recordChatMessageDeliveryFailed(["expected:true","reason:acknowledgement_timeout"]),SI._throw("".concat(wC,": Message timed out before being delivered to other participant"))}))))),hf((function(e){return t.logger.info("".concat(wC,": Message delivery failed with error"),{error:e,message_id:n.id}),nT.of(_C.FAILED)})),Yf(1),sd(i.unsubscribe))}},{key:"_sendMessage",value:function(e){var t,n,r,i,o,s,a=this,u=(t=e,n=this._generateGuid,r=t.content,i=t.options,o=i?i.attachment:void 0,s=i?i.metadata:void 0,{id:n(),content:r,attachment:o,metadata:s}),c=new vC.ReplaySubject(1).distinctUntilChanged();return c.next(_C.SENDING),this._sentMessages.next(Jr(u,{status:c})),this._addToReceived(u),this._subscription.add(this._sendMessageAndWaitForAcknowledgement({message:u}).subscribe((function(e){e===_C.DELIVERED&&(c.complete(),a.stats.recordChatMessageDelivered(),a.logger.info("".concat(wC,": Message delivered to other participant"),{message_id:u.id})),e===_C.FAILED&&c.next(_C.FAILED)}),(function(e){return a.logger.error("_sendMessageAndWaitForAcknowledgement failed",e)})))}},{key:"_acceptReceivedMessage",value:function(e){var t=this;return function(n){t.logger.info("".concat(wC,": Message received"),{message_id:n.id,source:e}),t._addToReceived(n),Ti(["sender","type"],"visitor",n)||n.delivered_at||(document.hidden?(t._undeliveredMessageIds.add(n.id),t.logger.info("".concat(wC,": Message not marked as delivered, tab is not in focus"),{message_id:n.id,source:e})):t._chatApi.markMessageAsDelivered(n.id))}}},{key:"_receivedOtherMessages",value:function(){var e=this;return this._chatEvents("receivedOtherMessages").pipe(Gu((function(t){return e._messageNotReceived(t)})),Mu((function(t){return nT.of(t).pipe(Ap(e._acceptReceivedMessage("participant")),hf((function(){return nT.of(t)})))})),np())}},{key:"_messagesReceivedFromHistory",value:function(){var e=this;return this._history.pipe(Gu((function(t){return e._messageNotReceived(t)})),Mu((function(e){return xS.from(e)})))}},{key:"_messageNotReceived",value:function(e){return!Gt(e.id,this._receivedMessageIds)}},{key:"_addToReceived",value:function(e){this._receivedMessageIds=Ne(e.id,this._receivedMessageIds)}}]),e}();EC.STATUSES=_C;var OC=e.visitor_api.own_typing_duration||5e3;var SC="engagement.chat.message",TC="engagement.chat.system_message",AC="engagement.chat.message_status",IC="engagement.chat.typing_indicator.operator",kC="engagement:chat_message:preview_update",xC="Chat",MC={retryLimit:5,initialDelay:1e3,maxDelay:void 0,factor:1.5},NC=function(e){return 0===e||421===e||429===e||e>=500},RC=function(){},CC=qi((function(e){return e===SC||e===TC}),"event_type"),PC=ji("event_type",AC),jC=function(e){var t=Ti(["message","engagement_id"],e);return we([CC,t])},LC=function(e){var t,n,r=e.engagementId,i=e.visitorId,o=e.logger,s=e.stats,a=e.channelObservable,u=e.xhrWithRetry,c=void 0===u?NI:u,l=e.getRequestHeaders,f=e.siteVisitorNotifications,d=new jS.Subject,p=function(e){return e.attachment?{content:e.content,attachment:e.attachment}:{content:e.content}},h=(t=d.map(ge("content")),t.pipe(mp((function(e){return""===e?RO.Observable.of(!1):RO.Observable.merge(RO.Observable.of(!0),RO.Observable.timer(OC,n).map((function(){return!1})))})),xp(50,n,{leading:!0,trailing:!0}),Hf())).subscribe((function(e){xI({method:"PUT",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/typing_indicator"),payload:JSON.stringify({typing:e}),responseType:"json",getRequestHeaders:function(){return Jr(l?l():{},{"Content-Type":"application/json"})},onSuccess:RC,onError:function(){return o.warn("Could not set typing indicator")}})})),v=d.startWith({content:""}).combineLatest(a).subscribe((function(e){var t=b(e,2),n=t[0];t[1].emit(kC,{engagement_id:r,content:n.content,visitor_id:i})}),o.error.bind(o,"".concat(xC,": Error sending chat preview"))),m=dt(Jr({type:"user"}),ki(["id","engagement_id","content","attachment","metadata","sender"]),ge("message")),g=dt(ki(["id","engagement_id"]),ge("message")),y=Ti(["message","engagement_id"],r),_=Ti(["message","sender","type"],"visitor"),w=Ti(["message","status"],"delivered"),E=f.pipe(Gu(jC(r))),O=E.pipe(Gu(ot(_)),Ka(m)),S=E.pipe(Gu(_),Ka(m)),T=f.pipe(Gu(we([PC,y,w])),Ka(g)),A=ji("event_type",IC),I=Ti(["typing_indicator","engagement_id"],r);return{stop:function(){v.unsubscribe(),h.unsubscribe()},sendMessage:function(e){var t=e.id;return mS.Observable.create((function(n){var i=0;c({method:"PUT",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/chat_messages/").concat(t),payload:JSON.stringify(p(e)),responseType:"json",contentType:"application/json",getRequestHeaders:l,calculateAttemptDelay:Ko(MC.initialDelay,MC.maxDelay,MC.factor),retryLimit:MC.retryLimit,onSuccess:function(t){o.info("".concat(xC,": Message sent to system, waiting for it to be delivered to other participant"),{message_id:e.id}),n.next(t),n.complete()},onError:function(e){var r=e.status,i=e.statusText,a=e.response,u="".concat(xC,": Failed to send message to system");o.warn(u,{message_id:t,status:r,status_text:i,response_body:JSON.stringify(a)});var c="unknown";0===e.status&&4===e.readyState&&null===a?c="network_timeout":401===e.status&&"Expired token"===(null==a?void 0:a.message)?c="token_expired":422===e.status&&"'engagement_id' has ended"===(null==a?void 0:a.message)?c="engagement_ended":422===e.status&&"'attachment.selected_option' must be filled"===(null==a?void 0:a.message)?c="response_card_misconfiguration":422===e.status&&"'content' size cannot be greater than 10000"===(null==a?void 0:a.message)?c="validation_error":409===e.status&&(c="conflict_on_message_creation");var l="unknown"!==c;s.recordChatMessageDeliveryFailed(["expected:".concat(l),"reason:".concat(c)]),n.error(u)},onAttempt:function(){++i>1&&o.info("Chat: Send message request failed, retrying",{message_id:t,attempt:i}),s.recordChatMessageSent(i)},shouldRetry:NC})})).pipe(Yf(1))},sendPreview:function(e){return d.next(e)},markMessageAsDelivered:function(e,t,n){c({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/chat_messages/").concat(e),payload:JSON.stringify({status:"delivered"}),responseType:"json",contentType:"application/json",getRequestHeaders:l,calculateAttemptDelay:Ko(MC.initialDelay,MC.maxDelay,MC.factor),retryLimit:MC.retryLimit,onSuccess:function(){o.info("".concat(xC,": Marked message as delivered"),{message_id:e}),"function"==typeof t&&t()},onError:function(t){var r=t.status,i=t.statusText;o.warn("".concat(xC,": Failed to mark message as delivered"),{message_id:e,status:r,status_text:i}),"function"==typeof n&&n()},shouldRetry:NC})},receivedOtherMessages:O,receivedVisitorMessages:S,deliveredMessages:T,operatorTypingIndicator:f.pipe(Gu(we([A,I])),Ka(ge("typing_indicator")),Mc((function(e,t){return t.clock>e.clock?t:e})),Ka(ki(["typing"])),Hf(At))}},UC="a-zA-Z0-9:$€£¢",qC=function(e,t){for(var n,r=[];n=t.exec(e);)r.push(n[1]);return r},DC=function(e,t,n){return t&&Gn((function(t){e=e.replace(t,n)}),t),e},VC=function(e){var t=!0;return e.split("").reduceRight((function(e,n){return n=parseInt(n,10),(t=!t)&&(n*=2),n>9&&(n-=9),e+n}),0)%10==0},FC=dt((function(e){var t=e.message;if(e.piiMaskingDisabledFields.includes("ssn"))return t;var n=new RegExp(/(?:^|\D)(\d{3}(-| )\d{2}(-| )\d{4})(?=\D|$)/g),r=qC(t,n);return DC(t,r,"***Social Security Number Not Allowed***")}),(function(e){var t=e.message,n=e.piiMaskingDisabledFields;if(n.includes("ccn"))return{message:t,piiMaskingDisabledFields:n};var r=new RegExp("(\\d{".concat(12,",})"),"g"),i=qC(function(e){var t=new RegExp("([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12})|([^(".concat(UC,")])"),"gm");return e.replace(t,"$1")}(t),r),o=Lt(VC,i).map((function(e){return new RegExp(e.split("").join("[^(".concat(UC,")]*?")))}));return{message:DC(t,o,"***Credit Card Number Not Allowed***"),piiMaskingDisabledFields:n}}),(function(e,t,n){var r=t.reduce((function(e,t){try{var n=new RegExp(t,"g"),r=e.replace(n,(function(e){return"*".repeat(e.length)}));return r}catch(t){return e}}),e);return{message:r,piiMaskingDisabledFields:n}})),HC=function(){var e,t,n=null===(e=sm)||void 0===e||null===(t=e.conf)||void 0===t?void 0:t.privacy_security.disable_glia_pii_masking;return n?n.split(","):[]}(),WC=function(e){return e.replace(/[0-9]/g,"*")},GC=function(){function e(t){var n=t.channelObservable,r=t.historyObservable,o=t.getRequestHeaders,s=t.logger,a=t.statsClient,u=t.engagementId,c=t.visitorId,l=t.siteVisitorNotifications,f=t.maskingRegularExpressions;i(this,e);var d=new aC(a);this._messagesToSend=new jS.Subject,this._previewToSend=new jS.Subject,this.chatApi=new LC({engagementId:u,visitorId:c,logger:s,stats:d,channelObservable:n,getRequestHeaders:o,siteVisitorNotifications:l}),this.messenger=new EC({chatApi:this.chatApi,stats:d,logger:s,messagesToSend:this._messagesToSend.pipe(Ka((function(e){return function(e,t,n){var r=e.content,i=e.options;return{content:FC(r,t,n),options:i}}(e,f,HC)}))),previewToSend:this._previewToSend.pipe(Ka(WC)),history:r}),this.messenger.start()}return s(e,[{key:"sendMessage",value:function(e,t){this._messagesToSend.next({content:e,options:t})}},{key:"sendMessagePreview",value:function(e){this._previewToSend.next(e)}},{key:"stop",value:function(){this.messenger.stop()}},{key:"observables",value:function(){return this.messenger.observables()}}]),e}(),BC=function(){function e(t){var n=t.chatHistoryObservable,r=t.engagementEndObservable,o=t.observeChatMessages,s=t.statsClient,a=t.chatController,u=t.fetchExtraOperatorInfo;i(this,e);var c=new WR.Subscription,l=FI(),f=a.observables(),d=f.otherMessages,p=f.ownMessages,h=f.operatorTypingIndicator,v=o({chatHistoryObservable:n,otherMessages:d,ownMessages:p,statsClient:s,fetchExtraOperatorInfo:u}),b=v.messages.pipe(Ud(1)),m=v.messagesWithStatusUpdates.pipe(Ud(1));c.add(b.connect()),c.add(m.connect());var g=h.pipe(Ka(Wt(oC)),vp(new oC({typing:!1})),Ud(1));c.add(g.connect());var y=function(){l.stop(),c.unsubscribe()},_=zn([[this.EVENTS.MESSAGES,b],[this.EVENTS.MESSAGES_WITH_STATUS_UPDATES,m],[this.EVENTS.OPERATOR_TYPING_STATUS_UPDATE,g]]);l.proxyAll(_),this.addEventListener=l.addEventListener,this.removeEventListener=l.removeEventListener,this.observable=function(e){return _[e]},this.sendMessage=function(e,t){a.sendMessage(e,t),a.sendMessagePreview("")},this.sendMessagePreview=function(e){a.sendMessagePreview(e)},r.subscribe((function(){}),y,y)}return s(e,null,[{key:"create",value:function(t){var n=t.chatHistoryObservable,r=t.engagementEndObservable,i=t.statsClient,o=t.engagementId,s=t.getRequestHeaders,a=t.siteVisitorNotifications,u=t.maskingRegularExpressions,c=iS.vent.observable(iS.MSG.PUBLIC.ENGAGEMENT_START),l=mS.Observable.defer((function(){return iS.request("get:engagement_observables").engagementObservable})),f=function(e){var t=e.getRequestHeaders,n=e.xhrWithRetry,r=void 0===n?NI:n,i=e.takeUntilNotifier,o={},s={},a=i||new CO.Subject;return function(e){return o[e]?nT.of(o[e]):mS.Observable.create((function(n){if(s[e])s[e].push(n);else{s[e]=[n];var i=function(e){return function(){s[e]&&(s[e].forEach((function(e){e.next(),e.complete()})),delete s[e])}}(e);r({method:"GET",url:"".concat(sm.conf.api_url,"/operators/").concat(e,"?include_engagements=false"),responseType:"json",contentType:"application/json",getRequestHeaders:t,onSuccess:function(t){o[e]=t.response,s[e]&&(s[e].forEach((function(e){e.next(t.response),e.complete()})),delete s[e]),delete s[e]},onError:i,shouldRetry:function(){return!1}})}})).pipe(wp(a))}}({getRequestHeaders:s}),d=function(e){var t=e.chatHistoryObservable,n=e.engagementStartObservable,r=e.engagementObservables,i=e.siteVisitorNotifications,o=e.getRequestHeaders,s=e.statsClient,a=e.engagementId,u=e.maskingRegularExpressions,c=n.pipe(Ad(r),jd("channel"),Ud(1)),l=c.connect(),f=new GC({channelObservable:c,historyObservable:t,getRequestHeaders:o,statsClient:s,logger:sm.logger.withTags({engagement_id:a,site_id:sm.siteId}),engagementId:a,visitorId:jO(),siteVisitorNotifications:i,maskingRegularExpressions:u});return{chatController:f,stopChat:function(){f.stop(),l.unsubscribe()}}}({chatHistoryObservable:n,engagementStartObservable:c,siteVisitorNotifications:a,engagementObservables:l,statsClient:i,engagementId:o,getRequestHeaders:s,maskingRegularExpressions:u}),p=d.chatController,h=d.stopChat;return{chat:new e({chatHistoryObservable:n,engagementEndObservable:r,observeChatMessages:iC,statsClient:i,chatController:p,fetchExtraOperatorInfo:f}),stopChat:h}}}]),e}();BC.prototype.EVENTS={MESSAGES:"messages",MESSAGES_WITH_STATUS_UPDATES:"messages-with-status-updates",OPERATOR_TYPING_STATUS_UPDATE:"operator-typing-status-update"},BC.prototype.SENDERS=KR;var zC=["engagement","engagements"],JC=["engagement","requests"],QC=["visitor","browser_tab_id"],YC=function(e){return Te(ji("id",sm.siteId),e.transferrable_sites)},KC=function(e){return e&&"transferring"===e.status&&e.capabilities.text},XC=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=void 0!==t.includeAsyncTransfer&&t.includeAsyncTransfer,r=Ai([],zC,e);try{var i=jn(YC,r);return KC(i)?n?i:void 0:i}catch(t){return void zO.error("Engagement was undefined in internalVisitorState",{internalVisitorState:e,engagements:r})}},$C=function(e){return YC(e)&&me(QC,e)===sm.tabId&&!KC(e)},ZC=dt(ve(0),Lt($C),Ai([],zC)),eP=dt(ve(0),Lt(ot($C)),Ai([],zC)),tP=dt(ve(0),Lt(we([YC,ji("outcome",null),ji("type","reactive")])),Ai([],JC)),nP={OBSERVATION:"OBSERVATION",ENGAGEMENT:"ENGAGEMENT",POINTER:"POINTER"},rP=function(){function e(t,n,r){i(this,e),this.mode=t,this.session=n,this.canVisitorEndCobrowsing=r.canVisitorEndCobrowsing||!1}return s(e,null,[{key:"createObservation",value:function(){return new this(nP.OBSERVATION,null,{})}},{key:"createActive",value:function(e){return new this(e.mode,e.session,e.metadata)}}]),e}(),iP=function(){function e(t){var n=t.cobra;i(this,e),this.stop=function(){return n.switchToObservation()}}return s(e,[{key:"stop",value:function(){}}]),e}(),oP=function(){function e(t){var n=t.operator,r=t.channel;i(this,e),this.operator=n,this.allow=function(){return r.emitAll("engagement:offer_cobrowsing:allow"),zO.info("Visitor accepted cobrowsing request"),null},this.decline=function(){return r.emitAll("engagement:offer_cobrowsing:deny"),zO.info("Visitor declined cobrowsing request"),null}}return s(e,[{key:"allow",value:function(){}},{key:"decline",value:function(){}}]),e}(),sP=s((function e(t){var n=this,r=t.cobraObservable,o=t.internalVisitorStateObservable,s=t.channelObservable,a=t.fromRxJs4,u=void 0===a?CT:a;i(this,e);var c=s.switchMap((function(e){var t=e.channel;return t.emitAll("engagement:offer_cobrowsing:ready"),t.observable("engagement:offer_cobrowsing:offer_cobrowsing").do((function(){return t.emitAll("engagement:offer_cobrowsing:ack")})).map((function(e){return{operator:void 0!==e&&"operator"in e?e.operator:null,channel:t}}))})).do((function(){return zO.info("Received cobrowsing request")})).share().map((function(e){var t=e.operator,n=e.channel;return new oP({operator:t,channel:n})})),l=s.switchMap((function(e){return e.channel.observable("engagement:offer_cobrowsing:deny").map((function(){return{}}))})),f=o.map((function(e){var t=XC(e),n=void 0!==t?t.platform:void 0;return void 0===n?{}:{canVisitorEndCobrowsing:n!==$A}})).startWith({}).distinctUntilChanged(At),d=r.switchMap((function(e){return u(e.modeObservable.pluck("name").map((function(t){return[t,e]})))})).withLatestFrom(f).map((function(e){var t=b(e,2),r=b(t[0],2),i=r[0],o=r[1];return function(e,t,r){return e===n.MODES.OBSERVATION?rP.createObservation():rP.createActive({mode:e,metadata:t,session:new iP({cobra:r})})}(i,t[1],o)})),p=zn([[this.EVENTS.COBROWSING_REQUEST,c],[this.EVENTS.MODE_CHANGE,d],[this.EVENTS.COBROWSING_REQUEST_REJECTED,l]]),h=HI(),v=FI();v.proxyAll(p),h.proxyAll(p),this.resendPage=function(){return r.timeout(2e3).take(1).toPromise().then((function(e){e.resendPage()}))},this.addUnbufferedEventListener=v.addEventListener,this.removeUnbufferedEventListener=v.removeEventListener,this.addBufferedEventListener=h.addEventListener,this.removeBufferedEventListener=h.removeEventListener,this.observable=function(e){return v.observable(e)},this.bufferedObservable=function(e){return h.observable(e)}}));sP.prototype.EVENTS={COBROWSING_REQUEST:"cobrowsing_request",MODE_CHANGE:"cobrowser_mode_change",COBROWSING_REQUEST_REJECTED:"cobrowsing_request_rejected"},sP.prototype.MODES=nP;var aP=function(e){return"browser"===e?"audio":"phone"},uP=function(e){var t=e.upgradeRequest,n=e.currentMediaState,r={audio:me(["audio","direction"],n),video:me(["video","direction"],n)},i=ki(["audio","video"],t),o=_r(r).two_way||[],s=_r(i).two_way||[];return!Sr(en(s,o))},cP="two_way",lP="one_way",fP=function(e,t){return Hr((function(e){return e===cP?2:e===lP?1:0}),e,t)},dP=function(e){if(e){if(e.video)return"video";if(e.audio&&"browser"===e.audio.type)return"audio";if(e.audio&&"phone"===e.audio.type)return"phone"}return"text"},pP=function(e){return e.stateObservable.bufferCount(2,1).filter((function(e){var t=b(e,2),n=t[0],r=t[1];return n.sub_engagement_id!==r.sub_engagement_id})).do(zO.log.bind(zO,"Detect sub_engagement change")).map((function(e){var t=b(e,2);return t[0],t[1]})).map((function(e){var t=new aN({id:e.operator.id,name:e.operator.name||"Operator",formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},media_type:e.operator.media_type}),n={id:e.id,subEngagementId:e.sub_engagement_legacy_id,channelUrl:e.channel_url,mediaState:e.media_state,operatorId:t.getId(),operatorName:t.getName(),operatorFormattedName:t.getFormattedName(),operatorPicture:t.getPictureUrl(),operatorMedia:t.getMediaType()};return n=qe("startingMedia",dP(n),n)})).map(ki(["operatorId","operatorName","operatorFormattedName","operatorPicture","operatorMedia","startingMedia","subEngagementId","id"])).map(Jr({isReestablishing:!1,isTransfer:!0})).do(zO.log.bind(zO,"Engagement transferred"))},hP=function(e){var t,n=e.engagement,r=e.transfers,i=e.channelObservable,o=e.webRtcMode,s=e.statusObservable,a={id:n.engagementId,subEngagementId:n.subEngagementId,startingMedia:n.startingMedia,isReestablishing:n.isReestablishing,operatorId:n.operator.id,operatorName:n.operator.name,operatorFormattedName:n.operator.formattedName,operatorPicture:n.operator.picture?n.operator.picture.url:void 0,operatorMedia:(t=n.operator.state.medias,Dn(Gt(I,t),JA)),observable:n.observable.bind(n),EVENTS:n.EVENTS},u=s.filter(ji("interaction","engagement")).map(ge("channelUrl")).take(1),c=i.switchMap((function(e){var t=e.channel;return u.map((function(e){return{channel:t,engagementChannelUrl:e}}))})).filter((function(e){var t=e.channel,n=e.engagementChannelUrl;return t.url===n})).take(1);return CO.Observable.of(a).merge(r).switchMap((function(e){return c.map((function(t){var n=t.channel;return Jr({channel:n},e)}))})).map(Cn({startingMedia:qo(De,Ee(n.startingMedia))})).map((function(e){return Jr(e,{webRtcMode:o})}))};function vP(e){return _e((function(e,t){return e.then((function(e){return t.then((function(t){return Ne(t,e)}))}))}),Promise.resolve([]),e)}var bP=dt(Tr(", "),pe((function(e){return"'".concat(e,"'")}))),mP=/^\+?[1-9]\d{1,14}$/,gP=function(e){return new Promise((function(t,n){return function(e){return Boolean(e&&e.phoneNumber)}(e)?(r=e.phoneNumber,mP.test(r)?void t():n(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Invalid phone number: '".concat(e.phoneNumber,"'! Make sure that country code is present in the number and it has plus sign (+) prefix")}))):n(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"'phone' was specified as the media but the 'phoneNumber' option is missing!"}));var r}))},yP=function(e){return new Promise((function(t,n){if(function(e){return e&&e.hasOwnProperty("phoneExtension")}(e)&&(null!==(r=e.phoneExtension)&&!r.match(/^(,*\d,*){1,25}$/)))return n(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Invalid phone extension: '".concat(e.phoneExtension,"'! The phone extension can only contain commas and up to 25 digits.")}));var r;t()}))},_P=function(e){var t=e.media,n=e.options,r=e.availableMediaTypes,i=e.availableOneWayMediaTypes,o=e.visitorUpgradesAllowed,s=e.highestAllowedMediaType,a=[],u=!1===o?cn(r.indexOf(s),r):r;return a.push(function(e,t,n,r,i){return new Promise((function(o,s){if(i.oneWay){if(!1===r)return s(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"This site does not support 'one-way' option!"}));if(!Gt(e,n))return s(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Media must be one of: ".concat(bP(n),"!")}))}if(!i.oneWay&&!Gt(e,t))return s(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Media must be one of: ".concat(bP(t),"!")}));o()}))}(t,u,i,o,n||{})),"phone"===t&&(a.push(gP(n)),a.push(yP(n))),vP(a)},wP=function(e){var t=e.options,n=e.availableMediaTypes,r=e.availableOneWayMediaTypes,i=e.visitorUpgradesAllowed,o=e.highestAllowedMediaType,s=[],a=!1===i?cn(n.indexOf(o),n):n;return s.push(function(e,t,n,r){return new Promise((function(i,o){if(e.audio){var s=["browser","phone"];if(!Gt(e.audio,s))return o(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Audio must be one of: ".concat(bP(s),"!")}));if(!Gt("audio",t)&&!Gt("phone",t))return o(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Audio is not supported!"}))}if(e.video){var a=["one_way","two_way"];if(!Gt(e.video,a))return o(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Video must be one of: ".concat(bP(a),"!")}));if("one_way"===e.video&&!1===r)return o(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"This site does not support 'one-way' option!"}));if("one_way"===e.video&&!Gt("video",n))return o(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"One-way video is not supported!"}));if("two_way"===e.video&&!Gt("video",t))return o(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Video is not supported!"}))}i()}))}(t,a,r,i)),"phone"===t.audio&&(s.push(gP(t)),s.push(yP(t))),vP(s)},EP=s((function e(t){var n=this;i(this,e);var r=t.visitor,o=t.operator;this.visitor=dt(Cn({phoneStatus:function(e){switch(e){case iS.MSG.PHONE_STATUSES.CONNECTED:return n.PHONE_STATUSES.CONNECTED;case iS.MSG.PHONE_STATUSES.CONNECTING:return n.PHONE_STATUSES.CONNECTING;default:return n.PHONE_STATUSES.UNUSED}}}),xi(["media","audioMuted","videoMuted","phoneStatus"]))(r),this.operator=xi(["media","audioMuted","videoMuted"],o)}));EP.prototype.PHONE_STATUSES={CONNECTED:"connected",CONNECTING:"connecting",UNUSED:"unused"};var OP=s((function e(t){var n=t.id,r=t.label,o=t.is_default,s=t.position;if(i(this,e),this.id=n,this.label=r,this.is_default=o,this.position=s,!this.id||!this.label)throw zO.error("Survey choice missing parameters",{parameters:{id:n,label:r,is_default:o,position:s}}),new rI({cause:BA.SALEMOVE.INTERNAL_ERROR,message:"Survey choice is missing required parameters"})})),SP=s((function e(t){var n=this,r=t.id,o=t.text,s=t.name,a=t.type,u=t.required,c=t.position,l=t.options;i(this,e),this.id=r,this.text=o,this.name=s,this.type=a,this.required=u,this.position=c,this.options=l;var f=function(){return n.options&&Array.isArray(n.options)&&!Sr(n.options)};if("single_choice"===this.type&&f()&&(this.options=this.options.map((function(e){return new OP(e)}))),"single_choice"!==this.type||f()||zO.warn("Single choice survey question missing options",{parameters:arguments[0]}),!(this.id&&this.text&&this.name&&this.type))throw zO.error("Survey question missing parameters",{parameters:arguments[0]}),new rI({cause:BA.SALEMOVE.INTERNAL_ERROR,message:"Survey question is missing required parameters"})})),TP=s((function e(t,n){var r=this,o=t.survey;i(this,e),this.id=o.id,this.description=o.description,this.title=o.title,this.type=o.type,this.name=o.name,this.questions=o.questions.map((function(e){return new SP(e)})).filter((function(e){return!(e.type===r.QUESTION_TYPES.SINGLE_CHOICE&&Sr(e.options))})),this.answer=function(e){return n({surveyId:o.id,answers:VA(e)})}}));TP.prototype.QUESTION_TYPES={BOOLEAN:"boolean",SCALE:"scale",TEXT:"text",SINGLE_CHOICE:"single_choice"};var AP=function(e){var t=e.stats,n=e.protocol,r=e.failureTagProperty,i=e.timeout,o=e.timeoutError,s=e.scheduler;return function(e,a){var u=e.resource,c=e.method,l=t.statApiUsage({protocol:n,resource:u})(c).attempted();return a().do(l.succeeded,dt(l.failed,ge(r))).timeoutWith(i,o.do(null,(function(){l.timedOut(),zO.warn("'".concat(c,"' on resource ").concat(u," has timed out"))})),s).do((function(e){return zO.log("Successfully executed '".concat(c,"' on resource ").concat(u))}),(function(e){return zO.warn("Failed to execute '".concat(c,"' on resource ").concat(u))})).finally((function(){if(!l.isFinished())return l.failed("aborted")}))}},IP=new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT}),kP=["#inner-page",".socketio","script[src*='".concat(e.assets.server,"']"),"#cobrowsing-mouse-container","style[data-page-iframer='keep']"],xP=e.visitor_app.is_custom_theme?["body > link","head > link"]:["link[href*='".concat(e.assets.server,"']"),"link[href*='".concat(e.api_url,"']"),"link[href*='https://uploads.salemove.com']"],MP=kP.concat(xP),NP=function(){function e(t,n){i(this,e),this._retainedElementsBySelector=this._retainedElementsBySelector.bind(this),this._document=t,n||(n=[]),this._filters=n}return s(e,[{key:"clean",value:function(){this._removeAccordingToFiltersLeavingTopLevelInPlace(),this._cleanHtmlElementOfUnnecessaryAttributes(),this._overrideBodyInlineStyles(),this._hideParentsOfKeptHiddenElements()}},{key:"_removeAccordingToFiltersLeavingTopLevelInPlace",value:function(){var e=Xe(this._retainedElementsBySelector,this._filters),t=_T(this._document.head.querySelectorAll("*")).concat(_T(this._document.body.querySelectorAll("*")));return tn(er,t,e).filter((function(e){return"title"!==e.localName})).map((function(e){return e.parentNode.removeChild(e)}))}},{key:"_retainedElementsBySelector",value:function(e){var t=_T(this._document.querySelectorAll(e));return Xe((function(e){return _T(e.querySelectorAll("*")).concat([e]).concat(yT(e))}),t)}},{key:"_cleanHtmlElementOfUnnecessaryAttributes",value:function(){var e=this._document.querySelector("html");_T(e.attributes).filter((function(e){return"lang"!==e.name})).forEach((function(t){return e.removeAttribute(t.name)}))}},{key:"_overrideBodyInlineStyles",value:function(){this._document.body.removeAttribute("style")}},{key:"_hideParentsOfKeptHiddenElements",value:function(){if(this._filters.length>0){var e=_T(this._document.body.querySelectorAll("*")).filter(gT),t=_T(this._document.body.querySelectorAll(this._filters.join(","))),n=Xe((function(e){var t=_T(e.querySelectorAll("*")).concat([e]);return gT(e)?t.concat(yT(e)):t}),t);tn(er,e,n).forEach((function(e){e.style.display="none"}))}}}]),e}(),RP=sm.conf.visitor_app.css_prefix||"sm-",CP={id:"inner-page",getTargetUrl:function(){return window.location.href},document:window.document,nonRemoved:[]},PP=function(){function e(t){i(this,e);var n=Jr(CP,t);this._id=n.id,this._targetUrl=n.getTargetUrl(),this._targetDocument=n.document||window.document,this._iframeElement=this._createIframeElement(this._targetDocument);var r=(n.nonRemoved||[]).concat(["#".concat(this._id)]).concat(MP);this._cleaner=new NP(this._targetDocument,r),this._iframeTargetPointer=n.targetId,this._wrapIframe=n.wrapIframe}return s(e,[{key:"putIntoIframe",value:function(){var e=this;return new Promise((function(t,n){var r=xR(e._targetDocument);return e._iframeElement.style.visibility="hidden",e._callWhenIframeLoaded((function(){return e._iframeElement.style.visibility="",kR(e._iframeElement.contentDocument,r),e._clearCurrentDom(),t({iframe:e._iframeElement})})),e._insertIframe()}))}},{key:"_clearCurrentDom",value:function(){return this._cleaner.clean()}},{key:"_createIframeElement",value:function(e){var t=e.createElement("iframe");return t.setAttribute("id",this._id),t}},{key:"_insertIframe",value:function(){var e;this._iframeElement.src=this._targetUrl,this._ensureBodyExists();var t=this._iframeSiblingElement();if(this._wrapIframe){var n=this._targetDocument.createElement("div");n.setAttribute("id","".concat(RP,"inner-page-wrapper")),n.appendChild(this._iframeElement),e=n}else e=this._iframeElement;t?this._targetDocument.body.insertBefore(e,this._iframeSiblingElement()):this._targetDocument.body.appendChild(e),this._iframeElement.contentWindow.location.href=this._targetUrl}},{key:"_iframeSiblingElement",value:function(){if(this._iframeTargetPointer)return this._targetDocument.getElementById(this._iframeTargetPointer)}},{key:"_callWhenIframeLoaded",value:function(e){return this._iframeElement.addEventListener("load",(function t(n){return n.target.removeEventListener("load",t),e()}))}},{key:"_ensureBodyExists",value:function(){if(!this._targetDocument.body){var e=this._targetDocument.createElement("body");return this._targetDocument.appendChild(e)}}}]),e}(),jP="sm-wrapped-page",LP=function(){function e(t){var n=t.document,r=t.nonRemoved;i(this,e),this.wrap=this.wrap.bind(this),this.unwrap=this.unwrap.bind(this),this.document=n,this.nonRemoved=(r||[]).concat(["#".concat(this._id)]).concat(MP)}return s(e,[{key:"wrap",value:function(){var e=this._createWrappingDiv(),t=this.nonRemoved.join(", ");_T(this.document.body.children).forEach((function(n){wT(n,t)||wT(n,"iframe")&&"none"===window.getComputedStyle(n).display||e.appendChild(n)}));var n=this.document.body.children[0];this.document.body.insertBefore(e,n)}},{key:"unwrap",value:function(){var e=this.document.getElementById(jP);e&&(_T(e.children).forEach((function(t){e.parentNode.appendChild(t)})),e.parentNode.removeChild(e))}},{key:"_createWrappingDiv",value:function(){var e=this.document.createElement("div");return e.id=jP,e.className=jP,e}}]),e}(),UP=s((function e(t){var n=t.media,r=t.medias;i(this,e),this.media=n,this.medias=r})),qP=function(e,t){"iframe"===e?document.querySelector("#inner-page").contentWindow.location.assign(t):window.location.href=t},DP=function(e){var t=e.volatileNotifications,n=e.visitorPageAdaption;return t.filter(ze(ji("site_id",sm.siteId),ji("event","navigation_to_url"))).map(ge("payload")).subscribe(qP.bind(this,n),zO.error.bind(zO,"Unable to navigate to url"))},VP=s((function e(t){var n=t.medraStream;i(this,e),this.stream=n.getWebMediaStream()})),FP=function(){function e(t){var n=t.medraStream,r=t.connection;i(this,e),n.getWebMediaStream().getVideoTracks()[0].onended=function(){return r.stop()},this.stopSharing=function(){return r.stop(),null}}return s(e,[{key:"stopSharing",value:function(){}}]),e}(),HP=s((function e(t){var n=t.status,r=t.screen;i(this,e),this.status=n,this.screen=r}));HP.prototype.STATUSES={SHARING:"sharing",NOT_SHARING:"not_sharing"};var WP=s((function e(t){var n=t.status,r=t.screen;i(this,e),this.status=n,this.screen=r}));WP.prototype.STATUSES={SHARING:"sharing",NOT_SHARING:"not_sharing"};var GP=s((function e(t){var n=t.onAccept,r=t.onDecline;i(this,e),this.accept=function(){return n().then((function(){return{}}))},this.decline=function(){r()}})),BP=function(e,t){var n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{mediaDevices:navigator.mediaDevices}).mediaDevices;return{getStream:function(){return new Promise((function(r,i){t.next(new GP({onAccept:function(){zO.info("Requesting screen capture");var t=e.statScreenShareUsage({stage:"capture",resource:"visitor_api.screen_sharing"}).attempted();return n.getDisplayMedia({video:!0}).then((function(e){r(e),zO.info("Screen capture successful"),t.succeeded()})).catch((function(e){return i(e),"NotAllowedError"===e.name?(zO.info("Screen capture permissions denied",e),t.failed("canceled"),Promise.reject(function(e){return"Permission denied by system"===e.message?new rI({cause:BA.SALEMOVE.DENIED_BY_SYSTEM}):new rI({cause:BA.SALEMOVE.CANCEL})}(e))):function(e){return"NotReadableError"===e.name||"NotFoundError"===e.name||"AbortError"===e.name}(e)?(zO.info("Screen capture failed due to no access to screen",e),t.failed("device-error"),Promise.reject(new rI({cause:BA.SALEMOVE.DEVICE_ACCESS_ERROR}))):"SecurityError"===e.name?(zO.info("Screen capture failed due to Permissions Policy",e),t.failed("permissions-policy"),Promise.reject(new rI({cause:BA.SALEMOVE.DENIED_BY_PERMISSIONS_POLICY}))):(t.failedUnknown(),Promise.reject(new rI({cause:BA.SALEMOVE.INTERNAL_ERROR})))}))},onDecline:function(){sm.logger.info("Screen sharing request declined"),i({name:"NotAllowedError"})}}))}))}}},zP=function(e){var t,n=e.conf,r=e.channelObservable,i=e.namespace,o=e.videoProvider;return rS("Medra").map(ge("default")).map((function(e){return new e({webRTC:{iceServers:n.communications.webrtc_server,videoProvider:o}})})).flatMap((function(e){return r.do((function(){t&&(sm.logger.info("Stopping Medra connection due to new channel"),t.stop())})).flatMap((function(t){var n=t.channel;return RT(e.connect(n,{namespace:i}))})).do((function(e){t=e}))}))},JP=function(){function e(t){var n=t.adapter,r=t.operatorScreenSharedObservable,o=t.visitorScreenSharedObservable,s=t.screenShareRequestedObservable;i(this,e),this.EVENTS={OPERATOR_STATE_UPDATE:"operator_state_update",VISITOR_STATE_UPDATE:"visitor_state_update",SCREEN_SHARING_REQUEST:"screen_sharing_request"};var a=zn([[this.EVENTS.OPERATOR_STATE_UPDATE,r],[this.EVENTS.VISITOR_STATE_UPDATE,o],[this.EVENTS.SCREEN_SHARING_REQUEST,s]]);n.proxyAll(a),this.addBufferedEventListener=n.addEventListener,this.removeBufferedEventListener=n.removeEventListener}return s(e,null,[{key:"start",value:function(t){var n,r,i=t.conf,o=t.channelObservable,s=t.connectMedra,a=t.fromRxJs5,u=t.scheduler,c=t.videoProvider,l=t.isReestablishing,f=t.stats;a||(a=RT),s||(s=zP);var d=new CO.Subscription,p=new CO.Subject,h=new CO.Subject;c||(c=BP(f,h));var v=new CO.Subject,b=v.switchMap((function(){return s({conf:i,channelObservable:o,namespace:"visitor-screensharing",videoProvider:c})})).publishReplay(1);if(d.add(b.connect()),v.next({}),b.switchMap((function(e){return a(e.communicationRequest).map((function(t){return{proposal:t,connection:e}}))})).subscribe((function(e){var t=e.proposal,n=e.connection,r=f.statScreenShareUsage({stage:"sharing",resource:"visitor_api.screen_sharing"}).attempted();return t.accept({video:{type:"browser"}}).then((function(e){var t=e.localVideoStream;r.succeeded(),sm.logger.info("Screen sharing succeeded"),p.next({connection:n,localVideoStream:t})})).catch((function(e){e&&e.cause===n.ERRORS.DENIED_BY_SYSTEM?(r.failed("canceled"),sm.logger.info("Screen sharing canceled")):e&&e.cause===n.ERRORS.DEVICE_ACCESS_ERROR?(r.failed("device_access_error"),sm.logger.warn("Screen sharing failed due to device access error",e)):(r.failedUnknown(),sm.logger.warn("Screen sharing failed",e))}))}),sm.logger.error.bind(sm.logger,"Failed to receive screen sharing request")),l){d.add(b.take(1).subscribe((function(e){return e.reestablish().then((function(t){var n=t.localVideoStream;if(n)return p.next({connection:e,localVideoStream:n})}))}),sm.logger.error.bind(sm.logger,"Failed to reestablish visitor screen")))}var g=new HP({status:HP.prototype.STATUSES.NOT_SHARING}),y=(n=s({conf:i,channelObservable:o,namespace:"operator-screensharing"}).switchMap((function(e){var t=a(e.communicationRequest).pipe(Mu((function(t){return CO.Observable.from(t.accept({})).catch((function(t){return t&&t.cause===e.ERRORS.REMOTE_PARTICIPANT_ERROR?sm.logger.info("Failed to receive operator screen due to error on operator side",t):sm.logger.warn("Failed to receive operator screen",t),CO.Observable.empty()}))})));return l?CO.Observable.merge(CO.Observable.fromPromise(e.reestablish()),t).filter((function(e){var t=e.remoteVideoStream;return!De(t)})):t})).do((function(){return sm.logger.info("Remote screen sharing stream received")})).flatMap((function(e){var t=e.remoteVideoStream,n=CO.Observable.defer((function(){var e="playing"===t.getMediaState()?HP.prototype.STATUSES.SHARING:HP.prototype.STATUSES.NOT_SHARING;return CO.Observable.of(new HP({screen:new VP({medraStream:t}),status:e}))})),r=a(t.observe(t.EVENTS.DISCONNECTED)).map((function(){return g}));return CO.Observable.merge(n,r)}))).startWith.apply(n,m([g,u].filter(gt))),_=new WP({status:WP.prototype.STATUSES.NOT_SHARING}),w=null,E=(r=p.do((function(){return sm.logger.info("Screen sharing request accepted")})).switchMap((function(e){var t=e.localVideoStream,n=e.connection;w=new FP({medraStream:t,connection:n});var r=CO.Observable.of(new WP({screen:w,status:WP.prototype.STATUSES.SHARING})),i=a(t.observe(t.EVENTS.DISCONNECTED)).do((function(){return v.next({})})).map((function(){return _}));return CO.Observable.merge(r,i)}))).startWith.apply(r,m([_,u].filter(gt))).share(),O=HI();return{screenSharing:new e({adapter:O,operatorScreenSharedObservable:y,visitorScreenSharedObservable:E,screenShareRequestedObservable:h}),stopScreenSharing:function(){w&&w.stopSharing(),O.stop(),d.unsubscribe()}}}}]),e}(),QP=s((function e(t){var n=t.id,r=t.properties;i(this,e),this.id=n,this.properties=r})),YP=function(){return"iframe"===sm.conf.visitor_app.visitor_page_adaption},KP=function(){return YP()?document.getElementById("inner-page").contentWindow.document:document},XP=function(e){try{var t=KP();return YP()?t.body.querySelector(e):t.querySelector(e)}catch(e){return zO.info("Target element not found",{error:e}),null}},$P="virtual_assistant_cobrowsing_cursor",ZP="virtual_assistant_cobrowsing_cursor_label",ej=function(e,t){var n=XP("#"+$P);if(!n){var r=function(){var e=KP().createElement("div");return e.setAttribute("id",$P),e.style.display="none",e.style.opacity="0",e.style.position="absolute",e.style.zIndex="10",e.style.top="0",e.style.left="0",e.style.width="20px",e.style.height="20px",e.style.backgroundRepeat="no-repeat",e.style.backgroundImage="url('data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAwAAAARCAYAAADpPU2iAAAAAXNSR0IArs4c6QAAAiNJREFUKBV1kl9oUlEcx39eR21JEAwEHQQ9OKcr2mDoemgsfV5vSdFLqzEu9NSo6MHF8iUIevRBtJfyrdjbarVQF8un7ELWnKUiNzFw88+qqyL3evoe22LG/MGHe87vfL+/37nnHGprWpLtRSKROE9EAugdrVZL8ly+yhYX7zNN01rRaHQa6t6mRqPxaWraxSBi0dg6U1W1GQgEzvQ0wbApijc7Bm56tfqaIbfj9XpPYa4D3dFsNtPXb8z/M2CVRSIxpiiK7Ha7BzHvNsGQ/d8ADUsmP7NqtSrBYDjYQtDpdIf8ICOnc5JKpe2xWq0Wg2Fg38TFffuTg996/Tc5HA4qFn9MVCqVVaz183Vu0PPBYbG7WyO73UbfMtmpQqHwFJr+PuFvdOkFvZ4eLPkI90Ky/J0aikJDZvOlcql0gm8H8EMiWli4Tfl8npaXX9Ds7DVaW3uTbbfVejaXPappKplNpkHCRVUsVjsTBH3ngZR3yp0jttlsLBgMbqEO30oQBMBDgRjT37t7h95vbJAoih9WXq7knJPnKJVK0bBl2OrxeH5B+G6PNLXRgpf2+/2bSD43Go3hjwmp08U6YmOyLOeQHwMmMER4cSyXychcDB6DOVT/Mjp6umMKhZ4wn88nIn8ckPA2Erl1dnz8GcbbIAHWw+Hwo1AwRAPHDCRJErlcrivIG4EAyALmwRwYAUfAyXg8Hi0Wiq2vW+mfF2dmeMELwPAHu44LBYcnDWwAAAAASUVORK5CYII=')",e}(),i=function(e,t){var n=KP().createElement("div");return n.setAttribute("id",ZP),n.style.display="inline-block",n.style.color="#ffffff",n.style.fontSize="13px",n.style.padding="2px 12px",n.style.margin="18px 0 0 14px",n.style.boxShadow="1px 1px 4px rgba(50, 50, 50, 0.75)",n.style.border="1px solid #ffffff",n.style.borderRadius="4px",n.style.backgroundColor="#232323",n.style.whiteSpace="nowrap",n.innerText=t,n}(0,t);r.appendChild(i),n=KP().body.appendChild(r)}return n.style.display="block",CO.Observable.of({cursor:n})},tj=function(e){return function(t){var n=t.interval.value+1;e.style.left=function(e,t){return(t=e.cursorInitialPosLeft-e.cursorDistanceDiffLeft*t/e.totalCircleSteps).toFixed(0)}(t,n)+"px",e.style.top=function(e,t){return(t=e.cursorInitialPosTop-e.cursorDistanceDiffTop*t/e.totalCircleSteps).toFixed(0)}(t,n)+"px"}},nj=function(e,t){var n=10*t;e.style.left=function(e,t){return(e+3*Math.cos(t*Math.PI/180)).toFixed(0)}(e.offsetLeft,n)+"px",e.style.top=function(e,t){return(e-3*Math.sin(t*Math.PI/180)).toFixed(0)}(e.offsetTop,n)+"px"},rj=function(e){return e||(e={moveCursorToPosition:tj,moveFrequency:20}),function(t){var n,r,i,o=t.cursor.offsetLeft,s=t.cursor.offsetTop,a=(n=t.targetElement,r=n.getBoundingClientRect(),i=r.top+KP().documentElement.scrollTop,{left:r.left+KP().documentElement.scrollLeft+n.offsetWidth/2,top:i+n.offsetHeight/2}),u=o-a.left,c=s-a.top,l=Math.abs((u+c)/50).toFixed(0),f=l>0?l:1;return CO.Observable.interval(e.moveFrequency).timeInterval().map((function(e){return{cursorInitialPosLeft:o,cursorInitialPosTop:s,cursorDistanceDiffLeft:u,cursorDistanceDiffTop:c,totalCircleSteps:l,interval:e}})).do(e.moveCursorToPosition(t.cursor)).skip(f-1).take(1).mapTo(t)}},ij=function(e){return e||(e={moveCursorCirclePosition:nj,circleFrequency:50}),function(t){return CO.Observable.interval(e.circleFrequency).timeInterval().do((function(n){return e.moveCursorCirclePosition(t.cursor,n.value)})).skip(107).take(1).mapTo(t)}},oj=function(e,t){e.style.opacity=t>=1?1:(parseFloat(t)+.1).toFixed(1)},sj=function(e,t){t<=.1?(e.style.opacity=0,e.style.display="none"):e.style.opacity=(parseFloat(t)-.1).toFixed(1)},aj=function(e,t,n){return CO.Observable.interval(t.stepDuration).do((function(){var r=e.cursor.style.opacity;"in"===n&&t.fadeInStep(e.cursor,r),"out"===n&&t.fadeOutStep(e.cursor,r)})).skip(9).take(1).mapTo(e)},uj=function(e){return e||(e={fadeInStep:oj,stepDuration:20}),function(t){return aj(t,e,"in")}},cj=function(e){return e||(e={fadeOutStep:sj,stepDuration:120}),function(t){return aj(t,e,"out")}},lj=function(e){e.targetElement.click()},fj="custom_commands",dj=function(){var e=localStorage.getItem(fj);return e?JSON.parse(e):[]},pj=function(e){localStorage.setItem(fj,JSON.stringify(e))},hj=function(e){pj([].concat(m(dj()),[e]))},vj=function(e){pj(dj().filter((function(t){return t.id!==e.id})))},bj="virtual_assistant_cobrowsing",mj="point",gj="scroll",yj="click",_j="navigate",wj=[gj,mj,yj],Ej=function(e){return e.targetElement.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})},Oj=function(e,t){e.operatorName;var n=e.operatorFormattedName;return function(e){var t,r,i,o=e.properties[bj];if(t=o.target,!((r=o.type)===_j?t&&t.length:Gt(r,wj)?Boolean(XP(t)):(zO.info("Invalid Virtual Assistant Cobrowsing action type",{type:r}),0)))return vj(e),CO.Observable.of(e);switch(o.type){case mj:return ej(0,n).map(qe("targetElement",XP(o.target))).do(Ej).flatMap(uj()).flatMap(rj()).flatMap(ij()).flatMap(cj()).do((function(){return vj(e)})).mapTo(e);case yj:return ej(0,n).map(qe("targetElement",XP(o.target))).do(Ej).flatMap(uj()).flatMap(rj()).flatMap(ij()).do((function(){return vj(e)})).do(lj).flatMap(cj()).mapTo(e);case gj:return ej(0,n).map(qe("targetElement",XP(o.target))).do(Ej).flatMap(uj()).flatMap(rj()).do((function(){return vj(e)})).mapTo(e);case _j:return(i=o.target,YP()?document.getElementById("inner-page").contentWindow.location.assign(i):window.location.href=i,CO.Observable.of({})).do((function(){return vj(e)})).mapTo(e);default:throw new Error("Unknown action: ".concat(o.type))}}},Sj="custom_command",Tj=function(e){return $n(bj,e.properties)},Aj=s((function e(t){var n=this,r=t.media,o=t.medias,s=t.onAccept,a=t.onDecline,u=t.validateMedia;i(this,e),this.media=r,this.medias=o,u=u||_P;this.select=function(e,t){return u({options:t,availableMediaTypes:n.medias,availableOneWayMediaTypes:[],media:e}).then((function(){return function(e,t){return s({media:e,options:t})}(e,t)}))},this.decline=a})),Ij=new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT}),kj=function(t){var n=t.visitorId,r=t.engagementId,i=t.volatileNotifications,o=t.engagementStateObservable,s=t.wsProxy,a=t.apiTimeoutMilliseconds,u=t.stats,c=AP({stats:u,protocol:"rest",failureTagProperty:"message",timeout:a,timeoutError:CO.Observable.throw(Ij)}),l=function(e,t){var n=ji("event_type","engagement.media_upgrade_request"),r=Ti(["media_upgrade_request","engagement_id"],e),i=Ti(["media_upgrade_request","target"],"visitor"),o=dt(ki(["id","audio","video"]),ge("media_upgrade_request"));return t.filter(we([n,r,i])).map(o)}(r,i),f=function(e){return e.filter(gt).map(ge("media")).distinctUntilChanged(At)}(o);return{mediaUpgradeRequestObservable:l,mediaStateObservable:f,requestMediaUpgrade:function(t){var n=t.mediaUpgradeRequest;return c({resource:"media-upgrade-request",method:"create"},(function(){return s.request({method:"POST",url:"".concat(e.api_url,"/engagements/").concat(r,"/media_upgrade_requests"),payload:n,headers:eI}).catch((function(e){return aI(e,{allowedCauses:[BA.SALEMOVE.INVALID_INPUT,BA.SALEMOVE.NETWORK_TIMEOUT,BA.SALEMOVE.CONFLICT]})}))})).toPromise()},acceptUpgradeRequest:function(t,n){return c({resource:"media-upgrade-request",method:"accept"},(function(){return s.request({method:"PATCH",url:"".concat(e.api_url,"/engagements/").concat(r,"/media_upgrade_requests/").concat(t.id),payload:Jr(n,{action:"accept"}),headers:eI}).catch((function(e){return aI(e,{allowedCauses:[BA.SALEMOVE.INVALID_INPUT,BA.SALEMOVE.NETWORK_TIMEOUT,BA.SALEMOVE.CONFLICT]})}))})).toPromise()},declineUpgradeRequest:function(t){return c({resource:"media-upgrade-request",method:"decline"},(function(){return s.request({method:"PATCH",url:"".concat(e.api_url,"/engagements/").concat(r,"/media_upgrade_requests/").concat(t.id),payload:{action:"decline"},headers:eI}).catch((function(e){return aI(e,{allowedCauses:[BA.SALEMOVE.INVALID_INPUT,BA.SALEMOVE.NETWORK_TIMEOUT,BA.SALEMOVE.CONFLICT]})}))})).toPromise()},removeVideo:function(){return c({resource:"engagement-participant",method:"remove video"},(function(){return s.request({method:"PATCH",url:"".concat(e.api_url,"/engagements/").concat(r,"/participants/").concat(n),payload:{action:"remove_video"},headers:eI}).catch(aI)})).map((function(){return{}})).toPromise()},removeAudio:function(){return c({resource:"engagement-participant",method:"remove audio"},(function(){return s.request({method:"PATCH",url:"".concat(e.api_url,"/engagements/").concat(r,"/participants/").concat(n),payload:{action:"remove_audio"},headers:eI}).catch(aI)})).map((function(){return{}})).toPromise()}}},xj=Object.freeze({__proto__:null,screenCapturingSupported:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.navigator;return Boolean(me(["mediaDevices","getDisplayMedia"],e))&&!function(e){return/android/i.test(e.userAgent)}(e)}}),Mj=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:yN,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:xj,n=e.canReceiveMedia()?["browser"]:[],r=e.canSendMedia()?["browser"]:[];return{canReceive:{video:n,audio:n.concat(["phone"])},canSend:{video:r,audio:r.concat(["phone"])},canShareScreen:t.screenCapturingSupported()&&e.canSendMedia()}},Nj=function(e,t){return t.filter(uP).map((function(t){var n=t.upgradeRequest,r=t.currentMediaState,i=function(e,t){if("two_way"===e.video)return{media:"video",medias:["video"]};if("two_way"===e.audio)return{media:"audio",medias:t.canSend.audio.map(aP)};throw new Error("Tried to create upgrade offer for one way media")}(n,Mj());return new Aj(Jr(i,{onAccept:function(t){return e.acceptUpgradeRequest(n,function(e,t){var n=(e.options?e.options.phoneNumber:void 0)||me(["audio","phone_number"],t),r=(e.options?e.options.phoneExtension:void 0)||me(["audio","phone_extension"],t);return{audio_type:"video"===e.media?me(["audio","type"],t)||"browser":"phone"===e.media?"phone":"browser",phone_number:n,phone_extension:r}}(t,r)).then(Ee({}))},onDecline:function(){return e.declineUpgradeRequest(n).then(Ee({}))}}))})).share()},Rj=function(e){var t,n=e.commsApi||kj(ki(["engagementId","visitorId","volatileNotifications","engagementStateObservable","wsProxy","apiTimeoutMilliseconds","stats"],e)),r=new CO.Subscription,i=n.mediaUpgradeRequestObservable.switchMap((t=e.channelObservable,function(e){return t.take(1).do((function(t){return t.channel.emit("comms:media_upgrade_request:ack",{id:e.id})})).mapTo(e)})).withLatestFrom(n.mediaStateObservable).map(Bo(["upgradeRequest","currentMediaState"])).share();r.add(function(e,t){return t.filter(ot(uP)).do((function(e){var t=e.upgradeRequest;return zO.info("Accepting media request automatically",{upgrade_request:t})})).switchMap((function(t){var n=t.upgradeRequest,r=t.currentMediaState;return e.acceptUpgradeRequest(n,{audio_type:me(["audio","type"],r),phone_number:me(["audio","phone_number"],r),phone_extension:me(["audio","phone_extension"],r)})})).catch((function(){return CO.Observable.empty()})).subscribe((function(){}))}(n,i));return r.add(iS.vent.observable(iS.MSG.ENGAGEMENT_REMOVE_AUDIO).subscribe(n.removeAudio,zO.error.bind(zO,"Error removing visitor's audio"))),{removeVideo:n.removeVideo.bind(n),mediaUpgradeOffers:Nj(n,i),mediaStateObservable:n.mediaStateObservable,requestMediaUpgrade:function(e){return n.mediaStateObservable.take(1).switchMap((function(t){var r=function(e){var t=e.options,n=e.currentMediaState,r=me(["audio","direction"],n),i=me(["video","direction"],n),o=t.audio?cP:null,s=t.video?t.video:null,a=fP(o,r),u=fP(s,i),c=me(["audio","phone_number"],n)||t.phoneNumber||null,l=me(["audio","phone_extension"],n)||t.phoneExtension||null;return{audio:a,video:u,audio_type:me(["audio","type"],n)||t.audio||null,phone_number:c,phone_extension:l}}({options:e,currentMediaState:t});return n.requestMediaUpgrade({mediaUpgradeRequest:r})})).toPromise().then(Ee({}))},stop:function(){r.unsubscribe()}}},Cj=new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT}),Pj=function(e){return e instanceof DOMException?oI(e):e instanceof rI?e:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(0===e)return new rI({cause:BA.SALEMOVE.CONNECTION_LOST});var i=At(e,404)?BA.SALEMOVE.RESOURCE_NOT_FOUND:Gt(e,YA)?BA.SALEMOVE.INVALID_INPUT:At(e,429)?BA.SALEMOVE.TOO_MANY_REQUESTS:401===e||403===e?BA.SALEMOVE.FORBIDDEN:(zO.warn("An INTERNAL_ERROR error from XHR occurred. Can we expose this error as non-internal?",h({status:e,message:n,responseText:t},r)),BA.SALEMOVE.INTERNAL_ERROR);return n||(n=t?function(){try{return JSON.parse(t).message}catch(e){}}():void 0),new rI(n?{cause:i,message:n}:{cause:i})}(e.status,e.response&&e.response.text&&e.response.text(),e.response?e.response.message:void 0,e)},jj=function(){function e(t,n){var r=this,o=t.id,s=t.securityScanningRequired,a=t.url;if(i(this,e),this.id=o,this.securityScanningRequired=s,this.url=a,this.securityScanningRequired){var u=Ti(["security_scan_result","file_id"],this.id);this.scanResultObservable=n.find(u).map(me(["security_scan_result","result"])).map((function(e){return{result:e,file:r}}))}}return s(e,[{key:"getScanResult",value:function(){return this.securityScanningRequired?this.scanResultObservable.toPromise():Promise.reject("Security scanning is not required")}}]),e}(),Lj=function(e,t,n,r,i){var o=n.onUploadProgress,s=n.getRequestHeaders,a=new FormData;a.append("content",t),a.append("site_id",sm.siteId);var u=RR(e?"/engagements/".concat(e,"/files"):"/messaging/files");return Gt(t.type,i)?t.size>25e6?CO.Observable.throw(new rI({cause:BA.SALEMOVE.FILE_TOO_LARGE,message:"File exceeds the maximum file size"})):function(e){var t=e.method,n=e.url,r=e.payload,i=e.onUploadProgress,o=e.getRequestHeaders;return MI({method:t,url:n,payload:r,responseType:"json",onUploadProgress:i,getRequestHeaders:o})}({url:u,method:"POST",payload:a,getRequestHeaders:s,onUploadProgress:o}).map((function(e){var t=e.response;return new jj({id:t.file_id,securityScanningRequired:t.security_scanning_required,url:u},r)})).catch((function(e){return CO.Observable.throw(Pj(e))})):CO.Observable.throw(new rI({cause:BA.SALEMOVE.FILE_CONTENT_TYPE_NOT_ALLOWED,message:"File content type is not allowed"}))},Uj=["visitor_authenticated","visitor_unauthenticated"],qj=s((function e(t){var n=t.mediaStateObservable,r=t.document,o=void 0===r?window.document:r,s=t.navigator,a=void 0===s?window.navigator:s;i(this,e);var u=null,c=null,l=!1,f=function(){if(!u&&"visible"===o.visibilityState)try{a.wakeLock.request("screen").then((function(e){u=e,zO.info("Screen Wake Lock acquired"),u.addEventListener("release",(function(){zO.info("Screen Wake Lock was released"),u=null}))})).catch((function(e){zO.warn("Failed to acquire Screen Wake Lock",e)}))}catch(e){zO.warn("Failed to acquire Screen Wake Lock",e)}},d=function(){u&&u.release().catch((function(e){zO.warn("Failed to release Screen Wake Lock",e)}))},p=function(e){(l=e.visitor&&"audio"===e.visitor.media)?f():d()},h=function(){"visible"===o.visibilityState&&l&&f()};this.start=function(){"wakeLock"in a?(c=n.subscribe(p,(function(e){return zO.warn("Failed to acquire Screen Wake Lock",e)})),o.addEventListener("visibilitychange",h)):zO.warn("Screen Wake Lock API is not supported in this browser")},this.stop=function(){d(),c&&(c.unsubscribe(),c=null),o.removeEventListener("visibilitychange",h)}})),Dj=function(){function e(t){var n=t.iframe;i(this,e),this.iframe=n}return s(e,[{key:"deframe",value:function(){iS.vent.trigger("visit:restore_url")}}]),e}(),Vj=s((function e(t){var n=t.unwrap;i(this,e),this.unwrap=n})),Fj=s((function e(){i(this,e),this.responsePromise=CO.Observable.merge(iS.vent.observable(iS.MSG.ALLOW_STREAM).map(Ee("allowed")),iS.vent.observable(iS.MSG.DENY_STREAM).map(Ee("denied"))).take(1).toPromise()})),Hj=s((function e(t){var n=t.asynchronous;i(this,e),this.asynchronous=n})),Wj=s((function e(t){var n=t.status,r=t.authenticated,o=t.isAsyncTransfer;i(this,e),this.status=n,this.authenticated=r,this.transfer="transferring"===n?new Hj({asynchronous:o}):{}}));Wj.prototype.STATUSES={ENGAGED:"engaged",TRANSFERRING:"transferring"};var Gj=s((function e(t){var n=t.text;i(this,e),this.text=n})),Bj=function(){function e(t){var n=this;i(this,e),this.startSalemoveViews=this.startSalemoveViews.bind(this);var r=t.engagementId,o=t.subEngagementId,s=t.startingMedia,a=t.type,u=t.isReestablishing,c=t.chat,l=t.stopChat,f=t.webRtcMode,d=t.enabledMediaLevel,p=t.channelObservable,h=t.operator,v=t.operatorFocusObservable,b=t.communicationWidget,m=t.createEngagementObservable,g=t.mediaStateObservable,_=t.backend,w=t.platform,E=t.startScreenSharing,O=t.stateObservable,S=t.statsClient,T=t.entrypoint,A=t.volatileNotifications,I=t.statusObservable,k=t.comms,x=t.events,M=t.surveyApi,N=t.getRequestHeaders,R=t.siteVisitorNotifications,C=t.createdAt,P=t.cobrowser;this.engagementId=r,this.chat=c,this.mediaState=null,this.isReestablishing=u,this.createdAt=C,this.subEngagementId=o,this.startingMedia=s,this.type=a,this.operator=h,this.cobrowser=P,this.allowFileSending=sm.conf.communications.allow_file_sending,this.onEnd=null,this.allowedFileContentTypes=sm.conf.communications.allowed_file_content_types;var j=E({conf:sm.conf,channelObservable:p,isReestablishing:this.isReestablishing,stats:S}),L=j.screenSharing,U=j.stopScreenSharing;this.screenSharing=L;var q=new CO.Subscription,D=t.engagementEndObservable.map((function(e){return"object"!==y(e)&&null!==e?{}:ki(n.ENGAGEMENT_END_EVENT_PAYLOAD_KEYS,e)})).take(1);g=g.publishReplay(1).refCount();var V=new qj({mediaStateObservable:g});v=v.map((function(e){return"chat"===e?n.FOCUS_TARGETS.CHAT:"cobrowse"===e?n.FOCUS_TARGETS.COBROWSER:(zO.error("Unexpected focus target!",e),"")}));var F=iS.vent.observable(iS.MSG.PUBLIC.ENGAGEMENT_MEDIA_UPGRADE_REQUEST).map(Wt(UP)),H=iS.vent.observable(iS.MSG.WILL_ASK_MEDIA_PERMISSION).map(Wt(Fj));u||localStorage.removeItem(fj);var W=function(e){return e.pipe(Gu(ji("event",Sj)),Ka((function(e){var t=e.payload,n=e.custom_command_id;return Wt(QP)({properties:t,id:n})})),Gu((function(e){return it(Tj(e))})),Df(ge("id")),Ap((function(e){return zO.info("Custom Command: received",{custom_command_id:e.id})})))}(A),G=function(e){var t=CO.Observable.from(dj()),n=e.pipe(Gu(ji("event",Sj)),Ka((function(e){var t=e.payload,n=e.custom_command_id;return Wt(QP)({properties:t,id:n})})),Gu((function(e){return Tj(e)})),Df(ge("id")),Ap((function(e){return zO.info("Virtual CoBrowsing Command: received",{custom_command_id:e.id})})),Ap(hj));return t.pipe(Td(n),Ap((function(e){return zO.info("Virtual CoBrowsing Command: processing",{custom_command_id:e.id})})))}(A),B=G.concatMap(Oj({operatorName:h.name,operatorFormattedName:h.formattedName})).subscribe((function(){}),(function(e){return zO.error("virtualCobrowsingCustomCommandSubscription failed",e)})),z=FI(),J=O.distinctUntilChanged(At,(function(e){return e.capabilities})).do((function(e){n.onEnd=e.on_end})).map((function(e){return new Gj(e.capabilities)})),Q=zn([[this.EVENTS.END,D],[this.EVENTS.STATE_CHANGE,O.map((function(e){return{status:e.status,authenticated:Ui(!1,"authenticated")(e.visitor),isAsyncTransfer:KC(e)}})).map(Wt(Wj))],[this.EVENTS.CAPABILITIES,J],[this.EVENTS.MEDIA_UPGRADE_OFFER,k.mediaUpgradeOffers],[this.EVENTS.FOCUS,v],[this.EVENTS.MEDIA_STATE_CHANGE,g],[this.EVENTS.MEDIA_PERMISSION_REQUEST,H],[this.EVENTS.WIDGET_MEDIA_UPGRADE_REQUEST,F],[this.EVENTS.CUSTOM_COMMAND,W]]);z.proxyAll(Q),this.addEventListener=function(e,t){e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.addUnbufferedEventListener(sP.prototype.EVENTS.COBROWSING_REQUEST,t):z.addEventListener(e,t)},this.removeEventListener=function(e,t){e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.removeUnbufferedEventListener(sP.prototype.EVENTS.COBROWSING_REQUEST,t):z.removeEventListener(e,t)},this.recordEvent=function(e){return x.recordEvent(e)};var Y=ji("event_type","engagement.files.security_scan_result"),K=R.filter(Y).publishReplay(this.SCAN_EVENT_REPLAY_COUNT);q.add(K.connect()),this.uploadFile=function(e,t){t||(t={});var n=t.onUploadProgress;return Lj(this.engagementId,e,{onUploadProgress:n,getRequestHeaders:N},K,this.allowedFileContentTypes).toPromise()},this.getChatTranscript=function(){return _.chatTranscript().then((function(e){return Promise.resolve(pe((function(e){var t=e.id,n=e.message,r=e.sender,i=e.attachment,o=e.metadata,s=e.created_at,a=r.type;return"operator"===a?new zR({id:t,content:n,attachment:i,metadata:o,created_at:s,sender:r}):"visitor"===a?new GR({id:t,content:n,status:GR.prototype.STATUSES.DELIVERED,attachment:i,created_at:s}):null}),e))}))},this.observable=function(e){return e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.observable(sP.prototype.EVENTS.COBROWSING_REQUEST):z.observable(e)};var X=function(){return setTimeout((function(){return z.stop()}))};D.subscribe((function(){}),X,X),this.iframePage=function(e){e||(e={});var t=e.keptElementSelectors;zO.info("Engagement: Iframe page started");var n=new PP({id:"inner-page",getTargetUrl:function(){return window.location.href},document:window.document,nonRemoved:t||[]});return sm.visitorPageNotifierSubscription&&sm.visitorPageNotifierSubscription.unsubscribe(),sm.trackerSubscription.unsubscribe(),sm.cobraSubscription.unsubscribe(),n.putIntoIframe().then((function(e){var t=e.iframe;return zO.info("Engagement: Iframe page finished"),Promise.resolve(new Dj({iframe:t}))}))},this.wrapPage=function(e){e||(e={});var t=e.keptElementSelectors;zO.info("Engagement: Wrap page started");var n=new LP({document:window.document,nonRemoved:t||[]});return n.wrap(),zO.info("Engagement: Wrap page finished"),Promise.resolve(new Vj({unwrap:n.unwrap}))};var $=pP({stateObservable:O}).share();q.add(DP({volatileNotifications:A,visitorPageAdaption:sm.conf.visitor_app.visitor_page_adaption})),this.getSurvey=function(){return M.fetchSurvey()};var Z=z.eventWithoutListenerObservable(this.EVENTS.WIDGET_MEDIA_UPGRADE_REQUEST);q.add(Z.subscribe((function(){console.warn("No listener set for the Engagement WIDGET_MEDIA_UPGRADE_REQUEST event. See 'WidgetMediaUpgradeRequest' documentation for how to add the listener to enable media upgrades from the sm-engaged-visitor widget."),zO.warn("Listener is not set for WIDGET_MEDIA_UPGRADE_REQUEST")}),(function(e){return zO.error("mediaUpgradeWithNoListenerObservable failed",e)})));q.add(g.subscribe((function(e){n.mediaState=e}),(function(e){return zO.error("mediaStateObservable failed",e)})));var ee=m({engagement:this,transfers:$,channelObservable:p,webRtcMode:f,statusObservable:I});b.start(ee),this.communicationWidget=b,V.start();var te=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return b.stop({mediaContinues:Boolean(e.isEngagementRestart)}),k.stop(),V.stop(),l(),U(),function(e){var t=e.cursorIdentifier,n=e.onRemove;if(!YP()){var r=XP(t||"#"+$P);if(r&&(r.parentElement.removeChild(r),n))n()}}({}),zO.info("Triggering ENGAGEMENT_END event"),iS.vent.trigger(iS.MSG.PUBLIC.ENGAGEMENT_END,n),q.unsubscribe()};this.start=function(){var e;n.isReestablishing||(e=["action:reach","stage:establish-engagement"],S.increment("engagement.flow",["entrypoint:".concat(T)].concat(e)));var t,r=iS.vent.trigger.bind(iS.vent,iS.MSG.ENGAGEMENT_TRANSFERRED);t={engagementObservable:ee},iS.reqres.setHandler("get:engagement_observables",Ee(t)),q.add($.subscribe((function(e){return function(e){n.operator=LN({id:e.operatorId,name:e.operatorName,formattedName:e.operatorFormattedName,picture:{url:e.operatorPicture},mediaType:e.operatorMedia,webRtcMode:f,enabledMediaType:d})}(e),r(e)}),(function(e){return zO.error("transfers observable failed",e)}))),q.add(D.subscribe(te,(function(e){return zO.error("engagementEndObservable",e)}))),iS.vent.trigger(iS.MSG.PUBLIC.ENGAGEMENT_START,n)},this.upgrade=function(e){if(w===ZA)return Promise.reject(new rI({cause:BA.SALEMOVE.NOT_SUPPORTED,message:"Unsupported functionality for OmniBrowse engagement"}));var t=n.operator.state.media,r=n.operator.state.oneWayMedias,i=sm.conf.communications.allow_upgrade_requests,o=n.mediaState.operator.media,s="phone"===o?"audio":o;return zO.info("Initiating media upgrade",{audio_type:e.audio,video_type:e.video,caller:(e?e.caller:void 0)||"client_integrator"}),wP({options:e,availableMediaTypes:t,availableOneWayMediaTypes:r,visitorUpgradesAllowed:i,highestAllowedMediaType:s}).then((function(){return k.requestMediaUpgrade(e)}))},this.end=function(){return te(),_.end().then(Ee({})).catch((function(e){return 422===(e?e.status:void 0)?(zO.warn("Engagement already ended",{reason:e.reason,error_status_code:e.status,engagement_id:n.engagementId}),Promise.reject(new rI({cause:BA.SALEMOVE.CONFLICT}))):De(e.status)?(zO.warn("Engagement end failed. No connection",{reason:e.reason,error_status_code:e.status,engagement_id:n.engagementId}),Promise.reject(new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT}))):e.status>500&&e.status<=504?(zO.warn("Engagement end failed. Service unavailable",{reason:e.reason,error_status_code:e.status,engagement_id:n.engagementId}),Promise.reject(new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT}))):(zO.error("Engagement end failed",{reason:e.reason,error_status_code:e.status,engagement_id:n.engagementId}),Promise.reject(new rI({cause:BA.SALEMOVE.INTERNAL_ERROR})))}))};var ne=new CO.Subject;this.notifyOfFocusChange=function(e){return ne.next(e)};var re=ne.asObservable().distinctUntilChanged().withLatestFrom(p,(function(e,t){return{target:e,channel:t.channel}})).subscribe((function(e){var t=e.target;return e.channel.emitAll("visitor:focus_changed",t)}),(function(e){return zO.error("notifyOfFocusEvents failed",e)}));q.add(re),q.add(B)}return s(e,[{key:"start",value:function(){}},{key:"upgrade",value:function(e){return null}},{key:"iframePage",value:function(e){return null}},{key:"wrapPage",value:function(e){}},{key:"getSurvey",value:function(){return null}},{key:"end",value:function(){return null}},{key:"notifyOfFocusChange",value:function(){return null}},{key:"startSalemoveViews",value:function(){zO.error("Private/undocumented Engagement#startSalemoveViews was used"),console.error("Usage of Engagement#startSalemoveViews is not supported")}},{key:"addEventListener",value:function(e,t){}},{key:"removeEventListener",value:function(e,t){}},{key:"recordEvent",value:function(e){return null}},{key:"uploadFile",value:function(e,t){return null}},{key:"getChatTranscript",value:function(){return null}}],[{key:"create",value:function(t){var n=t.engagementId,r=t.subEngagementId,i=t.startingMedia,o=t.mediaState,s=t.type,a=t.isReestablishing,u=t.initialChatHistoryObservable,c=t.operator,l=t.statsClient,f=t.channelObservable,d=t.platform,p=t.engagementApi,h=t.connectionStatusObservable,v=t.getRequestHeaders,b=t.internalVisitorStateObservable,m=t.entrypoint,g=t.volatileNotifications,y=t.statusObservable,_=t.pubsub,w=t.wsProxy,E=t.createdAt,O=t.cobrowser,S=b.map(dt(jn(ji("id",n)),Ai([],["engagement","engagements"]))),T=S.filter(gt).take(1),A=T.flatMap((function(){return S.filter(ot(gt)).switchMap((function(){return function(e){var t=e.engagementId,n=e.internalVisitorStateObservable,r=e.logger;return n.take(1).map((function(e){var n=Ai([],["engagement","ended_engagements"],e),i=jn(ji("id",t),n),o=Boolean(i&&Gt(i.end_reason,Uj));return o&&r.info("Received engagement end signal with authentication end_reason. Initiating engagement restart",{engagement_id:t}),{isEngagementRestart:o}}))}({engagementId:n,internalVisitorStateObservable:b,logger:zO})})).take(1)})),I=iS.vent.observable("engagement:prepare_for_restart").map(Ee({isEngagementRestart:!0})),k=CO.Observable.merge(A,I).take(1),x=f.switchMap((function(e){return e.channel.observable("visitor:state_changed")})),M=T.map(ge("transferrable_sites")),N=jO(),R=M.flatMap((function(e){var t=e.map((function(e){return e.id}));return _.joinSiteVisitorNotifications(N,t)})),C=sm.conf.engagement.api_timeout_milliseconds||zA,P=Rj({visitorId:jO(),engagementId:n,volatileNotifications:g,engagementStateObservable:S,apiTimeoutMilliseconds:C,wsProxy:w,stats:l,channelObservable:f});zO.info("Starting medra communication controller");var j=iS.request("comms:create_controller",{getRequestHeaders:v,visitorAppConf:sm.conf.visitor_app,statsClient:l,volatileNotifications:g,comms:P,pubsub:_,localCapabilities:Mj(),onMediaUpgrade:function(e){return p.createMediaUpgrade(e).subscribe(zO.log.bind(zO,"Media upgrade successfully created"),zO.warn.bind(zO,"Failed to create media upgrade"))}}),L=function(e){var t=e.mediaState,n=e.mediaStateChanges,r=t?Ds.of(t):Ds.of(new EP({visitor:{media:"text",audioMuted:!1,videoMuted:!1},operator:{media:"text",audioMuted:!1,videoMuted:!1}}));return n.pipe(Td(r),Ka(Wt(EP)))}({mediaState:o,mediaStateChanges:j.mediaStateChanges()}),U=CO.Observable.merge(u,jR({engagementId:n,connectionStatusObservable:h})),q=sm.conf.masking_regular_expressions;q||(zO.error("Failed to fetch masking_regular_expressions for site",{site_id:sm.siteId,visitor_id:jO()}),q=[]);var D=BC.create({chatHistoryObservable:U,engagementEndObservable:k,engagementId:n,statsClient:l,getRequestHeaders:v,siteVisitorNotifications:R,maskingRegularExpressions:q}),V=D.chat,F=D.stopChat,H={end:function(){return p.endEngagement({engagementId:n}).toPromise()},chatTranscript:function(){return p.getChatTranscript(n).map(Lt((function(e){var t=e.sender.type;return Gt(t,["operator","visitor"])}))).toPromise()}},W=ON(),G=sm.conf.communications.enabled_media_level,B=function(e){var t=e.engagementId,n=e.wsProxy,r=e.apiTimeoutMilliseconds,i=e.stats,o=AP({stats:i,protocol:"rest",failureTagProperty:"message",timeout:r,timeoutError:CO.Observable.throw(Cj)});return{recordEvent:function(e){return o({resource:"record-event",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/events"),payload:e,headers:eI}).catch(aI,{allowedCauses:[BA.SALEMOVE.INVALID_INPUT,BA.SALEMOVE.NETWORK_TIMEOUT]})})).toPromise()}}}({engagementId:n,wsProxy:w,apiTimeoutMilliseconds:C,stats:l}),z=function(e){var t=e.engagementId,n=e.wsProxy,r=e.apiTimeoutMilliseconds,i=e.stats,o=AP({stats:i,protocol:"rest",failureTagProperty:"message",timeout:r,timeoutError:CO.Observable.throw(IP)}),s=function(e){return 409===e.status?(zO.warn("Survey was not accepted because at least some answers were not unique for engagement. This could happen when survey was answered twice for the same engagement.",{engagement_id:t}),CO.Observable.throw(new rI({cause:BA.SALEMOVE.CONFLICT}))):aI(e)},a=function(e){var r=e.surveyId,i=e.answers;return o({resource:"survey-answers-post",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/surveys/").concat(r,"/answers"),payload:{engagement_id:t,answers:i},headers:eI}).catch(s)})).toPromise()};return{fetchSurvey:function(){return o({resource:"survey-request",method:"get"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/survey"),payload:null,headers:eI}).catch(aI)})).map((function(e){return new TP(e,a)})).toPromise()},saveSurveyAnswers:a}}({engagementId:n,wsProxy:w,apiTimeoutMilliseconds:C,stats:l});return i&&(c=function(e,t){var n=e.media,r=e.enabledMediaType,i=e.webRtcMode;if(or(n,t.state.medias)>-1)return t;var o=TN[n];return dt(RN({enabledMediaType:r,webRtcMode:i}),Yi(IN,o),Yi(AN,o))(t)}({media:i,enabledMediaType:G,webRtcMode:W},c)),new e({engagementId:n,subEngagementId:r,engagementEndObservable:k,startingMedia:i,type:s,isReestablishing:a,chat:V,stopChat:F,webRtcMode:W,enabledMediaLevel:G,channelObservable:f,operator:c,operatorFocusObservable:x,communicationWidget:j,createEngagementObservable:hP,mediaStateObservable:L,backend:H,platform:d,startScreenSharing:JP.start,stateObservable:S.filter(gt).distinctUntilChanged(At),statsClient:l,entrypoint:m,volatileNotifications:g,statusObservable:y,comms:P,events:B,surveyApi:z,getRequestHeaders:v,siteVisitorNotifications:R,createdAt:E,cobrowser:O})}}]),e}();Bj.prototype.SCAN_EVENT_REPLAY_COUNT=100,Bj.prototype.EVENTS={END:"end",STATE_CHANGE:"state_change",CAPABILITIES:"capabilities",MEDIA_UPGRADE_OFFER:"media_upgrade_offer",FOCUS:"focus",MEDIA_STATE_CHANGE:"media_state_change",COBROWSING_REQUEST:"cobrowsing_request",MEDIA_PERMISSION_REQUEST:"media_permission_request",WIDGET_MEDIA_UPGRADE_REQUEST:"widget_media_upgrade_request",CUSTOM_COMMAND:"custom_command"},Bj.prototype.ENGAGEMENT_END_EVENT_PAYLOAD_KEYS=["isEngagementRestart"],Bj.prototype.FOCUS_TARGETS={CHAT:"chat",COBROWSER:"cobrowse"},Bj.prototype.MEDIA_TYPES={TEXT:"text",AUDIO:"audio",PHONE:"phone",VIDEO:"video"},Bj.prototype.ON_END_VALUES={RETAIN:"retain",SHOW_SURVEY:"show_survey",SHOW_ENDED_NOTIFICATION:"show_ended_notification"};var zj=function(e){var t,n,r=e.api,i=e.conf,o=e.operatorsObservable,s=e.media,a=e.options,u=e.statsClient,c=e.channelObservable,l=e.cobrowser,f=e.engagementApi,d=e.webRtcMode,p=e.enabledMediaLevel,h=e.connectionStatusObservable,v=e.getRequestHeaders,b=e.internalVisitorStateObservable,m=e.volatileNotifications,g=e.statusObservable,y=e.pubsub,_=e.wsProxy,w=e.dynamicImport,E=new CO.AsyncSubject,O=DR({media:s,mediaOptions:a,mediaValidation:_P,api:r,notifyOfTimeout:iS.vent.trigger.bind(iS.vent,iS.MSG.REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT),operatorsObservable:o,engagementCoreObservable:w("Comms"),channelObservable:c,serverResponseTimeout:zA,communicationLib:i.communications.lib,engagementApi:f,webRtcMode:d,enabledMediaLevel:p,statsClient:u}),S=O.requestObservable,T=O.resultObservable,A=PT(E),I=T.merge(A).take(1).map((function(e){return Jr(e,{statsClient:u,connectionStatusObservable:h,getRequestHeaders:v,internalVisitorStateObservable:b,volatileNotifications:m,statusObservable:g,pubsub:y,cobrowser:l,wsProxy:_})})).map(Bj.create).do(Er(0,"start")).catch(sI);return{operatorObservable:(t=S,n=A,t.pipe(Ka(ge("operator")),Td(n),Yf(1))).catch(sI),engagementObservable:I,cancelEngagementRequest:function(){return function(e){var t=e.api,n=e.requestObservable,r=e.resultErrorSubject,i=e.statsClient;return n.catch((function(){return CO.Observable.of({requestNotCreated:!0})})).flatMap((function(e){var n=e.engagementRequestId;return e.requestNotCreated?CO.Observable.of({}):t.cancel({id:n}).do((function(){return r.next(new rI({cause:BA.SALEMOVE.CANCEL}))})).do((function(){return i.increment("engagement.flow",["entrypoint:reactive-request","action:end","stage:requested","expected:true","reason:cancel"])}))}))}({statsClient:u,api:r,requestObservable:S,resultErrorSubject:E}).toPromise()},engagementRequestTimeout:1e3*i.engagement.reactive_call_timeout}},Jj=s((function e(t){var n=t.timeout,r=t.engagementPromise,o=t.cancel,s=t.operatorPromise;i(this,e),this.timeout=n,this.engagementPromise=r,this.cancel=o,this.operatorPromise=s})),Qj=function(e){f(n,e);var t=a(n);function n(){var e;return i(this,n),(e=t.call(this))._currentSubscription=WR.Subscription.EMPTY,e}return s(n,[{key:"add",value:function(e){if(!this.closed)return"function"==typeof e&&(e=new WR.Subscription(e)),this._currentSubscription&&(this.remove(this._currentSubscription),this._currentSubscription.unsubscribe(),this._currentSubscription=null),c(l(n.prototype),"add",this).call(this,this._currentSubscription=e),this}}]),n}(WR.Subscription),Yj=s((function e(t,n){i(this,e),this.code=t,this.validDuration=n})),Kj=function(){function e(t){i(this,e);var n=t.incomingEngagementRequestObservable,r=t.setOmnibrowseReestablishHandler,o=t.statsClient,s=t.wsProxy,a=new Qj,u=n.filter(ji("platform",ZA)).map(ge("incomingEngagementRequest"));this.setIncomingEngagementRequestHandler=function(e){return a.add(u.subscribe(e,(function(e){return zO.error("incomingOmniBrowseEngagementObservable failed",e)})))},this.setEngagementReestablishHandler=r,this.getVisitorCode=function(){return AP({stats:o,protocol:"rest",failureTagProperty:"error",timeout:zA,timeoutError:CO.Observable.throw(new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT}))})({resource:"omnibrowse",method:"get"},(function(){return s.request({method:"GET",url:"".concat(sm.conf.api_url,"/omnibrowse/sites/").concat(DO(),"/visitor_code/").concat(jO()),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})})).map((function(e){var t=Date.parse(e.expires_at)-new Date;return new Yj(e.code,t)})).catch(dt(CO.Observable.throw,Ro(Or(rI),Ee(new rI({cause:BA.SALEMOVE.INTERNAL_ERROR}))))).do(null,(function(e){return zO.warn("Fetching visitor code failed",{site_id:sm.siteId,err:e})})).toPromise()}}return s(e,[{key:"setIncomingEngagementRequestHandler",value:function(e){}},{key:"setEngagementReestablishHandler",value:function(e){}},{key:"getVisitorCode",value:function(){return null}}]),e}(),Xj=s((function e(t){var n=t.text,r=t.noOperatorsOnlineText,o=t.duration,s=t.priority;i(this,e),this.text=n,this.noOperatorsOnlineText=r,this.duration=o,this.priority=s})),$j=s((function e(t){i(this,e),this.duration=t})),Zj=s((function e(t){var n=t.verticalOffset,r=t.horizontalOffset;i(this,e),this.verticalOffset=n,this.horizontalOffset=r})),eL=s((function e(t){i(this,e),this.text=t})),tL=s((function e(t,n){i(this,e),this.text=t,this.duration=n})),nL=s((function e(t){var n=t.operatorListReady,r=t.isOmniqEnabled,o=t.queueStateReady,s=t.routingObservable;i(this,e);var a=function(e){return r?e.flatMap((function(e){return CO.Observable.combineLatest(s,o).take(1).mapTo(e)})):e.flatMap((function(e){return n.mapTo(e)}))},u=iS.vent.observable("reactive_bar:enable").map(Ee({})),c=iS.vent.observable("reactive_bar:disable").map(Ee({})),l=iS.vent.observable("reactive_bar:set_position").map((function(e){return new Zj(e)})),f=iS.vent.observable("trigger_expand_reactive").map((function(e){return new $j(e.duration)})),d=iS.vent.observable("trigger_media_selection").map((function(e){return new eL(e.text)})),p=iS.vent.observable("trigger_reactive_callout").map((function(e){return new Xj({text:e.text,noOperatorsOnlineText:e.noOperatorsOnlineText,duration:e.duration,priority:e.priority})})),h=iS.vent.observable("show_engagement_invitation").map((function(e){return new tL(e.text,e.duration)})),v=zn([[this.EVENTS.REACTIVE_ENABLE,u],[this.EVENTS.REACTIVE_DISABLE,c],[this.EVENTS.REACTIVE_SET_POSITION,l],[this.EVENTS.REACTIVE_EXPAND,a(f)],[this.EVENTS.MEDIA_SELECTION_START,a(d)],[this.EVENTS.REACTIVE_CALLOUT_START,a(p)],[this.EVENTS.ENGAGEMENT_INVITATION_SHOW,a(h)]]),b=FI();b.proxyAll(v);var m=HI();m.proxyAll(v),this.addUnbufferedEventListener=b.addEventListener,this.removeUnbufferedEventListener=b.removeEventListener,this.addBufferedEventListener=m.addEventListener,this.removeBufferedEventListener=m.removeEventListener,this.observable=function(e){return b.observable(e)},this.bufferedObservable=function(e){return m.observable(e)}}));nL.prototype.EVENTS={REACTIVE_ENABLE:"overseer:reactive_enable",REACTIVE_DISABLE:"overseer:reactive_disable",REACTIVE_SET_POSITION:"overseer:reactive_set_position",REACTIVE_EXPAND:"overseer:reactive_expand",MEDIA_SELECTION_START:"overseer:media_selection_start",REACTIVE_CALLOUT_START:"overseer:reactive_callout_start",ENGAGEMENT_INVITATION_SHOW:"overseer:engagement_invitation_show"};var rL,iL=function(){function e(){i(this,e),this.EVENTS={ENGAGEMENT_REQUEST:"omnicall:engagement_request",PHONE_NUMBER_AVAILABLE:"omnicall:phone_number_available"};var t=zn([[this.EVENTS.ENGAGEMENT_REQUEST,CO.Observable.never()],[this.EVENTS.PHONE_NUMBER_AVAILABLE,CO.Observable.never()]]),n=FI();n.proxyAll(t),this.addEventListener=n.addEventListener,this.removeEventListener=n.removeEventListener,this.observable=function(e){return t[e]}}return s(e,[{key:"addEventListener",value:function(e,t){}},{key:"removeEventListener",value:function(e,t){}}]),e}(),oL=s((function e(){i(this,e),this.url=sm.conf.visitor_app.site_logo.url})),sL=function(){function e(){i(this,e),this.visibleOperatorCount=sm.conf.visitor_app.reactive_tab.visible_operator_count,this.backColor=sm.conf.visitor_app.reactive_tab.back_color,this.fontSize=sm.conf.visitor_app.reactive_tab.font_size,this.format=sm.conf.visitor_app.reactive_tab.format,this.frontColor=sm.conf.visitor_app.reactive_tab.front_color,this.iconType=this._iconClassToType(sm.conf.visitor_app.reactive_tab.icon_class),this.placement=sm.conf.visitor_app.reactive_tab.placement,this.size=sm.conf.visitor_app.reactive_tab.size,this.text=sm.conf.visitor_app.reactive_tab.text,this.useLocalesForText=sm.conf.visitor_app.reactive_tab.use_locales_for_text,this.verticalOffset=sm.conf.visitor_app.reactive_tab.vertical_offset}return s(e,[{key:"_iconClassToType",value:function(e){switch(e){case"ico-voice":return"audio";case"ico-video":return"video";case"ico-text":return"text";default:return zO.error("Unknown icon class of the reactive tab",e),"video"}}}]),e}(),aL=s((function e(){i(this,e),this.apiUrl=sm.conf.api_url,this.alwaysUseDefaultOperatorPicture=sm.conf.visitor_app.always_use_default_operator_picture,this.visitorPageAdaption=sm.conf.visitor_app.visitor_page_adaption,this.engagementMode=function(e){switch(e.visitor_app.visitor_page_adaption){case"div":default:return"iframeless";case"iframe":return"iframed";case"style":return"nowrap"}}(sm.conf),this.offlineMessagesEnabled=sm.conf.visitor_app.reactive_tab.contact_when_unstaffed,this.reactiveTabEnabled=sm.conf.visitor_app.reactive_tab.enabled,this.widgetMode=sm.conf.visitor_app.widget_mode,this.showReactiveTabWhenOperatorsUnavailable=sm.conf.visitor_app.reactive_tab.show_unavailable,this.theme=sm.conf.visitor_app.theme,this.isCustomTheme=sm.conf.visitor_app.is_custom_theme,this.locale=sm.conf.visitor_app.visitor_app_default_locale,this.reactiveTabVisuals=new sL,this.siteLogo=new oL,this.queuingEnabled=sm.conf.omniq.omniq_enabled,this.panelPosition=sm.conf.visitor_app.reactive_tab.position,this.phoneExtensionEnabled=sm.conf.visitor_app.phone_extension_enabled,this.phoneNumberDefaultCountry=sm.conf.visitor_app.phone_number_default_country,this.hideVisitorInfo=sm.conf.visitor_app.hide_visitor_info_in_visitor_app,this.publicVisitorContactInformationChangesAllowed=sm.conf.visitor_app.public_visitor_contact_information_changes_allowed,this.enableVisitorTranscriptDownload=sm.conf.visitor_app.enable_visitor_transcript_download,this.watchForNewContactOperatorIntegrations=!1!==sm.conf.visitor_app.watch_for_new_contact_operator_integrations,this.engagementInvitationAudio=sm.conf.visitor_app.engagement_invitation_audio})),uL=function(e,t,n,r){e||(e={}),n||(n=[]),r||(r=CO.Scheduler.asap);var i=e,o=i.phone,s=i.email;if(!o&&!s)return CO.Observable.throw({cause:BA.SALEMOVE.INVALID_INPUT,message:"Either phone or email must be specified"});var a=t.createApiRequestObservable,u=t.serverResponseTimeout;return a(ki(Vt(["name","phone","email","message"],n),e)).pipe(Ka((function(){return{}})),hf((function(e){return CO.Observable.throw(Pj(e))})),Cp(u,CO.Observable.throw(new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT,message:"Leave message request timed out"})),r),Ap(null,tr(ji("cause",BA.SALEMOVE.TOO_MANY_REQUESTS),zO.warn.bind(zO,"Leaving a message failed: too many requests"),zO.info.bind(zO,"Leaving a message failed"))),Yf(1))},cL=function(e,t){return function(e,t){return MI({method:"GET",url:e,responseType:"blob",getRequestHeaders:t})}(e,t).map((function(e){return e.response})).catch((function(e){return CO.Observable.throw(Pj(e))})).do(null,tr(ji("cause",BA.SALEMOVE.TOO_MANY_REQUESTS),zO.warn.bind(zO,"Requesting asset failed: too many requests"),zO.info.bind(zO,"Requesting asset failed"))).take(1)},lL=function(){function e(t){var n=t.id,r=t.api,o=t.operator,s=t.restrictedOperator,a=t.cobraObservable,u=t.channelObservable,c=t.message,l=t.logoUrl,f=t.platform,d=t.timeout,p=t.engagementApi,h=t.statsClient,v=t.cobrowser,b=t.communicationLib,m=t.notifyOfAccept,g=t.notifyOfDecline,y=t.createEngagement,_=t.cobraLoadTimeout,w=t.connectionStatusObservable,E=t.getRequestHeaders,O=t.internalVisitorStateObservable,S=t.volatileNotifications,T=t.statusObservable,A=t.pubsub,I=t.wsProxy;i(this,e),this.message=c,this.timeout=d,this.operator=s,this.logo={url:l};var k=new CO.AsyncSubject,x=k.merge(PT(CO.Observable.merge(r.canceledObservable.map(Ee(new rI({cause:BA.SALEMOVE.CANCEL}))),r.timedOutObservable.map(Ee(new rI({cause:BA.SALEMOVE.TIMEOUT})))))).take(1).flatMap((function(e){return a.map((function(t){return Jr({cobra:t},e)})).take(1).timeoutWith(_,CO.Observable.throw(new rI({cause:BA.SALEMOVE.INTERNAL_ERROR,message:"Cobra load timeout exceeded"})).do(null,(function(e){return zO.warn("Cobra loading timed out",e)}))).do(null,(function(t){return zO.warn("Loading cobra failed, ending engagement",t),p.endEngagement({engagementId:e.engagementId,reason:"error",subReason:"visitor_cobra_load_failure"}).take(1).subscribe(zO.log.bind(zO,"Successfully ended engagement after cobra load failure"),zO.warn.bind(zO,"Failed to end engagement after cobra load failure"))})).map((function(e){var t=e.engagementId,n=e.subEngagementId,r=e.media,i=e.cobra,s=e.createdAt;return y({operator:o,engagementId:t,subEngagementId:n,startingMedia:r,type:"proactive",isReestablishing:!1,initialChatHistoryObservable:PR(t),communicationLib:b,statsClient:h,cobra:i,channelObservable:u,platform:f,engagementApi:p,connectionStatusObservable:w,getRequestHeaders:E,internalVisitorStateObservable:O,entrypoint:"proactive-request",volatileNotifications:S,statusObservable:T,pubsub:A,wsProxy:I,createdAt:s,cobrowser:v})})).do((function(e){return e.start()})).catch(sI)}));this.engagementPromise=x.toPromise(),this.accept=function(){return r.acknowledge({id:n}).do((function(){return m({engagement_request_id:n,operator:o})})).do((function(){return zO.info("Engagement: Proactive request accepted",{operator:o})})).mapTo({}).catch(sI).toPromise()},this.selectMedia=function(e,t){if(f===ZA&&"text"!==e)return Promise.reject(new rI({cause:BA.SALEMOVE.NOT_SUPPORTED,message:"OmniBrowse engagements only support text media."}));var i=s.state.medias,a=uN(s.state.oneWayMedias),u=t||{},c=u.phoneNumber,l=u.phoneExtension,d=u.oneWay;return _P({options:t,availableMediaTypes:i,availableOneWayMediaTypes:a,media:e}).then((function(){return m({engagement_request_id:n,operator:o}),r.accept({id:n,selectedMedia:e,mediaOptions:{phoneNumber:c,phoneExtension:l,oneWay:d}}).do((function(){sm.logger.info("Engagement: Proactive request media selected",arguments[0])})).map((function(t){return Jr(t,{media:e})})).do(k).mapTo({}).catch(sI).toPromise()}))},this.decline=function(){return r.decline({id:n}).do((function(){return g({operator:o})})).do((function(){return k.error(new rI({cause:BA.SALEMOVE.DECLINE}))})).do((function(){return sm.logger.info("Engagement, Proactive request declined",arguments[0])})).mapTo({}).catch(sI).toPromise()}}return s(e,null,[{key:"create",value:function(t){var n=t.api,r=t.id,i=t.operator,o=t.restrictedOperator,s=t.message,a=t.logoUrl,u=t.platform,c=t.timeout,l=t.statsClient,f=t.cobraObservable,d=t.channelObservable,p=t.engagementApi,h=t.connectionStatusObservable,v=t.getRequestHeaders,b=t.internalVisitorStateObservable,m=t.volatileNotifications,g=t.statusObservable,y=t.pubsub,_=t.wsProxy,w=t.cobrowser;return new e({api:n,id:r,statsClient:l,communicationLib:sm.conf.communications.lib,createEngagement:Bj.create,cobraObservable:f,operator:i,restrictedOperator:o,platform:u,timeout:c,message:s,logoUrl:a,cobraLoadTimeout:1e4,notifyOfAccept:iS.vent.trigger.bind(iS.vent,iS.MSG.PROACTIVE_ACCEPT),notifyOfDecline:iS.vent.trigger.bind(iS.vent,iS.MSG.PROACTIVE_DECLINE),channelObservable:d,engagementApi:p,connectionStatusObservable:h,getRequestHeaders:v,internalVisitorStateObservable:b,volatileNotifications:m,statusObservable:g,pubsub:y,wsProxy:_,cobrowser:w})}}]),e}(),fL=function(e,t){return t.pipe(Gu((function(t){var n=function(e,t){return dt(jn(ji("id",e)),Ai([],JC))(t)}(e.id,t);return Boolean(n.outcome)})),Yf(1),Ka((function(t){var n=ZC(t);return n&&n.operator.id===e.operator.id?n:null})),Gu(gt))},dL=function(e){var t=e.channelObservable,n=e.internalVisitorStateObservable,r=e.statusObservable,i=e.webRtcMode,o=e.enabledMediaLevel,s=e.statsClient,a=e.isEngagedObservable,u=e.engagementApi,c=e.connectionStatusObservable,l=e.getRequestHeaders,f=e.volatileNotifications,d=e.pubsub,p=e.wsProxy,h=e.cobrowser,v=e.dynamicImport,m=function(e){var t=e.pipe(Zl(2,1),Ka((function(e){var t=b(e,2),n=t[0],r=t[1],i=eP(n),o=ZC(r),s=o&&i,a=o&&n.visitor_id!==r.visitor_id,u=o&&!me(["engagement","engagements",0],n)&&me(["engagement","engagements",0,"restarted_from_engagement_id"],r);return s||a||u?o:null})),Gu(gt));return e.pipe(Yf(1),Mu((function(t){var n=CO.Observable.of(t).map(ZC).filter(gt),r=tP(t),i=r?fL(r,e):CO.Observable.empty();return CO.Observable.merge(n,i)})),Td(t),Ka((function(e){return{id:e.id,platform:e.platform,subEngagementId:e.sub_engagement_legacy_id,channelUrl:e.channel_url,operatorId:e.operator.id,operatorName:e.operator.name,operatorFormattedName:e.operator.formatted_name,operatorMediaType:e.operator.media_type,operatorPicture:{url:e.operator.picture_url},entrypoint:e.entrypoint,createdAt:e.start_time}})))}(n);return function(e){var t=e.reestablishRequestObservable,n=e.isEngagedObservable;return t.pipe(Zp(n,(function(e,t){return{engagementReestablishMessage:e,isEngaged:t}})),Ap((function(e){e.isEngaged?zO.info("Found an ongoing engagement during engagement reestablishing, skipping"):zO.info("Reestablishing ongoing engagement")})),Gu((function(e){return!e.isEngaged})),Ka((function(e){return e.engagementReestablishMessage})))}({reestablishRequestObservable:m,isEngagedObservable:a}).flatMap((function(e){return v("Comms").mapTo(e)})).observeOn(CO.Scheduler.asap).map((function(e){var a=LN({id:e.operatorId,name:e.operatorName,formattedName:e.operatorFormattedName,picture:e.operatorPicture,mediaType:e.operatorMediaType,webRtcMode:i,enabledMediaType:o}),v=Bj.create({engagementId:e.id,subEngagementId:e.subEngagementId,initialChatHistoryObservable:PR(e.id),operator:a,isReestablishing:!0,mediaState:e.mediaState,platform:e.platform,communicationLib:sm.conf.communications.lib,statsClient:s,channelObservable:t,engagementApi:u,connectionStatusObservable:c,getRequestHeaders:l,internalVisitorStateObservable:n,entrypoint:e.entrypoint,volatileNotifications:f,statusObservable:r,pubsub:d,wsProxy:p,createdAt:e.createdAt,cobrowser:h});return v.start(),{engagement:v,platform:e.platform}}))},pL=function(e){var t=e.replayedReestablishObservable,n=e.defaultHandler,r=e.storeKey,i=e.platform,o=e.sessionStore,s=e.timeout,a=new Qj,u=t.filter(ji("platform",i)).map(ge("engagement")),c=function(e){return a.add(u.subscribe(e,(function(e){return zO.error("platformSpecificReestablishObservable failed",e)})))},l=new CO.Subject;return c((function(e){return o.get(r)?CO.Observable.timer(s).takeUntil(l).subscribe((function(){return o.remove(r),zO.error("Waited for custom reestablish handler to be set, but it wasn't set before timeout."),l.subscribe((function(){return zO.error("Custom reestablish handler was set, but after timeout."),console.error("Salemove#setEngagementReestablishHandler() was called too late!"+" Glia waits ".concat(Math.round(15)," seconds after page load")+" for the custom reestablish handler to be set. Executing the handler anyway, although the default handler has already been called.")})),n(e)})):n(e)})),function(e){c(e),l.next(e),o.set(r,!0)}},hL=s((function e(t){var n=t.engaged,r=t.name,o=t.email;i(this,e),this.engaged=n,this.name=r,this.email=o})),vL=s((function e(t){var n=t.connected;i(this,e),this.connected=n})),bL="__sm_mutation_event_trigger_flip__",mL=new rI({cause:BA.SALEMOVE.INTERNAL_ERROR}),gL=function(e,t){var n=e.wsProxy,r=e.stats,i=e.apiTimeoutMilliseconds;t||(t=CO.Scheduler.asap);var o=function(){return AP({stats:r,protocol:"rest",failureTagProperty:"message",timeout:i,timeoutError:CO.Observable.throw(mL),scheduler:t})};return{createMediaUpgrade:function(e){var t=e.engagementId,r=e.media;return o()({resource:"media-upgrade",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/media_upgrades"),payload:{media:r},headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))},getChatTranscript:function(e){return o()({resource:"chat-transcript",method:"fetch"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/engagements/").concat(e,"/chat_transcript"),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))},endEngagement:function(e){var t=e.engagementId,r=dt(qe("action","end"),FA({subReason:"sub_reason"}),ki(["reason","subReason"]))(e);return o()({resource:"engagement",method:"end"},(function(){return n.request({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagements/").concat(t),payload:r,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))}}},yL=new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT}),_L={"'operator_id' Operator is not available to be engaged":BA.SALEMOVE.OPERATOR_UNAVAILABLE,"Operator cannot be engaged":BA.SALEMOVE.OPERATOR_UNAVAILABLE,"Visitor cannot be engaged":BA.SALEMOVE.ALREADY_ENGAGED,"'engagement_request_id' already failed":BA.SALEMOVE.CONFLICT,"'engagement_request_id' already accepted":BA.SALEMOVE.CONFLICT,"'engagement_request_id' already acknowledged":BA.SALEMOVE.CONFLICT},wL=(u(rL={},403,BA.SALEMOVE.FORBIDDEN),u(rL,409,BA.SALEMOVE.CONFLICT),rL),EL=["'engagement_request_id' already failed","'engagement_request_id' already accepted","'engagement_request_id' already acknowledged"],OL=function(e,t,n){var r=Jr(n,{error:e});e&&Gt(e.message,EL)||e instanceof rI?zO.warn("Failed to ".concat(t," engagement request"),r):zO.error("Failed to ".concat(t," engagement request"),r)},SL=function(e){var t=_L[e&&e.message]||wL[e&&e.status]||BA.SALEMOVE.INTERNAL_ERROR;return new rI({cause:t})},TL=function(e,t){var n,r=e.wsProxy,i=e.stats,o=e.apiTimeoutMilliseconds,s=e.visitorMetadata,a=e.internalVisitorStateObservable,u=e.getRequestHeaders,c=e.conf;t||(t=CO.Scheduler.asap);var l,f,d=AP({stats:i,protocol:"rest",failureTagProperty:"cause",timeout:o,timeoutError:CO.Observable.throw(yL),scheduler:t});if(!1!==(null===(n=c.visitor_api)||void 0===n?void 0:n.use_ws_proxy))l=function(e){return r.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagement_requests"),payload:e,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}})},f=function(e){var t=e.id,n=e.data;return r.request({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagement_requests/").concat(t),payload:n,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}})};else{var p=function(e){return CO.Observable.throwError(h(h({},e.response),{},{status:e.status}))},v=ge("response"),m=function(){return h(h({},u.apply(void 0,arguments)),{},{"x-salemove-tab-id":sm.tabId})};l=function(e){return MI({method:"POST",url:"".concat(sm.conf.api_url,"/engagement_requests"),payload:e,responseType:"json",contentType:"application/json",getRequestHeaders:m}).map(v).catch(p)},f=function(e){var t=e.id,n=e.data;return MI({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagement_requests/").concat(t),payload:n,responseType:"json",contentType:"application/json",getRequestHeaders:m}).map(v).catch(p)}}var g=function(e){i.increment("engagement.flow",["entrypoint:proactive-request","stage:requested","action:end"].concat(e))},y=a.pipe(Ka(XC),Zl(2,1),Gu((function(e){var t=b(e,2),n=t[0],r=t[1];return!n&&Boolean(r)})),Ka((function(e){var t=b(e,2);return t[0],t[1]}))),_=y.pipe(Gu($C),Ap((function(e){var t=e.id;return zO.info("Found new accepted engagement",{engagement_id:t})})),Ka((function(e){return{engagementId:e.id,subEngagementId:e.sub_engagement_legacy_id,operatorId:e.operator.id,operatorMediaType:e.operator.media_type,operatorName:e.operator.name,operatorFormattedName:e.operator.formatted_name,operatorPicture:{url:e.operator.picture_url},media:dP(e.media),entrypoint:e.entrypoint,platform:e.platform,createdAt:e.start_time}}))),w=y.pipe(Gu(ot($C)),yd({})),E=function(e){var t=ji("site_id",sm.siteId);return dt(Lt(t),Ai([],["engagement","requests"]))(e)},O=dt(ve(0),Lt(ji("outcome",null)),E),S=function(e){return dt(ve(0),Lt(ji("id",e)),E)},T=a.pipe(Ka(O),Gu(gt)),A=Je((function(e,t){return a.pipe(Ka(S(t.id)),Gu(gt),Gu((function(t){return Gt(t.outcome,e)})),Yf(1),wp(function(e,t){return a.pipe(Ka(S(e.id)),Gu(gt),Gu((function(e){return!Gt(e.outcome,t)})))}(t,Ne(null,e))))})),I=T.pipe(Mu(A(["operator_cancel","operator_left"])),yd({})),k=CO.Observable.merge(w,I),x=T.pipe(Mu(A(["timed_out"])),yd({}));return{create:function(e){var t=e.operatorId,n=e.siteId,r=e.media,i=e.source,o=e.mediaOptions,a={operator_id:t,site_id:n,media:r,source:i||"sdk",visitor_metadata:s,media_options:{phone_number:o.phoneNumber,phone_extension:o.phoneExtension,one_way:o.oneWay}};return zO.info("Engagement: Sending reactive request",a),d({resource:"engagement-request",method:"create"},(function(){return l(a).map((function(e){var t=e.timeout;return{engagementRequestId:e.id,acknowledgeTimeoutSeconds:t}})).catch((function(e){var s={error:e,operator_id:t,site_id:n,media:r,source:i,media_options:o};return e instanceof rI?(zO.info("Failed to create engagement request",s),CO.Observable.throw(e)):(403===(e&&e.status)?zO.info("Visitor forbidden to create engagement request",s):422===(e&&e.status)?zO.info("Operator is not available to be engaged",s):409===(e&&e.status)?zO.info("Operator cannot be engaged",s):zO.error("Failed to create engagement request",s),CO.Observable.throw(SL(e)))}))}))},cancel:function(e){var t=e.id,n="cancel";return d({resource:"engagement-request",method:n},(function(){return f({id:t,data:{action:n}}).catch((function(e){return OL(e,n,{engagement_request_id:t}),CO.Observable.throw(SL(e))}))}))},acknowledge:function(e){var t=e.id,n="acknowledge";return d({resource:"engagement-request",method:n},(function(){return f({id:t,data:{action:n}}).catch((function(e){return OL(e,n,{engagement_request_id:t}),CO.Observable.throw(SL(e))})).do(null,(function(e){e.cause===BA.SALEMOVE.INTERNAL_ERROR?g(["reason:internal-error"]):e.cause!==BA.SALEMOVE.CONFLICT&&g(["reason:unknown"])}))}))},accept:function(e){var t=e.id,n=e.selectedMedia,r=e.mediaOptions,i="accept";return d({resource:"engagement-request",method:i},(function(){return f({id:t,data:{action:i,media:n,media_options:{phone_number:r.phoneNumber,phone_extension:r.phoneExtension,one_way:r.oneWay},visitor_metadata:s}}).catch((function(e){return OL(e,i,{engagement_request_id:t,media:n,media_options:r}),CO.Observable.throw(SL(e))})).do(null,(function(e){e.cause===BA.SALEMOVE.INTERNAL_ERROR?g(["reason:internal-error"]):e.cause!==BA.SALEMOVE.CONFLICT&&g(["reason:unknown"])})).map(FA({engagement_id:"engagementId",sub_engagement_id:"subEngagementId",created_at:"createdAt"}))}))},decline:function(e){var t=e.id,n="decline";return d({resource:"engagement-request",method:n},(function(){return f({id:t,data:{action:n}}).catch((function(e){return OL(e,n,{engagement_request_id:t}),CO.Observable.throw(SL(e))}))}))},notifyOfReactiveFailure:function(e){var t=e.id;return d({resource:"engagement-request",method:"cancel-due-to-error"},(function(){return f({id:t,data:{action:"cancel",reason:"error"}}).catch((function(e){return CO.Observable.throw(SL(e))})).do(null,zO.warn.bind(zO,"Failed to cancel reactive engagement request due to error"))}))},acceptedObservable:_,declinedObservable:T.pipe(Mu(A(["rejected"])),yd({})),canceledObservable:k,timedOutObservable:x}},AL=["name","email","phone","note","customAttributes","customAttributesUpdateMethod"],IL={customAttributes:"custom_attributes",customAttributesUpdateMethod:"custom_attributes_update_method"},kL="last_known_ci:".concat(DO()),xL=function(e){var t=jO(),n=JSON.stringify(e);return function(e){for(var t=0,n=0,r=e.length;n<r;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}(Math.floor(Date.now()/864e5).toString()+t+n).toString()},ML=new ZN,NL=0,RL=function(e,t,n){var r;n||(n=CO.Scheduler.asap);var i=t.createApiRequestObservable,o=t.serverResponseTimeout,s=t.tabId,a=t.visitorMetadata,u=t.status;if(e.customAttributes&&"object"!==y(e.customAttributes))return CO.Observable.throw({cause:BA.SALEMOVE.INVALID_INPUT,message:"Custom attributes must be an object"});if($n("customAttributesUpdateMethod",e)&&!Gt(e.customAttributesUpdateMethod,["merge","replace"]))return CO.Observable.throw({cause:BA.SALEMOVE.INVALID_INPUT,message:"Custom attributes update method must be either merge or replace"});var c=dt(FA(IL),ki(AL)),l=$n("externalId",e)?dt(Ve(["custom_attributes","external_id"],e.externalId),c)(e):c(e);return l.context={tab_id:s,url:window.location.href,metadata:a,status:u},null!==(r=sm.conf.visitor_api)&&void 0!==r&&r.disable_repeat_updates_optimization||0!==NL||!function(e){try{return ML.getItem(kL)===xL(e)}catch(e){return zO.info("Could not read last saved contact information hash",e),!1}}(nn("context",l))?(NL+=1,i(l).pipe(Ap((function(){return function(e){try{ML.setItem(kL,xL(e))}catch(e){zO.info("Could not save last saved contact information hash",e)}}(nn("context",l))})),Ka((function(){return{}})),hf((function(e){return CO.Observable.throw(Pj(e))})),Cp(o,CO.Observable.throw(new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT,message:"Set visitor information request timed out"})),n),Ap(null,tr(ji("cause",BA.SALEMOVE.TOO_MANY_REQUESTS),zO.warn.bind(zO,"Setting visitor information failed: too many requests"),zO.info.bind(zO,"Setting visitor information failed"))),hf(sI))):(zO.info("Avoiding first visitor information update as it matches a previous update"),CO.Observable.of({}))},CL={setTimeout:setTimeout,clearTimeout:clearTimeout},PL=function(e,t,n){var r,i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:CL,s=o.setTimeout,a=o.clearTimeout,u=function(e){return r=e,i&&a(i),i=s((function(){r=void 0}),t),e};return function(){return r?(n(r),Promise.resolve(r)):e().then(u)}},jL=s((function e(t){var n=t.state,r=t.medias,o=t.transitionReason,s=t.ticket,a=t.activeTicket;i(this,e),this.state=n,this.medias=r,this.transitionReason=o,this.ticket=s,this.activeTicket=a}));jL.prototype.QUEUE_STATES={CAN_QUEUE:"can_queue",CANNOT_QUEUE:"cannot_queue",QUEUED:"queued"},jL.prototype.TRANSITION_REASONS={ENGAGED:"engaged",CANCELED:"canceled",UNSTAFFED:"unstaffed",CLOSED:"closed",DISCONNECTED:"disconnected",FAILED:"failed",ALREADY_QUEUED:"already_queued",FORBIDDEN:"forbidden"};var LL=s((function e(t){var n=t.averageDurationInSeconds;i(this,e),this.averageDurationInSeconds=n})),UL=new rI({cause:BA.SALEMOVE.INTERNAL_ERROR}),qL=new rI({cause:BA.SALEMOVE.CANCEL}),DL=function(e,t){return e.increment("engagement.flow",["entrypoint:queue-request"].concat(t))},VL=function(e){var t=e.wsProxy,n=e.statsClient,r=e.apiTimeoutMilliseconds,i=e.ticket_id;return function(e,t){return AP({stats:e,protocol:"rest",failureTagProperty:"error",timeout:t,timeoutError:CO.Observable.throw(UL)})}(n,r)({resource:"queue_tickets",method:"delete"},(function(){return t.request({method:"DELETE",url:"".concat(sm.conf.api_url,"/queue_tickets/").concat(i),payload:{},headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})})).mapTo({}).do((function(){return function(e){return DL(e,["stage:requested","action:end","expected:true","reason:cancel"])}(n)})).catch(sI)},FL=function(e){var t=e.engagementApi,n=e.engagementRequestApi,r=e.fetchEngagementDependencies,i=e.channelObservable,o=e.communicationLib,s=e.statsClient,a=e.webRtcMode,u=e.enabledMediaLevel,c=e.connectionStatusObservable,l=e.getRequestHeaders,f=e.internalVisitorStateObservable,d=e.volatileNotifications,p=e.pubsub,h=e.statusObservable,v=e.wsProxy,b=e.cobrowser,m=r().publishReplay(1),g=m.connect();return n.acceptedObservable.take(1).flatMap((function(e){var n=e.engagementId,r=e.subEngagementId,g=e.operatorId,y=e.media,_=e.operatorName,w=e.operatorFormattedName,E=e.operatorPicture,O=e.operatorMediaType,S=e.entrypoint,T=e.createdAt;return m.take(1).map((function(){var e=LN({id:g,name:_,formattedName:w,picture:E,mediaType:O,webRtcMode:a,enabledMediaType:u});return{engagementId:n,subEngagementId:r,startingMedia:y,type:"reactive",isReestablishing:!1,initialChatHistoryObservable:PR(n),operator:e,channelObservable:i,communicationLib:o,engagementApi:t,getRequestHeaders:l,internalVisitorStateObservable:f,entrypoint:S,volatileNotifications:d,pubsub:p,statusObservable:h,wsProxy:v,createdAt:T,statsClient:s,connectionStatusObservable:c,cobrowser:b}})).map(Bj.create).do(null,(function(){return function(e){return DL(e,["stage:requested","action:end","reason:script-load-error"])}(s)})).do(null,(function(){return t.endEngagement({engagementId:n,reason:"error",subReason:"setup_failed"})}))})).finally((function(){return g.unsubscribe()}))},HL=function(){function e(t){i(this,e);var n=t.ticket_id,r=t.apiTimeoutMilliseconds,o=t.statsClient,s=t.wsProxy,a=t.stopObservable,u=new CO.Subject,c=CO.Observable.merge(u,a);zO.info("Queue Ticket created, waiting for engagement",{queue_ticket_id:n});var l=FL(t).takeUntil(c).do((function(e){return e.start()})).catch(sI).publishReplay(1);l.connect(),this.engagementPromise=l.merge(c.flatMapTo(CO.Observable.throw(qL))).take(1).toPromise(),this.cancel=function(){return u.next(),l.last(null,null,null).flatMap((function(e){return e?CO.Observable.fromPromise(e.end()):VL({wsProxy:s,statsClient:o,apiTimeoutMilliseconds:r,ticket_id:n})})).toPromise()}}return s(e,null,[{key:"create",value:function(t,n){var r=new CO.Subject;return{ticket:dt(Wt(e),qe("stopObservable",r.asObservable()))(Jr(t,{ticket_id:me(["activeTicket","id"],n)})),subscription:new CO.Subscription((function(){return r.next(),r.unsubscribe()}))}}}]),e}(),WL="requesting",GL="created",BL={open:1,opened:1,full:2,unstaffed:3,closed:4},zL=dt(_e(ii((function(e){return BL[e]})),"closed"),pe(me(["state","status"]))),JL=dt(fr,Xe(me(["state","medias"]))),QL=function(e){var t=Lt(Ti(["state","status"],"open"),e),n=JL(t);return{state:zL(e)||"closed",medias:n}},YL=function(e){return ki(Object.getOwnPropertyNames(e),e)},KL=["enqueued","request_sent"],XL=ji("site_id",sm.siteId),$L=dt(Lt(XL),Ai([],["omniq","queue_tickets"])),ZL=dt(ve(0),Lt((function(e){return-1!==KL.indexOf(e.state)})),$L),eU=Je((function(e,t){return dt(ve(0),Lt(ji("id",e)),$L)(t)})),tU=function(e){var t=e.queueState,n=e.queued,r=e.enqueuedInCurrentTab;return n||!(De(t)||De(n)||De(r))},nU=function(e,t){return dr(function(e){var t=["text","phone"];return e&&(t=t.concat(["messaging"])),ON()===EN&&(t=t.concat(["audio","video"])),t}(t),e)},rU=function(e){var t=e.queueState,n=e.queued,r=e.visitorLeftReason,i=e.enqueuedInCurrentTab,o=e.isEngaged,s=e.activeTicket,a=e.isVisitorAuthenticatedExternally,u=e.isAsyncTransfer;if(n)return new jL(i?{state:jL.prototype.QUEUE_STATES.QUEUED,activeTicket:s}:{state:jL.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:jL.prototype.TRANSITION_REASONS.ALREADY_QUEUED});var c=function(e,t){if(t)return jL.prototype.TRANSITION_REASONS.ENGAGED;if(e)switch(e){case"finished":return jL.prototype.TRANSITION_REASONS.ENGAGED;case"canceled":return jL.prototype.TRANSITION_REASONS.CANCELED;case"unstaffed":return jL.prototype.TRANSITION_REASONS.UNSTAFFED;case"closed":return jL.prototype.TRANSITION_REASONS.CLOSED;case"disconnected":return jL.prototype.TRANSITION_REASONS.DISCONNECTED;case"failure":case"visitor_conflict":return jL.prototype.TRANSITION_REASONS.FAILED;case"forbidden":return jL.prototype.TRANSITION_REASONS.FORBIDDEN;default:return void zO.error("Unknown visitor left reason",{reason:e})}}(r,o);if(c===jL.prototype.TRANSITION_REASONS.ENGAGED||"opened"!==t.state&&"open"!==t.state)return new jL({state:jL.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:c});var l=nU(u?t.medias.concat(["messaging"]):t.medias,a);return 0===l.length?new jL({state:jL.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:c}):new jL({state:jL.prototype.QUEUE_STATES.CAN_QUEUE,medias:l,transitionReason:c})},iU=ze(ji("state",jL.prototype.QUEUE_STATES.CANNOT_QUEUE),ji("transitionReason",jL.prototype.TRANSITION_REASONS.ENGAGED)),oU=function(e){var t,n=e.routingObservable,r=e.internalVisitorStateObservable,i=e.visitorAuthenticatedExternallyObservable,o=e.queuesStateUpdatesObservable,s=e.createQueueTicketStateObservable,a=e.queueTicketBindings,u=e.scheduler;if(u||(u=CO.Scheduler.asap),me(["conf","omniq","omniq_enabled"],sm)){var c=new CO.ReplaySubject(1);s.subscribe((function(e){return c.next(!Gt(e,[WL,GL]))}));var l=function(e,t){return e.pipe(Ld((function(e){return e.pipe(mf(t,(function(e,t){return t})),Gu((function(e){return e})),Ld((function(t){return e.bufferWhen((function(){return t.take(1)}))})))})),Mu((function(e){return CO.Observable.from(e)})))}(function(e){var t=e.routingObservable,n=e.queuesStateUpdatesObservable;return t.pipe(mp((function(e){var t=e.queue_ids;return it(t)?nT.of([]):n.subscribeToListAsObservable({queueIds:t})})),Ka(QL),Ka(vr("queueState")),Hf(At))}({routingObservable:n,queuesStateUpdatesObservable:o}),c),f=CO.Observable.combineLatest(r,i).scan((function(e,t){var n,r,i,o=b(t,2),s=o[0],a=o[1],u=e&&e.activeTicket&&e.activeTicket.id,c=ZL(s),l=XC(s,{includeAsyncTransfer:!0}),f=Boolean(l)&&!KC(l);return c?{queued:!0,enqueuedInCurrentTab:(r=c,i=Cr(["visitor","browser_tab_id"]),dt(At(sm.tabId),Uo(i))(r)),activeTicket:{id:c.id},visitorLeftReason:null,isEngaged:f,isAsyncTransfer:KC(l),isVisitorAuthenticatedExternally:a}:u&&(n=eU(u,s))?{queued:!1,enqueuedInCurrentTab:!1,activeTicket:null,visitorLeftReason:n.state,isEngaged:f,isAsyncTransfer:KC(l),isVisitorAuthenticatedExternally:a}:{queued:!1,enqueuedInCurrentTab:!1,activeTicket:null,visitorLeftReason:null,isEngaged:f,isAsyncTransfer:KC(l),isVisitorAuthenticatedExternally:a}}),{}).do((function(e){e.queued||c.next(!0)})).distinctUntilChanged(At);return t=CO.Observable.merge(l,f).scan(Jr,{}).filter(tU).do((function(e){sm.conf.visitor_api.enable_staffing_logs&&zO.info("[staffing-logs] Recording raw aggregate queue state",e)})).map(rU).distinctUntilChanged(At,YL).scan(function(e){return function(t,n){var r;if(n.state===jL.prototype.QUEUE_STATES.QUEUED){var i;t.subscription.unsubscribe();var o=HL.create(e,n);return i=o.ticket,r=o.subscription,n.ticket=i,{queueState:n,subscription:r}}return iU(n)?(zO.info("Discarding queue ticket subscription as Visitor got engaged"),{queueState:n,subscription:CO.Subscription.EMPTY}):(t.subscription!==CO.Subscription.EMPTY&&zO.info("Dispose queue ticket subscription as Visitor is no longer queued"),t.subscription.unsubscribe(),{queueState:n,subscription:CO.Subscription.EMPTY})}}(a),{subscription:CO.Subscription.EMPTY}).map(ge("queueState")).publishReplay(1,Number.POSITIVE_INFINITY,u).refCount(),{aggregateQueueStateObservable:t}}return{aggregateQueueStateObservable:CO.Observable.empty()}},sU=function(e){return e&&e.cause===BA.SALEMOVE.FORBIDDEN||e&&e.cause===BA.SALEMOVE.INVALID_INPUT?["reason:invalid-input"]:["reason:unknown"]},aU=[],uU=function(e){f(n,e);var t=a(n);function n(e){var r;return i(this,n),e||(e={}),(r=t.apply(this,arguments)).ticket=e.ticket,r}return s(n)}(rI),cU=new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT}),lU=function(e){return!function(e){return 0===e}(e.status)?!function(e){return 403===e}(e.status)?"Service Unavailable"===e.errorThrown&&(e=new rI({cause:BA.SALEMOVE.INTERNAL_ERROR})):e=new rI({cause:BA.SALEMOVE.FORBIDDEN}):e=new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT}),CO.Observable.throw(e)},fU=function(e,t){return AP({stats:e,protocol:"rest",failureTagProperty:"error",timeout:t,timeoutError:CO.Observable.throw(cU)})},dU=function(e,t){return e.omniq.omniq_enabled?t():Promise.reject(new rI({cause:BA.SALEMOVE.DISABLED}))},pU=function(e){var t=e.conf,n=e.statsClient,r=e.apiTimeoutMilliseconds;return function(){return dU(t,(function(){return fU(n,r)({resource:"queue_wait_duration",method:"get"},(function(){return MI({url:RR("/engagements/queue/wait_duration"),responseType:"json"})})).map(dt(Wt(LL),FA({average_duration_in_seconds:"averageDurationInSeconds"}),pe(Math.floor),ge("response"))).catch((function(e){return CO.Observable.throw(Pj(e))})).catch(sI).toPromise()}))}},hU=dt((function(e){var t=e.id,n=e.name,r=e.status,i=e.availableProperties;return new GA({id:t,name:n,status:r,medias:i.media})}),Cn({status:WA}),ki(["id","name","status","availableProperties"])),vU=function(e){var t=e.conf,n=e.wsProxy,r=e.statsClient,i=e.apiTimeoutMilliseconds,o=e.apiMaxRetries,s=e.apiRetryIntervalMilliseconds;return function(){var e=function(e){return it(Gt(e.status,Vi(400,499)))};return dU(t,(function(){var t=CO.Observable.defer((function(){return fU(r,i)({resource:"queues",method:"get"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/queues?site_ids[]=").concat(sm.siteId),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))}));return LT(t,{maxRetries:o,calculateDelay:Ko(s),shouldRetry:e}).map(ge("queues")).map(pe(FA({available_properties:"availableProperties"}))).map(pe(hU)).catch(lU).catch(sI).toPromise()}))}},bU=function(e){var t=e.wsProxy,n=e.pubsub,r=e.routingObservable,i=e.engagementApi,o=e.engagementRequestApi,s=e.operatorsObservable,a=e.cobraObservable,u=e.channelObservable,c=e.communicationLib,l=e.statsClient,f=e.fetchEngagementDependencies,d=e.apiTimeoutMilliseconds,p=e.apiRetryIntervalMilliseconds,h=e.apiMaxRetries,v=e.connectionStatusObservable,m=e.webRtcMode,g=e.enabledMediaLevel,y=e.visitorMetadata,_=e.conf,w=e.getRequestHeaders,E=e.internalVisitorStateObservable,O=e.visitorAuthenticatedExternallyObservable,S=e.volatileNotifications,T=e.statusObservable,A=e.queuesStateUpdatesObservable,I=e.cobrowser,k=new CO.Subscription;k.add(r.subscribe((function(e){aU=e.queue_ids})));var x=function(e){return l.increment("engagement.flow",["entrypoint:queue-request"].concat(e))},M=new CO.Subject,N=oU({routingObservable:r,internalVisitorStateObservable:E,visitorAuthenticatedExternallyObservable:O,queuesStateUpdatesObservable:A,createQueueTicketStateObservable:M,queueTicketBindings:{apiTimeoutMilliseconds:d,statsClient:l,wsProxy:t,engagementApi:i,engagementRequestApi:o,cobraObservable:a,fetchEngagementDependencies:f,operatorsObservable:s,channelObservable:u,communicationLib:c,webRtcMode:m,enabledMediaLevel:g,connectionStatusObservable:v,getRequestHeaders:w,internalVisitorStateObservable:E,volatileNotifications:S,pubsub:n,statusObservable:T,cobrowser:I}}).aggregateQueueStateObservable,R=function(e,t){return N.take(1).flatMap((function(n){var r=n.state,i=n.medias;return r===jL.prototype.QUEUE_STATES.CAN_QUEUE?function(e){var t=e.media,n=e.options,r=e.availableMediaTypes;return _P({media:t,options:n,availableMediaTypes:r,availableOneWayMediaTypes:uN(r)})}({media:e,options:t,availableMediaTypes:i}):CO.Observable.throw(new rI({cause:BA.SALEMOVE.FORBIDDEN,message:"Queue state must be: ".concat(jL.prototype.QUEUE_STATES.CAN_QUEUE)}))}))},C=function(){return E.take(1).flatMap((function(e){return Boolean(XC(e))?CO.Observable.throw(new rI({cause:BA.SALEMOVE.FORBIDDEN,message:"Visitor is already engaged"})):CO.Observable.of({})}))},P=function(e){return-1!==["Queue is closed","Queue is full"].indexOf(e.details)?CO.Observable.throw(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:e.message})):409===e.status?N.take(1).flatMap((function(e){return function(e){return CO.Observable.throw(new uU({cause:BA.SALEMOVE.ALREADY_QUEUED,message:"Visitor is already queued",ticket:e}))}(e.ticket)})):403===e.status?CO.Observable.throw(new rI({cause:BA.SALEMOVE.FORBIDDEN})):"Validation error"===e.error?CO.Observable.throw(new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:e.error})):sI(e)};return{subscription:k,queueForEngagement:function(e,n){return n||(n={}),x(["action:begin"]),dU(_,(function(){var r=b(n.queueId?[{media:e,options:n},C]:[{media:e,options:n,queueIds:aU},R],2),i=r[0],o=r[1],s=function(e){var t=e.wsProxy,n=e.statsClient,r=e.apiTimeoutMilliseconds,i=e.errorHandling,o=e.visitorMetadata;return function(e){var s=e.media,a=e.options,u=e.queueIds;return fU(n,r)({resource:"queue_tickets",method:"create"},(function(){var e={};a.phoneNumber&&(e.phone_number=a.phoneNumber),a.phoneExtension&&(e.phone_extension=a.phoneExtension),a.oneWay&&(e.one_way=a.oneWay);var n=a.source||"sdk",r=a.replaceExisting||!1,c={media:s,visitor_id:jO(),media_options:e,replace_existing:r,source:n,visitor_metadata:o};a.queueId?c=Jr(c,{queue_id:a.queueId}):u&&(c=Jr(c,{queue_ids:u}));var l={method:"POST",url:"".concat(sm.conf.api_url,"/queue_tickets"),payload:Jr(c,{site_id:sm.siteId}),headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}};return t.request(l).catch(i||sI).do(null,(function(e){return zO.warn("Failed to create a queue ticket",{error:e,payload:ki(["media","source","queue_id","queue_ids"],c)})}))}))}}({wsProxy:t,statsClient:l,apiTimeoutMilliseconds:d,visitorMetadata:y,errorHandling:P})(i);return o(e,n).do((function(){return M.next(WL)})).do((function(){return x(["action:reach","stage:create-request"])}),(function(e){return x(["action:end","stage:pre-request"].concat(sU(e)))})).flatMapTo(s).mapTo({}).do((function(){return x(["action:reach","stage:requested"])}),(function(e){return x(["action:end","stage:create-request"].concat(sU(e)))})).do((function(){return M.next(GL)}),(function(){return M.next("failed-to-create")})).toPromise()}))},fetchWaitDuration:pU({conf:_,statsClient:l,apiTimeoutMilliseconds:d}),aggregateQueueStateObservable:N,getQueues:PL(vU({conf:_,wsProxy:t,statsClient:l,apiTimeoutMilliseconds:d,apiMaxRetries:h,apiRetryIntervalMilliseconds:p}),6e4,(function(e){return zO.info("Returning cached response for queues",{cached_queues_length:null==e?void 0:e.length})}))}},mU=function(e,t,n){return function(){if("function"==typeof n&&n(arguments),e&&"function"==typeof e[t])return e[t].apply(e,arguments);throw new rI({cause:BA.SALEMOVE.NOT_SUPPORTED})}},gU=function(e){if(!Gt(e[0],tI))throw new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"Make sure function argument is one of ISO 3166-1 alpha-2 country codes"})},yU=function(){function e(t){i(this,e),this.triggerQueueMediaSelection=mU(t,"triggerQueueMediaSelection"),this.setChatMessageRenderer=mU(t,"setChatMessageRenderer"),this.setPhoneNumberDefaultCountry=mU(t,"setPhoneNumberDefaultCountry",gU),this.showVisitorCode=mU(t,"showVisitorCode")}return s(e,[{key:"triggerQueueMediaSelection",value:function(e){}},{key:"setChatMessageRenderer",value:function(e){}},{key:"setPhoneNumberDefaultCountry",value:function(e){}},{key:"showVisitorCode",value:function(){}}]),e}(),_U=s((function e(t){var n=t.id,r=t.siteId,o=t.visitorId,s=t.url,a=t.authenticationApi;i(this,e),this.id=n,this.siteId=r,this.visitorId=o,this.url=s,this.decline=function(e){return a.deleteAuthenticationRequest({id:this.id,siteId:this.siteId,visitorId:this.visitorId,reason:e})}})),wU=new rI({cause:BA.SALEMOVE.NETWORK_TIMEOUT}),EU=function(e){var t=e.wsProxy,n=e.apiTimeoutMilliseconds,r=e.stats,i=AP({stats:r,protocol:"rest",failureTagProperty:"message",timeout:n,timeoutError:CO.Observable.throw(wU)});return{createAuthenticationRequest:function(e){var n=(e=DA(e)).webhooks||[];return i({resource:"authentication-request",method:"create"},(function(){return t.request({method:"POST",url:"".concat(sm.conf.api_url,"/visitor_authentication_requests"),payload:{authentication_provider_id:e.authenticationProviderId,webhooks:n,visitor_id:jO(),site_id:sm.siteId},headers:eI}).catch((function(t){return function(e,t){var n=404===e.status?new rI({cause:BA.SALEMOVE.INVALID_INPUT,message:"The authentication provider with ID ".concat(t.authenticationProviderId," was not found.")}):oI(e);return CO.Observable.throw(n)}(t,e)}))})).toPromise()},deleteAuthenticationRequest:function(e){var n=e.id,r=e.siteId,o=e.visitorId,s=e.reason;return i({resource:"authentication-request",method:"delete"},(function(){return t.request({method:"DELETE",url:"".concat(sm.conf.api_url,"/visitor_authentication_requests/").concat(n),payload:{site_id:r,visitor_id:o,fail_reason:s},headers:eI}).catch(aI,{allowedCauses:[BA.SALEMOVE.INVALID_INPUT,BA.SALEMOVE.NETWORK_TIMEOUT]})})).toPromise()}}},OU=!1,SU=function(e){var t=e.volatileChannelObservable,n=e.joinChannel,r=e.renewTokenAndReconnectWaitForTeardown;return function(e,t){return t.pipe(mp((function(t){return t.observable("message").pipe(Gu((function(e){return"engagement.visitor_consolidation.requested"===e.event_type})),mp((function(n){var r=n.site_id,i=n.visitor_id,o=n.token_event_id;return e("site_visitor:".concat(i),{topics:["site_visitor:".concat(i,":").concat(r)]}).pipe(hf((function(e){return e&&"unauthorized"===e.error?mS.Observable.empty():mS.Observable.throw(e)})),Mu((function(e){return(0,e.observable)("message",{leaveChannelOnDispose:!0})})),Gu((function(e){return"engagement.visitor_consolidation"===e.event_type&&e.event_id===o})),Yf(1),Ka((function(e){return h(h({},e),{},{volatileChannel:t})})))})))})))}(n,t).subscribe((function(e){var t=e.secret,n=e.assumed_visitor_id,i=e.volatileChannel;zO.info("Consolidating visitor",{assumed_visitor_id:n}),i.leave(),r({consolidationSecret:t}).delay(0).subscribe((function(){return qO(n)}),zO.error.bind(zO,"Error from renewing token and reconnecting in visitor consolidation"))}),zO.warn.bind(zO,"Error from visitor consolidation subscription"))},TU=ge("id"),AU=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this._elements=[],this._ids=new Set,this._changeSubject=new CO.Subject,this._insertToBeginning=!0===t.insertToBeginning,this.observable=this._changeSubject.asObservable()}return s(e,[{key:"change",value:function(e,t){return this._elements=this._elements.map((function(n){return n.id===e?t:n})),this._changeSubject.next(this._elements),this}},{key:"add",value:function(e){return this._ids.has(e.id)?this.change(e.id,e):(this._ids.add(e.id),this._insertToBeginning?this._elements=[e].concat(this._elements):this._elements=this._elements.concat([e])),this._changeSubject.next(this._elements),this}},{key:"replace",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.retainMissingElements,i=void 0!==r&&r,o=n.elementsToRetain,s=void 0===o?function(){return!0}:o;if(e.forEach((function(e){return t._ids.add(e.id)})),i){var a=ir(TU,e),u=this._elements.filter((function(e){return!a[e.id]})).filter(s);this._insertToBeginning?this._elements=u.concat(e):this._elements=e.concat(u)}else this._elements=e;return this._changeSubject.next(this._elements),this}},{key:"values",value:function(){return this._elements}},{key:"valuesUntil",value:function(e){return co((function(t){return!ji("id",e,t)}),this._elements)}}]),e}(),IU=Ai(0,["engagement","unread_message_count"]),kU={MESSAGES:"MESSAGES",UNREAD_MESSAGE_COUNT:"UNREAD_MESSAGE_COUNT"},xU=function(){return Ko(MC.initialDelay,MC.maxDelay,MC.factor)},MU={latestQueueIds:[],unreadMessageCount:0,markAsReadCount:0,lastSeenMessageDuringMarkRead:{id:void 0}};function NU(e){var t,n=e.pubsub,r=e.routingObservable,i=e.getRequestHeaders,o=e.internalVisitorStateObservable,s=new CO.Subscription,a=FI(),c=o.map(IU).distinctUntilChanged().publishReplay(1);s.add(c.connect());var l=o.map((function(e){return XC(e,{includeAsyncTransfer:!0})}));s.add(l.subscribe((function(e){t=e})));var f=MU;s.add(r.subscribe((function(e){var t=e.queue_ids;f=h(h({},f),{},{latestQueueIds:t})}))),s.add(c.subscribe((function(e){f=h(h({},f),{},{unreadMessageCount:e})})));var d,p=new AU({insertToBeginning:!0}),v=lt(ge("message"),FA({content:"message",timestamp:"created_at"}),nC),b=function(e){return h(h({},e),{},u({},$R,XR.PUBSUB))},m=ji("event_type","queued_message.created"),g=jO(),y=Ti(["message","sender","type"],"visitor"),_=CO.Observable.create((function(e){var r=n.joinSiteVisitorNotifications(g,[sm.siteId]).pipe(Lt((function(e){return m(e)||t&&jC(t.id)(e)})),Ut(y),pe(v),pe(b)),i=p.observable.subscribe(e);return i.add(r.subscribe(p.add.bind(p))),i})).throttleTime(50,qa,{leading:!0,trailing:!0}).distinctUntilChanged(At).share(),w=ji("event_type","engagement.files.security_scan_result");a.proxyAll(zn([[kU.MESSAGES,_],[kU.UNREAD_MESSAGE_COUNT,c]]));var E=a.addEventListener,O=a.removeEventListener;return{EVENTS:kU,addEventListener:E,uploadFile:function(e,t){var r=t.onUploadProgress,o=jO();return Lj(null,e,{onUploadProgress:r,getRequestHeaders:i},function(e){var t=e.visitorId;return d||((d=n.joinSiteVisitorNotifications(t,[sm.siteId]).filter(w).publishReplay(100)).connect(),d)}({visitorId:o}),sm.conf.communications.allowed_file_content_types).toPromise()},removeEventListener:O,fetchMessages:function(){return new Promise((function(e,t){!function(e){var t=e.getRequestHeaders,n=e.onSuccess,r=e.onError;NI({url:"".concat(sm.conf.api_url,"/messaging/chat_transcript"),method:"GET",getRequestHeaders:t,responseType:"json",calculateAttemptDelay:xU(),onSuccess:function(e){return n(e.response)},shouldRetry:function(e){return e>=500},onError:r})}({getRequestHeaders:i,onSuccess:function(t){var n=rC(t).filter(gt);p.replace(n,{retainMissingElements:!0,elementsToRetain:function(e){return e[$R]===XR.PUBSUB}}),e(p.values())},onError:function(e){return t(Pj(e))}})}))},send:function(e){var n=e.message,r=e.attachment,o=function(e){var t=e.message,n=e.attachment;return new GR({id:oA(),content:t,attachment:n,status:GR.prototype.STATUSES.SENDING})}({message:n,attachment:r});return p.add(o),new Promise((function(e,s){!function(e){var t,n=e.id,r=e.ongoingEngagement,i=e.message,o=e.attachment,s=e.queueIds,a=e.getRequestHeaders,u=e.onSuccess,c=e.onError,l="/messaging/chat_messages/".concat(n),f="/messaging/messages/".concat(n),d=Ai(!1,["visitor_app","secure_conversations_controlled_by_interaction_coordinator"],sm.conf),p=Ai(!1,["visitor_app","secure_conversations_redesign_enabled"],sm.conf),v=d&&p?f:l,b=r?"/engagements/".concat(r.id,"/chat_messages/").concat(n):v;NI({url:sm.conf.api_url+b,method:"PUT",getRequestHeaders:a,contentType:"application/json",responseType:"json",payload:JSON.stringify((t={content:i,attachment:o,queue_ids:s},h(h({},t),{},d&&p?{channel:"secure_conversation"}:{source:"tab"}))),calculateAttemptDelay:xU(),onSuccess:u,shouldRetry:function(e){return e>=500},onError:c})}({id:o.id,ongoingEngagement:t,message:n,attachment:r,queueIds:f.latestQueueIds,getRequestHeaders:i,onSuccess:function(){var t=function(e){return h(h({},e),{},{status:GR.prototype.STATUSES.DELIVERED})}(o);p.change(o.id,t),e(t)},onError:function(e){var t=function(e){return h(h({},e),{},{status:GR.prototype.STATUSES.FAILED})}(o);zO.warn("Failed to send message using message center",{error:e.response||{status:e.status}}),p.change(o.id,t),s(t)}})}))},markMessagesAsRead:function e(){var t=f,n=t.markAsReadCount,r=t.lastSeenMessageDuringMarkRead;f=h(h({},f),{},{markAsReadCount:n+1});var o=p.values()[0];if(o){if(0===n)return 0===f.unreadMessageCount?Promise.resolve():e();var s=p.valuesUntil(r.id);return B(BR,s)?Promise.resolve():(f=h(h({},f),{},{lastSeenMessageDuringMarkRead:o}),new Promise((function(e,t){NI({url:"".concat(sm.conf.api_url,"/messaging/mark_chat_messages_read"),method:"POST",responseType:"json",getRequestHeaders:i,calculateAttemptDelay:xU(),onSuccess:function(){return e()},shouldRetry:function(e){return e>=500},onError:function(e){f=h(h({},f),{},{lastSeenMessageDuringMarkRead:MU.lastSeenMessageDuringMarkRead}),t(Pj(e))}})})))}return Promise.resolve()},_stop:function(){s.unsubscribe(),a.stop()}}}var RU=function(e){return function(){return console.warn("Private API, do not use"),e.apply(this,arguments)}},CU=function(){function e(t){var n=this,r=t.statusObservable,o=t.cobraObservable,s=t.webRtcMode,a=t.enabledMediaLevel,u=t.statsClient,c=t.channelObservable,l=t.apiStart,f=t.visitorAppPublicInterface,d=t.pubsub,p=t.routingObservable,h=t.visitorMetadata,v=t.internalVisitorStateObservable,m=t.volatileNotifications,g=t.wsProxy,y=t.currentStatusObservable,_=t.operatorPresenceObservable,w=t.getVisitorPriority,E=t.queuesStateUpdatesObservable,O=t.dynamicImport,S=void 0===O?rS:O;i(this,e),this.willNavigate=this.willNavigate.bind(this),this.statsClient=u,this.visitorApp=new yU(f);var T,A=new CO.ReplaySubject(1);this.cobrowser=new sP({channelObservable:c,internalVisitorStateObservable:v,cobraObservable:o.pluck("cobraSource")}),this.setLocale=function(e){if(Gt(e,de(sm.conf.visitor_app_assets.locales)))return RI({url:sm.conf.visitor_app_assets.locales[e],retryLimit:5,calculateAttemptDelay:Ko(1e3),assetKey:"locale-change",identifier:e,onSuccess:function(t){return zO.info("Locale updated",{locale:e}),A.next(t.response)}},this.statsClient),{};throw new rI({cause:this.ERRORS.INVALID_INPUT})},this.messageCenter=new NU({routingObservable:(T={internalVisitorStateObservable:v,pubsub:d,routingObservable:p,getRequestHeaders:this.getRequestHeaders}).routingObservable,getRequestHeaders:T.getRequestHeaders,pubsub:T.pubsub,internalVisitorStateObservable:T.internalVisitorStateObservable});var I=_.map((function(e){return e.values()})),k=_.bufferCount(2,1).flatMap((function(e){var t=b(e,2),n=t[0],r=t[1],i=[];return n.values().forEach((function(e){var t=r.get(e.id);if(t&&!At(e,t))return i.push(t)})),CO.Observable.from(i)})),x=I,M=iS.vent.observable(iS.MSG.PUBLIC.ENGAGEMENT_START),N=iS.vent.observable(iS.MSG.PUBLIC.ENGAGEMENT_END),R=iS.vent.observable(iS.MSG.PUBLIC.ENGAGEMENT_ERROR),C=!1,P=function(e,t){return bT.merge(e.pipe(Ka(Ee(!0))),t.pipe(Ka(Ee(!1)))).pipe(vp(!1))}(M,N);P.subscribe((function(e){C=e})),this.isInEngagement=function(){return C};var j=new CO.ReplaySubject(1),L=function(e){var t=At("engagement");return e.pipe(Ka((function(e){var n=e.interaction,r=e.visitor,i=e.engagement;return new hL({engaged:t(n)&&!KC(i),name:r&&r.name,email:r&&r.email})})))}(r),U=function(e){return e.connectedObservable.pipe(Ka((function(e){return new vL({connected:e})})))}(d);SU(d);var q=sm.conf.engagement.api_timeout_milliseconds||zA,D=sm.conf.omniq.api_retry_interval_milliseconds||1e3,V=sm.conf.omniq.api_max_retries||100,F=new gL({wsProxy:g,stats:this.statsClient,apiTimeoutMilliseconds:q}),H=new TL({wsProxy:g,stats:this.statsClient,apiTimeoutMilliseconds:q,visitorMetadata:h,internalVisitorStateObservable:v,getRequestHeaders:this.getRequestHeaders,conf:sm.conf}),W=new EU({wsProxy:g,apiTimeoutMilliseconds:q,stats:this.statsClient}),G=bU({wsProxy:g,pubsub:d,routingObservable:p,engagementApi:F,engagementRequestApi:H,operatorsObservable:x,cobraObservable:o.pluck("cobraSource"),fetchEngagementDependencies:function(){return S("Comms")},channelObservable:c,communicationLib:sm.conf.communications.lib,statsClient:this.statsClient,apiTimeoutMilliseconds:q,apiRetryIntervalMilliseconds:D,apiMaxRetries:V,connectionStatusObservable:U,webRtcMode:s,enabledMediaLevel:a,visitorMetadata:h,conf:sm.conf,getRequestHeaders:this.getRequestHeaders,internalVisitorStateObservable:v,visitorAuthenticatedExternallyObservable:VO.asObservable().distinctUntilChanged(),volatileNotifications:m,statusObservable:r,queuesStateUpdatesObservable:E,cobrowser:this.cobrowser});this.queueForEngagement=G.queueForEngagement,this.getQueueWaitDuration=G.fetchWaitDuration,this.getQueues=G.getQueues;var B=G.aggregateQueueStateObservable;this.__queueForEngagement=G.oldQueueForEngagement,this.__setQueueReestablishListener=G.oldSetQueueReestablishListener,this.__fetchQueueWaitDuration=G.getQueueWaitDuration,this.subscribeToQueueStateUpdates=vI({enabled:sm.conf.omniq.omniq_enabled,statsClient:this.statsClient,pubsub:d}).subscribe,this.requestEngagement=function(e,t){var i=zj({api:H,conf:sm.conf,operatorsObservable:x.take(1),media:e,options:t,statsClient:n.statsClient,channelObservable:c,engagementApi:F,webRtcMode:s,enabledMediaLevel:a,connectionStatusObservable:U,getRequestHeaders:n.getRequestHeaders,internalVisitorStateObservable:v,volatileNotifications:m,statusObservable:r,pubsub:d,wsProxy:g,dynamicImport:S,cobrowser:n.cobrowser});return function(e){var t=e.operatorObservable,n=e.engagementObservable,r=e.cancelEngagementRequest,i=e.engagementRequestTimeout;return new Jj({timeout:i,engagementPromise:n.toPromise(),operatorPromise:t.toPromise(),cancel:r})}({operatorObservable:i.operatorObservable,engagementObservable:i.engagementObservable,cancelEngagementRequest:i.cancelEngagementRequest,engagementRequestTimeout:i.engagementRequestTimeout})};var z=function(e){var t=e.internalVisitorStateObservable,n=e.webRtcMode,r=e.enabledMediaLevel,i=e.engagementRequestApi,o=e.statsClient,s=e.cobraObservable,a=e.channelObservable,u=e.engagementApi,c=e.connectionStatus,l=e.getRequestHeaders,f=e.volatileNotifications,d=e.statusObservable,p=e.pubsub,h=e.wsProxy,v=e.dynamicImport,b=e.cobrowser,m=1e3*sm.conf.engagement.proactive_call_timeout,g=dt(ve(0),Lt((function(e){return Te(ji("id",sm.siteId),e.transferrable_sites)})),Lt(ji("outcome",null)),Lt(ji("type","proactive")),Ai([],["engagement","requests"]));return t.map(g).filter(gt).distinctUntilChanged(null,ge("id")).map((function(e){var v=LN({id:e.operator.id,name:e.operator.name,formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},mediaType:e.operator.media_type,webRtcMode:n,enabledMediaType:r}),g=LN({id:e.operator.id,name:e.operator.name,formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},mediaType:e.offered_media_type,webRtcMode:n,enabledMediaType:r});return{incomingEngagementRequest:lL.create({api:i,id:e.id,operator:v,restrictedOperator:g,message:e.welcome_message,logoUrl:sm.conf.visitor_app.site_logo.url,platform:e.platform,timeout:m,statsClient:o,cobraObservable:s.take(1).pluck("cobraSource"),channelObservable:a,engagementApi:u,connectionStatusObservable:c,getRequestHeaders:l,internalVisitorStateObservable:t,volatileNotifications:f,statusObservable:d,pubsub:p,wsProxy:h,cobrowser:b}),platform:e.platform}})).switchMap((function(e){var t=e.incomingEngagementRequest,n=e.platform;return v("Comms").mapTo({incomingEngagementRequest:t,platform:n})}))}({dynamicImport:S,internalVisitorStateObservable:v,webRtcMode:s,enabledMediaLevel:a,engagementRequestApi:H,statsClient:this.statsClient,cobraObservable:o,channelObservable:c,engagementApi:F,connectionStatus:U,getRequestHeaders:this.getRequestHeaders,volatileNotifications:m,statusObservable:r,pubsub:d,wsProxy:g,cobrowser:this.cobrowser}),J=new Qj,Q=z.filter(ji("platform",$A)).map(ge("incomingEngagementRequest"));this.setIncomingEngagementRequestHandler=function(e){J.add(Q.subscribe(e,(function(e){return zO.error("incomingEngagementObservable failed",e)})))};var Y=function(e){var t=e.reestablishObservable,n=e.defaultOmnicoreHandler,r=e.defaultOmnibrowseHandler,i=e.internalVisitorStateObservable,o=e.sessionStore||FM,s=e.timeout||15e3,a=t.publishReplay(1);a.connect();var u={replayedReestablishObservable:a.withLatestFrom(i,(function(e,t){return{source:e,visitorState:t}})).filter((function(e){var t=e.source,n=e.visitorState;return!!t.engagement.engagementId&&dt(jn(ji("id",t.engagement.engagementId)),Ai([],["engagement","engagements"]))(n)})).map((function(e){return e.source})),sessionStore:o,timeout:s};return{setOmnicoreReestablishHandler:pL(Jr(u,{defaultHandler:n,storeKey:"custom_reestablish_handler_set",platform:$A})),setOmnibrowseReestablishHandler:pL(Jr(u,{defaultHandler:r,storeKey:"omnibrowse_custom_reestablish_handler_set",platform:ZA}))}}({reestablishObservable:l.flatMap((function(){return dL({channelObservable:c,cobrowser:n.cobrowser,internalVisitorStateObservable:v,statusObservable:r,webRtcMode:s,enabledMediaLevel:a,statsClient:n.statsClient,isEngagedObservable:P,engagementApi:F,connectionStatusObservable:U,getRequestHeaders:n.getRequestHeaders,volatileNotifications:m,pubsub:d,wsProxy:g,dynamicImport:S})})),defaultOmnicoreHandler:function(e){return zO.warn("Engagement reestablished without a reestablish handler in place")},defaultOmnibrowseHandler:function(e){return zO.warn("Phone-first (OmniBrowse) engagement reestablished without a reestablish handler in place")},internalVisitorStateObservable:v}),K=Y.setOmnicoreReestablishHandler,X=Y.setOmnibrowseReestablishHandler;this.setEngagementReestablishHandler=K,this.requestAsset=function(e,t){t||(t={});return cL(e,(function(){return Jr(n.getRequestHeaders(),t)})).toPromise()},this.omnibrowse=new Kj({incomingEngagementRequestObservable:z,setOmnibrowseReestablishHandler:X,statsClient:this.statsClient,wsProxy:g}),this.overseer=new nL({operatorListReady:I.take(1),isOmniqEnabled:sm.conf.omniq.omniq_enabled,routingObservable:p,queueStateReady:B.take(1)}),this.omnicall=new iL,this.config=new aL,this.getBrowserContext=function(){return y.take(1).map((function(e){return{tab_id:sm.tabId,url:window.location.href,metadata:sm.conf.visitor_metadata,status:e}})).toPromise()},this.updateInformation=function(e){return y.take(1).flatMap((function(t){return RL(e,{createApiRequestObservable:function(e){return MI({url:RR("/sites/".concat(DO(),"/visitors/").concat(jO())),method:"PATCH",contentType:"application/json",payload:e})},serverResponseTimeout:zA,tabId:sm.tabId,visitorMetadata:sm.conf.visitor_metadata,status:t})})).toPromise()},this.createAuthenticationRequest=function(e){return zO.info("Create authentication request called",e),W.createAuthenticationRequest(e)},this.setupContactOperatorButton=function(e){return e||(e={}),zO.warn("setupContactOperatorButton is deprecated!"),j.next(e)};var $=function(e){var t=e.internalVisitorStateObservable,n=e.authenticationApi,r=dt(jn((function(e){return e.site_id===DO()&&e.visitor_id===jO()})),Ai([],["authentication_requests"]));return t.pipe(Ka(r),Gu(gt),Hf(At),Ka((function(e){return Wt(_U)({id:e.id,siteId:e.site_id,visitorId:e.visitor_id,url:e.url,authenticationApi:n})})))}({internalVisitorStateObservable:v,authenticationApi:W}),Z=function(e){var t=e.pipe(Ka(Ai([],["engagement","pending_secure_conversations"])),Ka(DA),Hf(At),Ud(1));return t.connect(),{pendingSecureConversationsObservable:t}}(v),ee=Z.pendingSecureConversationsObservable,te=zn([[this.EVENTS.ENGAGEMENT_START,M],[this.EVENTS.ENGAGEMENT_END,N],[this.EVENTS.ENGAGEMENT_ERROR,R],[this.EVENTS.VISITOR_STATUS_UPDATE,L],[this.EVENTS.OPERATOR_STATUS_UPDATE,k],[this.EVENTS.OPERATOR_LIST_UPDATE,I],[this.EVENTS.ENGAGEMENT_REQUEST,z.map(Ee({}))],[this.EVENTS.CONNECTION_STATUS_UPDATE,U],[this.EVENTS.QUEUE_STATE_UPDATE,B],[this.EVENTS.AUTHENTICATION_REQUEST,$],[this.EVENTS.PENDING_SECURE_CONVERSATIONS,ee],["contact_operator_button_configuration",j],["locale_change_requested",A]]),ne=FI();ne.proxyAll(te),this.addEventListener=ne.addEventListener,this.removeEventListener=ne.removeEventListener,this.observable=function(e){return te[e]},function(e){var t,n=e.internalVisitorStateObservable,r=e.useOmniq,i=e.operatorListUpdate,o=e.queueStateUpdate,s=e.statsClient,a=e.staffingCheckDelayMs,u=void 0===a?1e4:a,c=e.recordingMaxTime,l=void 0===c?6e4:c,f=dt(Mr,Lt(me(["state","available"]))),d=n.map((function(e){return Boolean(XC(e))})).filter(At(!0));t=r?o.map((function(e){return sm.conf.visitor_api.enable_staffing_logs&&zO.info("[staffing-logs] Recording queue state",{queue_state:e.state}),Gt(e.state,[e.QUEUE_STATES.CAN_QUEUE,e.QUEUE_STATES.QUEUED])?"staffed":"general"})):i.map((function(e){return sm.conf.visitor_api.enable_staffing_logs&&zO.info("[staffing-logs] Recording operator state",{operator_count:f(e)}),f(e)>0?"staffed":"general"})),sm.conf.visitor_api.enable_staffing_logs&&zO.info("[staffing-logs] Starting recorder timer",{duration:u});var p=CO.Observable.create((function(e){var t=setTimeout((function(){e.next(null)}),u);return function(){return clearTimeout(t)}})),h=new Date,v=function(){return window.performance&&window.performance.now&&window.performance.now()},b=v();p.flatMapTo(t).take(1).takeUntil(d).subscribe((function(e){var t=new Date,n=v(),r=t-h+1e3<=u;r||t-h>l?zO.warn("Recording staffing failed due to browser timer issues",{type:e,early_recording:r,start_time:h.toISOString(),recording_time:t.toISOString(),accurate_start_time:b,accurate_recording_time:n,difference:t&&t-h,accurate_difference:n&&n-b}):s.increment("usage_metrics.visitor.reactive_tab_showed",["type:".concat(e),"source:desktop","site_id:".concat(DO()),"visitor_id:".concat(jO())])}),(function(e){return zO.error("Operator staffing observable failed",e)}))}({internalVisitorStateObservable:v,useOmniq:sm.conf.omniq.omniq_enabled,operatorListUpdate:this.observable(this.EVENTS.OPERATOR_LIST_UPDATE),queueStateUpdate:this.observable(this.EVENTS.QUEUE_STATE_UPDATE),statsClient:this.statsClient});var re=fA(),ie=function(e,t){var n=e.activityObservable,r=e.engagementEndObservable,i=e.timeUntilIdle,o=e.maxIdleTime,s=e.isEngaged;return CO.Observable.merge(n,r).debounceTime(i+o,t).filter((function(){return!s()})).map((function(){}))}({activityObservable:re,engagementEndObservable:N,timeUntilIdle:1e3*sm.conf.engagement.visitor_time_to_inactive_sec,maxIdleTime:1e3*sm.conf.visitor_api.max_idle_time_seconds,isEngaged:function(){return C}}).filter((function(){return sm.conf.visitor_api.disconnect_idle_visitors}));!function(e){var t=e.visitorIdleAfterTime,n=e.pubsub;t.subscribe((function(){sm.logger.info("Visitor was idle for too long, disconnecting"),n.disconnect(),OU=!0}))}({visitorIdleAfterTime:ie,pubsub:d}),function(e){var t=e.activityObservable,n=e.pubsub;t.filter((function(){return OU&&n.allowReconnection()})).subscribe((function(){sm.logger.info("Reconnecting idle visitor due to detected activity"),OU=!1,n.connect()}))}({activityObservable:re,pubsub:d}),this.getSessionContext=function(){var e={tab_id:sm.tabId,visitor_priority:w(),access_token:sm.accessToken};return encodeURIComponent(btoa(JSON.stringify(e)))},this.__pubsub__={reconnect:RU(d.reconnect),socket:RU((function(){return d.__socket__}))}}return s(e,[{key:"getRequestHeaders",value:function(){return{Accept:"application/vnd.salemove.v1+json",Authorization:"Bearer "+sm.accessToken}}},{key:"getVisitorId",value:function(){return jO()}},{key:"getSiteId",value:function(){return DO()}},{key:"leaveMessage",value:function(e){return uL(e,{createApiRequestObservable:function(e){return MI({url:RR("/visitor/offline_message"),method:"POST",contentType:"application/json",payload:e})},serverResponseTimeout:zA}).toPromise()}},{key:"leaveOperatorMessage",value:function(e){return function(e,t,n){e||(e={}),n||(n=CO.Scheduler.asap);var r=e.operatorId;return r?uL(Jr({operator_id:r},e),t,["operator_id"],n):CO.Observable.throw({cause:BA.SALEMOVE.INVALID_INPUT,message:"operatorId must be specified"})}(e,{createApiRequestObservable:function(e){return MI({url:RR("/visitor/operator_message"),method:"POST",contentType:"application/json",payload:e})},serverResponseTimeout:zA}).toPromise()}},{key:"willNavigate",value:function(){return Promise.resolve({})}},{key:"changeElementAttributesForCobrowsing",value:function(e,t){if("function"!=typeof t)throw new rI({cause:this.ERRORS.INVALID_INPUT});return e[XA]=DI("Custom element attribute serializer threw error",XA,t),function(e){e.setAttribute(bL,"0"===(e.getAttribute(bL)||"0")?"1":"0")}(e),null}}]),e}();CU.prototype.ERRORS={INVALID_INPUT:"invalid input",OPERATOR_UNAVAILABLE:"operator unavailable",INTERNAL_ERROR:"internal error",RESOURCE_NOT_FOUND:"not found",OPERATOR_DECLINED:"operator declined",DECLINE:"decline",CANCEL:"cancel",TIMEOUT:"timeout",NETWORK_TIMEOUT:"network timeout",CONNECTION_LOST:"connection lost",TOO_MANY_REQUESTS:"too many requests",FORBIDDEN:"forbidden",NOT_SUPPORTED:"not supported",DISABLED:"disabled",ALREADY_QUEUED:"already queued",ALREADY_ENGAGED:"already engaged",CONFLICT:"conflict",FILE_TOO_LARGE:"file too large",FILE_CONTENT_TYPE_NOT_ALLOWED:"file content type not allowed",DENIED_BY_PERMISSIONS_POLICY:"denied by permissions policy",DEVICE_ACCESS_ERROR:"device access error",DENIED_BY_SYSTEM:"denied by system",UNAUTHORIZED:"unauthorized"},CU.prototype.EVENTS={ENGAGEMENT_END:"sm:engagement:end",ENGAGEMENT_START:"sm:engagement:start",ENGAGEMENT_ERROR:"sm:engagement:error",VISITOR_STATUS_UPDATE:"sm:visitor_status:update",ENGAGEMENT_REQUEST:"sm:engagement:request",OPERATOR_LIST_UPDATE:"sm:operator_list:update",OPERATOR_STATUS_UPDATE:"sm:operator_status:update",CONNECTION_STATUS_UPDATE:"sm:connection_status:update",QUEUE_STATE_UPDATE:"sm:queue:update",AUTHENTICATION_REQUEST:"sm:authentication:request",PENDING_SECURE_CONVERSATIONS:"sm:secure_conversations:pending"};var PU="sm.app.visitor_api.send_capabilities",jU=function(){function e(t){var n=t.channelObservable,r=t.statsClient,o=t.getLocalCapabilities,s=void 0===o?Mj:o;i(this,e),this.channelObservable=n,this.statsClient=r,this.getLocalCapabilities=s,this._receivePostMessage=this._receivePostMessage.bind(this),this._restoreLastUrl=this._restoreLastUrl.bind(this),this._subscription=new CO.Subscription,this.lastUrl=window.location.href}return s(e,[{key:"start",value:function(){return this._addListeners()}},{key:"capabilitiesRequestObservable",value:function(){return this.channelObservable.switchMap((function(e){var t=e.channel;return function(e){return sm.logger.log("Capabilities response, received request"),e.observable("capabilities:request")}(t).map((function(){return t}))}))}},{key:"_addListeners",value:function(){var e=this;iS.vent.observable("visit:restore_url").subscribe(this._restoreLastUrl,(function(e){return sm.logger.error("visit:restore_url observable failed",e)})),window.addEventListener("message",this._receivePostMessage,!1),this._subscription.add(this.capabilitiesRequestObservable().map((function(t){return{channel:t,localCapabilities:e.getLocalCapabilities()}})).do((function(){return e.statsClient.increment(PU,["action:succeeded"])})).do(null,(function(){return e.statsClient.increment(PU,["action:failed"])})).subscribe((function(e){var t=e.channel,n=e.localCapabilities;sm.logger.log("Sending local capabilities",n),t.emit("capabilities:response",n)}),sm.logger.warn.bind(sm.logger,"Failed to send visitor capabilities")))}},{key:"_receivePostMessage",value:function(e){try{var t=JSON.parse(e.data);t["sm-xdr-url"]&&(this.lastUrl=t["sm-xdr-url"])}catch(e){}}},{key:"_restoreLastUrl",value:function(){var e;null!==(e=sm.conf.visitor_api)&&void 0!==e&&e.use_buggy_iframe_reload?this._oldRestoreLastUrl():window.location.hash&&this.lastUrl.split("#")[0]===window.location.href.split("#")[0]?window.location.reload():window.location.href=this.lastUrl}},{key:"_oldRestoreLastUrl",value:function(){this.lastUrl&&this.lastUrl.split("#")===window.location.href.split("#")[0]?window.location.reload():window.location.href=this.lastUrl}}]),e}(),LU=["v1"],UU=new Promise((function(e,t){return sm._apiHandlers.push({resolve:e,options:{version:"v1"}})})),qU=new CO.Subject,DU=CO.Observable.fromPromise(UU).flatMap((function(e){return CO.Observable.merge(e.observable(e.EVENTS.ENGAGEMENT_START),e.observable(e.EVENTS.ENGAGEMENT_END).map((function(){return null})))})).publishReplay(1);DU.connect();var VU=function(){function t(e){var n=e.element;i(this,t),this._empty=this._empty.bind(this),this._startOperatorMediaInElement=this._startOperatorMediaInElement.bind(this),this.element=n,this._subscription=new CO.Subscription;var r=b(DU.partition(gt),2);this.startMediaObservable=r[0],this.endMediaObservable=r[1]}return s(t,[{key:"start",value:function(){this._subscription.add(this.startMediaObservable.subscribe(this._startOperatorMediaInElement,(function(e){return zO.error("startMediaObservable failed",e)}))),this._subscription.add(this.endMediaObservable.subscribe(this._empty,(function(e){return zO.error("endMediaObservable failed",e)})))}},{key:"destroy",value:function(){this._subscription.unsubscribe()}},{key:"_empty",value:function(){this.element.innerHTML=""}},{key:"_startOperatorMediaInElement",value:function(t){var n=e.visitor_api?e.visitor_api.use_updated_webcomponents:void 0;t.communicationWidget.startOperatorMedia(this.element),zO.info("Starting operator media in widget",{engagement_id:t.engagementId,updated_webcomponents:n}),XO.increment("sm.app.visitor.customElements",["action:succeeded","type:engaged_operator","updated_webcomponents:".concat(n)])}}]),t}(),FU=function(){if(sm.conf.visitor_api&&sm.conf.visitor_api.use_updated_webcomponents)return function(e){f(n,e);var t=a(n);function n(){return i(this,n),t.apply(this,arguments)}return s(n,[{key:"connectedCallback",value:function(){return this._controller=new VU({element:this}),this._controller.start()}},{key:"disconnectedCallback",value:function(){return this._controller.destroy()}}]),n}(w(HTMLElement));if(window.customElements){var e=function e(){return window.Reflect.construct(HTMLElement,[],e)};return Object.setPrototypeOf(e.prototype,HTMLElement.prototype),Object.setPrototypeOf(e,HTMLElement),e.prototype.connectedCallback=function(){return this._controller=new VU({element:this}),this._controller.start()},e.prototype.disconnectedCallback=function(){return this._controller.destroy()},e}var t={}.hasOwnProperty,n=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return function(e,n){var r;for(r in n)t.call(n,r)&&(e[r]=n[r]);function i(){this.constructor=e}i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype}(e,HTMLElement),e.prototype.attachedCallback=function(){return this._controller=new VU({element:this}),this._controller.start()},e.prototype.detachedCallback=function(){return this._controller.destroy()},e}();return n},HU=function(){var t=FU();if(window.customElements)try{customElements.get("sm-engaged-operator")||window.customElements.define("sm-engaged-operator",t)}catch(t){var n=e.visitor_api?e.visitor_api.use_updated_webcomponents:void 0;XO.increment("sm.app.visitor.customElements",["action:failed","type:engaged_operator","updated_webcomponents:".concat(n)]),zO.error("Failed to initiate sm-engaged-operator",{error_message:t?t.message:void 0,updated_webcomponents:n})}else document.registerElement("sm-engaged-operator",t)},WU=function(){function t(e){var n=e.engagedVisitorElement,r=e.attributes;i(this,t),this._addListeners=this._addListeners.bind(this),this._empty=this._empty.bind(this),this._startVisitorMedia=this._startVisitorMedia.bind(this),this.engagedVisitorElement=n,this._subscription=new CO.Subscription,this._attributes=r}return s(t,[{key:"start",value:function(){return this._addListeners()}},{key:"destroy",value:function(){return this._subscription.unsubscribe()}},{key:"_addListeners",value:function(){var e=b(DU.partition(gt),2),t=e[0],n=e[1];return this._subscription.add(t.subscribe(this._startVisitorMedia,(function(e){return zO.error("startMediaObservable failed",e)}))),this._subscription.add(n.subscribe(this._empty,(function(e){return zO.error("endMediaObservable failed",e)})))}},{key:"_empty",value:function(){this.engagedVisitorElement.innerHTML=""}},{key:"_startVisitorMedia",value:function(t){var n=e.visitor_api?e.visitor_api.use_updated_webcomponents:void 0,r=document.createElement("div");this.engagedVisitorElement.appendChild(r),t.communicationWidget.startVisitorMedia(r,this._attributes),zO.info("Starting visitor media in widget",{engagement_id:t.engagementId,updated_webcomponents:n}),XO.increment("sm.app.visitor.customElements",["action:succeeded","type:engaged_visitor","updated_webcomponents:".concat(n)])}}]),t}(),GU=function(){if(sm.conf.visitor_api&&sm.conf.visitor_api.use_updated_webcomponents)return function(e){f(n,e);var t=a(n);function n(){return i(this,n),t.apply(this,arguments)}return s(n,[{key:"connectedCallback",value:function(){this._controller=new WU({engagedVisitorElement:this,attributes:{translations:JSON.parse(this.getAttribute("translations"))||{}}}),this._controller.start()}},{key:"disconnectedCallback",value:function(){this._controller.destroy()}}]),n}(w(HTMLElement));if(window.customElements){var e=function e(){return window.Reflect.construct(HTMLElement,[],e)};return Object.setPrototypeOf(e.prototype,HTMLElement.prototype),Object.setPrototypeOf(e,HTMLElement),e.prototype.connectedCallback=function(){this._controller=new WU({engagedVisitorElement:this,attributes:{translations:JSON.parse(this.getAttribute("translations"))||{}}}),this._controller.start()},e.prototype.disconnectedCallback=function(){this._controller.destroy()},e}var t={}.hasOwnProperty,n=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return function(e,n){var r;for(r in n)t.call(n,r)&&(e[r]=n[r]);function i(){this.constructor=e}i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype}(e,HTMLElement),e.prototype.attachedCallback=function(){return this._controller=new WU({engagedVisitorElement:this,translations:this.getAttribute("translations")||{}}),this._controller.start()},e.prototype.detachedCallback=function(){return this._controller.destroy()},e}();return n},BU=function(){var t=GU();if(window.customElements)try{customElements.get("sm-engaged-visitor")||window.customElements.define("sm-engaged-visitor",t)}catch(t){var n=e.visitor_api?e.visitor_api.use_updated_webcomponents:void 0;XO.increment("sm.app.visitor.customElements",["action:failed","type:engaged_visitor","updated_webcomponents:".concat(n)]),zO.error("Failed to initiate sm-engaged-visitor",{error_message:t?t.message:void 0,updated_webcomponents:n})}else document.registerElement("sm-engaged-visitor",t)},zU=!1,JU=!1,QU=[],YU=function e(){if(!JU){if(!document.body)return setTimeout(e,13);if(JU=!0,QU){for(var t,n=0;t=QU[n++];)t.call(document);QU=null}}},KU=function e(){document.removeEventListener("DOMContentLoaded",e,!1),YU()};function XU(e){!function(){if(!zU){if(zU=!0,"complete"===document.readyState||"interactive"===document.readyState)return YU();document.addEventListener("DOMContentLoaded",KU,!1),window.addEventListener("load",YU,!1)}}(),JU?e.call(document):QU&&QU.push(e)}sm.ready=XU;var $U=function(e){localStorage.setItem("sm.access_token",e)},ZU=function(e){var t=e.token,n=e.offset,r=void 0===n?-5e3:n,i=e.scheduler,o=void 0===i?CO.Scheduler.asap:i,s=e.getJwtExpMSFn,a=void 0===s?rN:s,u=e.startDate,c=void 0===u?Date.now():u;return CO.Observable.timer(a(t)+r-c,o)},eq=function(e){var t=e.accessTokenRenewalSignal,n=e.accessToken,r=e.getGliaContextObservable,i=void 0===r?tN:r,o=e.tokenExpirationObservable,s=void 0===o?ZU:o,a=e.isVisitorAuthenticatedExternallyFn;it(void 0===a?FO:a)||i().switchMap((function(e){var t=e.idToken,r=function(e,t){return 3===e.split(".").length?e:t}(t,n);return s({offset:-5e3,token:r}).mapTo(t)})).switchMap((function(e){return i().map((function(t){var n=t.idToken;return[e,n]}))})).filter((function(e){var t=b(e,2);return t[0]===t[1]})).subscribe((function(){return t.next({expiringIdTokenRefresh:!0})}))},tq=["isLocaleFetchFailed"];if(sm.conf.visitor_api.persist_visitor_session_in_url){sm.urlParams=sR({accessToken:/.+/,tabId:/.+/},{targetWindow:window,logger:zO})}else sm.urlParams={};if(window.onpageshow=function(e){e.persisted&&window.location.reload()},"show_visitor_code"===sm.conf.visitor_app.chat_link_visitor_consolidation){var nq=sR({showVisitorCode:/true/},{targetWindow:window,logger:zO});Sr(nq)||(sm.urlParams.showVisitorCode=!0)}var rq={setStatsClient:function(){},setLogger:function(){},ready:function(){}},iq=function(e){var t=sm.conf.visitor_app_assets,n="visitor_app";return new Promise((function(r,i){var o,s,a;-1!==["latest_new_app","latest_v2","latest_v2_plus"].indexOf(sm.conf.visitor_app_option)?(o=function(e){e.setAttribute("data-sm-visitor-app-asset",""),e.setAttribute("data-loaded-callback","sm.visitorAppLoaded"),sm.visitorAppLoaded=r},a=null):(o=function(e){return e.setAttribute("data-sm-visitor-app-asset","")},a=function(){return r(rq)}),t.js.forEach((function(t){t=encodeURI(t),s=t.substring(t.lastIndexOf("/")+1),ts({integrity:es({versionedName:s}),fileUrl:t,beforeLoad:o,onAttempt:function(){e.increment("sm.assets.load",["action:attempted","asset:".concat(n,".js")])},onLoad:function(){e.increment("sm.assets.load",["action:succeeded","asset:".concat(n,".js")]),a&&a()},onError:function(){e.increment("sm.assets.load",["action:warning","asset:".concat(n,".js")])},onGiveUp:function(){e.increment("sm.assets.load",["action:failed","asset:".concat(n,".js")]),zO.warn(new Error("Failed to load visitor app JS asset"),{asset_url:t})}})})),t.css.forEach((function(t){t=encodeURI(t),s=t.substring(t.lastIndexOf("/")+1),ns({integrity:es({versionedName:s}),fileUrl:t,onAttempt:function(){e.increment("sm.assets.load",["action:attempted","asset:".concat(n,".css")])},onLoad:function(){e.increment("sm.assets.load",["action:succeeded","asset:".concat(n,".css")])},onError:function(){e.increment("sm.assets.load",["action:warning","asset:".concat(n,".css")])},onGiveUp:function(){e.increment("sm.assets.load",["action:failed","asset:".concat(n,".css")]),zO.warn(new Error("Failed to load visitor app CSS asset"),{asset_url:t})}})}))}))},oq=function(){return-1!==["latest_new_app","latest_v2","latest_v2_plus","custom","omnibrowse"].indexOf(sm.conf.visitor_app_option)},sq=function(e){var t=e.stats;return oq()?iq(t):Promise.resolve(rq)},aq=function(){return sm.conf.visitor_app.visitor_app_default_locale||""},uq={translations:{}},cq=function(e){return new Promise((function(t,n){var r=aq(),i=(sm.conf.visitor_app_assets.locales||{})[r];i?RI({url:i,shouldRetry:function(){return!1},assetKey:"locale",identifier:r,onSuccess:function(e){t({translations:e.response})},onError:function(){zO.warn("Fetching locale failed, using empty locale"),t(h(h({},uq),{},{isLocaleFetchFailed:!0}))},skipErrorReport:!0},e):(e.increment("sm.assets.load",["action:failed","asset:locale","reason:locale_missing"]),zO.warn("Locale is not present, starting with defaultMessages",{localeKey:r,localeUrl:i}),t(uq))}))},lq=function(e){return"en-US"===aq()?Promise.resolve(uq):oq()?cq(e):Promise.resolve(uq)},fq=function(e){var t=QN.extractLinkFromEvent(e);t&&function(e,t){"https:"!==t.protocol&&"http:"!==t.protocol||QN.isAllowedToNavigate(t.hostname)||(e.preventDefault(),window.open(t.href))}(e,t)},dq=function(){return qM.unloadMaybeToPageCache.subscribe((function(){return FM.set(IR,xR(document))}))},pq=function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.routingObservable;document.body.addEventListener("click",fq),dq(),function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.routingObservable;ok();var u=zI({channelObservable:OR({internalVisitorStateObservable:o,getAccessToken:t,stats:n,visitorPresenceChannel:i,salemovePresentInParent:!0}).channelObservable,logger:zO}).cobraObservable,c=vI({enabled:sm.conf.omniq.omniq_enabled,pubsub:r});qI({internalVisitorStateObservable:o,cobraObservable:u,volatileNotifications:s,stats:n,currentStatusObservable:GM(o),queuesStateUpdatesObservable:c,routingObservable:a})}({getAccessToken:t,stats:n,pubsub:r,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,routingObservable:a}),fS(),YN()},hq={setup:function(){$U(sm.accessToken),zO.info("Visitor WebRTC mode",{webrtc_mode:ON()}),sm.conf.visitor_app.theme=sm.conf.visitor_app.theme.desktop_css_url;var e=eR(),t=e.bestEffortXDomainStorage,n=e.windowNameStorage,r=e.xDomainUrlStorage,i=HM.setup(n,{sessionContext:sm._sessionContext,tabIdFromConfiguration:sm.tabId}),o=i.getId();sm.tabId=o;var s=new CO.Subject;!function(e,t){Yo=Jr(Yo,{enabled:t}),e.take(1).subscribe((function(e){e.volatileChannelObservable.flatMap((function(e){return e.observable("system:visitor_retry_configuration")})).subscribe((function(e){Yo=e}))}))}(s,sm.conf.visitor_request_retries_enabled);var a=function(e){return e.getItem(JM)}(t)||zM,u=function(){return a},c=Ai(!1,["sm","conf","engagement_restart","skip_on_unauthentication"])(window),l=new CO.Subject,f=function(e){var t=e.fetchToken,n=void 0===t?sN:t,r=e.accessToken,i=e.scheduler,o=void 0===i?CO.Scheduler.asap:i,s=e.accessTokenRenewalSignal,a=void 0===s?CO.Observable.empty():s,u=e.backoffStrategy,c=void 0===u?Ko:u,l=e.getVisitorPriority,f=e.getVisitorTabId,d=void 0===f?function(){return sm.tabId}:f,p=e.tabHandler,h=new CO.ReplaySubject(1),v=iN(r);h.next(v);var b=c(3e3),m=function(e){return function(e){return e&&e.consolidationSecret}(e)||function(e){return e&&e.newIdToken}(e)||function(e){return e&&e.expiringIdTokenRefresh}(e)};return h.switchMap((function(e){return CO.Observable.timer(e,o)})).merge(a.filter(ot(m))).throttleTime(6e4,o).merge(a.filter(m)).switchMap((function(e){var t={priority:l(),tabId:d(),sessionTabIds:p.getSessionTabIds()};e&&e.consolidationSecret?t.consolidationSecret=e.consolidationSecret:e&&e.expiringIdTokenRefresh?t.includeIdToken=!1:t.accessToken=r,zO.info("Refreshing access token");var i=CO.Observable.defer((function(){return n(t)})).do(null,(function(e){503!==e.status&&429!==e.status||(zO.warn("Visitor access token unavailable, switching to maximum backoff"),b.maximizeNextDelay()),zO.warn("Failed to fetch JWT token. Retrying...",e.responseText)}));return LT(i,{maxRetries:403200,calculateDelay:b,scheduler:o}).do((function(e){var t=e.accessToken;r=t;var n=iN(t);h.next(n),zO.info("Access token refresh succeeded",{interval_seconds:n/1e3})}))}))}({accessToken:sm.accessToken,accessTokenRenewalSignal:l,getVisitorPriority:u,tabHandler:i}).share(),d=function(){return sm.accessToken};FO()&&eq({accessTokenRenewalSignal:l,accessToken:sm.accessToken});var p=Qk({server:sm.conf.pubsub_server,stats:XO,logsEnabled:sm.conf.visitor_api.pubsub_logs_enabled,getAccessToken:d,renewAccessToken:function(e){return l.next(e),f.delay(1e3)},reconnectConf:{initialDelay:sm.conf.visitor_api.socket_connection_error_retry_delay,maxDelay:sm.conf.visitor_api.socket_connection_error_max_delay,delayFactor:sm.conf.visitor_api.socket_connection_error_delay_factor},getVisitorPriority:u});s.next(p),f.subscribe((function(e){var t,n,r,i,o,s=e.accessToken,a=e.visitorId,u=e.authenticatedExternally,f=rN(sm.accessToken)!==rN(s);sm.accessToken=s,$U(s),f&&u&&eq({accessTokenRenewalSignal:l,accessToken:sm.accessToken}),t={oldVisitorId:jO(),newVisitorId:a,oldAuthenticatedExternally:FO(),newAuthenticatedExternally:u},n=t.oldVisitorId,r=t.newVisitorId,i=t.oldAuthenticatedExternally,o=t.newAuthenticatedExternally,r!==n&&o!==i&&function(e){var t=e.visitorId,n=e.authenticatedExternally,r=e.pubsub,i=e.skipEngagementRestartOnUnauthentication,o=void 0!==i&&i,s=e.App,a=void 0===s?iS:s,u=e.setNewVisitorIdFn,c=void 0===u?qO:u,l=e.setVisitorAuthenticatedExternallyFn,f=void 0===l?HO:l;(n||!o)&&a.vent.trigger("engagement:prepare_for_restart"),f(n),r.disconnect((function(){c(t),r.connect()}))}({visitorId:a,authenticatedExternally:u,pubsub:p,skipEngagementRestartOnUnauthentication:c})})),tN().switchMap((function(e){var t=e.idToken;return function(e){var t=e.accessTokenObservable,n=e.timeInterval,r=void 0===n?1e3:n,i=e.scheduler,o=void 0===i?CO.Scheduler.asap:i,s=e.initialValue,a=e.getGliaContextAsObservable,u=void 0===a?tN:a,c=s;return CO.Observable.merge(t,CO.Observable.of(null)).switchMap((function(){return CO.Observable.timer(r,r,o).switchMap((function(){return u().filter((function(e){var t=e.idToken,n=t===c;return c=t,!n}))})).take(1)}))}({accessTokenObservable:f,initialValue:t})})).subscribe((function(){l.next({newIdToken:!0})}));var h=new Yk(p,{tabId:sm.tabId,idleTimeoutSeconds:sm.conf.engagement.visitor_time_to_inactive_sec,visitorMetadata:sm.conf.visitor_metadata}),v=CM({pubsub:p,tabId:sm.tabId});(function(e,t){return e.map(XM).distinctUntilChanged().do((function(e){return t.setItem(JM,e)}))})(v,t).subscribe((function(e){a=e}));var b,m=p.volatileChannelObservable.flatMap((function(e){return(0,e.observable)("message")})),g=function(e){var t=e.pubsub,n=t.joinChannel("websocket_proxy").publishReplay(1);return n.connect(),{connectedObservable:t.connectedObservable,updateAccessToken:function(e){n.take(1).flatMap((function(t){return t.push("update_access_token",{token:e})})).subscribe()},request:function(e,t){return t||(t={}),"GET"===e.method&&null!==e.payload?(PM.error("Request with GET method cannot have payload",{params:e}),CO.Observable.throw("Request with GET method cannot have payload")):n.flatMap((function(n){return n.push("request",e,t)})).flatMap(jM).catch(LM)}}}({pubsub:p});f.subscribe((function(e){var t=e.accessToken;g.updateAccessToken(t)})),b=sm.conf.visitor_api.use_updated_webcomponents?window.customElements&&window.customElements.define?"webcomponents_es5":"webcomponents":"legacy_webcomponents";var y=sm.BusinessRules.Controller.actionTriggers(m,sm.BusinessRules.ACTION_TYPES.SHOW_OPERATORS_IN_SELECTOR_V2).scan((function(e,t){var n=t.operator_team_id,r=t.rule_id,i=t.rule_name,o=t.clear_previous;return o?{team_ids:[n],rule_id:r,rule_name:i,clear_previous:o}:{team_ids:xo(e.team_ids,[n]),rule_id:r,rule_name:i,clear_previous:o}}),{}).do((function(e){return zO.info("Business rule setting visible teams",{team_ids:e.team_ids,rule_id:e.rule_id,rule_name:e.rule_name,clear_previous:e.clear_previous})})).pluck("team_ids").publishReplay(1);y.connect();var _=function(e){var t=e.pubsub,n=e.visibleTeamsObservable,r=e.enabledMediaLevel,i=e.webRtcMode,o=t.joinChannel("site_operator_presence:".concat(sm.siteId)).map((function(e){var t=e.phoenixChannel;return new Rk(t)})).switchMap((function(e){return CO.Observable.create((function(t){return DN({presence:e,presenceMapper:UN({enabledMediaLevel:r,webRtcMode:i}),visibleTeamsObservable:n,onChange:function(e){return t.next(e)}})}))})).publishReplay(1);return(o=jT(o)).sampleTime(300)}({pubsub:p,visibleTeamsObservable:y,enabledMediaLevel:sm.conf.communications.enabled_media_level,webRtcMode:ON()}),w=sm.conf.engagement.default_queues||[],E=tR({internalVisitorStateObservable:v,defaultQueues:w});rS(b).subscribe((function(){XU((function(){window!==window.top?hq.setupIFrame({getAccessToken:d,stats:XO,pubsub:p,visitorPresenceChannel:h,internalVisitorStateObservable:v,volatileNotifications:m,wsProxy:g,bestEffortXDomainStorage:t,operatorPresenceObservable:_,xDomainUrlStorage:r,getVisitorPriority:u,routingObservable:E,tabId:o}):(sm.visitorPageNotifierSubscription={unsubscribe:nk(o)},rk(o),hq.setupApp({getAccessToken:d,stats:XO,pubsub:p,visitorPresenceChannel:h,internalVisitorStateObservable:v,volatileNotifications:m,wsProxy:g,operatorPresenceObservable:_,bestEffortXDomainStorage:t,xDomainUrlStorage:r,getVisitorPriority:u,routingObservable:E}))}))}))},setupApp:function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.operatorPresenceObservable,c=e.xDomainUrlStorage,l=e.getVisitorPriority,f=e.routingObservable;HU(),BU();return Promise.all([sq({stats:n}),lq(n),rR({stats:n}),oR({stats:n})]).then((function(e){return"[0]"!==JSON.stringify([0])?(r.disconnect(),Promise.reject('Misimplemented array stringification: (JSON.stringify([0]) !== "[0]"')):e})).then((function(e){var t=b(e,2),r=t[0],i=t[1],o=i.isLocaleFetchFailed,s=function(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n={};for(var r in e)if({}.hasOwnProperty.call(e,r)){if(t.includes(r))continue;n[r]=e[r]}return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.includes(n)||{}.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}(i,tq);return o&&sm.getApi({version:"v1"}).then((function(e){return e.setLocale(aq())})),function(e){var t=e.visitorApp,r=e.locale;return void 0===t.setStatsClient&&zO.warn("Setting dependencies failed. visitorApp.setStatsClient was undefined.",{visitorApp:t}),t.setStatsClient(n),t.setLogger(zO),t.ready({locale:r}),t}({visitorApp:r,locale:s})})).then((function(e){c.setItem("tabId",sm.tabId),c.setItem("accessToken",sm.accessToken);var d=function(e){var t=e.getAccessToken,n=e.stats,r=e.visitorPresenceChannel,i=e.internalVisitorStateObservable;ok();var o=OR({internalVisitorStateObservable:i,getAccessToken:t,stats:n,visitorPresenceChannel:r,salemovePresentInParent:!1}),s=o.channelObservable;return{channelObservable:s,statusObservable:o.statusObservable,cobraObservable:zI({channelObservable:s,logger:zO}).cobraObservable}}({getAccessToken:t,stats:n,visitorPresenceChannel:i,internalVisitorStateObservable:o}),p=GM(o),h=vI({enabled:sm.conf.omniq.omniq_enabled,pubsub:r});!function(e){var t,n=e.statusObservable,r=e.cobraObservable,i=e.statsClient,o=e.channelObservable,s=e.visitorAppPublicInterface,a=e.pubsub,u=e.visitorMetadata,c=e.internalVisitorStateObservable,l=e.routingObservable,f=e.volatileNotifications,d=e.wsProxy,p=e.currentStatusObservable,h=e.operatorPresenceObservable,v=e.getVisitorPriority,b=e.queuesStateUpdatesObservable,m=ON(),g=sm.conf.communications.enabled_media_level,y=new CU({statusObservable:n,webRtcMode:m,enabledMediaLevel:g,statsClient:i,cobraObservable:r,channelObservable:o,apiStart:qU,visitorAppPublicInterface:s,pubsub:a,visitorMetadata:u,internalVisitorStateObservable:c,routingObservable:l,volatileNotifications:f,wsProxy:d,currentStatusObservable:p,operatorPresenceObservable:h,getVisitorPriority:v,queuesStateUpdatesObservable:b});sm._getApi=t=function(e){e||(e={});var t=e.version;return t?Gt(t,LU)?Promise.resolve(y):(zO.warn("getApi used with unsupported version ".concat(t," at ").concat(window.location.host)),Promise.reject(new Error("".concat(t," is not supported for Glia API. ")+"The supported versions are: ".concat(bP(LU))))):(console.warn("Requesting the Glia API without a version is deprecated. Provide the 'version' parameter to the sm.getApi function. Example: sm.getApi({version: 'v1'})"),zO.warn("getApi used without version at ".concat(window.location.host)),Promise.resolve(y))},Gn((function(e){t(e.options).then(e.resolve.bind(e))}),sm._apiHandlers),new jU({channelObservable:o,statsClient:i}).start(),qU.next(),qU.complete(),setTimeout((function(){sm.urlParams.showVisitorCode&&s&&(s.showVisitorCode?s.showVisitorCode():zO.info("showVisitorCode is undefined on visitorAppPublicInterface"))}))}({statusObservable:d.statusObservable,cobraObservable:d.cobraObservable,channelObservable:d.channelObservable,statsClient:n,visitorAppPublicInterface:e,pubsub:r,visitorMetadata:sm.conf.visitor_metadata,internalVisitorStateObservable:o,routingObservable:f,volatileNotifications:s,wsProxy:a,currentStatusObservable:p,operatorPresenceObservable:u,getVisitorPriority:l,queuesStateUpdatesObservable:h}),qI({internalVisitorStateObservable:o,cobraObservable:d.cobraObservable,volatileNotifications:s,stats:n,currentStatusObservable:p,queuesStateUpdatesObservable:h,routingObservable:f}),fS(),function(){var e=FM.get(IR);if(e)FM.remove(IR),kR(document,e)}()})).catch((function(e){return zO.warn("Starting visitor app failed",{error:e})}))},setupIFrame:function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.bestEffortXDomainStorage,c=e.operatorPresenceObservable,l=e.xDomainUrlStorage,f=e.getVisitorPriority,d=e.routingObservable,p=e.tabId,h=new tk(p);h.start(),h.request(),sm.visitorPageNotifierSubscription={unsubscribe:nk(p)};var v=new ik(h,sm.conf),b=!1;return v.identityObservable().subscribe((function(e){if(b)zO.warn("Received iFrame identity after defaulting to unknown",{identity:e});else switch(b=!0,e){case v.IDENTITIES.NESTED_COBROWSABLE_IFRAME:fS(),function(e){var t=e.parentWindowMessenger,n=e.iframeContext,r=e.getAccessToken,i=e.stats;new wM(t,n.nestedCobrowsableVisitorIframeChannelUrl,r,i).boot()}({getAccessToken:t,parentWindowMessenger:h.getParentWindowMessenger(),iframeContext:h.getCurrentContext(),stats:n});break;case v.IDENTITIES.ENGAGEMENT_IFRAME:h.stop(),pq({stats:n,pubsub:r,getAccessToken:t,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,routingObservable:d});break;default:sm.conf.visitor_api.allow_embedding?(zO.info("Did not receive iFrame identity from parent, bootstrapping as top frame"),rk(p),hq.setupApp({stats:n,pubsub:r,getAccessToken:t,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:c,bestEffortXDomainStorage:u,xDomainUrlStorage:l,getVisitorPriority:f,routingObservable:d})):zO.warn("Starting base app failed. IFrame has unknown identity.                 Top frame likely does not have Glia scripts installed.",{identity:e})}}))}};sm.EventEmitter=A,sm.dynamicImport=rS,sm.R=Qo,sm.Rx=CO,sm.App=iS;var vq=Boolean(sm.Bootstrapper);sm.Bootstrapper={boot:function(){vq||sm.installed||(sm.installed=!0,hq.setup())}}}(sm.conf);
//# sourceMappingURL=bootstrapper-02766f85f.js.map
